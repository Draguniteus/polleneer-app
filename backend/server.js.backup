const express = require('express');
const cors = require('cors');
const path = require('path'); // ADD BACK for production
const { Pool } = require('pg');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 8080; // DigitalOcean uses 8080

// ===== MIDDLEWARE =====
app.use(cors({ 
    origin: process.env.NODE_ENV === 'production' 
        ? ['https://polleneer-dbkzq.ondigitalocean.app'] 
        : ['http://localhost:3000', 'http://localhost:5173'],
    credentials: true 
}));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ===== SERVE REACT IN PRODUCTION =====
if (process.env.NODE_ENV === 'production') {
    console.log('ğŸš€ PRODUCTION MODE: Serving React build');
    app.use(express.static(path.join(__dirname, '../frontend/dist')));
}

// ===== DATABASE CONNECTION (PostgreSQL) =====
let pool;
const DATABASE_URL = process.env.DATABASE_URL || 'postgresql://localhost:5432/polleneer';

try {
    pool = new Pool({
        connectionString: DATABASE_URL,
        ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
    });
    console.log('âœ… PostgreSQL connected');
    
    // Create tables if they don't exist
    (async () => {
        try {
            await pool.query(`
                CREATE TABLE IF NOT EXISTS users (
                    id SERIAL PRIMARY KEY,
                    username VARCHAR(50) UNIQUE NOT NULL,
                    email VARCHAR(100) UNIQUE NOT NULL,
                    password VARCHAR(100) NOT NULL,
                    profile_color VARCHAR(20) DEFAULT '#FFC107',
                    honey_points INTEGER DEFAULT 100,
                    join_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
                
                CREATE TABLE IF NOT EXISTS posts (
                    id SERIAL PRIMARY KEY,
                    content TEXT NOT NULL,
                    author_id INTEGER REFERENCES users(id),
                    author_name VARCHAR(50) NOT NULL,
                    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    likes INTEGER DEFAULT 0,
                    pollinates INTEGER DEFAULT 0
                );
                
                CREATE TABLE IF NOT EXISTS comments (
                    id SERIAL PRIMARY KEY,
                    post_id INTEGER REFERENCES posts(id),
                    user_id INTEGER REFERENCES users(id),
                    username VARCHAR(50) NOT NULL,
                    content TEXT NOT NULL,
                    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
            `);
            console.log('âœ… Database tables ready');
        } catch (err) {
            console.log('âš ï¸ Table creation error:', err.message);
        }
    })();
} catch (error) {
    console.log('âŒ PostgreSQL connection failed:', error.message);
    console.log('âš ï¸ Using in-memory storage instead');
    pool = null;
}

// ===== IN-MEMORY STORAGE (FALLBACK) =====
let inMemoryUsers = [];
let inMemoryPosts = [];
let inMemoryComments = [];

// ===== API ROUTES =====

// Test route
app.get('/api/test', (req, res) => {
    res.json({ 
        message: 'API is working! ğŸ',
        timestamp: new Date().toISOString(),
        mode: pool ? 'PostgreSQL' : 'In-memory',
        environment: process.env.NODE_ENV || 'development'
    });
});

// Health check
app.get('/api/health', (req, res) => {
    res.json({
        status: 'healthy',
        server: 'Polleneer Backend',
        port: PORT,
        timestamp: new Date().toISOString()
    });
});

// Auth routes (keep your existing auth routes here)
app.post('/api/auth/register', async (req, res) => {
    // ... keep your existing register code ...
});

app.post('/api/auth/login', async (req, res) => {
    // ... keep your existing login code ...
});

// Posts routes (keep your existing posts code)
app.get('/api/posts', async (req, res) => {
    // ... keep your existing get posts code ...
});

app.post('/api/posts', async (req, res) => {
    // ... keep your existing create post code ...
});

// ===== CATCH ALL ROUTE FOR REACT ROUTING =====
if (process.env.NODE_ENV === 'production') {
    app.get('*', (req, res) => {
        res.sendFile(path.join(__dirname, '../frontend/dist', 'index.html'));
    });
}

// ===== START SERVER =====
app.listen(PORT, () => {
    console.log(`ğŸš€ Server running on port ${PORT}`);
    console.log(`ğŸŒ Environment: ${process.env.NODE_ENV || 'development'}`);
    console.log(`ğŸ”— API URL: http://localhost:${PORT}/api`);
    console.log(`ğŸ—„ï¸ Database: ${pool ? 'PostgreSQL' : 'In-memory (no DB)'}`);
    
    if (process.env.NODE_ENV === 'production') {
        console.log('ğŸ“ Serving React build from: ../frontend/dist');
    }
});