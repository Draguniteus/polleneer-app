<!DOCTYPE html>
<html lang="en" data-theme="dark" data-site-style="default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polleneer - The Social Hive</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&family=Source+Code+Pro:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Variables for Theme */
        :root {
            /* Bee Theme Colors */
            --honey-yellow: #FFC30B;
            --honey-dark: #E6A800;
            --hive-orange: #FF8C00;
            --pollen-gold: #FFD700;
            --nectar-light: #FFF9C4;
            --bee-black: #1A1A1A;
            --wax-white: #EEDFA5;
            --comb-brown: #8B4513;
            --flower-pink: #FF69B4;
            --leaf-green: #228B22;
            --sky-blue: #87CEEB;
            --background-light: #F5E6B8;
            --background-dark: #0F0F0F;
            --card-light: #FBF0D1;
            --card-dark: #1E1E1E;
            --text-light: #333333;
            --text-dark: #E0E0E0;
            --border-light: #DEBB6E;
            --border-dark: #333333;
        }

        /* Default Dark Theme */
        [data-theme="dark"] {
            --bg-primary: var(--background-dark);
            --bg-secondary: var(--bee-black);
            --bg-card: var(--card-dark);
            --bg-input: #2A2A2A;
            --text-primary: var(--text-dark);
            --text-secondary: #AAAAAA;
            --border-color: var(--border-dark);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #F5E6B8;
            --bg-secondary: #EEDFA5;
            --bg-card: #FBF0D1;
            --bg-input: #F7E9BC;
            --text-primary: #3A2510;
            --text-secondary: #6B4F2D;
            --border-color: #DEBB6E;
            --shadow-color: rgba(160, 120, 30, 0.15);
            --honey-yellow: #D49B00;
            --honey-dark: #B88600;
            --hive-orange: #C46A0A;
            --pollen-gold: #E8AD00;
            --leaf-green: #4E7A28;
            --sky-blue: #5A9EC2;
            --flower-pink: #C44D7E;
        }

        /* Spring Theme - Cherry Blossom / Stardew Spring */
        [data-theme="spring"] {
            --bg-primary: #FFF5F5;
            --bg-secondary: #FFF0F0;
            --bg-card: #FFFFFF;
            --bg-input: #FFF8F6;
            --text-primary: #3D2B1F;
            --text-secondary: #7A6455;
            --border-color: #F0D6D0;
            --shadow-color: rgba(255, 150, 150, 0.15);
            --honey-yellow: #FF92B0;
            --honey-dark: #E87A98;
            --hive-orange: #66CDAA;
            --pollen-gold: #FFD1DC;
            --leaf-green: #5CB85C;
            --sky-blue: #87CEEB;
            --flower-pink: #FF69B4;
        }

        /* Summer Theme - Golden Hour / Stardew Summer */
        [data-theme="summer"] {
            --bg-primary: #1A1A2E;
            --bg-secondary: #16213E;
            --bg-card: #222845;
            --bg-input: #2A2F4E;
            --text-primary: #F0E6D2;
            --text-secondary: #C4A882;
            --border-color: #3A3F5E;
            --shadow-color: rgba(255, 165, 0, 0.15);
            --honey-yellow: #FF9F43;
            --honey-dark: #E68A30;
            --hive-orange: #FF6B35;
            --pollen-gold: #FFD700;
            --leaf-green: #27AE60;
            --sky-blue: #00CEC9;
            --flower-pink: #FD79A8;
        }

        /* Autumn Theme - Harvest Amber / Stardew Fall */
        [data-theme="autumn"] {
            --bg-primary: #1C1410;
            --bg-secondary: #2A1F17;
            --bg-card: #2E221A;
            --bg-input: #3A2E24;
            --text-primary: #F5E6D3;
            --text-secondary: #C4A882;
            --border-color: #4A3828;
            --shadow-color: rgba(200, 100, 0, 0.2);
            --honey-yellow: #E67E22;
            --honey-dark: #D35400;
            --hive-orange: #E74C3C;
            --pollen-gold: #F1C40F;
            --leaf-green: #6B8E23;
            --sky-blue: #CD853F;
            --flower-pink: #C0392B;
        }

        /* Winter Theme - Frost Colony / Stardew Winter */
        [data-theme="winter"] {
            --bg-primary: #0A0E1A;
            --bg-secondary: #0F1525;
            --bg-card: #141C2E;
            --bg-input: #1A2338;
            --text-primary: #E8EDF5;
            --text-secondary: #8899B0;
            --border-color: #253046;
            --shadow-color: rgba(100, 180, 255, 0.1);
            --honey-yellow: #5DADE2;
            --honey-dark: #3498DB;
            --hive-orange: #9B59B6;
            --pollen-gold: #AED6F1;
            --leaf-green: #1ABC9C;
            --sky-blue: #85C1E9;
            --flower-pink: #AF7AC5;
        }

        /* Rose Garden Theme - Bold & Beautiful */
        [data-theme="rose"] {
            --bg-primary: #1A0A14;
            --bg-secondary: #220E1A;
            --bg-card: #2A1222;
            --bg-input: #33162A;
            --text-primary: #F8E0F0;
            --text-secondary: #C990B0;
            --border-color: #4A1E3A;
            --shadow-color: rgba(255, 50, 130, 0.15);
            --honey-yellow: #FF1493;
            --honey-dark: #E00080;
            --hive-orange: #FF69B4;
            --pollen-gold: #FFB6C1;
            --leaf-green: #E875A8;
            --sky-blue: #DA70D6;
            --flower-pink: #FF1493;
        }

        /* Crimson Flame Theme - Deep Red Fire */
        [data-theme="crimson"] {
            --bg-primary: #1A0808;
            --bg-secondary: #221010;
            --bg-card: #2C1414;
            --bg-input: #361A1A;
            --text-primary: #F8E0E0;
            --text-secondary: #C99090;
            --border-color: #4A1E1E;
            --shadow-color: rgba(220, 20, 60, 0.15);
            --honey-yellow: #DC143C;
            --honey-dark: #B01030;
            --hive-orange: #FF4500;
            --pollen-gold: #FF6B6B;
            --leaf-green: #E85050;
            --sky-blue: #FF7F50;
            --flower-pink: #DC143C;
        }

        /* Emerald Grove Theme - Deep Forest Green */
        [data-theme="emerald"] {
            --bg-primary: #081A0A;
            --bg-secondary: #0E220F;
            --bg-card: #122A14;
            --bg-input: #16331A;
            --text-primary: #E0F8E4;
            --text-secondary: #90C998;
            --border-color: #1E4A24;
            --shadow-color: rgba(0, 200, 83, 0.15);
            --honey-yellow: #00C853;
            --honey-dark: #00A844;
            --hive-orange: #69F0AE;
            --pollen-gold: #A5D6A7;
            --leaf-green: #00E676;
            --sky-blue: #4DB6AC;
            --flower-pink: #00C853;
        }

        /* Golden Crown Theme - Royal Gold & Yellow */
        [data-theme="gold"] {
            --bg-primary: #1A1408;
            --bg-secondary: #221C0E;
            --bg-card: #2A2212;
            --bg-input: #332A16;
            --text-primary: #F8F0D8;
            --text-secondary: #C9B878;
            --border-color: #4A3E1E;
            --shadow-color: rgba(255, 215, 0, 0.15);
            --honey-yellow: #FFD700;
            --honey-dark: #FFC000;
            --hive-orange: #FFA000;
            --pollen-gold: #FFE082;
            --leaf-green: #FFCA28;
            --sky-blue: #FFB300;
            --flower-pink: #FFD700;
        }

        /* Violet Throne Theme - Royal Purple */
        [data-theme="violet"] {
            --bg-primary: #120A1A;
            --bg-secondary: #180E22;
            --bg-card: #1E122A;
            --bg-input: #261633;
            --text-primary: #F0E0F8;
            --text-secondary: #B890C9;
            --border-color: #361E4A;
            --shadow-color: rgba(156, 39, 176, 0.15);
            --honey-yellow: #CE93D8;
            --honey-dark: #AB47BC;
            --hive-orange: #BA68C8;
            --pollen-gold: #E1BEE7;
            --leaf-green: #9C27B0;
            --sky-blue: #7B1FA2;
            --flower-pink: #CE93D8;
        }

        /* Steel Fortress Theme - Sleek Grey */
        [data-theme="steel"] {
            --bg-primary: #121418;
            --bg-secondary: #181C22;
            --bg-card: #1E232A;
            --bg-input: #252B33;
            --text-primary: #E0E4E8;
            --text-secondary: #90A0B0;
            --border-color: #2E3842;
            --shadow-color: rgba(120, 144, 156, 0.15);
            --honey-yellow: #78909C;
            --honey-dark: #607D8B;
            --hive-orange: #90A4AE;
            --pollen-gold: #B0BEC5;
            --leaf-green: #80CBC4;
            --sky-blue: #81D4FA;
            --flower-pink: #78909C;
        }

        /* Ember Blaze Theme - Hot Orange */
        [data-theme="ember"] {
            --bg-primary: #1A100A;
            --bg-secondary: #22160E;
            --bg-card: #2A1C12;
            --bg-input: #332216;
            --text-primary: #F8ECE0;
            --text-secondary: #C9A880;
            --border-color: #4A321E;
            --shadow-color: rgba(255, 109, 0, 0.15);
            --honey-yellow: #FF6D00;
            --honey-dark: #E65100;
            --hive-orange: #FF9100;
            --pollen-gold: #FFAB40;
            --leaf-green: #FF8F00;
            --sky-blue: #FFB74D;
            --flower-pink: #FF6D00;
        }

        /* Cedar Lodge Theme - Rich Brown & Wood */
        [data-theme="cedar"] {
            --bg-primary: #14100C;
            --bg-secondary: #1C1610;
            --bg-card: #241C16;
            --bg-input: #2C221A;
            --text-primary: #F0E8E0;
            --text-secondary: #B89878;
            --border-color: #3E3028;
            --shadow-color: rgba(141, 110, 99, 0.15);
            --honey-yellow: #A1887F;
            --honey-dark: #8D6E63;
            --hive-orange: #BCAAA4;
            --pollen-gold: #D7CCC8;
            --leaf-green: #A1887F;
            --sky-blue: #BCAAA4;
            --flower-pink: #8D6E63;
        }

        /* Sapphire Depths Theme - Deep Ocean Blue */
        [data-theme="sapphire"] {
            --bg-primary: #080E1A;
            --bg-secondary: #0E1422;
            --bg-card: #121A2A;
            --bg-input: #162033;
            --text-primary: #E0ECF8;
            --text-secondary: #90B0D0;
            --border-color: #1E324A;
            --shadow-color: rgba(30, 136, 229, 0.15);
            --honey-yellow: #42A5F5;
            --honey-dark: #1E88E5;
            --hive-orange: #64B5F6;
            --pollen-gold: #90CAF9;
            --leaf-green: #29B6F6;
            --sky-blue: #0288D1;
            --flower-pink: #42A5F5;
        }

        /* Prismatic Hive Theme - All Colors Rainbow */
        [data-theme="rainbow"] {
            --bg-primary: #0E0A14;
            --bg-secondary: #140E1A;
            --bg-card: #1A1222;
            --bg-input: #20182A;
            --text-primary: #F0E8F8;
            --text-secondary: #B8A0C8;
            --border-color: #302444;
            --shadow-color: rgba(180, 100, 255, 0.12);
            --honey-yellow: #FF1493;
            --honey-dark: #E00080;
            --hive-orange: #FF6D00;
            --pollen-gold: #FFD700;
            --leaf-green: #00E676;
            --sky-blue: #42A5F5;
            --flower-pink: #CE93D8;
        }

        /* Prismatic Hive animated glow */
        [data-theme="rainbow"] .post-card,
        [data-theme="rainbow"] .nav-btn.active,
        [data-theme="rainbow"] .create-buzz-btn {
            border-image: linear-gradient(135deg, #FF1493, #FF4500, #FFD700, #00E676, #42A5F5, #CE93D8) 1;
        }
        [data-theme="rainbow"] .create-buzz-btn {
            background: linear-gradient(135deg, #FF1493, #FF4500, #FFD700, #00E676, #42A5F5, #CE93D8) !important;
            border: none !important;
            color: white !important;
        }

        /* Theme Picker Styles */
        .theme-picker-option {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 8px 10px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.15s;
        }
        .theme-picker-option:hover {
            background: var(--bg-input);
        }
        .theme-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .theme-picker-option .theme-check {
            margin-left: auto;
            color: var(--honey-yellow);
            display: none;
            font-size: 12px;
        }
        .theme-picker-option.active .theme-check {
            display: inline;
        }

        /* Smooth theme transition */
        [data-theme] {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        [data-theme] *, [data-theme] *::before, [data-theme] *::after {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Site Styles */
        [data-site-style="default"] {
            --site-bg: var(--bg-primary);
            --site-font: 'Inter', sans-serif;
            --site-radius: 15px;
        }

        [data-site-style="rounded"] {
            --site-radius: 25px;
        }

        [data-site-style="sharp"] {
            --site-radius: 5px;
        }

        [data-site-style="honeycomb"] {
            --site-bg: linear-gradient(45deg, var(--bg-primary), var(--bg-secondary));
        }

        /* ===== LOADING SPINNER STYLES ===== */
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 204, 0, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    flex-direction: column;
    backdrop-filter: blur(5px);
}

.hexagon-spinner {
    width: 60px;
    height: 60px;
    position: relative;
}

.hexagon-spinner:before,
.hexagon-spinner:after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    border: 4px solid #ff9900;
    border-radius: 8px;
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    animation: hex-spin 1.5s linear infinite;
}

.hexagon-spinner:after {
    border-color: #ffcc00;
    animation-delay: -0.75s;
}

@keyframes hex-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 20px;
    color: #8b4513;
    font-size: 16px;
    font-weight: bold;
    font-family: 'Arial', sans-serif;
}
        
        /* CSS Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--site-font, 'Inter'), sans-serif;
            background: var(--site-bg, var(--bg-primary));
            color: var(--text-primary);
            transition: all 0.3s ease;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--honey-yellow);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--honey-dark);
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }

        .rounded {
            border-radius: var(--site-radius);
        }

        .shadow {
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        /* Navigation */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-bottom: 2px solid var(--honey-yellow);
            z-index: 1000;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            cursor: pointer;
        }

        .logo-icon {
            font-size: 28px;
            color: var(--honey-yellow);
            animation: float 3s ease-in-out infinite;
        }

        .logo-text {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 24px;
            background: linear-gradient(45deg, var(--honey-yellow), var(--hive-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-search {
            flex: 1;
            max-width: 500px;
            margin: 0 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--honey-yellow);
            box-shadow: 0 0 0 2px rgba(255, 195, 11, 0.2);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s;
            position: relative;
        }

        .nav-btn:hover {
            background: var(--bg-secondary);
            color: var(--honey-yellow);
        }

        .badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--flower-pink);
            color: white;
            font-size: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-profile-btn, .profile-btn-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--honey-yellow);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .header-profile-btn:hover, .profile-btn-circle:hover {
            transform: scale(1.1);
        }

        .profile-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            max-width: 1600px;
            margin: 60px auto 0;
            padding: 20px 40px;
            gap: 20px;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            flex-shrink: 0;
            position: sticky;
            top: 80px;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .sidebar-section {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--honey-yellow);
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-details h3 {
            font-size: 16px;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .user-details h3:hover {
            color: var(--honey-yellow);
        }

        .user-details p {
            color: var(--text-secondary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .bee-role {
            background: var(--honey-yellow);
            color: var(--bee-black);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .honey-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(45deg, var(--honey-yellow), var(--pollen-gold));
            padding: 15px;
            border-radius: 10px;
            color: var(--bee-black);
            margin-bottom: 20px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .honey-display:hover {
            transform: translateY(-2px);
        }

        .honey-amount {
            font-size: 24px;
            font-weight: 700;
        }

        .honey-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .nav-menu {
            list-style: none;
            margin-bottom: 20px;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--bg-secondary);
            color: var(--honey-yellow);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        .create-post-btn {
            width: 100%;
            background: linear-gradient(45deg, var(--honey-yellow), var(--hive-orange));
            color: var(--bee-black);
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.3s;
        }

        .create-post-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 195, 11, 0.3);
        }

        /* Trends Section */
        .trends-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trend-list {
            list-style: none;
        }

        .trend-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
        }

        .trend-item:hover {
            background: var(--bg-secondary);
            padding-left: 10px;
            border-radius: 5px;
        }

        .trend-item:last-child {
            border-bottom: none;
        }

        .trend-category {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .trend-tag {
            font-weight: 600;
            color: var(--honey-yellow);
        }

        .trend-stats {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        /* Hive Communities */
        .hives-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hive-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hive-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .hive-card:hover {
            background: var(--bg-input);
            transform: translateX(5px);
        }

        .hive-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--honey-yellow), var(--hive-orange));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .hive-info h4 {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .hive-members {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            min-width: 0;
        }

        /* Feed content width control â€” readable width while sidebar stays right */
        .main-content .feed,
        .main-content .inline-compose,
        .main-content .create-post,
        .main-content .customization-panel {
            max-width: 680px;
        }

        /* Create Post */
        .create-post {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .post-input {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .user-avatar-small {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--honey-yellow);
            cursor: pointer;
        }

        .post-textarea {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            color: var(--text-primary);
            font-size: 16px;
            resize: none;
            min-height: 100px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .post-textarea:focus {
            outline: none;
            border-color: var(--honey-yellow);
            box-shadow: 0 0 0 2px rgba(255, 195, 11, 0.2);
        }

        .post-textarea::placeholder {
            color: var(--text-secondary);
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 14px;
        }

        .action-btn:hover {
            background: var(--bg-secondary);
            color: var(--honey-yellow);
        }

        .pollinate-btn {
            background: linear-gradient(45deg, var(--honey-yellow), var(--hive-orange));
            color: var(--bee-black);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.3s;
            font-size: 14px;
        }

        .pollinate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 195, 11, 0.3);
        }

        /* Posts Feed */
        .feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .post-card {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px var(--shadow-color);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .post-user {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--honey-yellow);
        }

        .user-name-role {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-role-badge {
            background: var(--honey-yellow);
            color: var(--bee-black);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .post-meta {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .post-options {
            position: relative;
        }

        .options-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .options-btn:hover {
            background: var(--bg-secondary);
            color: var(--honey-yellow);
        }

        .options-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 0;
            min-width: 150px;
            z-index: 100;
            box-shadow: 0 4px 20px var(--shadow-color);
            display: none;
        }

        .options-menu.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .option-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
        }

        .option-item:hover {
            background: var(--bg-secondary);
            color: var(--honey-yellow);
        }

        .post-content {
            margin-bottom: 15px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .post-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .post-tag {
            color: var(--honey-yellow);
            background: rgba(255, 195, 11, 0.1);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .post-tag:hover {
            background: rgba(255, 195, 11, 0.2);
            transform: translateY(-1px);
        }

        .post-media {
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            max-height: 500px;
        }

        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .post-image:hover {
            transform: scale(1.01);
        }

        .post-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .post-actions-bar {
            display: flex;
            justify-content: space-around;
            gap: 5px;
        }

        .post-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            flex: 1;
            justify-content: center;
        }

        .post-action-btn:hover {
            background: var(--bg-secondary);
            color: var(--honey-yellow);
        }

        .post-action-btn.liked {
            color: var(--flower-pink);
        }

        .post-action-btn.pollinated {
            color: var(--honey-yellow);
        }

        /* Comments Section */
        .comments-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            display: none;
        }

        .comments-section.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .comment {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            background: var(--bg-secondary);
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--honey-yellow);
        }

        .comment-content {
            flex: 1;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .comment-author {
            font-weight: 600;
            font-size: 14px;
        }

        .comment-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.5;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .comment-action {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: color 0.3s;
        }

        .comment-action:hover {
            color: var(--honey-yellow);
        }

        .add-comment {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .comment-input {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 10px 15px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--honey-yellow);
        }

        .comment-submit-btn {
            background: var(--honey-yellow);
            color: var(--bee-black);
            border: none;
            border-radius: 20px;
            padding: 0 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-family: inherit;
        }

        .comment-submit-btn:hover {
            background: var(--honey-dark);
            transform: translateY(-2px);
        }

        /* Right Sidebar */
        .right-sidebar {
            width: 300px;
            flex-shrink: 0;
            position: sticky;
            top: 80px;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }

        /* Who to Follow */
        .follow-section {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            color: var(--honey-yellow);
            transform: rotate(180deg);
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .user-to-follow {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .follow-user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .follow-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }

        .follow-details h4 {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .follow-details p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .follow-btn {
            background: var(--honey-yellow);
            color: var(--bee-black);
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .follow-btn:hover {
            background: var(--honey-dark);
            transform: translateY(-1px);
        }

        .follow-btn.following {
            background: var(--bg-input);
            color: var(--text-secondary);
        }

        /* Trending Pollinations */
        .trending-pollinations {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .pollination-chain {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pollination-chain:hover {
            background: var(--bg-input);
            transform: translateX(5px);
        }

        .chain-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .chain-icon {
            color: var(--honey-yellow);
            font-size: 20px;
        }

        .chain-title {
            font-weight: 600;
            font-size: 14px;
        }

        .chain-stats {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Hive Activity */
        .hive-activity {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--honey-yellow);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bee-black);
            font-size: 14px;
        }

        .activity-content {
            flex: 1;
            font-size: 14px;
        }

        .activity-content strong {
            color: var(--honey-yellow);
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        
        /* Profile Song Player */
        .profile-song-player {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        /* Profile Song Player - ONLY visible on profile page */
        .profile-song-player {
            display: none !important;
        }
        html[data-page="profile"] .profile-song-player {
            display: block !important;
        }



        .profile-song-player::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--honey-yellow), var(--hive-orange), var(--honey-yellow));
            background-size: 200% 100%;
            animation: playerGlow 3s ease infinite;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .profile-song-player.playing::before {
            opacity: 1;
        }

        @keyframes playerGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .player-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .player-title-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-icon {
            color: var(--honey-yellow);
            font-size: 16px;
        }

        .player-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .player-settings-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.3s;
            font-size: 12px;
        }

        .player-settings-btn:hover {
            color: var(--honey-yellow);
        }

        .player-song-info {
            margin-bottom: 12px;
        }

        .player-song-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-song-artist {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .player-play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--honey-yellow);
            color: var(--bee-black);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .player-play-btn:hover {
            background: var(--honey-dark);
            transform: scale(1.1);
        }

        .player-progress-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .player-progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-input);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .player-progress-bar:hover {
            height: 6px;
        }

        .player-progress-fill {
            height: 100%;
            background: var(--honey-yellow);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .player-progress-fill::after {
            content: '';
            position: absolute;
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--honey-yellow);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .player-progress-bar:hover .player-progress-fill::after {
            opacity: 1;
        }

        .player-time {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .player-bottom-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .player-volume-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .player-volume-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px;
            font-size: 12px;
            transition: color 0.3s;
        }

        .player-volume-btn:hover {
            color: var(--honey-yellow);
        }

        .player-volume-slider {
            width: 60px;
            height: 3px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-input);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .player-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--honey-yellow);
            cursor: pointer;
        }

        .player-volume-slider::-moz-range-thumb {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--honey-yellow);
            border: none;
            cursor: pointer;
        }

        .player-visualizer {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 16px;
        }

        .player-visualizer-bar {
            width: 3px;
            background: var(--honey-yellow);
            border-radius: 1px;
            transition: height 0.15s ease;
            opacity: 0.6;
        }

        .profile-song-player.playing .player-visualizer-bar {
            animation: visualizerBounce 0.8s ease infinite;
            opacity: 1;
        }

        .profile-song-player.playing .player-visualizer-bar:nth-child(1) { animation-delay: 0s; }
        .profile-song-player.playing .player-visualizer-bar:nth-child(2) { animation-delay: 0.1s; }
        .profile-song-player.playing .player-visualizer-bar:nth-child(3) { animation-delay: 0.2s; }
        .profile-song-player.playing .player-visualizer-bar:nth-child(4) { animation-delay: 0.15s; }
        .profile-song-player.playing .player-visualizer-bar:nth-child(5) { animation-delay: 0.25s; }

        @keyframes visualizerBounce {
            0%, 100% { height: 4px; }
            50% { height: 16px; }
        }

        /* No song state */
        .player-empty-state {
            text-align: center;
            padding: 10px 0;
        }

        .player-empty-icon {
            font-size: 24px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .player-empty-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .player-upload-btn {
            background: var(--bg-input);
            color: var(--honey-yellow);
            border: 1px dashed var(--honey-yellow);
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .player-upload-btn:hover {
            background: var(--honey-yellow);
            color: var(--bee-black);
            border-style: solid;
        }

        /* Song settings modal */
        .player-settings-dropdown {
            display: none;
            position: absolute;
            top: 40px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 8px 0;
            z-index: 100;
            min-width: 160px;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .player-settings-dropdown.show {
            display: block;
        }

        .player-settings-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            font-size: 13px;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        .player-settings-item:hover {
            background: var(--bg-input);
        }

        .player-settings-item i {
            width: 16px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .player-settings-item.danger {
            color: #ff4444;
        }

        .player-settings-item.danger i {
            color: #ff4444;
        }

        /* Rainbow theme special player styling */
        [data-theme="rainbow"] .profile-song-player::before {
            background: linear-gradient(90deg, #FF1493, #FF4500, #FFD700, #00E676, #42A5F5, #CE93D8);
            background-size: 200% 100%;
        }

        [data-theme="rainbow"] .player-play-btn {
            background: linear-gradient(135deg, #FF1493, #FF4500, #FFD700);
        }

        [data-theme="rainbow"] .player-progress-fill {
            background: linear-gradient(90deg, #FF1493, #FF4500, #FFD700, #00E676, #42A5F5);
        }

        [data-theme="rainbow"] .player-visualizer-bar {
            background: linear-gradient(to top, #FF1493, #42A5F5);
        }


        /* Auth Pages */
        .auth-container {
            display: flex;
            min-height: 100vh;
        }

        .auth-left {
            flex: 1;
            background: linear-gradient(45deg, var(--honey-yellow), var(--hive-orange));
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .auth-left::before {
            content: '';
            position: absolute;
            width: 300%;
            height: 300%;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.3;
            animation: spin 20s linear infinite;
        }

        .auth-left h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .auth-left p {
            font-size: 18px;
            text-align: center;
            max-width: 500px;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        .bee-animation {
            margin: 40px 0;
            font-size: 100px;
            animation: float 3s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }

        .auth-right {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--bg-primary);
        }

        .auth-card {
            width: 100%;
            max-width: 400px;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px var(--shadow-color);
        }

        .auth-card h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--honey-yellow);
        }

        .auth-card p {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            padding: 12px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--honey-yellow);
            box-shadow: 0 0 0 2px rgba(255, 195, 11, 0.2);
        }

        .auth-btn {
            background: linear-gradient(45deg, var(--honey-yellow), var(--hive-orange));
            color: var(--bee-black);
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            margin-top: 10px;
            font-family: inherit;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 195, 11, 0.3);
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            color: var(--text-secondary);
            position: relative;
            font-size: 14px;
        }

        .auth-divider:before,
        .auth-divider:after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: var(--border-color);
        }

        .auth-divider:before {
            left: 0;
        }

        .auth-divider:after {
            right: 0;
        }

        .social-auth {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            font-size: 14px;
        }

        .social-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--honey-yellow);
        }

        .auth-footer {
            text-align: center;
            margin-top: 30px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .auth-footer a {
            color: var(--honey-yellow);
            text-decoration: none;
            font-weight: 500;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
            border: 2px solid var(--honey-yellow);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            color: var(--honey-yellow);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--honey-yellow);
        }

        .modal-body {
            padding: 20px;
        }

        /* Profile Page */
        .profile-page {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }

        .profile-header {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .profile-banner {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: linear-gradient(45deg, var(--honey-yellow), var(--hive-orange));
            z-index: 1;
        }

        .profile-info {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: flex-end;
            gap: 30px;
            margin-top: 100px;
        }

        .profile-avatar-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid var(--bg-card);
            object-fit: cover;
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-avatar-large:hover {
            transform: scale(1.05);
            border-color: var(--honey-yellow);
        }

        .profile-details {
            flex: 1;
        }

        .profile-name {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        

        .profile-bio {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
            max-width: 600px;
        }

        .profile-stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
            cursor: pointer;
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: var(--honey-yellow);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .profile-btn {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .profile-btn.primary {
            background: var(--honey-yellow);
            color: var(--bee-black);
        }

        .profile-btn.secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        /* Profile Customization */
        .customization-panel {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .customization-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .customization-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .customization-tab.active {
            background: var(--honey-yellow);
            color: var(--bee-black);
        }

        .customization-tab:hover:not(.active) {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .customization-section {
            display: none;
        }

        .customization-section.active {
            display: block;
        }

        .color-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        .color-option.selected::after {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .color-option {
            position: relative;
        }
        .bg-type-btn.active {
            border-color: var(--honey-yellow) !important;
            background: var(--honey-yellow)22 !important;
            color: var(--honey-yellow) !important;
        }
        .grad-dir-btn.active {
            border-color: var(--honey-yellow) !important;
            background: var(--honey-yellow)22 !important;
            color: var(--honey-yellow) !important;
        }
        .pattern-option.active {
            border-color: var(--honey-yellow) !important;
            box-shadow: 0 0 8px rgba(255, 195, 11, 0.3);
        }
        .pattern-option:hover {
            border-color: var(--text-secondary) !important;
        }

        .css-editor {
            width: 100%;
            min-height: 200px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            color: var(--text-primary);
            font-family: 'Source Code Pro', monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .css-editor:focus {
            outline: none;
            border-color: var(--honey-yellow);
        }

        .preview-area {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            min-height: 100px;
            margin-bottom: 20px;
        }

        /* Music Player */
        .music-player {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--honey-yellow);
            border: none;
            color: var(--bee-black);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .play-btn:hover {
            transform: scale(1.1);
        }

        .song-info {
            flex: 1;
        }

        .song-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .song-artist {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-input);
            border-radius: 2px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress {
            height: 100%;
            background: var(--honey-yellow);
            width: 30%;
        }

        /* Bulletin Posts */
        .bulletin-section {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .bulletin-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .bulletin-form textarea:focus {
            outline: none;
            border-color: var(--honey-yellow);
        }

        .bulletin-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .bulletin-option {
            background: none;
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 15px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .bulletin-option:hover {
            border-color: var(--honey-yellow);
            color: var(--honey-yellow);
        }

        .bulletin-option.selected {
            background: var(--honey-yellow);
            color: var(--bee-black);
            border-color: var(--honey-yellow);
        }

        /* Top Friends */
        .friends-section {
            background: var(--bg-card);
            border-radius: var(--site-radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .friend-card {
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .friend-card:hover {
            transform: translateY(-5px);
        }

        .friend-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--border-color);
            margin-bottom: 5px;
            transition: all 0.3s;
        }

        .friend-card:hover .friend-avatar {
            border-color: var(--honey-yellow);
        }

        .friend-name {
            font-size: 12px;
            font-weight: 600;
        }

        /* Admin Panel - Full Dashboard */
        .admin-modal-fullscreen .modal-content {
            max-width: 95vw;
            width: 1200px;
            height: 85vh;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .admin-modal-fullscreen .modal-body {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 0;
        }
        .admin-sidebar {
            width: 220px;
            min-width: 220px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 12px 0;
            overflow-y: auto;
        }
        .admin-sidebar-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            text-align: left;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .admin-sidebar-btn:hover {
            background: var(--bg-input);
            color: var(--text-primary);
        }
        .admin-sidebar-btn.active {
            background: var(--bg-input);
            color: var(--flower-pink);
            border-left-color: var(--flower-pink);
            font-weight: 600;
        }
        .admin-sidebar-btn i {
            width: 20px;
            text-align: center;
            font-size: 15px;
        }
        .admin-main {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        .admin-section {
            display: none;
        }
        .admin-section.active {
            display: block;
        }
        .admin-section h3 {
            color: var(--flower-pink);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
        }
        .admin-stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .admin-stat-card {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }
        .admin-stat-card:hover {
            transform: translateY(-2px);
        }
        .admin-stat-card .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 12px;
        }
        .admin-stat-card .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .admin-stat-card .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .admin-stat-card .stat-change {
            font-size: 12px;
            margin-top: 6px;
        }
        .admin-stat-card .stat-change.positive { color: #4CAF50; }
        .admin-stat-card .stat-change.negative { color: #FF4444; }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .admin-table th {
            text-align: left;
            padding: 12px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }
        .admin-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .admin-table tr:hover td {
            background: var(--bg-input);
        }
        .admin-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .admin-badge.queen { background: rgba(255,195,11,0.2); color: #FFC30B; }
        .admin-badge.worker { background: rgba(100,200,100,0.2); color: #4CAF50; }
        .admin-badge.drone { background: rgba(100,150,255,0.2); color: #64B5F6; }
        .admin-badge.banned { background: rgba(255,68,68,0.2); color: #FF4444; }
        .admin-badge.active { background: rgba(76,175,80,0.2); color: #4CAF50; }
        .admin-badge.suspended { background: rgba(255,152,0,0.2); color: #FF9800; }
        .admin-action-btn {
            padding: 5px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }
        .admin-action-btn:hover {
            background: var(--bg-input);
            border-color: var(--flower-pink);
        }
        .admin-action-btn.danger {
            border-color: rgba(255,68,68,0.5);
            color: #FF4444;
        }
        .admin-action-btn.danger:hover {
            background: rgba(255,68,68,0.1);
        }
        .admin-action-btn.success {
            border-color: rgba(76,175,80,0.5);
            color: #4CAF50;
        }
        .admin-search {
            width: 100%;
            padding: 10px 14px 10px 38px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            margin-bottom: 16px;
        }
        .admin-search:focus {
            outline: none;
            border-color: var(--flower-pink);
        }
        .admin-search-wrapper {
            position: relative;
            margin-bottom: 16px;
        }
        .admin-search-wrapper i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
        }
        .admin-controls-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .admin-control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .admin-control-group label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }
        .admin-select, .admin-input {
            padding: 9px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
        }
        .admin-select:focus, .admin-input:focus {
            outline: none;
            border-color: var(--flower-pink);
        }
        .admin-toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            border-radius: 10px;
            background: var(--bg-input);
            margin-bottom: 10px;
        }
        .admin-toggle-row strong {
            font-size: 14px;
        }
        .admin-toggle-row span {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .admin-card {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }
        .admin-card h4 {
            margin-bottom: 12px;
            color: var(--flower-pink);
        }
        .admin-btn-row {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        .admin-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            font-size: 14px;
        }
        .admin-btn.primary {
            background: var(--flower-pink);
            color: white;
        }
        .admin-btn.secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        .admin-chart-placeholder {
            height: 200px;
            background: var(--bg-input);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        .admin-chart-bars {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            height: 120px;
            padding: 0 20px;
        }
        .admin-chart-bar {
            width: 30px;
            background: linear-gradient(to top, var(--flower-pink), rgba(255,105,180,0.3));
            border-radius: 4px 4px 0 0;
            transition: height 0.5s;
        }
        .admin-report-card {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #FF9800;
        }
        .admin-report-card.resolved {
            border-left-color: #4CAF50;
            opacity: 0.7;
        }
        .admin-log-entry {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }
        .admin-log-entry .log-time {
            color: var(--text-secondary);
            white-space: nowrap;
            font-size: 12px;
        }
        .admin-announcement-card {
            padding: 16px;
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        
        /* Admin Profile Viewer */
        .admin-profile-viewer {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .admin-profile-left {
            width: 280px;
            min-width: 280px;
        }
        .admin-profile-right {
            flex: 1;
        }
        .admin-profile-banner {
            width: 100%;
            height: 120px;
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, var(--flower-pink), var(--honey-yellow));
            position: relative;
            overflow: hidden;
        }
        .admin-profile-banner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .admin-profile-avatar-area {
            text-align: center;
            margin-top: -40px;
            position: relative;
            z-index: 2;
        }
        .admin-profile-avatar-area img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--bg-card);
            background: var(--bg-secondary);
        }
        .admin-profile-info {
            text-align: center;
            padding: 10px 16px 16px;
            background: var(--bg-input);
            border-radius: 0 0 12px 12px;
            border: 1px solid var(--border-color);
            border-top: none;
        }
        .admin-profile-info h4 {
            margin-bottom: 4px;
        }
        .admin-profile-info .username {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 8px;
        }
        .admin-profile-info .bio {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
            min-height: 40px;
        }
        .admin-reset-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            width: 100%;
            justify-content: center;
            margin-bottom: 6px;
        }
        .admin-reset-btn:hover {
            border-color: var(--flower-pink);
            background: var(--bg-input);
        }
        .admin-reset-btn.danger {
            border-color: rgba(255,68,68,0.4);
            color: #FF4444;
        }
        .admin-reset-btn.danger:hover {
            background: rgba(255,68,68,0.1);
        }
        .admin-honey-control {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        .admin-honey-control input[type="number"] {
            width: 100px;
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
        }
        .admin-warning-card {
            padding: 14px;
            background: rgba(255,152,0,0.08);
            border: 1px solid rgba(255,152,0,0.3);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .admin-warning-card.active {
            border-color: #FF4444;
            background: rgba(255,68,68,0.08);
        }
        .admin-notes-area {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            resize: vertical;
        }
        .admin-notes-area:focus {
            outline: none;
            border-color: var(--flower-pink);
        }
        .admin-note-entry {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }
        .admin-note-entry:last-child {
            border-bottom: none;
        }
        .admin-appeal-card {
            padding: 16px;
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #64B5F6;
        }
        .admin-appeal-card.pending {
            border-left-color: #FF9800;
        }
        .admin-appeal-card.approved {
            border-left-color: #4CAF50;
        }
        .admin-appeal-card.denied {
            border-left-color: #FF4444;
        }
        .admin-bulk-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: var(--flower-pink);
            color: white;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
        }
        .admin-bulk-bar button {
            padding: 5px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.4);
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }
        .admin-bulk-bar button:hover {
            background: rgba(255,255,255,0.3);
        }
        .admin-content-search-result {
            padding: 14px;
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        .admin-mod-log-entry {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            align-items: flex-start;
        }
        
        /* Online Status Indicator */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
            font-size: 12px;
            font-weight: 500;
            vertical-align: middle;
            position: relative;
            cursor: default;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }
        .status-dot.online {
            background: #39FF14;
            box-shadow: 0 0 8px #39FF14, 0 0 18px rgba(57,255,20,0.5), 0 0 30px rgba(57,255,20,0.2);
            animation: statusPulse 2s ease-in-out infinite;
        }
        .status-dot.busy {
            background: #FF9800;
            box-shadow: 0 0 6px #FF9800, 0 0 12px rgba(255,152,0,0.4);
            animation: statusGlow 3s ease-in-out infinite;
        }
        .status-dot.offline {
            background: #FF4444;
            box-shadow: 0 0 4px rgba(255,68,68,0.3);
        }
        .status-label {
            color: var(--text-secondary);
            font-size: 12px;
            white-space: nowrap;
        }
        .status-label.online { color: #39FF14; }
        .status-label.busy { color: #FF9800; }
        .status-label.offline { color: #FF4444; }

        @keyframes statusPulse {
            0%, 100% { transform: scale(1); opacity: 1; box-shadow: 0 0 8px #39FF14, 0 0 18px rgba(57,255,20,0.5); }
            50% { transform: scale(1.25); opacity: 0.85; box-shadow: 0 0 12px #39FF14, 0 0 28px rgba(57,255,20,0.6), 0 0 45px rgba(57,255,20,0.25); }
        }
        @keyframes statusGlow {
            0%, 100% { box-shadow: 0 0 6px #FF9800, 0 0 12px rgba(255,152,0,0.4); }
            50% { box-shadow: 0 0 8px #FF9800, 0 0 18px rgba(255,152,0,0.5); }
        }

        .status-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .status-indicator:hover .status-tooltip {
            opacity: 1;
        }

        .profile-username {
            color: var(--text-secondary);
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        /* Mini status dot for posts, comments, suggested users */
        .mini-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 4px;
            vertical-align: middle;
        }
        .mini-status-dot.online {
            background: #39FF14;
            box-shadow: 0 0 6px #39FF14, 0 0 14px rgba(57,255,20,0.4);
            animation: statusPulse 2s ease-in-out infinite;
        }
        .mini-status-dot.busy {
            background: #FF9800;
            box-shadow: 0 0 4px #FF9800;
            animation: statusGlow 3s ease-in-out infinite;
        }
        .mini-status-dot.offline {
            background: #FF4444;
        }

        @media (max-width: 768px) {
            .admin-modal-fullscreen .modal-content {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
            .admin-sidebar {
                width: 60px;
                min-width: 60px;
            }
            .admin-sidebar-btn span {
                display: none;
            }
            .admin-sidebar-btn {
                justify-content: center;
                padding: 12px;
            }
            .admin-stat-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .right-sidebar {
                display: none;
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                display: none;
            }
            
            .app-container {
                padding: 20px 10px;
            }
            
            .profile-info {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .friends-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .auth-container {
                flex-direction: column;
            }
            
            .auth-left {
                padding: 20px;
                min-height: 300px;
            }
            
            .auth-left h1 {
                font-size: 32px;
            }
            
            .bee-animation {
                font-size: 60px;
                margin: 20px 0;
            }
            
            .nav-search {
                display: none;
            }
            
            .post-actions-bar {
                flex-wrap: wrap;
            }
            
            .post-action-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        @media (max-width: 576px) {
            .navbar {
                padding: 0 10px;
            }
            
            .logo-text {
                font-size: 20px;
            }
            
            .app-container {
                margin-top: 60px;
                padding: 10px;
            }
            
            .create-post,
            .post-card {
                padding: 15px;
            }
            
            .modal-content {
                width: 95%;
                padding: 10px;
            }
            
            .friends-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Active states for interactions */
        .clicked {
            animation: clickEffect 0.3s ease;
        }

        @keyframes clickEffect {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--honey-yellow);
            color: var(--bee-black);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px var(--shadow-color);
            z-index: 3000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
            font-weight: 600;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--honey-yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
    
        /* File input hidden - triggered by button */
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        .file-input-wrapper .file-input,
        input.file-input[type="file"] {
            position: absolute;
            width: 0;
            height: 0;
            opacity: 0;
            overflow: hidden;
            pointer-events: none;
        }

        /* Inline compose area */
        .inline-compose {
            background: var(--bg-card);
            border-radius: var(--site-radius, 15px);
            padding: 15px;
            margin-bottom: 20px;
        }
        .inline-compose .compose-top {
            display: flex;
            gap: 12px;
        }
        .inline-compose .compose-textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            resize: none;
            font-size: 16px;
            font-family: inherit;
            min-height: 28px;
            max-height: 200px;
            outline: none;
            padding: 8px 0;
            line-height: 1.5;
        }
        .inline-compose .compose-textarea::placeholder {
            color: var(--text-secondary);
        }
        .inline-compose .compose-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            margin-top: 10px;
        }
        .inline-compose .compose-actions.hidden {
            display: none;
        }
        .inline-compose .compose-btns {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .inline-compose .compose-btns button {
            background: none;
            border: none;
            color: var(--honey-yellow);
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 50%;
            font-size: 15px;
            transition: background 0.2s;
        }
        .inline-compose .compose-btns button:hover {
            background: rgba(255, 195, 11, 0.15);
        }
        .inline-compose .compose-btns .gif-label {
            font-size: 12px;
            font-weight: 800;
            border: 1.5px solid var(--honey-yellow);
            border-radius: 4px;
            padding: 1px 5px;
            line-height: 1.3;
        }
        .inline-compose .compose-submit {
            background: var(--honey-yellow);
            color: #000;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: opacity 0.2s;
        }
        .inline-compose .compose-submit:hover {
            opacity: 0.9;
        }
        .inline-compose .compose-submit:disabled {
            opacity: 0.5;
            cursor: default;
        }
        .inline-compose .media-preview-inline {
            margin-top: 10px;
            display: none;
        }


        /* Compact icon-only compose buttons */
        .compose-icon-btn {
            padding: 8px 10px !important;
            min-width: unset !important;
            gap: 0 !important;
        }
        .compose-icon-btn span {
            display: none;
        }
        .compose-icon-btn i,
        .compose-icon-btn > span[style] {
            display: inline !important;
        }

        /* Hashtag highlight in rendered posts â€” yellow */
        .hashtag-link {
            color: var(--honey-yellow);
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }
        .hashtag-link:hover {
            text-decoration: underline;
        }


/* ContentEditable placeholder for all compose areas */
        [contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: var(--text-secondary);
            pointer-events: none;
            display: block;
        }


        /* ===== Animated Avatar Border System ===== */
        @keyframes avatar-rotate-border {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes avatar-pulse-glow {
            0%, 100% { box-shadow: 0 0 15px 3px var(--avatar-accent, var(--honey-yellow)), 0 0 30px 6px rgba(255,195,11,0.2); }
            50% { box-shadow: 0 0 25px 8px var(--avatar-accent, var(--honey-yellow)), 0 0 50px 15px rgba(255,195,11,0.3); }
        }
        @keyframes avatar-rainbow-rotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        .avatar-border-container {
            position: relative;
            display: inline-block;
            z-index: 5;
        }
        .avatar-border-container::before {
            content: '';
            position: absolute;
            inset: -6px;
            border-radius: 50%;
            z-index: 0;
            opacity: 0;
            transition: opacity 0.4s;
        }
        /* Style: Rotating Gradient */
        .avatar-border-container[data-border-style="rotating"]::before {
            opacity: 1;
            background: conic-gradient(
                var(--avatar-accent, var(--honey-yellow)),
                var(--avatar-accent2, var(--hive-orange)),
                var(--avatar-accent, var(--honey-yellow)),
                var(--avatar-accent2, var(--hive-orange)),
                var(--avatar-accent, var(--honey-yellow))
            );
            animation: avatar-rotate-border 3s linear infinite;
        }
        /* Style: Pulsing Glow */
        .avatar-border-container[data-border-style="pulse"] #profileAvatar {
            animation: avatar-pulse-glow 2s ease-in-out infinite;
        }
        /* Style: Static Ring */
        .avatar-border-container[data-border-style="static"]::before {
            opacity: 1;
            background: linear-gradient(135deg, var(--avatar-accent, var(--honey-yellow)), var(--avatar-accent2, var(--hive-orange)));
        }
        /* Style: Rainbow */
        .avatar-border-container[data-border-style="rainbow"]::before {
            opacity: 1;
            background: conic-gradient(#ff0000, #ff8800, #ffff00, #00ff00, #0088ff, #8800ff, #ff0000);
            animation: avatar-rotate-border 4s linear infinite;
        }
        /* Style: None */
        .avatar-border-container[data-border-style="none"]::before {
            opacity: 0;
        }
        .avatar-border-container img {
            position: relative;
            z-index: 1;
        }

        
        /* Style: Neon Pulse */
        @keyframes avatar-neon-pulse {
            0%, 100% { box-shadow: 0 0 8px 2px var(--avatar-accent, var(--honey-yellow)), 0 0 20px 4px var(--avatar-accent, var(--honey-yellow)), inset 0 0 8px 2px rgba(255,195,11,0.1); }
            50% { box-shadow: 0 0 20px 6px var(--avatar-accent, var(--honey-yellow)), 0 0 40px 12px var(--avatar-accent, var(--honey-yellow)), 0 0 60px 20px rgba(255,195,11,0.15), inset 0 0 12px 4px rgba(255,195,11,0.15); }
        }
        .avatar-border-container[data-border-style="neon"] #profileAvatar,
        .avatar-border-container[data-border-style="neon"] img {
            animation: avatar-neon-pulse 1.5s ease-in-out infinite;
        }
        /* Style: Double Ring */
        .avatar-border-container[data-border-style="double"]::before {
            opacity: 1;
            background: transparent;
            border: 3px solid var(--avatar-accent, var(--honey-yellow));
            inset: -10px;
        }
        .avatar-border-container[data-border-style="double"]::after {
            content: '';
            position: absolute;
            inset: -5px;
            border-radius: 50%;
            border: 2px solid var(--avatar-accent2, var(--hive-orange));
            z-index: 0;
        }
        /* Style: Dashed Spin */
        @keyframes avatar-dash-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .avatar-border-container[data-border-style="dashed"]::before {
            opacity: 1;
            background: transparent;
            border: 3px dashed var(--avatar-accent, var(--honey-yellow));
            animation: avatar-dash-spin 8s linear infinite;
        }
        /* Style: Fire Ring */
        @keyframes avatar-fire-glow {
            0%, 100% { box-shadow: 0 0 10px 3px #ff4500, 0 0 25px 5px #ff6600, 0 0 40px 8px rgba(255,69,0,0.3); }
            33% { box-shadow: 0 0 15px 5px #ff6600, 0 0 30px 8px #ff8800, 0 0 50px 12px rgba(255,102,0,0.4); }
            66% { box-shadow: 0 0 12px 4px #ffaa00, 0 0 28px 7px #ff6600, 0 0 45px 10px rgba(255,136,0,0.35); }
        }
        .avatar-border-container[data-border-style="fire"] #profileAvatar,
        .avatar-border-container[data-border-style="fire"] img {
            animation: avatar-fire-glow 1.2s ease-in-out infinite;
        }
        /* Style: Electric Bolt */
        @keyframes avatar-electric {
            0%, 90%, 100% { box-shadow: 0 0 5px 2px #00d4ff, 0 0 15px 4px rgba(0,212,255,0.3); }
            92% { box-shadow: 0 0 30px 10px #00ffff, 0 0 60px 20px rgba(0,255,255,0.5); }
            94% { box-shadow: 0 0 5px 2px #00d4ff, 0 0 15px 4px rgba(0,212,255,0.3); }
            96% { box-shadow: 0 0 25px 8px #44ffff, 0 0 50px 15px rgba(68,255,255,0.4); }
        }
        .avatar-border-container[data-border-style="electric"] #profileAvatar,
        .avatar-border-container[data-border-style="electric"] img {
            animation: avatar-electric 2s ease-in-out infinite;
        }
        /* Style: Shadow Orbit */
        @keyframes avatar-orbit {
            0% { box-shadow: 8px 0 12px -2px var(--avatar-accent, var(--honey-yellow)); }
            25% { box-shadow: 0 8px 12px -2px var(--avatar-accent2, var(--hive-orange)); }
            50% { box-shadow: -8px 0 12px -2px var(--avatar-accent, var(--honey-yellow)); }
            75% { box-shadow: 0 -8px 12px -2px var(--avatar-accent2, var(--hive-orange)); }
            100% { box-shadow: 8px 0 12px -2px var(--avatar-accent, var(--honey-yellow)); }
        }
        .avatar-border-container[data-border-style="orbit"] #profileAvatar,
        .avatar-border-container[data-border-style="orbit"] img {
            animation: avatar-orbit 3s linear infinite;
        }
        /* Style: Hexagon Frame */
        .avatar-border-container[data-border-style="hexagon"]::before {
            opacity: 1;
            border-radius: 0;
            clip-path: polygon(50% 0%, 93% 25%, 93% 75%, 50% 100%, 7% 75%, 7% 25%);
            background: linear-gradient(135deg, var(--avatar-accent, var(--honey-yellow)), var(--avatar-accent2, var(--hive-orange)));
            inset: -12px;
        }
        .avatar-border-container[data-border-style="hexagon"] img {
            clip-path: polygon(50% 2%, 91% 26%, 91% 74%, 50% 98%, 9% 74%, 9% 26%);
        }


        /* ===== Banner Border Effects ===== */
        .banner-border-wrapper {
            position: relative;
        }
        .banner-border-wrapper::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: calc(var(--site-radius, 15px) + 4px) calc(var(--site-radius, 15px) + 4px) 0 0;
            z-index: 0;
            opacity: 0;
            transition: opacity 0.4s;
            pointer-events: none;
        }
        .banner-border-wrapper > * {
            position: relative;
            z-index: 1;
        }
        /* Banner: Rotating Gradient */
        .banner-border-wrapper[data-banner-style="rotating"]::before {
            opacity: 1;
            background: conic-gradient(
                var(--banner-accent, var(--honey-yellow)),
                var(--banner-accent2, var(--hive-orange)),
                var(--banner-accent, var(--honey-yellow)),
                var(--banner-accent2, var(--hive-orange)),
                var(--banner-accent, var(--honey-yellow))
            );
            animation: avatar-rotate-border 4s linear infinite;
        }
        /* Banner: Pulsing Glow */
        @keyframes banner-pulse-glow {
            0%, 100% { box-shadow: 0 0 15px 3px var(--banner-accent, var(--honey-yellow)), 0 0 30px 6px rgba(255,195,11,0.15); }
            50% { box-shadow: 0 0 25px 8px var(--banner-accent, var(--honey-yellow)), 0 0 50px 15px rgba(255,195,11,0.25); }
        }
        .banner-border-wrapper[data-banner-style="pulse"] {
            animation: banner-pulse-glow 2.5s ease-in-out infinite;
        }
        /* Banner: Static Gradient Frame */
        .banner-border-wrapper[data-banner-style="static"]::before {
            opacity: 1;
            background: linear-gradient(135deg, var(--banner-accent, var(--honey-yellow)), var(--banner-accent2, var(--hive-orange)));
        }
        /* Banner: Rainbow */
        .banner-border-wrapper[data-banner-style="rainbow"]::before {
            opacity: 1;
            background: conic-gradient(#ff0000, #ff8800, #ffff00, #00ff00, #0088ff, #8800ff, #ff0000);
            animation: avatar-rotate-border 5s linear infinite;
        }
        /* Banner: Neon Glow */
        @keyframes banner-neon {
            0%, 100% { box-shadow: 0 0 10px 2px var(--banner-accent, var(--honey-yellow)), 0 0 25px 5px var(--banner-accent, var(--honey-yellow)); }
            50% { box-shadow: 0 0 20px 6px var(--banner-accent, var(--honey-yellow)), 0 0 40px 12px var(--banner-accent, var(--honey-yellow)), 0 0 60px 18px rgba(255,195,11,0.15); }
        }
        .banner-border-wrapper[data-banner-style="neon"] {
            animation: banner-neon 2s ease-in-out infinite;
        }
        /* Banner: Fire Frame */
        @keyframes banner-fire {
            0%, 100% { box-shadow: 0 -3px 12px 2px #ff4500, 0 -6px 25px 4px #ff6600, 0 -10px 40px 6px rgba(255,69,0,0.25); }
            33% { box-shadow: 0 -4px 15px 3px #ff6600, 0 -8px 30px 6px #ff8800, 0 -12px 50px 8px rgba(255,102,0,0.3); }
            66% { box-shadow: 0 -3px 13px 3px #ffaa00, 0 -7px 28px 5px #ff6600, 0 -11px 45px 7px rgba(255,136,0,0.28); }
        }
        .banner-border-wrapper[data-banner-style="fire"] {
            animation: banner-fire 1.5s ease-in-out infinite;
        }
        /* Banner: Electric */
        @keyframes banner-electric {
            0%, 88%, 100% { box-shadow: 0 0 5px 1px #00d4ff, 0 0 15px 3px rgba(0,212,255,0.2); }
            90% { box-shadow: 0 0 25px 8px #00ffff, 0 0 50px 15px rgba(0,255,255,0.4); }
            93% { box-shadow: 0 0 5px 1px #00d4ff, 0 0 15px 3px rgba(0,212,255,0.2); }
            95% { box-shadow: 0 0 20px 6px #44ffff, 0 0 40px 12px rgba(68,255,255,0.35); }
        }
        .banner-border-wrapper[data-banner-style="electric"] {
            animation: banner-electric 2.5s ease-in-out infinite;
        }
        /* Banner: Double Border */
        .banner-border-wrapper[data-banner-style="double"]::before {
            opacity: 1;
            background: transparent;
            border: 3px solid var(--banner-accent, var(--honey-yellow));
            inset: -8px;
        }
        .banner-border-wrapper[data-banner-style="double"]::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: calc(var(--site-radius, 15px) + 4px) calc(var(--site-radius, 15px) + 4px) 0 0;
            border: 2px solid var(--banner-accent2, var(--hive-orange));
            z-index: 0;
            pointer-events: none;
        }
        /* Banner: Shadow Orbit */
        @keyframes banner-orbit {
            0% { box-shadow: 6px 0 15px -3px var(--banner-accent, var(--honey-yellow)), -6px 0 15px -3px transparent; }
            25% { box-shadow: 0 6px 15px -3px var(--banner-accent2, var(--hive-orange)), 0 -6px 15px -3px transparent; }
            50% { box-shadow: -6px 0 15px -3px var(--banner-accent, var(--honey-yellow)), 6px 0 15px -3px transparent; }
            75% { box-shadow: 0 -6px 15px -3px var(--banner-accent2, var(--hive-orange)), 0 6px 15px -3px transparent; }
            100% { box-shadow: 6px 0 15px -3px var(--banner-accent, var(--honey-yellow)), -6px 0 15px -3px transparent; }
        }
        .banner-border-wrapper[data-banner-style="orbit"] {
            animation: banner-orbit 4s linear infinite;
        }
        /* Banner: None */
        .banner-border-wrapper[data-banner-style="none"]::before {
            opacity: 0;
        }

        /* ===== Profile Mood/Status ===== */
        .profile-mood-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.2s;
            max-width: 300px;
        }
        .profile-mood-status:hover {
            border-color: var(--honey-yellow);
            color: var(--text-primary);
        }
        .profile-mood-status .mood-emoji {
            font-size: 16px;
        }
        .profile-mood-status .mood-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .mood-editor-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mood-editor-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            width: 380px;
            max-width: 90vw;
            border: 1px solid var(--border-color);
        }

        /* ===== Pinned Post ===== */
        .pinned-post-container {
            position: relative;
            border: 1px solid var(--honey-yellow);
            border-radius: var(--site-radius, 15px);
            overflow: hidden;
        }
        .pinned-post-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--honey-yellow), var(--hive-orange));
        }
        .pinned-post-label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }
        .pinned-post-label i {
            color: var(--honey-yellow);
        }



/* =============================================
   DIRECT MESSAGES SYSTEM - CSS
   ============================================= */

/* DM Container Layout */
.dm-container {
    max-width: 700px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 120px);
}

/* Conversation List */
.dm-list-container {
    max-width: 700px;
    margin: 0 auto;
}

.dm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.dm-header h3 {
    color: var(--honey-yellow);
    margin: 0;
    font-size: 1.3em;
}

.dm-new-btn {
    background: var(--honey-yellow);
    color: #000;
    border: none;
    padding: 8px 18px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    font-size: 13px;
    transition: all 0.2s;
}
.dm-new-btn:hover { opacity: 0.85; transform: scale(1.03); }

/* DM Tabs */
.dm-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
}
.dm-tab {
    flex: 1;
    padding: 10px 0;
    border: none;
    background: none;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}
.dm-tab.active {
    color: var(--honey-yellow);
}
.dm-tab.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 20%;
    right: 20%;
    height: 3px;
    background: var(--honey-yellow);
    border-radius: 3px 3px 0 0;
}
.dm-tab .tab-badge {
    background: var(--honey-yellow);
    color: #000;
    font-size: 10px;
    font-weight: bold;
    padding: 1px 6px;
    border-radius: 10px;
    margin-left: 5px;
}

/* DM Search */
.dm-search {
    position: relative;
    margin-bottom: 12px;
}
.dm-search input {
    width: 100%;
    padding: 10px 15px 10px 38px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    background: var(--bg-input);
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
}
.dm-search input:focus { border-color: var(--honey-yellow); }
.dm-search i {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 13px;
}

/* Conversation Card */
.dm-conv-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 15px;
    cursor: pointer;
    transition: background 0.2s;
    border-radius: 0;
    position: relative;
}
.dm-conv-card:hover { background: var(--bg-input); }
.dm-conv-card.unread { border-left: 3px solid var(--honey-yellow); }
.dm-conv-card.pinned { background: rgba(255,195,11,0.04); }

.dm-conv-avatar-wrap {
    position: relative;
    flex-shrink: 0;
}
.dm-conv-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}
.dm-conv-status {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid var(--bg-primary);
}
.dm-conv-status.online { background: #39FF14; box-shadow: 0 0 6px #39FF14; }
.dm-conv-status.away { background: #FF9800; }
.dm-conv-status.offline { background: #666; }

.dm-conv-body {
    flex: 1;
    min-width: 0;
}
.dm-conv-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3px;
}
.dm-conv-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
}
.dm-conv-time {
    font-size: 12px;
    color: var(--text-secondary);
    flex-shrink: 0;
}
.dm-conv-preview {
    color: var(--text-secondary);
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.dm-conv-card.unread .dm-conv-preview {
    color: var(--text-primary);
    font-weight: 500;
}
.dm-conv-unread-badge {
    background: var(--honey-yellow);
    color: #000;
    font-size: 10px;
    font-weight: bold;
    min-width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.dm-conv-icons {
    display: flex;
    gap: 2px;
    align-items: center;
    margin-right: 4px;
}
.dm-conv-pin {
    color: var(--honey-yellow);
    font-size: 11px;
}
.dm-conv-mute {
    color: var(--text-secondary);
    font-size: 11px;
}

/* Context Menu */
.dm-context-menu {
    position: fixed;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 6px 0;
    min-width: 180px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    z-index: 9999;
    display: none;
}
.dm-context-menu.show { display: block; }
.dm-context-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    cursor: pointer;
    font-size: 14px;
    color: var(--text-primary);
    transition: background 0.15s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}
.dm-context-item:hover { background: var(--bg-input); }
.dm-context-item i { width: 16px; text-align: center; color: var(--text-secondary); }
.dm-context-item.danger { color: #FF4444; }
.dm-context-item.danger i { color: #FF4444; }

/* Empty State */
.dm-empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}
.dm-empty i {
    font-size: 48px;
    color: var(--honey-yellow);
    opacity: 0.4;
    margin-bottom: 16px;
}
.dm-empty h4 {
    color: var(--text-primary);
    margin-bottom: 8px;
    font-size: 18px;
}
.dm-empty p { font-size: 14px; }

/* =============================================
   CHAT VIEW
   ============================================= */
.dm-chat-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}
.dm-back-btn {
    background: none;
    border: none;
    color: var(--text-primary);
    cursor: pointer;
    font-size: 1.2em;
    padding: 4px;
    transition: color 0.2s;
}
.dm-back-btn:hover { color: var(--honey-yellow); }

.dm-chat-user-info {
    flex: 1;
    cursor: pointer;
}
.dm-chat-user-info strong {
    font-size: 15px;
}
.dm-chat-user-status {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 5px;
}
.dm-chat-user-status .online-dot {
    width: 7px; height: 7px; border-radius: 50%; display: inline-block;
}
.dm-chat-user-status .online-dot.online { background: #39FF14; box-shadow: 0 0 4px #39FF14; }
.dm-chat-user-status .online-dot.away { background: #FF9800; }
.dm-chat-user-status .online-dot.offline { background: #666; }

.dm-chat-header-actions {
    display: flex;
    gap: 4px;
}
.dm-chat-header-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.1em;
    padding: 6px 8px;
    border-radius: 50%;
    transition: all 0.2s;
}
.dm-chat-header-btn:hover {
    color: var(--honey-yellow);
    background: var(--bg-input);
}

/* Messages Area */
.dm-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 2px;
    position: relative;
    scroll-behavior: smooth;
}

/* Date Separator */
.dm-date-sep {
    text-align: center;
    margin: 16px 0;
    position: relative;
}
.dm-date-sep span {
    background: var(--bg-primary);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 2px 12px;
    position: relative;
    z-index: 1;
}
.dm-date-sep::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: var(--border-color);
}

/* Message Bubble */
.dm-msg-row {
    display: flex;
    max-width: 75%;
    position: relative;
}
.dm-msg-row.sent {
    align-self: flex-end;
}
.dm-msg-row.received {
    align-self: flex-start;
}
.dm-msg-row.grouped { margin-top: -6px; }

.dm-msg-bubble {
    padding: 10px 14px;
    border-radius: 18px;
    line-height: 1.45;
    position: relative;
    word-wrap: break-word;
    max-width: 100%;
}
.dm-msg-row.sent .dm-msg-bubble {
    background: var(--honey-yellow);
    color: #000;
    border-bottom-right-radius: 6px;
}
.dm-msg-row.sent.grouped .dm-msg-bubble {
    border-top-right-radius: 6px;
}
.dm-msg-row.received .dm-msg-bubble {
    background: var(--bg-input);
    color: var(--text-primary);
    border-bottom-left-radius: 6px;
}
.dm-msg-row.received.grouped .dm-msg-bubble {
    border-top-left-radius: 6px;
}

/* Reply quote */
.dm-msg-reply-quote {
    padding: 6px 10px;
    margin-bottom: 6px;
    border-left: 3px solid var(--honey-yellow);
    border-radius: 4px;
    font-size: 12px;
    opacity: 0.8;
    cursor: pointer;
}
.dm-msg-row.sent .dm-msg-reply-quote { background: rgba(0,0,0,0.1); }
.dm-msg-row.received .dm-msg-reply-quote { background: rgba(255,255,255,0.05); }

/* Message image */
.dm-msg-image {
    max-width: 260px;
    max-height: 300px;
    border-radius: 12px;
    margin-bottom: 4px;
    cursor: pointer;
    display: block;
}

/* Message meta (time + checks) */
.dm-msg-meta {
    font-size: 11px;
    margin-top: 3px;
    display: flex;
    align-items: center;
    gap: 4px;
    justify-content: flex-end;
    opacity: 0.6;
}
.dm-msg-row.sent .dm-msg-meta { color: #000; }
.dm-msg-row.received .dm-msg-meta { color: var(--text-secondary); }

/* Read receipts */
.dm-check { font-size: 12px; }
.dm-check.sent { color: rgba(0,0,0,0.5); }
.dm-check.delivered { color: rgba(0,0,0,0.5); }
.dm-check.read { color: #2196F3; }

/* Message hover actions */
.dm-msg-actions {
    position: absolute;
    top: -8px;
    display: none;
    gap: 2px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 2px 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.dm-msg-row.sent .dm-msg-actions { right: 0; }
.dm-msg-row.received .dm-msg-actions { left: 0; }
.dm-msg-row:hover .dm-msg-actions { display: flex; }

.dm-msg-action-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 13px;
    padding: 4px 6px;
    border-radius: 50%;
    transition: all 0.15s;
}
.dm-msg-action-btn:hover {
    color: var(--honey-yellow);
    background: var(--bg-input);
}

/* Message reactions */
.dm-msg-reactions {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 4px;
}
.dm-msg-reaction {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2px 6px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 3px;
}
.dm-msg-reaction:hover { border-color: var(--honey-yellow); }
.dm-msg-reaction .count { font-size: 11px; color: var(--text-secondary); }

/* Deleted message */
.dm-msg-deleted {
    font-style: italic;
    opacity: 0.5;
}

/* Edited indicator */
.dm-msg-edited {
    font-size: 11px;
    opacity: 0.5;
    margin-left: 4px;
}

/* Typing indicator */
.dm-typing-indicator {
    display: none;
    align-self: flex-start;
    padding: 10px 14px;
    background: var(--bg-input);
    border-radius: 18px 18px 18px 6px;
    margin-top: 4px;
}
.dm-typing-indicator.show { display: flex; }
.dm-typing-dots {
    display: flex;
    gap: 3px;
    align-items: center;
}
.dm-typing-dots span {
    width: 7px;
    height: 7px;
    background: var(--text-secondary);
    border-radius: 50%;
    animation: dmTypingBounce 1.2s ease-in-out infinite;
}
.dm-typing-dots span:nth-child(2) { animation-delay: 0.15s; }
.dm-typing-dots span:nth-child(3) { animation-delay: 0.3s; }
@keyframes dmTypingBounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-5px); opacity: 1; }
}

/* Scroll to bottom FAB */
.dm-scroll-bottom {
    position: absolute;
    bottom: 80px;
    right: 20px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    z-index: 10;
    transition: all 0.2s;
}
.dm-scroll-bottom.show { display: flex; }
.dm-scroll-bottom:hover { background: var(--honey-yellow); color: #000; }

/* Input Area */
.dm-input-area {
    padding: 10px 12px;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

/* Reply preview bar */
.dm-reply-bar {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--bg-input);
    border-radius: 10px 10px 0 0;
    border-left: 3px solid var(--honey-yellow);
    margin-bottom: -2px;
    font-size: 13px;
}
.dm-reply-bar.show { display: flex; }
.dm-reply-bar .reply-text {
    flex: 1;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.dm-reply-bar .reply-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
    padding: 2px;
}

/* Edit bar */
.dm-edit-bar {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--bg-input);
    border-radius: 10px 10px 0 0;
    border-left: 3px solid #2196F3;
    margin-bottom: -2px;
    font-size: 13px;
}
.dm-edit-bar.show { display: flex; }
.dm-edit-bar .edit-label {
    color: #2196F3;
    font-weight: 600;
}
.dm-edit-bar .edit-text {
    flex: 1;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.dm-edit-bar .edit-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
    padding: 2px;
}

.dm-input-row {
    display: flex;
    gap: 8px;
    align-items: flex-end;
}
.dm-attach-btns {
    display: flex;
    gap: 4px;
    align-items: center;
    padding-bottom: 6px;
}
.dm-attach-btn {
    background: none;
    border: none;
    color: var(--honey-yellow);
    cursor: pointer;
    font-size: 1.1em;
    padding: 4px;
    transition: opacity 0.2s;
}
.dm-attach-btn:hover { opacity: 0.7; }

.dm-text-input {
    flex: 1;
    padding: 10px 15px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    background: var(--bg-input);
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    max-height: 120px;
    resize: none;
    font-family: inherit;
    transition: border-color 0.2s;
}
.dm-text-input:focus { border-color: var(--honey-yellow); }

.dm-send-btn {
    background: var(--honey-yellow);
    color: #000;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
}
.dm-send-btn:hover { opacity: 0.85; transform: scale(1.05); }
.dm-send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

/* DM Image preview */
.dm-image-preview {
    display: none;
    padding: 8px 12px;
    position: relative;
}
.dm-image-preview.show { display: block; }
.dm-image-preview img {
    max-height: 100px;
    border-radius: 10px;
}
.dm-image-preview .remove-btn {
    position: absolute;
    top: 4px;
    right: 8px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    border: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* New DM Modal */
.dm-new-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 9998;
    display: none;
    align-items: flex-start;
    justify-content: center;
    padding-top: 12vh;
}
.dm-new-modal-overlay.show { display: flex; }
.dm-new-modal {
    background: var(--bg-card);
    border-radius: 16px;
    width: 420px;
    max-width: 90vw;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 12px 40px rgba(0,0,0,0.4);
}
.dm-new-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
}
.dm-new-modal-header h4 { margin: 0; font-size: 16px; }
.dm-new-modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.2em;
}
.dm-new-modal-search {
    padding: 12px 20px;
}
.dm-new-modal-search input {
    width: 100%;
    padding: 10px 14px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    background: var(--bg-input);
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    box-sizing: border-box;
}
.dm-new-modal-search input:focus { border-color: var(--honey-yellow); }

.dm-new-modal-list {
    flex: 1;
    overflow-y: auto;
    padding: 0 8px 8px;
}
.dm-new-user-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    cursor: pointer;
    border-radius: 10px;
    transition: background 0.15s;
}
.dm-new-user-item:hover { background: var(--bg-input); }
.dm-new-user-item img {
    width: 42px;
    height: 42px;
    border-radius: 50%;
}
.dm-new-user-item .user-name { font-weight: 600; font-size: 14px; }
.dm-new-user-item .user-handle { color: var(--text-secondary); font-size: 13px; }

/* Conversation Info Panel */
.dm-info-panel {
    position: fixed;
    top: 0;
    right: -380px;
    width: 380px;
    max-width: 90vw;
    height: 100vh;
    background: var(--bg-card);
    border-left: 1px solid var(--border-color);
    z-index: 9997;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
    box-shadow: -4px 0 20px rgba(0,0,0,0.2);
}
.dm-info-panel.show { right: 0; }
.dm-info-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
}
.dm-info-panel-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.2em;
}
.dm-info-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}
.dm-info-user {
    text-align: center;
    margin-bottom: 24px;
}
.dm-info-user img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin-bottom: 10px;
}
.dm-info-section {
    margin-bottom: 20px;
}
.dm-info-section h5 {
    color: var(--text-secondary);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
}
.dm-info-media-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
}
.dm-info-media-grid img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer;
}
.dm-info-action {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 14px;
    transition: color 0.2s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}
.dm-info-action:hover { color: var(--honey-yellow); }
.dm-info-action i { width: 20px; text-align: center; }
.dm-info-action.danger { color: #FF4444; }
.dm-info-action.danger:hover { color: #FF6666; }

/* Quick emoji reaction picker */
.dm-reaction-picker {
    position: absolute;
    display: none;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 4px 6px;
    gap: 2px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
}
.dm-reaction-picker.show { display: flex; }
.dm-reaction-option {
    font-size: 18px;
    cursor: pointer;
    padding: 3px 5px;
    border-radius: 8px;
    transition: all 0.15s;
    border: none;
    background: none;
}
.dm-reaction-option:hover { background: var(--bg-input); transform: scale(1.2); }

/* In-conversation search */
.dm-search-bar {
    display: none;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-color);
    gap: 8px;
    align-items: center;
}
.dm-search-bar.show { display: flex; }
.dm-search-bar input {
    flex: 1;
    padding: 8px 12px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    background: var(--bg-input);
    color: var(--text-primary);
    font-size: 13px;
    outline: none;
}
.dm-search-bar .search-nav {
    display: flex;
    align-items: center;
    gap: 4px;
    color: var(--text-secondary);
    font-size: 12px;
}
.dm-search-bar .search-nav button {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px;
}
.dm-search-bar .search-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
}

.dm-msg-highlight {
    background: rgba(255,195,11,0.25) !important;
    transition: background 0.5s;
}

</style>
</head>
<body>
    <!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none;">
    <div class="hexagon-spinner"></div>
    <div class="loading-text">Connecting to Hive...</div>
</div>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-left">
            <div class="bee-animation">ðŸ</div>
            <h1>Welcome to Polleneer</h1>
            <p>Where ideas take flight! Join our hive and connect with friends, share thoughts, and customize your space like never before.</p>
            <div style="margin-top: 40px; font-size: 14px; opacity: 0.8;">
                <p>"The world is buzzing with possibilities. Let's make some honey together!"</p>
            </div>
        </div>
        <div class="auth-right">
            <div class="auth-card">
                <h2>Enter the Hive</h2>
                <p>Sign in to start connecting</p>
                
                <form class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label for="email">Email or Username</label>
                        <input type="text" id="email" class="form-control" placeholder="you@example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
                    </div>
                    
                    <div style="text-align: right; margin-bottom: 10px;">
                        <a href="#" id="forgotPassword" style="color: var(--honey-yellow); font-size: 14px; text-decoration: none;">Forgot password?</a>
                    </div>
                    
                    <button type="submit" class="auth-btn">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </form>
                
                <div class="auth-divider">or continue with</div>
                
                <div class="social-auth">
                    <button class="social-btn" id="googleLogin">
                        <i class="fab fa-google" style="color: #DB4437;"></i>
                        Continue with Google
                    </button>
                    <button class="social-btn" id="githubLogin">
                        <i class="fab fa-github"></i>
                        Continue with GitHub
                    </button>
                </div>
                
                <div class="auth-footer">
                    New to the hive? <a href="#" id="showRegister">Create an account</a>
                </div>
            </div>
            
            <!-- Register Form -->
            <div class="auth-card hidden" id="registerCard">
                <h2>Join the Hive</h2>
                <p>Create your account to start your journey</p>
                
                <form class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label for="regUsername">Username</label>
                        <input type="text" id="regUsername" class="form-control" placeholder="Choose a username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" class="form-control" placeholder="you@example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regPassword">Password</label>
                        <input type="password" id="regPassword" class="form-control" placeholder="Create a strong password" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regConfirmPassword">Confirm Password</label>
                        <input type="password" id="regConfirmPassword" class="form-control" placeholder="Confirm your password" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regBeeRole">Choose Your Bee Role</label>
                        <select id="regBeeRole" class="form-control" required>
                            <option value="">Select your role</option>
                            <option value="queen">Queen Bee (Leader)</option>
                            <option value="worker">Worker Bee (Contributor)</option>
                            <option value="drone">Drone (Explorer)</option>
                            <option value="honeybee">Honey Bee (Creator)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="auth-btn">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </form>
                
                <div class="auth-footer">
                    Already have an account? <a href="#" id="showLogin">Sign in</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appScreen" class="hidden">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="logo" onclick="goToHome()">
                <div class="logo-icon">ðŸ</div>
                <div class="logo-text">Polleneer</div>
            </div>
            
            <div class="nav-search">
                <input type="text" class="search-input" placeholder="Search Polleneer..." id="searchInput">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div class="nav-actions">
                <div style="position: relative; display: inline-block;">
                    <button class="nav-btn" id="themeToggle" title="Change theme" onclick="toggleThemePicker()">
                        <i class="fas fa-palette"></i>
                    </button>
                    <div id="themePickerDropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; z-index: 9999; min-width: 200px; box-shadow: 0 8px 24px var(--shadow-color);">
                        <div style="padding: 6px 10px; font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Theme</div>
                        <button class="theme-picker-option" onclick="setTheme('dark')" data-theme-option="dark">
                            <span class="theme-dot" style="background: #0F0F0F; border: 2px solid #333;"></span>
                            <span>Night Hive</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('light')" data-theme-option="light">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #F5E6B8, #D49B00); border: 2px solid #DEBB6E;"></span>
                            <span>Sunlit Meadow</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <div style="height: 1px; background: var(--border-color); margin: 4px 8px;"></div>
                        <div style="padding: 6px 10px; font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Seasonal</div>
                        <button class="theme-picker-option" onclick="setTheme('spring')" data-theme-option="spring">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #FFB7C5, #98FB98);"></span>
                            <span>Blossom Fields</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('summer')" data-theme-option="summer">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #FF9F43, #00CEC9);"></span>
                            <span>Honey Coast</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('autumn')" data-theme-option="autumn">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #E67E22, #C0392B);"></span>
                            <span>Amber Harvest</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('winter')" data-theme-option="winter">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #5DADE2, #9B59B6);"></span>
                            <span>Frost Colony</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <div style="height: 1px; background: var(--border-color); margin: 4px 8px;"></div>
                        <div style="padding: 6px 10px; font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Special</div>
                        <button class="theme-picker-option" onclick="setTheme('rose')" data-theme-option="rose">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #FF1493, #DA70D6);"></span>
                            <span>Rose Garden</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('crimson')" data-theme-option="crimson">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #DC143C, #FF4500);"></span>
                            <span>Crimson Flame</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('emerald')" data-theme-option="emerald">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #00C853, #1B5E20);"></span>
                            <span>Emerald Grove</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('gold')" data-theme-option="gold">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #FFD700, #FFA000);"></span>
                            <span>Golden Crown</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('violet')" data-theme-option="violet">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #9C27B0, #6A1B9A);"></span>
                            <span>Violet Throne</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('steel')" data-theme-option="steel">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #78909C, #37474F);"></span>
                            <span>Steel Fortress</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('ember')" data-theme-option="ember">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #FF6D00, #E65100);"></span>
                            <span>Ember Blaze</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('cedar')" data-theme-option="cedar">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #8D6E63, #4E342E);"></span>
                            <span>Cedar Lodge</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('sapphire')" data-theme-option="sapphire">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #1E88E5, #0D47A1);"></span>
                            <span>Sapphire Depths</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                        <button class="theme-picker-option" onclick="setTheme('rainbow')" data-theme-option="rainbow">
                            <span class="theme-dot" style="background: linear-gradient(135deg, #FF1493, #FF4500, #FFD700, #00E676, #42A5F5, #CE93D8);"></span>
                            <span>Prismatic Hive</span>
                            <i class="fas fa-check theme-check"></i>
                        </button>
                    </div>
                </div>
                
                <button class="nav-btn" id="notificationsBtn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notificationBadge">3</span>
                </button>
                
                <button class="nav-btn" id="messagesBtn" title="Messages">
                    <i class="fas fa-envelope"></i>
                    <span class="badge" id="messageBadge">2</span>
                </button>
                
                <button class="nav-btn" id="createPostBtn" title="Create post">
                    <i class="fas fa-feather-alt"></i>
                </button>
                
                <button class="nav-btn" id="adminPanelBtn" title="Admin Panel" style="display: none;">
                    <i class="fas fa-crown"></i>
                </button>
                
                <div class="profile-btn-circle" id="profileMenuBtn">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=BeeKeeper" alt="Profile" class="profile-img" id="currentUserAvatar">
                </div>
            </div>
        </nav>

        <!-- Main Layout -->
        <div class="app-container">
            <!-- Left Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <div class="user-info" onclick="goToProfile()">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=BeeKeeper" alt="Profile" class="user-avatar" id="sidebarUserAvatar">
                        <div class="user-details">
                            <h3 id="sidebarUserName">MichaelTheGreat</h3>
                            <p><span class="bee-role" id="sidebarUserRole">Queen Bee</span> â€¢ <span id="sidebarHoneyPoints">1,247</span>ðŸ¯</p>
                        </div>
                    </div>
                    
                    <div class="honey-display" onclick="showHoneyShop()">
                        <div>
                            <div class="honey-amount" id="honeyPoints">1,247</div>
                            <div class="honey-label">Honey Points</div>
                        </div>
                        <i class="fas fa-coins" style="font-size: 32px;"></i>
                    </div>
                    
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a class="nav-link active" onclick="goToHome()">
                                <i class="fas fa-home"></i>
                                <span>Home</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" onclick="goToExplore()">
                                <i class="fas fa-hashtag"></i>
                                <span>Explore</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" onclick="showNotifications()">
                                <i class="fas fa-bell"></i>
                                <span>Notifications</span>
                                <span class="badge" style="margin-left: auto;" id="sidebarNotificationBadge">3</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" onclick="showMessages()">
                                <i class="fas fa-envelope"></i>
                                <span>Messages</span>
                                <span class="badge" style="margin-left: auto;" id="sidebarMessageBadge">2</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" onclick="goToBookmarks()">
                                <i class="fas fa-bookmark"></i>
                                <span>Bookmarks</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" onclick="goToCommunities()">
                                <i class="fas fa-users"></i>
                                <span>Communities</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" onclick="goToProfile()">
                                <i class="fas fa-user"></i>
                                <span>Profile</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" onclick="showSettings()">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </a>
                        </li>
                    </ul>
                    
                    <button class="create-post-btn" onclick="showCreatePostModal()">
                        <i class="fas fa-feather-alt"></i>
                        Create Buzz
                    </button>
                </div>
                
                <div class="sidebar-section trends-section">
                    <h3><i class="fas fa-fire"></i> Trending Now</h3>
                    <ul class="trend-list" id="trendingList">
                        <!-- Trends will be loaded here -->
                    </ul>
                </div>
                
                <div class="sidebar-section hives-section">
                    <h3><i class="fas fa-archive"></i> Your Hives</h3>
                    <div class="hive-list" id="hiveList">
                        <!-- Hives will be loaded here -->
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content" id="mainContent">
                <!-- Content will be loaded dynamically -->
                <div class="feed" id="homeFeed">
                    <!-- Posts will be loaded here -->
                </div>
            </main>

            <!-- Right Sidebar -->
            <aside class="right-sidebar">
                <!-- Profile Song Player -->
                <div class="profile-song-player" id="profileSongPlayer">
                    <div class="player-header">
                        <div class="player-title-row">
                            <i class="fas fa-music player-icon"></i>
                            <span class="player-label">Profile Song</span>
                        </div>
                        <button class="player-settings-btn" onclick="togglePlayerSettings(event)" id="playerSettingsBtn" style="display:none;">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div class="player-settings-dropdown" id="playerSettingsDropdown">
                            <button class="player-settings-item" onclick="triggerSongUpload()">
                                <i class="fas fa-exchange-alt"></i> Change Song
                            </button>
                            <button class="player-settings-item" onclick="editSongInfo()">
                                <i class="fas fa-pen"></i> Edit Info
                            </button>
                            <button class="player-settings-item danger" onclick="removeProfileSong()">
                                <i class="fas fa-trash"></i> Remove Song
                            </button>
                        </div>
                    </div>

                    <!-- Active player (shown when song is set) -->
                    <div id="playerActive" style="display:none;">
                        <div class="player-song-info">
                            <div class="player-song-title" id="playerSongTitle">Song Title</div>
                            <div class="player-song-artist" id="playerSongArtist">Artist</div>
                        </div>
                        <div class="player-controls">
                            <button class="player-play-btn" id="playerPlayBtn" onclick="toggleProfileSong()">
                                <i class="fas fa-play" id="playerPlayIcon"></i>
                            </button>
                            <div class="player-progress-container">
                                <div class="player-progress-bar" id="playerProgressBar" onclick="seekProfileSong(event)">
                                    <div class="player-progress-fill" id="playerProgressFill"></div>
                                </div>
                                <div class="player-time">
                                    <span id="playerCurrentTime">0:00</span>
                                    <span id="playerDuration">0:00</span>
                                </div>
                            </div>
                        </div>
                        <div class="player-bottom-row">
                            <div class="player-volume-container">
                                <button class="player-volume-btn" onclick="togglePlayerMute()">
                                    <i class="fas fa-volume-up" id="playerVolumeIcon"></i>
                                </button>
                                <input type="range" class="player-volume-slider" id="playerVolumeSlider" min="0" max="100" value="70" oninput="setPlayerVolume(this.value)">
                            </div>
                            <div class="player-visualizer" id="playerVisualizer">
                                <div class="player-visualizer-bar" style="height:4px;"></div>
                                <div class="player-visualizer-bar" style="height:6px;"></div>
                                <div class="player-visualizer-bar" style="height:8px;"></div>
                                <div class="player-visualizer-bar" style="height:5px;"></div>
                                <div class="player-visualizer-bar" style="height:7px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty state (shown when no song) -->
                    <div id="playerEmptyState">
                        <div class="player-empty-state">
                            <div class="player-empty-icon">&#x1F3B5;</div>
                            <div class="player-empty-text">No profile song set</div>
                            <input type="file" id="songFileInput" accept="audio/mp3,audio/mpeg,audio/wav,audio/ogg,audio/m4a,audio/*" style="display:none;" onchange="handleSongUpload(event)">
                            <button class="player-upload-btn" onclick="triggerSongUpload()">
                                <i class="fas fa-upload"></i> Upload Song
                            </button>
                        </div>
                    </div>
                    <audio id="profileAudio" preload="metadata"></audio>
                </div>
                
                <!-- Who to Follow -->
                <div class="follow-section">
                    <div class="section-header">
                        <h3 class="section-title">Who to Follow</h3>
                        <button class="refresh-btn" onclick="refreshSuggestions()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <div class="user-list" id="suggestedUsers">
                        <!-- Suggested users will be loaded here -->
                    </div>
                </div>
                
                <!-- Trending Pollinations -->
                <div class="trending-pollinations">
                    <div class="section-header">
                        <h3 class="section-title">Trending Pollinations</h3>
                    </div>
                    <div id="trendingPollinations">
                        <!-- Trending pollinations will be loaded here -->
                    </div>
                </div>
                
                <!-- Hive Activity -->
                <div class="hive-activity">
                    <div class="section-header">
                        <h3 class="section-title">Hive Activity</h3>
                    </div>
                    <div id="activityFeed">
                        <!-- Activity will be loaded here -->
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="createPostModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Buzz</h3>
                <button class="modal-close" onclick="closeModal('createPostModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="post-input" style="border: none; padding: 0;">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=BeeKeeper" alt="Profile" class="user-avatar-small" id="modalUserAvatar">
                    <div class="post-textarea" id="postContent" contenteditable="true" data-placeholder="What's buzzing in your mind? Start pollinating ideas..." style="min-height: 150px; outline: none; white-space: pre-wrap; word-wrap: break-word; overflow-y: auto;" oninput="debouncedHighlightHashtags(this)"></div>
                </div>

                <div style="margin: 20px 0;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                        <div class="file-input-wrapper">
                            <input type="file" class="file-input" id="mediaUpload" accept="image/*,video/*" multiple onchange="handleMediaUpload(event)">
                            <button class="action-btn compose-icon-btn" onclick="document.getElementById('mediaUpload').click()" title="Media">
                                <i class="fas fa-image"></i>
                            </button>
                        </div>

                        <button class="action-btn compose-icon-btn" onclick="showGifPicker()" title="GIF">
                            <span style="font-weight:bold;font-size:11px;border:1.5px solid currentColor;border-radius:3px;padding:0 3px;line-height:1.3;">GIF</span>
                        </button>

                        <button class="action-btn compose-icon-btn" onclick="showStickerPicker()" title="Stickers">
                            <i class="fas fa-note-sticky"></i>
                        </button>

                        <button class="action-btn compose-icon-btn" onclick="showEmojiPicker()" title="Emoji">
                            <i class="fas fa-face-smile"></i>
                        </button>

                        <button class="action-btn compose-icon-btn" onclick="showLinkModal()" title="Link">
                            <i class="fas fa-link"></i>
                        </button>

                        <button class="action-btn compose-icon-btn" onclick="createPoll()" title="Poll">
                            <i class="fas fa-poll"></i>
                        </button>

                        <button class="action-btn compose-icon-btn" onclick="showLocationPicker()" title="Location">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>

                        <button class="action-btn compose-icon-btn" onclick="showSchedulePost()" title="Schedule">
                            <i class="fas fa-clock"></i>
                        </button>

                        <button class="action-btn compose-icon-btn" onmousedown="event.preventDefault()" onclick="toggleBold()" title="Bold">
                            <i class="fas fa-bold"></i>
                        </button>

                        <button class="action-btn compose-icon-btn" onmousedown="event.preventDefault()" onclick="toggleItalic()" title="Italic">
                            <i class="fas fa-italic"></i>
                        </button>


                    </div>



                    <div style="margin-bottom: 20px;" id="postPollContainer" class="hidden">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Poll Options</label>
                        <div id="pollOptions"></div>
                        <button class="action-btn" onclick="addPollOption()" style="margin-top: 10px;">
                            <i class="fas fa-plus"></i>
                            <span>Add Option</span>
                        </button>
                    </div>

                    <div style="margin-bottom: 20px;" id="postMediaContainer" class="hidden">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Media Preview</label>
                        <div id="mediaPreview"></div>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button class="action-btn" onclick="closeModal('createPostModal')">
                        Cancel
                    </button>
                    <button class="pollinate-btn" onclick="submitPost()">
                        <i class="fas fa-feather-alt"></i>
                        Post Buzz
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div class="modal" id="linkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Link</h3>
                <button class="modal-close" onclick="closeModal('linkModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="linkUrl">URL</label>
                    <input type="url" id="linkUrl" class="form-control" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label for="linkText">Display Text (optional)</label>
                    <input type="text" id="linkText" class="form-control" placeholder="Check this out!">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button class="action-btn" onclick="closeModal('linkModal')">
                        Cancel
                    </button>
                    <button class="pollinate-btn" onclick="addLinkFromModal()">
                        <i class="fas fa-link"></i>
                        Add Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bio Edit Modal -->
    <div class="modal" id="bioModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Bio</h3>
                <button class="modal-close" onclick="closeModal('bioModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="bioText">Your Bio</label>
                    <textarea id="bioText" class="form-control" rows="4" placeholder="Tell us about yourself..."></textarea>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button class="action-btn" onclick="closeModal('bioModal')">
                        Cancel
                    </button>
                    <button class="pollinate-btn" onclick="saveBio()">
                        <i class="fas fa-save"></i>
                        Save Bio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Avatar Upload Modal -->
    <div class="modal" id="avatarModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Avatar</h3>
                <button class="modal-close" onclick="closeModal('avatarModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div id="avatarPreview" style="width: 150px; height: 150px; border-radius: 50%; margin: 0 auto 20px; border: 3px solid var(--honey-yellow); overflow: hidden;">
                        <img id="avatarPreviewImg" src="" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div class="file-input-wrapper" style="display: inline-block;">
                        <input type="file" class="file-input" id="avatarUpload" accept="image/*" onchange="previewAvatar(event)">
                        <button class="action-btn" onclick="document.getElementById('avatarUpload').click()">
                            <i class="fas fa-upload"></i>
                            <span>Choose Image</span>
                        </button>
                    </div>
                </div>
                <div style="color: var(--text-secondary); font-size: 12px; text-align: center; margin-bottom: 20px;">
                    Supported: JPG, PNG, GIF â€¢ Max 5MB
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button class="action-btn" onclick="closeModal('avatarModal')">
                        Cancel
                    </button>
                    <button class="pollinate-btn" onclick="saveAvatar()">
                        <i class="fas fa-save"></i>
                        Save Avatar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Menu Modal -->
    <div class="modal" id="profileMenuModal">
        <div class="modal-content">
            <div class="modal-body">
                <div style="text-align: center; padding: 20px 0;">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=BeeKeeper" alt="Profile" id="menuUserAvatar" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--honey-yellow); margin-bottom: 15px; cursor: pointer;" onclick="goToProfile()">
                    <h3 style="margin-bottom: 5px;" id="menuUserName">MichaelTheGreat</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;" id="menuUserRole">@michaelthegreat Â· Queen Bee</p>
                </div>
                
                <div style="display: flex; justify-content: space-around; margin-bottom: 20px; text-align: center;">
                    <div onclick="goToProfile('following')" style="cursor: pointer;">
                        <div style="font-size: 20px; font-weight: 700;" id="menuFollowingCount">247</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Following</div>
                    </div>
                    <div onclick="goToProfile('followers')" style="cursor: pointer;">
                        <div style="font-size: 20px; font-weight: 700;" id="menuFollowersCount">1.2k</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Followers</div>
                    </div>
                    <div onclick="showHoneyShop()" style="cursor: pointer;">
                        <div style="font-size: 20px; font-weight: 700;" id="menuHoneyCount">1,247</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Honey</div>
                    </div>
                </div>
                
                <div style="border-top: 1px solid var(--border-color); padding-top: 15px;">
                    <button class="option-item" onclick="goToProfile()">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </button>
                    <button class="option-item" onclick="showCustomization()">
                        <i class="fas fa-paint-brush"></i>
                        <span>Customize Profile</span>
                    </button>
                    <button class="option-item" onclick="showSettings()">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </button>
                    <button class="option-item" onclick="showThemeModal()">
                        <i class="fas fa-palette"></i>
                        <span>Theme</span>
                    </button>
                    <button class="option-item" onclick="showHelp()">
                        <i class="fas fa-question-circle"></i>
                        <span>Help Center</span>
                    </button>
                    <button class="option-item" style="color: #ff6b6b;" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Log out</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Customization Modal -->
    <div class="modal" id="customizationModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Customize Your Profile</h3>
                <button class="modal-close" onclick="closeModal('customizationModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="customization-tabs">
                    <button class="customization-tab active" onclick="switchCustomizationTab('colors')">Colors</button>
                    <button class="customization-tab" onclick="switchCustomizationTab('background')">Background</button>
                    <button class="customization-tab" onclick="switchCustomizationTab('css')">CSS Editor</button>
                    <button class="customization-tab" onclick="switchCustomizationTab('music')">Music Player</button>
                    <button class="customization-tab" data-tab-flair="true" onclick="switchCustomizationTab('flair')"><i class="fas fa-magic" style="margin-right:4px;"></i>Flair</button>
                </div>
                
                <div class="customization-section active" id="colorsSection">
                    <h4 style="margin-bottom: 15px;">Profile Accent Color</h4>
                    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">Choose a color that highlights your profile â€” banner, avatar ring, tabs, buttons, and stats.</p>
                    <div class="color-picker" style="display:flex;flex-wrap:wrap;gap:10px;">
                        <div class="color-option" style="background:#FFC30B;" onclick="selectColor('#FFC30B')" data-color="#FFC30B" title="Honey Gold"></div>
                        <div class="color-option" style="background:#FF69B4;" onclick="selectColor('#FF69B4')" data-color="#FF69B4" title="Hot Pink"></div>
                        <div class="color-option" style="background:#FF4444;" onclick="selectColor('#FF4444')" data-color="#FF4444" title="Crimson"></div>
                        <div class="color-option" style="background:#FF8C00;" onclick="selectColor('#FF8C00')" data-color="#FF8C00" title="Orange"></div>
                        <div class="color-option" style="background:#228B22;" onclick="selectColor('#228B22')" data-color="#228B22" title="Forest Green"></div>
                        <div class="color-option" style="background:#20B2AA;" onclick="selectColor('#20B2AA')" data-color="#20B2AA" title="Teal"></div>
                        <div class="color-option" style="background:#87CEEB;" onclick="selectColor('#87CEEB')" data-color="#87CEEB" title="Sky Blue"></div>
                        <div class="color-option" style="background:#4169E1;" onclick="selectColor('#4169E1')" data-color="#4169E1" title="Royal Blue"></div>
                        <div class="color-option" style="background:#9370DB;" onclick="selectColor('#9370DB')" data-color="#9370DB" title="Purple"></div>
                        <div class="color-option" style="background:#E0E0E0;" onclick="selectColor('#E0E0E0')" data-color="#E0E0E0" title="Silver"></div>
                        <div class="color-option" style="background:#8B4513;" onclick="selectColor('#8B4513')" data-color="#8B4513" title="Brown"></div>
                        <div class="color-option" style="background:#FFFFFF;border:2px solid var(--border-color);" onclick="selectColor('#FFFFFF')" data-color="#FFFFFF" title="White"></div>
                    </div>
                    <div style="margin-top:15px;display:flex;align-items:center;gap:12px;">
                        <label style="font-weight:500;font-size:14px;white-space:nowrap;">Custom:</label>
                        <input type="color" id="customColorPicker" value="#FFC30B" style="width:50px;height:36px;border-radius:8px;border:2px solid var(--border-color);cursor:pointer;padding:2px;" oninput="selectColor(this.value)">
                        <span id="colorHexDisplay" style="font-family:monospace;font-size:13px;color:var(--text-secondary);">#FFC30B</span>
                    </div>
                    <div id="colorPreviewBox" style="margin-top:15px;padding:14px;border-radius:12px;border:2px solid var(--border-color);background:var(--bg-input);">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
                            <div id="previewAvatarRing" style="width:48px;height:48px;border-radius:50%;border:3px solid #FFC30B;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;font-size:20px;">
                                <i class="fas fa-user" style="color:var(--text-secondary);"></i>
                            </div>
                            <div>
                                <div id="previewNameColor" style="font-weight:700;font-size:15px;">Your Name</div>
                                <div style="font-size:12px;color:var(--text-secondary);">@username</div>
                            </div>
                        </div>
                        <div style="display:flex;gap:16px;font-size:13px;">
                            <span><strong>42</strong> <span id="previewStatColor" style="color:#FFC30B;">Following</span></span>
                            <span><strong>108</strong> <span id="previewStatColor2" style="color:#FFC30B;">Followers</span></span>
                        </div>
                        <div id="previewTabBar" style="margin-top:10px;display:flex;gap:0;">
                            <div style="flex:1;text-align:center;padding:8px;font-size:12px;font-weight:700;border-bottom:3px solid #FFC30B;">Posts</div>
                            <div style="flex:1;text-align:center;padding:8px;font-size:12px;color:var(--text-secondary);border-bottom:3px solid transparent;">Media</div>
                            <div style="flex:1;text-align:center;padding:8px;font-size:12px;color:var(--text-secondary);border-bottom:3px solid transparent;">Likes</div>
                        </div>
                    </div>
                </div>
                
                <div class="customization-section" id="backgroundSection">
                    <h4 style="margin-bottom: 15px;">Profile Banner Background</h4>
                    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">Set the background for your profile banner area.</p>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:15px;">
                        <button class="bg-type-btn active" data-bg-type="gradient" onclick="setBackground('gradient')" style="padding:12px;border-radius:10px;border:2px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);cursor:pointer;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;transition:all 0.2s;font-family:inherit;">
                            <i class="fas fa-palette"></i> Gradient
                        </button>
                        <button class="bg-type-btn" data-bg-type="solid" onclick="setBackground('solid')" style="padding:12px;border-radius:10px;border:2px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);cursor:pointer;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;transition:all 0.2s;font-family:inherit;">
                            <i class="fas fa-square-full"></i> Solid Color
                        </button>
                        <button class="bg-type-btn" data-bg-type="pattern" onclick="setBackground('pattern')" style="padding:12px;border-radius:10px;border:2px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);cursor:pointer;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;transition:all 0.2s;font-family:inherit;">
                            <i class="fas fa-th"></i> Pattern
                        </button>
                        <button class="bg-type-btn" data-bg-type="image" onclick="setBackground('image')" style="padding:12px;border-radius:10px;border:2px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);cursor:pointer;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;transition:all 0.2s;font-family:inherit;">
                            <i class="fas fa-image"></i> Image
                        </button>
                    </div>
                    <div id="backgroundOptions">
                        <!-- Gradient options (default) -->
                        <div id="bgGradientOptions">
                            <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;">
                                <div style="flex:1;">
                                    <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:4px;">Color 1</label>
                                    <input type="color" id="bgGradColor1" value="#FFC30B" style="width:100%;height:36px;border-radius:8px;border:2px solid var(--border-color);cursor:pointer;padding:2px;" oninput="updateBgPreview()">
                                </div>
                                <div style="flex:1;">
                                    <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:4px;">Color 2</label>
                                    <input type="color" id="bgGradColor2" value="#FF8C00" style="width:100%;height:36px;border-radius:8px;border:2px solid var(--border-color);cursor:pointer;padding:2px;" oninput="updateBgPreview()">
                                </div>
                            </div>
                            <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:6px;">Direction</label>
                            <div style="display:flex;gap:6px;margin-bottom:12px;">
                                <button class="grad-dir-btn active" data-dir="135deg" onclick="selectGradDirection('135deg')" style="flex:1;padding:8px;border-radius:8px;border:2px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);cursor:pointer;font-size:12px;font-family:inherit;">Diagonal â†˜</button>
                                <button class="grad-dir-btn" data-dir="90deg" onclick="selectGradDirection('90deg')" style="flex:1;padding:8px;border-radius:8px;border:2px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);cursor:pointer;font-size:12px;font-family:inherit;">Horizontal â†’</button>
                                <button class="grad-dir-btn" data-dir="180deg" onclick="selectGradDirection('180deg')" style="flex:1;padding:8px;border-radius:8px;border:2px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);cursor:pointer;font-size:12px;font-family:inherit;">Vertical â†“</button>
                                <button class="grad-dir-btn" data-dir="radial" onclick="selectGradDirection('radial')" style="flex:1;padding:8px;border-radius:8px;border:2px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);cursor:pointer;font-size:12px;font-family:inherit;">Radial â—Ž</button>
                            </div>
                        </div>
                        <!-- Solid color options -->
                        <div id="bgSolidOptions" style="display:none;">
                            <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:6px;">Banner Color</label>
                            <input type="color" id="bgSolidColor" value="#1a1a2e" style="width:100%;height:40px;border-radius:8px;border:2px solid var(--border-color);cursor:pointer;padding:2px;" oninput="updateBgPreview()">
                        </div>
                        <!-- Pattern options -->
                        <div id="bgPatternOptions" style="display:none;">
                            <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:8px;">Choose a pattern overlay</label>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
                                <div class="pattern-option active" data-pattern="honeycomb" onclick="selectPattern('honeycomb')" style="height:70px;border-radius:10px;border:2px solid var(--border-color);cursor:pointer;position:relative;overflow:hidden;background:#FFC30B22;transition:all 0.2s;">
                                    <div style="position:absolute;inset:0;background-image:url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2756%27 height=%27100%27 viewBox=%270 0 56 100%27%3E%3Cpath d=%27M28 66L0 50L0 16L28 0L56 16L56 50L28 66L28 100%27 fill=%27none%27 stroke=%27%23FFC30B%27 stroke-width=%271.5%27/%3E%3C/svg%3E');background-size:28px 50px;opacity:0.5;"></div>
                                    <span style="position:absolute;bottom:4px;left:0;right:0;text-align:center;font-size:10px;font-weight:600;color:var(--text-primary);">Honeycomb</span>
                                </div>
                                <div class="pattern-option" data-pattern="dots" onclick="selectPattern('dots')" style="height:70px;border-radius:10px;border:2px solid var(--border-color);cursor:pointer;position:relative;overflow:hidden;background:#FFC30B11;transition:all 0.2s;">
                                    <div style="position:absolute;inset:0;background-image:radial-gradient(circle, var(--honey-yellow) 1px, transparent 1px);background-size:12px 12px;opacity:0.4;"></div>
                                    <span style="position:absolute;bottom:4px;left:0;right:0;text-align:center;font-size:10px;font-weight:600;color:var(--text-primary);">Dots</span>
                                </div>
                                <div class="pattern-option" data-pattern="diagonal" onclick="selectPattern('diagonal')" style="height:70px;border-radius:10px;border:2px solid var(--border-color);cursor:pointer;position:relative;overflow:hidden;background:#FFC30B11;transition:all 0.2s;">
                                    <div style="position:absolute;inset:0;background-image:repeating-linear-gradient(45deg, transparent, transparent 8px, rgba(255,195,11,0.15) 8px, rgba(255,195,11,0.15) 9px);opacity:0.6;"></div>
                                    <span style="position:absolute;bottom:4px;left:0;right:0;text-align:center;font-size:10px;font-weight:600;color:var(--text-primary);">Diagonal</span>
                                </div>
                                <div class="pattern-option" data-pattern="waves" onclick="selectPattern('waves')" style="height:70px;border-radius:10px;border:2px solid var(--border-color);cursor:pointer;position:relative;overflow:hidden;background:#FFC30B11;transition:all 0.2s;">
                                    <div style="position:absolute;inset:0;background-image:url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27100%27 height=%2720%27 viewBox=%270 0 100 20%27%3E%3Cpath d=%27M0 10 Q25 0 50 10 Q75 20 100 10%27 fill=%27none%27 stroke=%27%23FFC30B%27 stroke-width=%271.5%27/%3E%3C/svg%3E');background-size:50px 20px;opacity:0.4;"></div>
                                    <span style="position:absolute;bottom:4px;left:0;right:0;text-align:center;font-size:10px;font-weight:600;color:var(--text-primary);">Waves</span>
                                </div>
                                <div class="pattern-option" data-pattern="hexgrid" onclick="selectPattern('hexgrid')" style="height:70px;border-radius:10px;border:2px solid var(--border-color);cursor:pointer;position:relative;overflow:hidden;background:#FFC30B11;transition:all 0.2s;">
                                    <div style="position:absolute;inset:0;background-image:url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2728%27 height=%2749%27 viewBox=%270 0 28 49%27%3E%3Cg fill-rule=%27evenodd%27%3E%3Cg fill=%27%23FFC30B%27 fill-opacity=%270.15%27%3E%3Cpath d=%27M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9z%27/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');opacity:0.5;"></div>
                                    <span style="position:absolute;bottom:4px;left:0;right:0;text-align:center;font-size:10px;font-weight:600;color:var(--text-primary);">Hex Grid</span>
                                </div>
                                <div class="pattern-option" data-pattern="crosshatch" onclick="selectPattern('crosshatch')" style="height:70px;border-radius:10px;border:2px solid var(--border-color);cursor:pointer;position:relative;overflow:hidden;background:#FFC30B11;transition:all 0.2s;">
                                    <div style="position:absolute;inset:0;background-image:repeating-linear-gradient(0deg, transparent, transparent 10px, rgba(255,195,11,0.12) 10px, rgba(255,195,11,0.12) 11px), repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(255,195,11,0.12) 10px, rgba(255,195,11,0.12) 11px);opacity:0.6;"></div>
                                    <span style="position:absolute;bottom:4px;left:0;right:0;text-align:center;font-size:10px;font-weight:600;color:var(--text-primary);">Grid</span>
                                </div>
                            </div>
                            <div style="margin-top:12px;display:flex;gap:12px;align-items:center;">
                                <div style="flex:1;">
                                    <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:4px;">Base Color</label>
                                    <input type="color" id="bgPatternBaseColor" value="#1a1a2e" style="width:100%;height:32px;border-radius:8px;border:2px solid var(--border-color);cursor:pointer;padding:2px;" oninput="updateBgPreview()">
                                </div>
                                <div style="flex:1;">
                                    <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:4px;">Pattern Color</label>
                                    <input type="color" id="bgPatternColor" value="#FFC30B" style="width:100%;height:32px;border-radius:8px;border:2px solid var(--border-color);cursor:pointer;padding:2px;" oninput="updateBgPreview()">
                                </div>
                            </div>
                        </div>
                        <!-- Image options -->
                        <div id="bgImageOptions" style="display:none;">
                            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:10px;">Upload a custom banner image, or click directly on the banner in your profile page.</p>
                            <label style="display:flex;align-items:center;gap:10px;padding:14px;border-radius:10px;border:2px dashed var(--border-color);cursor:pointer;transition:all 0.2s;justify-content:center;" onmouseover="this.style.borderColor='var(--honey-yellow)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="fas fa-cloud-upload-alt" style="font-size:20px;color:var(--honey-yellow);"></i>
                                <span style="font-weight:600;font-size:14px;">Choose Image</span>
                                <input type="file" id="bgImageUpload" accept="image/*" style="display:none;" onchange="handleBgImageUpload(event)">
                            </label>
                            <div id="bgImagePreviewContainer" style="display:none;margin-top:10px;position:relative;">
                                <img id="bgImagePreview" style="width:100%;height:120px;object-fit:cover;border-radius:10px;border:2px solid var(--border-color);">
                                <button onclick="removeBgImage()" style="position:absolute;top:6px;right:6px;width:28px;height:28px;border-radius:50%;background:rgba(0,0,0,0.7);border:none;color:white;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;">&times;</button>
                            </div>
                        </div>
                    </div>
                    <!-- Banner preview -->
                    <div style="margin-top:15px;">
                        <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:6px;">Preview</label>
                        <div id="bgPreviewBanner" style="height:80px;border-radius:10px;border:2px solid var(--border-color);background:linear-gradient(135deg, #FFC30B, #FF8C00);overflow:hidden;transition:all 0.3s;"></div>
                    </div>
                </div>
                
                <div class="customization-section" id="cssSection">
                    <h4 style="margin-bottom: 15px;">Custom CSS Editor</h4>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">
                        Add custom CSS to style your profile. This is for advanced users.
                    </p>
                    <textarea class="css-editor" id="customCSSEditor" placeholder="/* Add your custom CSS here */
.profile-header {
    background: linear-gradient(45deg, #FFC30B, #FF8C00);
    border-radius: 20px;
}

.profile-avatar-large {
    border: 5px solid #FFC30B;
    box-shadow: 0 0 20px rgba(255, 195, 11, 0.5);
}"></textarea>
                    <div class="preview-area" id="cssPreview">
                        <p>CSS Preview Area</p>
                    </div>
                </div>
                
                <div class="customization-section" id="musicSection">
                    <h4 style="margin-bottom: 15px;"><i class="fas fa-music" style="color:var(--honey-yellow);margin-right:8px;"></i>Profile Song Player</h4>

                    <!-- Current Song Preview -->
                    <div style="background:var(--bg-secondary);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--border-color);">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                            <button class="player-play-btn" id="customizePlayBtn" onclick="toggleProfileSong()" style="width:40px;height:40px;font-size:14px;">
                                <i class="fas fa-play" id="customizePlayIcon"></i>
                            </button>
                            <div style="flex:1;min-width:0;">
                                <div style="font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" id="customizeSongTitle">No song selected</div>
                                <div style="font-size:12px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" id="customizeSongArtist">Upload an MP3 to get started</div>
                            </div>
                            <div class="player-visualizer" id="customizeVisualizer" style="opacity:0.5;">
                                <div class="player-visualizer-bar" style="height:4px;"></div>
                                <div class="player-visualizer-bar" style="height:6px;"></div>
                                <div class="player-visualizer-bar" style="height:8px;"></div>
                                <div class="player-visualizer-bar" style="height:5px;"></div>
                                <div class="player-visualizer-bar" style="height:7px;"></div>
                            </div>
                        </div>
                        <!-- Progress bar in customize -->
                        <div class="player-progress-bar" onclick="seekProfileSong(event)" style="margin-bottom:4px;">
                            <div class="player-progress-fill" id="customizeProgressFill"></div>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-secondary);">
                            <span id="customizeCurrentTime">0:00</span>
                            <span id="customizeDuration">0:00</span>
                        </div>
                    </div>

                    <!-- Upload Section -->
                    <div style="margin-bottom:16px;">
                        <label style="display:block;margin-bottom:8px;font-weight:600;font-size:13px;"><i class="fas fa-upload" style="color:var(--honey-yellow);margin-right:6px;"></i>Upload MP3</label>
                        <div style="display:flex;gap:8px;">
                            <input type="file" id="customizeSongInput" accept="audio/mp3,audio/mpeg,audio/wav,audio/ogg,audio/m4a,audio/*" style="display:none;" onchange="handleSongUpload(event)">
                            <button class="action-btn" onclick="document.getElementById('customizeSongInput').click()" style="flex:1;padding:12px;border-radius:10px;border:1px dashed var(--border-color);background:var(--bg-input);cursor:pointer;transition:all 0.3s;text-align:center;">
                                <i class="fas fa-cloud-upload-alt" style="font-size:18px;color:var(--honey-yellow);display:block;margin-bottom:4px;"></i>
                                <span style="font-size:12px;color:var(--text-secondary);">Choose audio file (MP3, WAV, OGG &middot; Max 10MB)</span>
                            </button>
                        </div>
                    </div>

                    <!-- Song Info Edit -->
                    <div id="customizeSongInfoEdit" style="margin-bottom:16px;">
                        <label style="display:block;margin-bottom:8px;font-weight:600;font-size:13px;"><i class="fas fa-pen" style="color:var(--honey-yellow);margin-right:6px;"></i>Song Info</label>
                        <div style="display:flex;flex-direction:column;gap:8px;">
                            <input type="text" class="form-control" id="customizeTitleInput" placeholder="Song title" style="padding:10px 12px;border-radius:8px;background:var(--bg-input);border:1px solid var(--border-color);color:var(--text-primary);font-size:13px;" oninput="updateSongInfoFromCustomize()">
                            <input type="text" class="form-control" id="customizeArtistInput" placeholder="Artist name" style="padding:10px 12px;border-radius:8px;background:var(--bg-input);border:1px solid var(--border-color);color:var(--text-primary);font-size:13px;" oninput="updateSongInfoFromCustomize()">
                        </div>
                    </div>

                    <!-- Player Settings -->
                    <div style="margin-bottom:16px;">
                        <label style="display:block;margin-bottom:8px;font-weight:600;font-size:13px;"><i class="fas fa-sliders-h" style="color:var(--honey-yellow);margin-right:6px;"></i>Player Settings</label>
                        <div style="background:var(--bg-secondary);border-radius:10px;padding:12px;border:1px solid var(--border-color);">
                            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
                                <div>
                                    <div style="font-size:13px;font-weight:500;">Auto-play on profile visit</div>
                                    <div style="font-size:11px;color:var(--text-secondary);">Song starts when someone views your profile</div>
                                </div>
                                <label style="position:relative;display:inline-block;width:40px;height:22px;cursor:pointer;">
                                    <input type="checkbox" id="autoplayToggle" checked onchange="savePlayerSettings()" style="opacity:0;width:0;height:0;">
                                    <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--bg-input);border-radius:11px;transition:0.3s;"></span>
                                    <span style="position:absolute;content:'';height:18px;width:18px;left:2px;bottom:2px;background:var(--text-secondary);border-radius:50%;transition:0.3s;" id="autoplaySlider"></span>
                                </label>
                            </div>
                            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
                                <div>
                                    <div style="font-size:13px;font-weight:500;">Loop song</div>
                                    <div style="font-size:11px;color:var(--text-secondary);">Repeat when song ends</div>
                                </div>
                                <label style="position:relative;display:inline-block;width:40px;height:22px;cursor:pointer;">
                                    <input type="checkbox" id="loopToggle" checked onchange="savePlayerSettings()" style="opacity:0;width:0;height:0;">
                                    <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--bg-input);border-radius:11px;transition:0.3s;"></span>
                                    <span style="position:absolute;content:'';height:18px;width:18px;left:2px;bottom:2px;background:var(--text-secondary);border-radius:50%;transition:0.3s;" id="loopSlider"></span>
                                </label>
                            </div>
                            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;">
                                <div>
                                    <div style="font-size:13px;font-weight:500;">Default volume</div>
                                    <div style="font-size:11px;color:var(--text-secondary);">Starting volume for visitors</div>
                                </div>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <i class="fas fa-volume-down" style="color:var(--text-secondary);font-size:11px;"></i>
                                    <input type="range" class="player-volume-slider" id="defaultVolumeSlider" min="0" max="100" value="70" onchange="savePlayerSettings()" style="width:80px;">
                                    <span style="font-size:11px;color:var(--text-secondary);min-width:28px;" id="defaultVolumeLabel">70%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Remove Song -->
                    <button class="action-btn" onclick="removeProfileSong(); syncCustomizePanel();" style="width:100%;color:#ff4444;border-color:#ff4444;padding:10px;border-radius:10px;" id="removeSongBtn">
                        <i class="fas fa-trash"></i>
                        <span>Remove Profile Song</span>
                    </button>
                </div>

                <!-- Flair Section (Avatar Border + Mood/Status) -->
                <div class="customization-section" id="flairSection">
                    <div id="flairContentInner">
                        <!-- Populated dynamically by switchCustomizationTab -->
                    </div>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button class="action-btn" onclick="resetCustomization()">
                        Reset
                    </button>
                    <button class="pollinate-btn" onclick="saveCustomization()">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal admin-modal-fullscreen" id="adminPanelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-crown" style="color: var(--flower-pink);"></i> Admin Panel</h3>
                <button class="modal-close" onclick="closeModal('adminPanelModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="admin-sidebar">
                    <button class="admin-sidebar-btn active" onclick="switchAdminTab('dashboard')"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></button>
                    <button class="admin-sidebar-btn" onclick="switchAdminTab('users')"><i class="fas fa-users"></i> <span>Users</span></button>
                    <button class="admin-sidebar-btn" onclick="switchAdminTab('moderation')"><i class="fas fa-shield-alt"></i> <span>Moderation</span></button>
                    <button class="admin-sidebar-btn" onclick="switchAdminTab('config')"><i class="fas fa-cog"></i> <span>Site Config</span></button>
                    <button class="admin-sidebar-btn" onclick="switchAdminTab('announcements')"><i class="fas fa-bullhorn"></i> <span>Announcements</span></button>
                    <button class="admin-sidebar-btn" onclick="switchAdminTab('analytics')"><i class="fas fa-chart-line"></i> <span>Analytics</span></button>
                    <button class="admin-sidebar-btn" onclick="switchAdminTab('roles')"><i class="fas fa-user-shield"></i> <span>Roles</span></button>
                    <button class="admin-sidebar-btn" onclick="switchAdminTab('auditlog')"><i class="fas fa-clipboard-list"></i> <span>Audit Log</span></button>
                    <button class="admin-sidebar-btn" onclick="switchAdminTab('appeals')"><i class="fas fa-gavel"></i> <span>Appeals</span></button>
                    <button class="admin-sidebar-btn" onclick="switchAdminTab('modlog')"><i class="fas fa-history"></i> <span>Mod Log</span></button>
                    <button class="admin-sidebar-btn" onclick="switchAdminTab('contentsearch')"><i class="fas fa-search-plus"></i> <span>Content Search</span></button>
                </div>
                <div class="admin-main" id="adminMainContent">
                    <!-- Dashboard -->
                    <div class="admin-section active" id="adminDashboard">
                        <h3><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
                        <div class="admin-stat-grid" id="adminStatGrid"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="admin-card">
                                <h4><i class="fas fa-chart-bar"></i> Posts This Week</h4>
                                <div class="admin-chart-bars" id="adminWeeklyChart"></div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 20px 0; font-size: 11px; color: var(--text-secondary);">
                                    <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
                                </div>
                            </div>
                            <div class="admin-card">
                                <h4><i class="fas fa-fire"></i> Recent Activity</h4>
                                <div id="adminRecentActivity" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="admin-section" id="adminUsers">
                        <h3><i class="fas fa-users"></i> User Management</h3>
                        <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center;">
                            <div class="admin-search-wrapper" style="flex: 1; margin-bottom: 0;">
                                <i class="fas fa-search"></i>
                                <input type="text" class="admin-search" id="adminUserSearch" placeholder="Search users by name, email, or role..." oninput="filterAdminUsers()" style="margin-bottom: 0;">
                            </div>
                            <select class="admin-select" id="adminUserRoleFilter" onchange="filterAdminUsers()" style="width: 150px;">
                                <option value="">All Roles</option>
                                <option value="queen">Queen Bee</option>
                                <option value="worker">Worker Bee</option>
                                <option value="drone">Drone</option>
                            </select>
                            <select class="admin-select" id="adminUserStatusFilter" onchange="filterAdminUsers()" style="width: 150px;">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="suspended">Suspended</option>
                                <option value="banned">Banned</option>
                            </select>
                        </div>
                        <div id="adminBulkBar" class="admin-bulk-bar" style="display: none;">
                            <span id="adminBulkCount">0 users selected</span>
                            <div style="margin-left: auto; display: flex; gap: 8px;">
                                <button onclick="adminBulkAction('warn')"><i class="fas fa-exclamation-triangle"></i> Warn All</button>
                                <button onclick="adminBulkAction('role')"><i class="fas fa-crown"></i> Change Role</button>
                                <button onclick="adminBulkAction('ban')"><i class="fas fa-ban"></i> Ban All</button>
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="admin-table" id="adminUserTable">
                                <thead>
                                    <tr>
                                        <th style="width: 30px;"><input type="checkbox" onchange="toggleAdminSelectAll(this)" style="accent-color: var(--honey-yellow);"></th>
                                        <th>User</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Joined</th>
                                        <th>Honey Pts</th>
                                        <th>Posts</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminUserTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Content Moderation -->
                    <div class="admin-section" id="adminModeration">
                        <h3><i class="fas fa-shield-alt"></i> Content Moderation</h3>
                        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                            <button class="admin-action-btn" onclick="switchModerationTab('reports')" id="modTabReports" style="font-weight: 600; border-color: var(--flower-pink); color: var(--flower-pink);">
                                <i class="fas fa-flag"></i> Reports <span class="admin-badge" style="margin-left: 6px; background: rgba(255,68,68,0.2); color: #FF4444;" id="reportCount">0</span>
                            </button>
                            <button class="admin-action-btn" onclick="switchModerationTab('flagged')"><i class="fas fa-exclamation-triangle"></i> Flagged Content</button>
                            <button class="admin-action-btn" onclick="switchModerationTab('mutedwords')"><i class="fas fa-volume-mute"></i> Muted Words</button>
                        </div>
                        <div id="moderationReports"></div>
                        <div id="moderationFlagged" style="display: none;"></div>
                        <div id="moderationMutedWords" style="display: none;"></div>
                    </div>

                    <!-- Site Configuration -->
                    <div class="admin-section" id="adminConfig">
                        <h3><i class="fas fa-cog"></i> Site Configuration</h3>

                        <div class="admin-card">
                            <h4><i class="fas fa-palette"></i> Theme & Appearance</h4>
                            <div class="admin-controls-row">
                                <div class="admin-control-group">
                                    <label>Default Site Theme</label>
                                    <select class="admin-select" id="adminDefaultTheme">
                                        <option value="dark">Night Hive (Dark)</option>
                                        <option value="light">Sunlit Meadow (Light)</option>
                                        <option value="spring">Blossom Fields</option>
                                        <option value="summer">Honey Coast</option>
                                        <option value="autumn">Amber Harvest</option>
                                        <option value="winter">Frost Colony</option>
                                        <option value="rose">Rose Garden</option>
                                        <option value="crimson">Crimson Flame</option>
                                        <option value="emerald">Emerald Grove</option>
                                        <option value="golden">Golden Crown</option>
                                        <option value="violet">Violet Throne</option>
                                        <option value="steel">Steel Fortress</option>
                                        <option value="ember">Ember Blaze</option>
                                        <option value="cedar">Cedar Lodge</option>
                                        <option value="sapphire">Sapphire Depths</option>
                                        <option value="rainbow">Prismatic Hive</option>
                                    </select>
                                </div>
                                <div class="admin-control-group">
                                    <label>Site Style</label>
                                    <select class="admin-select" id="adminSiteStyleNew">
                                        <option value="default">Default</option>
                                        <option value="rounded">Rounded</option>
                                        <option value="sharp">Sharp</option>
                                        <option value="honeycomb">Honeycomb</option>
                                    </select>
                                </div>
                                <div class="admin-control-group">
                                    <label>Border Radius</label>
                                    <select class="admin-select" id="adminBorderRadiusNew">
                                        <option value="5">Small (5px)</option>
                                        <option value="15" selected>Medium (15px)</option>
                                        <option value="25">Large (25px)</option>
                                        <option value="50">Extra Large (50px)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="admin-controls-row">
                                <div class="admin-control-group">
                                    <label>Primary Accent Color</label>
                                    <input type="color" class="admin-select" id="adminAccentColor" value="#FF69B4" style="height: 38px;">
                                </div>
                                <div class="admin-control-group">
                                    <label>Background Override</label>
                                    <input type="color" class="admin-select" id="adminBgOverride" value="#0F0F0F" style="height: 38px;">
                                </div>
                                <div class="admin-control-group">
                                    <label>Font Family</label>
                                    <select class="admin-select" id="adminFontFamilyNew">
                                        <option value="Inter">Inter</option>
                                        <option value="Poppins">Poppins</option>
                                        <option value="Arial">Arial</option>
                                        <option value="Georgia">Georgia</option>
                                        <option value="Roboto">Roboto</option>
                                        <option value="'Fira Code', monospace">Fira Code</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="admin-card">
                            <h4><i class="fas fa-toggle-on"></i> Feature Toggles</h4>
                            <div id="adminFeatureToggles"></div>
                        </div>

                        <div class="admin-card">
                            <h4><i class="fas fa-sliders-h"></i> Content Settings</h4>
                            <div class="admin-controls-row">
                                <div class="admin-control-group">
                                    <label>Max Post Length</label>
                                    <input type="number" class="admin-input" id="adminMaxPostLength" value="500" min="100" max="5000">
                                </div>
                                <div class="admin-control-group">
                                    <label>Max Upload Size (MB)</label>
                                    <input type="number" class="admin-input" id="adminMaxUpload" value="10" min="1" max="100">
                                </div>
                                <div class="admin-control-group">
                                    <label>Posts Per Page</label>
                                    <input type="number" class="admin-input" id="adminPostsPerPage" value="20" min="5" max="100">
                                </div>
                            </div>
                        </div>

                        <div class="admin-btn-row">
                            <button class="admin-btn secondary" onclick="resetAdminConfig()"><i class="fas fa-undo"></i> Reset to Defaults</button>
                            <button class="admin-btn primary" onclick="saveAdminConfig()"><i class="fas fa-save"></i> Save Configuration</button>
                        </div>
                    </div>

                    <!-- Announcements -->
                    <div class="admin-section" id="adminAnnouncements">
                        <h3><i class="fas fa-bullhorn"></i> Announcements</h3>
                        <div class="admin-card">
                            <h4>Create Announcement</h4>
                            <div class="admin-control-group" style="margin-bottom: 12px;">
                                <label>Title</label>
                                <input type="text" class="admin-input" id="announcementTitle" placeholder="Announcement title..." style="width: 100%;">
                            </div>
                            <div class="admin-control-group" style="margin-bottom: 12px;">
                                <label>Message</label>
                                <textarea class="admin-input" id="announcementMessage" placeholder="Write your announcement..." rows="4" style="width: 100%; resize: vertical;"></textarea>
                            </div>
                            <div class="admin-controls-row" style="margin-bottom: 12px;">
                                <div class="admin-control-group">
                                    <label>Type</label>
                                    <select class="admin-select" id="announcementType">
                                        <option value="info">Info</option>
                                        <option value="warning">Warning</option>
                                        <option value="success">Success</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                                <div class="admin-control-group">
                                    <label>Display</label>
                                    <select class="admin-select" id="announcementDisplay">
                                        <option value="banner">Top Banner</option>
                                        <option value="modal">Modal Popup</option>
                                        <option value="feed">Feed Post</option>
                                    </select>
                                </div>
                                <div class="admin-control-group">
                                    <label>Duration</label>
                                    <select class="admin-select" id="announcementDuration">
                                        <option value="1h">1 Hour</option>
                                        <option value="24h">24 Hours</option>
                                        <option value="7d">7 Days</option>
                                        <option value="permanent">Permanent</option>
                                    </select>
                                </div>
                            </div>
                            <button class="admin-btn primary" onclick="publishAnnouncement()"><i class="fas fa-paper-plane"></i> Publish Announcement</button>
                        </div>
                        <h4 style="margin: 20px 0 12px; color: var(--text-primary);">Active Announcements</h4>
                        <div id="adminAnnouncementsList"></div>
                    </div>

                    <!-- Analytics -->
                    <div class="admin-section" id="adminAnalytics">
                        <h3><i class="fas fa-chart-line"></i> Analytics</h3>
                        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                            <select class="admin-select" id="analyticsTimeRange" onchange="refreshAnalytics()">
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div class="admin-stat-grid" id="analyticsStatGrid"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="admin-card">
                                <h4><i class="fas fa-users"></i> User Growth</h4>
                                <div class="admin-chart-bars" id="analyticsUserGrowth"></div>
                                <div style="display: flex; justify-content: space-around; padding: 8px 20px 0; font-size: 11px; color: var(--text-secondary);" id="analyticsUserLabels"></div>
                            </div>
                            <div class="admin-card">
                                <h4><i class="fas fa-heart"></i> Engagement Rate</h4>
                                <div class="admin-chart-bars" id="analyticsEngagement"></div>
                                <div style="display: flex; justify-content: space-around; padding: 8px 20px 0; font-size: 11px; color: var(--text-secondary);" id="analyticsEngLabels"></div>
                            </div>
                        </div>
                        <div class="admin-card" style="margin-top: 16px;">
                            <h4><i class="fas fa-trophy"></i> Top Posts</h4>
                            <div id="analyticsTopPosts"></div>
                        </div>
                    </div>

                    <!-- Roles & Permissions -->
                    <div class="admin-section" id="adminRoles">
                        <h3><i class="fas fa-user-shield"></i> Roles & Permissions</h3>
                        <div id="adminRolesList"></div>
                        <div class="admin-card" style="margin-top: 20px;">
                            <h4><i class="fas fa-plus"></i> Create Custom Role</h4>
                            <div class="admin-controls-row">
                                <div class="admin-control-group">
                                    <label>Role Name</label>
                                    <input type="text" class="admin-input" id="newRoleName" placeholder="e.g. Moderator Bee">
                                </div>
                                <div class="admin-control-group">
                                    <label>Color</label>
                                    <input type="color" class="admin-input" id="newRoleColor" value="#FF69B4" style="height: 38px;">
                                </div>
                                <div class="admin-control-group">
                                    <label>Icon</label>
                                    <select class="admin-select" id="newRoleIcon">
                                        <option value="crown">Crown</option>
                                        <option value="shield-alt">Shield</option>
                                        <option value="star">Star</option>
                                        <option value="gem">Gem</option>
                                        <option value="bolt">Bolt</option>
                                        <option value="hammer">Hammer</option>
                                    </select>
                                </div>
                            </div>
                            <h5 style="margin: 12px 0 8px; color: var(--text-secondary); font-size: 13px;">Permissions</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;" id="newRolePermissions">
                            </div>
                            <button class="admin-btn primary" onclick="createCustomRole()"><i class="fas fa-plus"></i> Create Role</button>
                        </div>
                    </div>

                    <!-- Audit Log -->
                    <div class="admin-section" id="adminAuditlog">
                        <h3><i class="fas fa-clipboard-list"></i> Audit Log</h3>
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <select class="admin-select" id="auditActionFilter" onchange="filterAuditLog()">
                                <option value="">All Actions</option>
                                <option value="user_ban">User Bans</option>
                                <option value="user_role">Role Changes</option>
                                <option value="content_remove">Content Removal</option>
                                <option value="config_change">Config Changes</option>
                                <option value="announcement">Announcements</option>
                            </select>
                            <select class="admin-select" id="auditTimeFilter" onchange="filterAuditLog()">
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div class="admin-card" style="padding: 0; overflow: hidden;">
                            <div id="adminAuditLogEntries" style="max-height: 500px; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <!-- User Profile Viewer (overlay inside Users tab) -->
                    <div id="adminProfileViewer" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <button class="admin-action-btn" onclick="closeAdminProfileViewer()"><i class="fas fa-arrow-left"></i> Back to Users</button>
                            <h3 style="color: var(--flower-pink); margin: 0;"><i class="fas fa-user-edit"></i> User Profile â€” <span id="adminProfileUsername">username</span></h3>
                        </div>
                        <div class="admin-profile-viewer">
                            <div class="admin-profile-left">
                                <div class="admin-profile-banner" id="adminProfileBanner"></div>
                                <div class="admin-profile-avatar-area">
                                    <img id="adminProfileAvatar" src="" alt="Avatar">
                                </div>
                                <div class="admin-profile-info">
                                    <h4 id="adminProfileDisplayName">Display Name</h4>
                                    <div class="username" id="adminProfileHandle">@username</div>
                                    <div class="bio" id="adminProfileBio">Bio text here</div>
                                    <div style="display: flex; gap: 8px; margin-bottom: 10px; justify-content: center;">
                                        <span class="admin-badge" id="adminProfileRole">role</span>
                                        <span class="admin-badge" id="adminProfileStatus">status</span>
                                    </div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--honey-yellow); margin-bottom: 4px;"><i class="fas fa-coins"></i> <span id="adminProfileHoneyPoints">0</span></div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Honey Points</div>
                                </div>
                                <div style="margin-top: 12px;">
                                    <button class="admin-reset-btn" onclick="adminResetAvatar()"><i class="fas fa-user-circle"></i> Reset Avatar to Default</button>
                                    <button class="admin-reset-btn" onclick="adminResetBanner()"><i class="fas fa-image"></i> Reset Banner to Default</button>
                                    <button class="admin-reset-btn" onclick="adminResetBio()"><i class="fas fa-align-left"></i> Reset Bio to Default</button>
                                    <button class="admin-reset-btn danger" onclick="adminResetAll()"><i class="fas fa-undo-alt"></i> Reset All to Defaults</button>
                                </div>
                            </div>
                            <div class="admin-profile-right">
                                <!-- Honey Points Management -->
                                <div class="admin-card">
                                    <h4><i class="fas fa-coins" style="color: var(--honey-yellow);"></i> Honey Points Management</h4>
                                    <div class="admin-honey-control">
                                        <select class="admin-select" id="adminHoneyAction" style="width: 130px;">
                                            <option value="add">Add Points</option>
                                            <option value="deduct">Deduct Points</option>
                                            <option value="set">Set Exact</option>
                                        </select>
                                        <input type="number" id="adminHoneyAmount" min="0" max="99999" value="100" placeholder="Amount">
                                        <select class="admin-select" id="adminHoneyReason" style="flex: 1;">
                                            <option value="gifted">Gifted by Admin</option>
                                            <option value="contest">Contest Prize</option>
                                            <option value="achievement">Achievement Reward</option>
                                            <option value="violation">Violation Penalty</option>
                                            <option value="illegal">Illegal Gathering</option>
                                            <option value="refund">Refund</option>
                                            <option value="other">Other</option>
                                        </select>
                                        <button class="admin-btn primary" onclick="adminApplyHoneyPoints()" style="white-space: nowrap;"><i class="fas fa-check"></i> Apply</button>
                                    </div>
                                    <div id="adminHoneyHistory" style="max-height: 150px; overflow-y: auto; font-size: 12px; color: var(--text-secondary);"></div>
                                </div>

                                <!-- Violations & Warnings -->
                                <div class="admin-card">
                                    <h4><i class="fas fa-exclamation-triangle" style="color: #FF9800;"></i> Issue Warning / Violation</h4>
                                    <div style="margin-bottom: 12px;">
                                        <select class="admin-select" id="adminViolationType" style="width: 100%; margin-bottom: 8px;">
                                            <option value="inappropriate_avatar">Inappropriate Avatar</option>
                                            <option value="inappropriate_banner">Inappropriate Banner</option>
                                            <option value="inappropriate_bio">Inappropriate Bio</option>
                                            <option value="spam">Spam / Spam Behavior</option>
                                            <option value="harassment">Harassment</option>
                                            <option value="illegal_points">Illegal Honey Points Gathering</option>
                                            <option value="tos_violation">Terms of Service Violation</option>
                                            <option value="other">Other</option>
                                        </select>
                                        <textarea class="admin-notes-area" id="adminViolationNote" placeholder="Add details about the violation..." rows="2" style="min-height: 50px;"></textarea>
                                    </div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <button class="admin-btn primary" onclick="adminIssueWarning()"><i class="fas fa-exclamation-circle"></i> Issue Warning</button>
                                        <button class="admin-btn secondary" onclick="adminIssueWarningWithBan()" style="border-color: rgba(255,152,0,0.5); color: #FF9800;"><i class="fas fa-ban"></i> Warn + 24h Edit Ban</button>
                                        <button class="admin-btn secondary" onclick="adminIssueWarningResetBan()" style="border-color: rgba(255,68,68,0.5); color: #FF4444;"><i class="fas fa-skull-crossbones"></i> Warn + Reset + 24h Ban</button>
                                    </div>
                                    <div id="adminUserWarnings" style="margin-top: 12px;"></div>
                                </div>

                                <!-- Edit Lock Status -->
                                <div class="admin-card" id="adminEditLockCard">
                                    <h4><i class="fas fa-lock" style="color: #FF4444;"></i> Profile Edit Lock</h4>
                                    <div id="adminEditLockStatus"></div>
                                </div>

                                <!-- Admin Notes (Internal) -->
                                <div class="admin-card">
                                    <h4><i class="fas fa-sticky-note" style="color: #64B5F6;"></i> Admin Notes (Internal â€” not visible to user)</h4>
                                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                        <textarea class="admin-notes-area" id="adminNoteInput" placeholder="Add an internal note about this user..." rows="2" style="min-height: 50px; flex: 1;"></textarea>
                                        <button class="admin-btn primary" onclick="adminAddNote()" style="align-self: flex-end;"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div id="adminNotesHistory" style="max-height: 200px; overflow-y: auto; background: var(--bg-secondary); border-radius: 8px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Appeals -->
                    <div class="admin-section" id="adminAppeals">
                        <h3><i class="fas fa-gavel"></i> Appeals</h3>
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <button class="admin-action-btn" id="appealTabPending" onclick="switchAppealTab('pending')" style="font-weight: 600; border-color: var(--flower-pink); color: var(--flower-pink);"><i class="fas fa-clock"></i> Pending <span class="admin-badge" style="margin-left: 6px; background: rgba(255,152,0,0.2); color: #FF9800;" id="appealPendingCount">0</span></button>
                            <button class="admin-action-btn" id="appealTabApproved" onclick="switchAppealTab('approved')"><i class="fas fa-check-circle"></i> Approved</button>
                            <button class="admin-action-btn" id="appealTabDenied" onclick="switchAppealTab('denied')"><i class="fas fa-times-circle"></i> Denied</button>
                        </div>
                        <div id="adminAppealsList"></div>
                    </div>

                    <!-- Mod Activity Log -->
                    <div class="admin-section" id="adminModlog">
                        <h3><i class="fas fa-history"></i> Moderator Activity Log</h3>
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <select class="admin-select" id="modLogModFilter" onchange="filterModLog()">
                                <option value="">All Moderators</option>
                                <option value="admin">admin</option>
                            </select>
                            <select class="admin-select" id="modLogActionFilter" onchange="filterModLog()">
                                <option value="">All Actions</option>
                                <option value="warning">Warnings Issued</option>
                                <option value="edit_ban">Edit Bans</option>
                                <option value="profile_reset">Profile Resets</option>
                                <option value="honey_adjust">Honey Point Adjustments</option>
                                <option value="report_resolved">Reports Resolved</option>
                                <option value="appeal_decision">Appeal Decisions</option>
                                <option value="user_ban">User Bans/Unbans</option>
                            </select>
                        </div>
                        <div class="admin-card" style="padding: 0; overflow: hidden;">
                            <div id="adminModLogEntries" style="max-height: 500px; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <!-- Content Search -->
                    <div class="admin-section" id="adminContentsearch">
                        <h3><i class="fas fa-search-plus"></i> Content Search</h3>
                        <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center;">
                            <div class="admin-search-wrapper" style="flex: 1; margin-bottom: 0;">
                                <i class="fas fa-search"></i>
                                <input type="text" class="admin-search" id="adminContentSearchInput" placeholder="Search posts by keyword, username, or content..." style="margin-bottom: 0;">
                            </div>
                            <select class="admin-select" id="adminContentTypeFilter" style="width: 150px;">
                                <option value="">All Types</option>
                                <option value="post">Posts</option>
                                <option value="comment">Comments</option>
                                <option value="community">Community Posts</option>
                            </select>
                            <button class="admin-btn primary" onclick="adminSearchContent()"><i class="fas fa-search"></i> Search</button>
                        </div>
                        <div id="adminContentSearchResults"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast" id="notificationToast"></div>

    <!-- JavaScript -->
    <script>
    /* ===== LOADING HELPER FUNCTIONS ===== */
    function showLoading(message = 'Connecting to Hive...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = overlay.querySelector('.loading-text');
        if (overlay && text) {
            text.textContent = message;
            overlay.style.display = 'flex';
        }
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }

    // Show loading when page loads
    window.addEventListener('load', () => {
        setTimeout(() => {
            hideLoading();
        }, 1000);
    });

    // Show loading immediately when page starts loading
    
        // ============================================
        // PROFILE SONG PLAYER
        // ============================================
        let profileSongData = null;
        let profileAudioElement = null;
        let playerUpdateInterval = null;

        function initProfileSongPlayer() {
            profileAudioElement = document.getElementById('profileAudio');
            if (!profileAudioElement) return;

            // Load saved song from localStorage
            const saved = localStorage.getItem('polleneer_profile_song');
            if (saved) {
                try {
                    profileSongData = JSON.parse(saved);
                    if (profileSongData && profileSongData.audioData) {
                        loadSongIntoPlayer(profileSongData);
                    }
                } catch(e) {
                    console.error('Error loading saved song:', e);
                    localStorage.removeItem('polleneer_profile_song');
                }
            }

            // Audio event listeners
            profileAudioElement.addEventListener('loadedmetadata', function() {
                document.getElementById('playerDuration').textContent = formatPlayerTime(profileAudioElement.duration);
            });

            profileAudioElement.addEventListener('timeupdate', updatePlayerProgress);

            profileAudioElement.addEventListener('ended', function() {
                // Check loop setting
                const settings = JSON.parse(localStorage.getItem('polleneer_player_settings') || '{}');
                if (settings.loop !== false) {
                    profileAudioElement.currentTime = 0;
                    profileAudioElement.play();
                }
            });

            profileAudioElement.addEventListener('play', function() {
                document.getElementById('profileSongPlayer').classList.add('playing');
                document.getElementById('playerPlayIcon').className = 'fas fa-pause';
                startVisualizerAnimation();
                syncCustomizePlayIcon();
            });

            profileAudioElement.addEventListener('pause', function() {
                document.getElementById('profileSongPlayer').classList.remove('playing');
                document.getElementById('playerPlayIcon').className = 'fas fa-play';
                stopVisualizerAnimation();
                syncCustomizePlayIcon();
            });

            // Set initial volume
            profileAudioElement.volume = 0.7;

            // Close settings dropdown on outside click
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('playerSettingsDropdown');
                const btn = document.getElementById('playerSettingsBtn');
                if (dropdown && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Set initial visibility based on current page
            updateProfileSongPlayerVisibility();
        }

        
        // Show/hide profile song player based on current page
        function updateProfileSongPlayerVisibility() {
            // CSS handles display via data-page attribute on <html>
            // This function only handles audio pause when leaving profile
            if (currentPage !== 'profile' && profileAudioElement && !profileAudioElement.paused) {
                profileAudioElement.pause();
            }
        }

        function triggerSongUpload() {
            document.getElementById('playerSettingsDropdown').classList.remove('show');
            document.getElementById('songFileInput').click();
        }

        function handleSongUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('File too large. Max 10MB allowed.', 'error');
                return;
            }

            // Validate file type
            if (!file.type.startsWith('audio/')) {
                showToast('Please upload an audio file (MP3, WAV, OGG, M4A)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // Extract filename as default title
                let songTitle = file.name.replace(/\.[^/.]+$/, ''); // Remove extension
                songTitle = songTitle.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Title case

                profileSongData = {
                    title: songTitle,
                    artist: 'My Collection',
                    audioData: e.target.result,
                    fileName: file.name,
                    fileSize: file.size,
                    uploadedAt: new Date().toISOString()
                };

                // Save to localStorage
                try {
                    localStorage.setItem('polleneer_profile_song', JSON.stringify(profileSongData));
                } catch(storageErr) {
                    console.warn('Song too large for localStorage, playing in session only');
                    showToast('Song loaded! (Too large to save permanently)', 'warning');
                }

                loadSongIntoPlayer(profileSongData);
                showToast('Profile song set! \u{1F3B6}');
                syncCustomizePanel();
            };

            reader.onerror = function() {
                showToast('Error reading file. Please try again.', 'error');
            };

            reader.readAsDataURL(file);
            // Reset input so same file can be re-selected
            event.target.value = '';
        }

        function loadSongIntoPlayer(songData) {
            if (!profileAudioElement || !songData) return;

            profileAudioElement.src = songData.audioData;
            document.getElementById('playerSongTitle').textContent = songData.title || 'Unknown Song';
            document.getElementById('playerSongArtist').textContent = songData.artist || 'Unknown Artist';

            // Show active player, hide empty state
            document.getElementById('playerActive').style.display = 'block';
            document.getElementById('playerEmptyState').style.display = 'none';
            document.getElementById('playerSettingsBtn').style.display = 'block';

            // Reset progress
            document.getElementById('playerProgressFill').style.width = '0%';
            document.getElementById('playerCurrentTime').textContent = '0:00';
        }

        function toggleProfileSong() {
            if (!profileAudioElement || !profileAudioElement.src) return;

            if (profileAudioElement.paused) {
                profileAudioElement.play().catch(err => {
                    console.log('Playback prevented:', err);
                });
            } else {
                profileAudioElement.pause();
            }
        }

        function updatePlayerProgress() {
            if (!profileAudioElement || !profileAudioElement.duration) return;

            const progress = (profileAudioElement.currentTime / profileAudioElement.duration) * 100;
            document.getElementById('playerProgressFill').style.width = progress + '%';
            document.getElementById('playerCurrentTime').textContent = formatPlayerTime(profileAudioElement.currentTime);

            // Also update customize panel if open
            const custFill = document.getElementById('customizeProgressFill');
            if (custFill) custFill.style.width = progress + '%';
            const custTime = document.getElementById('customizeCurrentTime');
            if (custTime) custTime.textContent = formatPlayerTime(profileAudioElement.currentTime);
            const custDur = document.getElementById('customizeDuration');
            if (custDur) custDur.textContent = formatPlayerTime(profileAudioElement.duration);
        }

        function seekProfileSong(event) {
            if (!profileAudioElement || !profileAudioElement.duration) return;

            const bar = document.getElementById('playerProgressBar');
            const rect = bar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            profileAudioElement.currentTime = percent * profileAudioElement.duration;
        }

        function setPlayerVolume(value) {
            if (!profileAudioElement) return;
            const vol = value / 100;
            profileAudioElement.volume = vol;

            const icon = document.getElementById('playerVolumeIcon');
            if (vol === 0) {
                icon.className = 'fas fa-volume-mute';
            } else if (vol < 0.5) {
                icon.className = 'fas fa-volume-down';
            } else {
                icon.className = 'fas fa-volume-up';
            }
        }

        function togglePlayerMute() {
            if (!profileAudioElement) return;
            const slider = document.getElementById('playerVolumeSlider');

            if (profileAudioElement.volume > 0) {
                profileAudioElement._savedVolume = profileAudioElement.volume;
                profileAudioElement.volume = 0;
                slider.value = 0;
            } else {
                profileAudioElement.volume = profileAudioElement._savedVolume || 0.7;
                slider.value = profileAudioElement.volume * 100;
            }
            setPlayerVolume(slider.value);
        }

        function togglePlayerSettings(event) {
            event.stopPropagation();
            document.getElementById('playerSettingsDropdown').classList.toggle('show');
        }

        function editSongInfo() {
            document.getElementById('playerSettingsDropdown').classList.remove('show');
            if (!profileSongData) return;

            const newTitle = prompt('Song title:', profileSongData.title || '');
            if (newTitle !== null) {
                profileSongData.title = newTitle || 'Untitled';
                const newArtist = prompt('Artist name:', profileSongData.artist || '');
                if (newArtist !== null) {
                    profileSongData.artist = newArtist || 'Unknown';
                }
                document.getElementById('playerSongTitle').textContent = profileSongData.title;
                document.getElementById('playerSongArtist').textContent = profileSongData.artist;

                try {
                    localStorage.setItem('polleneer_profile_song', JSON.stringify(profileSongData));
                } catch(e) {}
                showToast('Song info updated!');
            }
        }

        function removeProfileSong() {
            document.getElementById('playerSettingsDropdown').classList.remove('show');

            if (profileAudioElement) {
                profileAudioElement.pause();
                profileAudioElement.src = '';
            }

            profileSongData = null;
            localStorage.removeItem('polleneer_profile_song');

            // Show empty state, hide active player
            document.getElementById('playerActive').style.display = 'none';
            document.getElementById('playerEmptyState').style.display = 'block';
            document.getElementById('playerSettingsBtn').style.display = 'none';
            document.getElementById('profileSongPlayer').classList.remove('playing');

            showToast('Profile song removed');
        }

        function formatPlayerTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        // Visualizer animation
        let visualizerAnimFrame = null;

        function startVisualizerAnimation() {
            const bars = document.querySelectorAll('.player-visualizer-bar');
            function animate() {
                bars.forEach(bar => {
                    const height = Math.random() * 14 + 3;
                    bar.style.height = height + 'px';
                });
                visualizerAnimFrame = requestAnimationFrame(() => {
                    setTimeout(animate, 150);
                });
            }
            animate();
        }

        function stopVisualizerAnimation() {
            if (visualizerAnimFrame) {
                cancelAnimationFrame(visualizerAnimFrame);
                visualizerAnimFrame = null;
            }
            // Reset bars to static
            const bars = document.querySelectorAll('.player-visualizer-bar');
            const heights = [4, 6, 8, 5, 7];
            bars.forEach((bar, i) => {
                bar.style.height = heights[i] + 'px';
            });
        }
        // Sync customize panel with sidebar player state
        function syncCustomizePanel() {
            if (!profileSongData) {
                document.getElementById('customizeSongTitle').textContent = 'No song selected';
                document.getElementById('customizeSongArtist').textContent = 'Upload an MP3 to get started';
                document.getElementById('customizeTitleInput') && (document.getElementById('customizeTitleInput').value = '');
                document.getElementById('customizeArtistInput') && (document.getElementById('customizeArtistInput').value = '');
                if (document.getElementById('customizeSongInfoEdit')) {
                    document.getElementById('customizeSongInfoEdit').style.display = 'none';
                }
                if (document.getElementById('removeSongBtn')) {
                    document.getElementById('removeSongBtn').style.display = 'none';
                }
                return;
            }

            // Update preview
            const titleEl = document.getElementById('customizeSongTitle');
            const artistEl = document.getElementById('customizeSongArtist');
            if (titleEl) titleEl.textContent = profileSongData.title || 'Unknown Song';
            if (artistEl) artistEl.textContent = profileSongData.artist || 'Unknown Artist';

            // Update edit fields
            const titleInput = document.getElementById('customizeTitleInput');
            const artistInput = document.getElementById('customizeArtistInput');
            if (titleInput) titleInput.value = profileSongData.title || '';
            if (artistInput) artistInput.value = profileSongData.artist || '';

            // Show edit section and remove button
            if (document.getElementById('customizeSongInfoEdit')) {
                document.getElementById('customizeSongInfoEdit').style.display = 'block';
            }
            if (document.getElementById('removeSongBtn')) {
                document.getElementById('removeSongBtn').style.display = 'flex';
            }

            // Sync play icon
            syncCustomizePlayIcon();

            // Sync duration
            if (profileAudioElement && profileAudioElement.duration) {
                const durEl = document.getElementById('customizeDuration');
                if (durEl) durEl.textContent = formatPlayerTime(profileAudioElement.duration);
            }

            // Load settings
            loadPlayerSettings();
        }

        function syncCustomizePlayIcon() {
            const icon = document.getElementById('customizePlayIcon');
            if (!icon) return;
            if (profileAudioElement && !profileAudioElement.paused) {
                icon.className = 'fas fa-pause';
            } else {
                icon.className = 'fas fa-play';
            }
        }

        function updateSongInfoFromCustomize() {
            if (!profileSongData) return;

            const titleInput = document.getElementById('customizeTitleInput');
            const artistInput = document.getElementById('customizeArtistInput');

            if (titleInput) profileSongData.title = titleInput.value || 'Untitled';
            if (artistInput) profileSongData.artist = artistInput.value || 'Unknown';

            // Update sidebar player
            const sideTitle = document.getElementById('playerSongTitle');
            const sideArtist = document.getElementById('playerSongArtist');
            if (sideTitle) sideTitle.textContent = profileSongData.title;
            if (sideArtist) sideArtist.textContent = profileSongData.artist;

            // Update customize preview
            const custTitle = document.getElementById('customizeSongTitle');
            const custArtist = document.getElementById('customizeSongArtist');
            if (custTitle) custTitle.textContent = profileSongData.title;
            if (custArtist) custArtist.textContent = profileSongData.artist;

            // Save to localStorage
            try {
                localStorage.setItem('polleneer_profile_song', JSON.stringify(profileSongData));
            } catch(e) {}
        }

        function savePlayerSettings() {
            const settings = {
                autoplay: document.getElementById('autoplayToggle') ? document.getElementById('autoplayToggle').checked : true,
                loop: document.getElementById('loopToggle') ? document.getElementById('loopToggle').checked : true,
                defaultVolume: document.getElementById('defaultVolumeSlider') ? parseInt(document.getElementById('defaultVolumeSlider').value) : 70
            };

            localStorage.setItem('polleneer_player_settings', JSON.stringify(settings));

            // Apply settings immediately
            if (profileAudioElement) {
                profileAudioElement.loop = settings.loop;
                profileAudioElement.volume = settings.defaultVolume / 100;
            }

            // Update volume label
            const volLabel = document.getElementById('defaultVolumeLabel');
            if (volLabel) volLabel.textContent = settings.defaultVolume + '%';

            // Update volume slider in sidebar
            const sideVol = document.getElementById('playerVolumeSlider');
            if (sideVol) sideVol.value = settings.defaultVolume;

            // Update toggle visual states
            updateToggleVisuals();

            showToast('Player settings saved!');
        }

        function loadPlayerSettings() {
            const saved = localStorage.getItem('polleneer_player_settings');
            if (!saved) return;

            try {
                const settings = JSON.parse(saved);

                const autoplayEl = document.getElementById('autoplayToggle');
                if (autoplayEl) autoplayEl.checked = settings.autoplay !== false;

                const loopEl = document.getElementById('loopToggle');
                if (loopEl) loopEl.checked = settings.loop !== false;

                const volEl = document.getElementById('defaultVolumeSlider');
                if (volEl) volEl.value = settings.defaultVolume || 70;

                const volLabel = document.getElementById('defaultVolumeLabel');
                if (volLabel) volLabel.textContent = (settings.defaultVolume || 70) + '%';

                // Apply to audio element
                if (profileAudioElement) {
                    profileAudioElement.loop = settings.loop !== false;
                }

                updateToggleVisuals();
            } catch(e) {}
        }

        function updateToggleVisuals() {
            // Auto-play toggle
            const autoplayToggle = document.getElementById('autoplayToggle');
            const autoplaySlider = document.getElementById('autoplaySlider');
            if (autoplayToggle && autoplaySlider) {
                const parentSpan = autoplaySlider.previousElementSibling;
                if (autoplayToggle.checked) {
                    if (parentSpan) parentSpan.style.background = 'var(--honey-yellow)';
                    autoplaySlider.style.transform = 'translateX(18px)';
                    autoplaySlider.style.background = 'white';
                } else {
                    if (parentSpan) parentSpan.style.background = 'var(--bg-input)';
                    autoplaySlider.style.transform = 'translateX(0)';
                    autoplaySlider.style.background = 'var(--text-secondary)';
                }
            }

            // Loop toggle
            const loopToggle = document.getElementById('loopToggle');
            const loopSlider = document.getElementById('loopSlider');
            if (loopToggle && loopSlider) {
                const parentSpan = loopSlider.previousElementSibling;
                if (loopToggle.checked) {
                    if (parentSpan) parentSpan.style.background = 'var(--honey-yellow)';
                    loopSlider.style.transform = 'translateX(18px)';
                    loopSlider.style.background = 'white';
                } else {
                    if (parentSpan) parentSpan.style.background = 'var(--bg-input)';
                    loopSlider.style.transform = 'translateX(0)';
                    loopSlider.style.background = 'var(--text-secondary)';
                }
            }
        }




        document.addEventListener('DOMContentLoaded', () => {
        showLoading('Loading Polleneer...');
    });

    /* ===== API SERVICE ===== */
    const apiService = {
        baseUrl: 'https://polleneer-dbkzq.ondigitalocean.app/api',
        
        async request(endpoint, options = {}) {
            showLoading('Connecting to API...');
            
            const url = `${this.baseUrl}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            
            const config = { ...defaultOptions, ...options };
            
            try {
                const response = await fetch(url, config);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Request failed:', error);
                throw error;
            } finally {
                hideLoading();
            }
        },
        
        async get(endpoint) {
            return this.request(endpoint, { method: 'GET' });
        },
        
        async post(endpoint, data) {
            return this.request(endpoint, {
                method: 'POST',
                body: JSON.stringify(data),
            });
        },
        
        async put(endpoint, data) {
            return this.request(endpoint, {
                method: 'PUT',
                body: JSON.stringify(data),
            });
        },
        
        async delete(endpoint) {
            return this.request(endpoint, { method: 'DELETE' });
        }
    };
        
        // ============================================
        // GLOBAL VARIABLES AND INITIALIZATION
        // ============================================
        let currentUser = null;
        let isAdmin = false;
        let posts = [];
        let users = [];
        let notifications = [];
        let messages = [];
        let _currentPage = 'home';
        Object.defineProperty(window, 'currentPage', {
            get: function() { return _currentPage; },
            set: function(val) {
                var wasProfile = _currentPage === 'profile';
                _currentPage = val;
                document.documentElement.setAttribute('data-page', val);
                // Auto-pause profile song when leaving profile page
                if (val !== 'profile' && typeof profileAudioElement !== 'undefined' && profileAudioElement && !profileAudioElement.paused) {
                    profileAudioElement.pause();
                }
                // Remove profile custom CSS when leaving profile
                if (wasProfile && val !== 'profile') {
                    var customStyle = document.getElementById('profileCustomCSS');
                    if (customStyle) customStyle.remove();
                }
            },
            configurable: true
        });
        // Set initial value to trigger the setter
        currentPage = 'home';
        let customization = {
            colors: {},
            background: '',
            css: '',
            music: ''
        };
        let comments = {};
        let selectedBulletinOption = 'public';
        let selectedProfileTab = 'posts';
        let selectedColor = '#FFC30B';
        let selectedBackground = 'gradient';

        // Admin account
        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: 'polleneer2024',
            email: 'admin@polleneer.com',
            role: 'admin',
            honeyPoints: 9999,
            lastActive: new Date()
        };

        // Sample data
        const SAMPLE_USERS = [
            {
                id: 1,
                username: 'MichaelTheGreat',
                displayName: 'MichaelTheGreat',
                email: 'michael@example.com',
                role: 'queen',
                bio: 'Bee Keeper of Polleneer. Building the future of social media.',
                honeyPoints: 1247,
                followers: 1200,
                following: 247,
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=BeeKeeper',
                joined: '2024-01-01',
                lastActive: new Date(Date.now() - 3 * 60000),
                customization: {}
            },
            {
                id: 2,
                username: 'FloraCreative',
                displayName: 'FloraCreative',
                role: 'worker',
                bio: 'Digital artist and garden enthusiast. Love creating beautiful things.',
                honeyPoints: 892,
                followers: 843,
                following: 156,
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=FloraCreative',
                lastActive: new Date(Date.now() - 45 * 60000)
            },
            {
                id: 3,
                username: 'TechWorker',
                displayName: 'TechWorker',
                role: 'drone',
                bio: 'Exploring the intersection of technology and nature.',
                honeyPoints: 567,
                followers: 432,
                following: 189,
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=TechWorker',
                lastActive: new Date(Date.now() - 3 * 3600000)
            },
            {
                id: 4,
                username: 'ScienceBee',
                displayName: 'ScienceBee',
                role: 'honeybee',
                bio: 'Researcher and educator. Passionate about science communication.',
                honeyPoints: 1123,
                followers: 987,
                following: 210,
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=ScienceBee',
                lastActive: new Date(Date.now() - 8 * 3600000)
            }
        ];

        const SAMPLE_POSTS = [
            {
                id: 1,
                userId: 2,
                content: "Just finished designing a new garden layout that incorporates both native plants and edible crops. The cross-pollination between biodiversity and food security is fascinating! ðŸðŸŒ¸",
                tags: ['#Permaculture', '#UrbanFarming', '#BeeFriendly'],
                media: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
                likes: 127,
                comments: 18,
                pollinations: 42,
                views: 2400,
                createdAt: '2 hours ago',
                isLiked: false,
                isPollinated: true
            },
            {
                id: 2,
                userId: 3,
                content: "Working on a new algorithm that mimics bee colony optimization for solving complex routing problems. Nature's solutions are often the most elegant! ðŸðŸ’»\n\nBuilding on @FloraCreative's garden design principles.",
                tags: ['#SwarmIntelligence', '#Algorithms', '#NatureInspired', '#CrossPollination'],
                likes: 89,
                comments: 24,
                pollinations: 31,
                views: 1800,
                createdAt: '4 hours ago',
                isLiked: true,
                isPollinated: false
            },
            {
                id: 3,
                userId: 1,
                content: "Greetings, fellow pollinators! ðŸ\n\nThe hive has reached 10,000 active members today! Watching ideas cross-pollinate across disciplines has been incredible.\n\nRemember: Every idea shared here creates ripples throughout our network. Keep pollinating, keep connecting, and let's build something beautiful together.",
                tags: ['#Polleneer', '#HiveGrowth', '#CrossPollination', '#BeeTheChange'],
                media: 'https://images.unsplash.com/photo-1587923623987-c7e4083beb23?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
                likes: 521,
                comments: 89,
                pollinations: 247,
                views: 5200,
                createdAt: '6 hours ago',
                isLiked: true,
                isPollinated: true
            }
        ];

        const TRENDING_TOPICS = [
            { tag: '#WeekendVibes', category: 'Lifestyle', posts: '12.4k' },
            { tag: '#NewMusicFriday', category: 'Music', posts: '8.7k' },
            { tag: '#Gaming', category: 'Gaming', posts: '23.1k' },
            { tag: '#Foodie', category: 'Food', posts: '15.6k' },
            { tag: '#Travel', category: 'Travel', posts: '9.3k' },
            { tag: '#Fitness', category: 'Health', posts: '11.2k' }
        ];

        // Sample comments
        const SAMPLE_COMMENTS = {
            1: [
                { id: 1, userId: 3, text: 'This garden design is amazing! Could you share more details about the native plants?', createdAt: '1h ago' },
                { id: 2, userId: 4, text: 'Love the integration of food production and biodiversity! ðŸ', createdAt: '45m ago' },
                { id: 3, userId: 1, text: 'Great work! This is exactly what we need more of!', createdAt: '30m ago' }
            ],
            2: [
                { id: 4, userId: 2, text: 'Fascinating! Would love to see the code when ready.', createdAt: '2h ago' },
                { id: 5, userId: 1, text: 'Nature-inspired algorithms are the future!', createdAt: '1h ago' }
            ],
            3: [
                { id: 6, userId: 2, text: 'Congratulations on this milestone! ðŸŽ‰', createdAt: '5h ago' },
                { id: 7, userId: 3, text: '10,000 members! That\'s incredible growth!', createdAt: '4h ago' },
                { id: 8, userId: 4, text: 'Here\'s to the next 10,000! ðŸ', createdAt: '3h ago' }
            ]
        };

                // ============================================
        // CUSTOMIZATION FUNCTION
        // ============================================
        function applyCustomization() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser'));
            if (currentUser && currentUser.profileColor) {
                document.documentElement.style.setProperty('--primary', currentUser.profileColor);
            }

            const siteStyle = localStorage.getItem('siteStyle') || 'default';
            document.body.setAttribute('data-site-style', siteStyle);

            // Load saved customization object
            var saved = localStorage.getItem('polleneer_customization');
            if (saved) {
                try { customization = JSON.parse(saved); } catch(e) {}
            }

            console.log('Customization applied');
        }

        // ============================================
        // INITIALIZATION FUNCTIONS
        // ============================================
        function initializeApp() {
            const savedTheme = localStorage.getItem('polleneer_theme') || 'dark';
            const savedStyle = localStorage.getItem('polleneer_style') || 'default';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.documentElement.setAttribute('data-site-style', savedStyle);
            updateThemeIcon(savedTheme);
            updateThemePickerState(savedTheme);
            updateSettingsThemeGrid(savedTheme);
            
            comments = { ...SAMPLE_COMMENTS };
            
            const savedCustomization = localStorage.getItem('polleneer_customization');
            if (savedCustomization) {
                customization = JSON.parse(savedCustomization);
                applyCustomization();  // Now this will work!
            }
        }
        
        // ============================================
        // INITIALIZATION FUNCTIONS
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadSampleData();
            initProfileSongPlayer();
            
            const savedUser = localStorage.getItem('polleneer_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                if (currentUser.username === 'admin') {
                    isAdmin = true;
                    document.getElementById('adminPanelBtn').style.display = 'block';
                }
                showApp();
                updateUIForUser();
                loadHomeFeed();
            } else {
                showAuth();
            }
        });

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('showRegister').addEventListener('click', showRegisterForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);
            document.getElementById('forgotPassword').addEventListener('click', handleForgotPassword);
            
            document.getElementById('googleLogin').addEventListener('click', handleGoogleLogin);
            document.getElementById('githubLogin').addEventListener('click', handleGithubLogin);
            
            // Theme toggle now handled via onclick in HTML
            document.getElementById('notificationsBtn').addEventListener('click', showNotifications);
            document.getElementById('messagesBtn').addEventListener('click', showMessages);
            document.getElementById('createPostBtn').addEventListener('click', showCreatePostModal);
            document.getElementById('profileMenuBtn').addEventListener('click', showProfileMenu);
            document.getElementById('adminPanelBtn').addEventListener('click', showAdminPanel);
            
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
        }

        function loadSampleData() {
            users = [...SAMPLE_USERS];
            posts = [...SAMPLE_POSTS];
            notifications = [
                { id: 1, text: 'FloraCreative liked your post', time: '5m ago', read: false },
                { id: 2, text: 'TechWorker pollinated your idea', time: '12m ago', read: false },
                { id: 3, text: 'ScienceBee started following you', time: '1h ago', read: true },
                { id: 4, text: 'Your post is trending!', time: '2h ago', read: true }
            ];
            messages = [
                { id: 1, from: 'FloraCreative', text: 'Hey! Loved your garden post!', time: '10m ago', unread: true },
                { id: 2, from: 'TechWorker', text: 'Can we collaborate on that algorithm?', time: '1h ago', unread: true }
            ];
            
            updateBadgeCounts();
            loadTrendingTopics();
            loadSuggestedUsers();
            loadActivityFeed();
        }

        // ============================================
        // FILE UPLOAD FUNCTIONS - FIXED
        // ============================================
        function handleMediaUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                const mediaPreview = document.getElementById('mediaPreview');
                mediaPreview.innerHTML = '';
                
                for (let i = 0; i < Math.min(files.length, 4); i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        if (file.type.startsWith('image/')) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.maxWidth = '100%';
                            img.style.borderRadius = '10px';
                            img.style.marginBottom = '10px';
                            img.style.maxHeight = '200px';
                            mediaPreview.appendChild(img);
                        } else if (file.type.startsWith('video/')) {
                            const video = document.createElement('video');
                            video.src = e.target.result;
                            video.controls = true;
                            video.style.maxWidth = '100%';
                            video.style.borderRadius = '10px';
                            video.style.marginBottom = '10px';
                            video.style.maxHeight = '200px';
                            mediaPreview.appendChild(video);
                        }
                    };
                    
                    reader.readAsDataURL(file);
                }
                
                document.getElementById('postMediaContainer').classList.remove('hidden');
                showToast(`Added ${files.length} file(s) to post`);
            }
        }

        function showLinkModal() {
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkText').value = '';
            openModal('linkModal');
        }

        function addLinkFromModal() {
            const url = document.getElementById('linkUrl').value.trim();
            const text = document.getElementById('linkText').value.trim();
            
            if (!url) {
                showToast('Please enter a URL');
                return;
            }
            
            const contentEl = document.getElementById('postContent');
            if (contentEl.contentEditable === 'true') {
                contentEl.focus();
                document.execCommand('insertText', false, '\n' + (text ? '[' + text + '](' + url + ')' : url));
            } else {
                contentEl.value += '\n' + (text ? '[' + text + '](' + url + ')' : url);
            }
            
            closeModal('linkModal');
            showToast('Link added to post');
        }

        function addTagFromInput() {
            const input = document.getElementById('hashtagInput');
            let tag = input.value.trim();
            
            if (tag && !tag.startsWith('#')) {
                tag = '#' + tag;
            }
            
            if (tag) {
                const tagsContainer = document.getElementById('postTags');
                const tagElement = document.createElement('span');
                tagElement.className = 'post-tag';
                tagElement.textContent = tag;
                tagElement.onclick = function() { this.remove(); };
                tagsContainer.appendChild(tagElement);
                
                input.value = '';
                input.focus();
            }
        }

        // ============================================
        // PROFILE FUNCTIONS - FIXED
        // ============================================
        function editProfile() {
            document.getElementById('bioText').value = currentUser.bio;
            openModal('bioModal');
        }

        function saveBio() {
            const newBio = document.getElementById('bioText').value.trim();
            if (newBio) {
                currentUser.bio = newBio;
                updateUIForUser();
                localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
                closeModal('bioModal');
                showToast('Bio updated successfully!');
                
                if (currentPage === 'profile') {
                    goToProfile(selectedProfileTab);
                }
            }
        }

        function changeAvatar() {
            document.getElementById('avatarPreviewImg').src = currentUser.avatar;
            openModal('avatarModal');
        }

        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('File size must be less than 5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarPreviewImg').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveAvatar() {
            const previewImg = document.getElementById('avatarPreviewImg').src;
            if (previewImg && previewImg !== currentUser.avatar) {
                currentUser.avatar = previewImg;
                updateUIForUser();
                localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
                closeModal('avatarModal');
                showToast('Avatar updated successfully!');
                
                if (currentPage === 'profile') {
                    goToProfile(selectedProfileTab);
                }
            }
        }

        // ============================================
        // BULLETIN BOARD FUNCTIONS - FIXED
        // ============================================
        function addBulletinOption(option) {
            selectedBulletinOption = option;
            
            document.querySelectorAll('.bulletin-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
        }

        function postBulletin() {
            const text = document.getElementById('bulletinText').value.trim();
            if (!text) {
                showToast('Please write something for your bulletin');
                return;
            }
            
            showToast(`Bulletin posted as ${selectedBulletinOption}!`);
            document.getElementById('bulletinText').value = '';
            
            document.querySelectorAll('.bulletin-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector('.bulletin-option').classList.add('selected');
            selectedBulletinOption = 'public';
        }

        function manageFriends() {
            showToast('Friends management would open here. In a real app, this would show friend management options.');
        }

        function switchProfileTab(tab) {
            selectedProfileTab = tab;
            
            document.querySelectorAll('.customization-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            loadProfileFeed(tab);
        }

        // ============================================
        // CUSTOMIZATION FUNCTIONS - FIXED
        // ============================================
        function switchCustomizationTab(tab) {
            // Update tab button active states
            document.querySelectorAll('.customization-tab').forEach(function(btn) {
                btn.classList.remove('active');
                var onclick = btn.getAttribute('onclick') || '';
                if (onclick === "switchCustomizationTab('" + tab + "')") {
                    btn.classList.add('active');
                }
            });

            // Hide all sections
            document.querySelectorAll('.customization-section').forEach(function(section) {
                section.classList.remove('active');
            });

            // Show the requested section
            var section = document.getElementById(tab + 'Section');
            if (section) {
                section.classList.add('active');
                // If flair tab, populate its content
                if (tab === 'flair') {
                    var inner = document.getElementById('flairContentInner');
                    if (inner) {
                        inner.innerHTML = renderAvatarBorderSettings() + '<div style="border-top:1px solid var(--border-color);"></div>' + renderBannerBorderSettings() + '<div style="border-top:1px solid var(--border-color);"></div>' + renderMoodSettings();
                    }
                }
            }
        }

        function selectColor(color) {
            selectedColor = color;

            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-color') === color) {
                    option.classList.add('selected');
                }
            });

            var picker = document.getElementById('customColorPicker');
            if (picker) picker.value = color;
            var hexDisplay = document.getElementById('colorHexDisplay');
            if (hexDisplay) hexDisplay.textContent = color.toUpperCase();

            // Live preview in the color preview box
            var ring = document.getElementById('previewAvatarRing');
            if (ring) ring.style.borderColor = color;
            var stat1 = document.getElementById('previewStatColor');
            var stat2 = document.getElementById('previewStatColor2');
            if (stat1) stat1.style.color = color;
            if (stat2) stat2.style.color = color;
            var tabBar = document.getElementById('previewTabBar');
            if (tabBar) {
                var firstTab = tabBar.querySelector('div');
                if (firstTab) firstTab.style.borderBottomColor = color;
            }

            // LIVE PREVIEW on actual profile page if currently viewing it
            if (currentPage === 'profile') {
                applyProfileAccentColor(color);
            }
        }

        function setBackground(type) {
            selectedBackground = type;

            // Update active button
            document.querySelectorAll('.bg-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-bg-type') === type) btn.classList.add('active');
            });

            // Show/hide sub-panels
            var panels = {
                gradient: document.getElementById('bgGradientOptions'),
                solid: document.getElementById('bgSolidOptions'),
                pattern: document.getElementById('bgPatternOptions'),
                image: document.getElementById('bgImageOptions')
            };
            Object.keys(panels).forEach(function(key) {
                if (panels[key]) panels[key].style.display = key === type ? 'block' : 'none';
            });

            updateBgPreview();
        }

        var selectedGradDirection = '135deg';
        var selectedPattern = 'honeycomb';
        var bgImageData = null;

        function selectGradDirection(dir) {
            selectedGradDirection = dir;
            document.querySelectorAll('.grad-dir-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-dir') === dir) btn.classList.add('active');
            });
            updateBgPreview();
        }

        function selectPattern(pat) {
            selectedPattern = pat;
            document.querySelectorAll('.pattern-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.getAttribute('data-pattern') === pat) opt.classList.add('active');
            });
            updateBgPreview();
        }

        function handleBgImageUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image must be under 5MB');
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                bgImageData = e.target.result;
                var preview = document.getElementById('bgImagePreview');
                var container = document.getElementById('bgImagePreviewContainer');
                if (preview) { preview.src = bgImageData; }
                if (container) { container.style.display = 'block'; }
                updateBgPreview();
            };
            reader.readAsDataURL(file);
        }

        function removeBgImage() {
            bgImageData = null;
            var container = document.getElementById('bgImagePreviewContainer');
            if (container) container.style.display = 'none';
            var input = document.getElementById('bgImageUpload');
            if (input) input.value = '';
            updateBgPreview();
        }

        function getPatternCSS(pattern, patternColor) {
            var c = patternColor || '#FFC30B';
            var cEnc = encodeURIComponent(c);
            var patterns = {
                honeycomb: 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'56\' height=\'100\' viewBox=\'0 0 56 100\'%3E%3Cpath d=\'M28 66L0 50L0 16L28 0L56 16L56 50L28 66L28 100\' fill=\'none\' stroke=\'' + cEnc + '\' stroke-width=\'1.5\'/%3E%3C/svg%3E")',
                dots: 'radial-gradient(circle, ' + c + ' 1.5px, transparent 1.5px)',
                diagonal: 'repeating-linear-gradient(45deg, transparent, transparent 8px, ' + c + '33 8px, ' + c + '33 9px)',
                waves: 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'20\' viewBox=\'0 0 100 20\'%3E%3Cpath d=\'M0 10 Q25 0 50 10 Q75 20 100 10\' fill=\'none\' stroke=\'' + cEnc + '\' stroke-width=\'1.5\'/%3E%3C/svg%3E")',
                hexgrid: 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'28\' height=\'49\' viewBox=\'0 0 28 49\'%3E%3Cg fill-rule=\'evenodd\'%3E%3Cg fill=\'' + cEnc + '\' fill-opacity=\'0.2\'%3E%3Cpath d=\'M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")',
                crosshatch: 'repeating-linear-gradient(0deg, transparent, transparent 10px, ' + c + '22 10px, ' + c + '22 11px), repeating-linear-gradient(90deg, transparent, transparent 10px, ' + c + '22 10px, ' + c + '22 11px)'
            };
            var sizes = {
                honeycomb: '28px 50px',
                dots: '14px 14px',
                diagonal: 'auto',
                waves: '50px 20px',
                hexgrid: '28px 49px',
                crosshatch: 'auto'
            };
            return { image: patterns[pattern] || patterns.honeycomb, size: sizes[pattern] || 'auto' };
        }

        function getBannerBackground() {
            var config = { type: selectedBackground };
            if (selectedBackground === 'gradient') {
                var c1 = document.getElementById('bgGradColor1');
                var c2 = document.getElementById('bgGradColor2');
                config.color1 = c1 ? c1.value : '#FFC30B';
                config.color2 = c2 ? c2.value : '#FF8C00';
                config.direction = selectedGradDirection;
                if (config.direction === 'radial') {
                    config.css = 'radial-gradient(circle, ' + config.color1 + ', ' + config.color2 + ')';
                } else {
                    config.css = 'linear-gradient(' + config.direction + ', ' + config.color1 + ', ' + config.color2 + ')';
                }
            } else if (selectedBackground === 'solid') {
                var sc = document.getElementById('bgSolidColor');
                config.color = sc ? sc.value : '#1a1a2e';
                config.css = config.color;
            } else if (selectedBackground === 'pattern') {
                var bc = document.getElementById('bgPatternBaseColor');
                var pc = document.getElementById('bgPatternColor');
                config.baseColor = bc ? bc.value : '#1a1a2e';
                config.patternColor = pc ? pc.value : '#FFC30B';
                config.pattern = selectedPattern;
                var pat = getPatternCSS(config.pattern, config.patternColor);
                config.css = config.baseColor;
                config.patternImage = pat.image;
                config.patternSize = pat.size;
            } else if (selectedBackground === 'image') {
                if (bgImageData) {
                    config.imageData = bgImageData;
                    config.css = "url('" + bgImageData + "')";
                } else {
                    config.css = 'linear-gradient(135deg, var(--honey-yellow), var(--hive-orange))';
                }
            }
            return config;
        }

        function updateBgPreview() {
            var preview = document.getElementById('bgPreviewBanner');
            if (!preview) return;
            var config = getBannerBackground();
            preview.style.backgroundImage = 'none';
            preview.style.backgroundColor = 'transparent';

            if (config.type === 'gradient') {
                preview.style.background = config.css;
            } else if (config.type === 'solid') {
                preview.style.background = config.css;
            } else if (config.type === 'pattern') {
                preview.style.backgroundColor = config.baseColor;
                preview.style.backgroundImage = config.patternImage;
                preview.style.backgroundSize = config.patternSize;
            } else if (config.type === 'image' && config.imageData) {
                preview.style.backgroundImage = "url('" + config.imageData + "')";
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
            } else {
                preview.style.background = 'linear-gradient(135deg, var(--honey-yellow), var(--hive-orange))';
            }

            // Live preview on actual profile if viewing
            if (currentPage === 'profile') {
                applyBannerBackground(config);
            }
        }

        function testMusic() {
            const url = document.getElementById('musicUrl').value.trim();
            if (url) {
                showToast('Testing music... In a real app, this would play the music.');
            } else {
                showToast('Please enter a music URL');
            }
        }

        function saveCustomization() {
            // Save full color + background config
            customization.colors = { primary: selectedColor };
            customization.background = getBannerBackground();
            customization.css = document.getElementById('customCSSEditor') ? document.getElementById('customCSSEditor').value : '';

            localStorage.setItem('polleneer_customization', JSON.stringify(customization));
            showToast('Customization saved!');

            if (currentPage === 'profile') {
                applyProfileCustomization();
            }
        }

        function resetCustomization() {
            selectedColor = '#FFC30B';
            selectedBackground = 'gradient';
            selectedGradDirection = '135deg';
            selectedPattern = 'honeycomb';
            bgImageData = null;

            // Reset colors UI
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-color') === '#FFC30B') option.classList.add('selected');
            });
            var picker = document.getElementById('customColorPicker');
            if (picker) picker.value = '#FFC30B';
            var hexDisp = document.getElementById('colorHexDisplay');
            if (hexDisp) hexDisp.textContent = '#FFC30B';

            // Reset color preview
            selectColor('#FFC30B');

            // Reset background UI
            var gc1 = document.getElementById('bgGradColor1');
            var gc2 = document.getElementById('bgGradColor2');
            if (gc1) gc1.value = '#FFC30B';
            if (gc2) gc2.value = '#FF8C00';

            document.querySelectorAll('.grad-dir-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-dir') === '135deg') btn.classList.add('active');
            });

            document.querySelectorAll('.bg-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-bg-type') === 'gradient') btn.classList.add('active');
            });

            document.querySelectorAll('.pattern-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.getAttribute('data-pattern') === 'honeycomb') opt.classList.add('active');
            });

            setBackground('gradient');

            // Reset CSS editor
            var cssEditor = document.getElementById('customCSSEditor');
            if (cssEditor) cssEditor.value = '';

            // Clear saved and remove custom CSS
            customization = { colors: {}, background: '', css: '', music: customization.music || '' };
            localStorage.removeItem('polleneer_customization');

            var customStyle = document.getElementById('profileCustomCSS');
            if (customStyle) customStyle.remove();

            // Remove live preview from profile
            if (currentPage === 'profile') {
                goToProfile();
            }

            showToast('Customization reset to default');
        }

        function applyProfileAccentColor(color) {
            // Apply accent color cascade to profile page elements
            if (!color) return;

            // Avatar ring glow
            var avatar = document.getElementById('profileAvatar');
            if (avatar) {
                avatar.style.border = '4px solid ' + color;
                avatar.style.boxShadow = '0 0 15px ' + color + '44';
            }

            // Profile tab underlines (active tab)
            document.querySelectorAll('#profileTabBar button, [onclick*="switchProfileTab"]').forEach(function(tab) {
                if (tab.style.borderBottomColor && tab.style.borderBottomColor !== 'transparent') {
                    tab.style.borderBottomColor = color;
                    tab.style.color = color;
                }
            });

            // Edit Profile / Customize buttons
            var editBtn = document.querySelector('[onclick="editProfileFull()"]');
            if (editBtn) {
                editBtn.style.background = color;
                // Determine text color based on luminance
                var r = parseInt(color.slice(1,3),16), g = parseInt(color.slice(3,5),16), b = parseInt(color.slice(5,7),16);
                var lum = (0.299*r + 0.587*g + 0.114*b) / 255;
                editBtn.style.color = lum > 0.6 ? '#000' : '#FFF';
            }

            // Stat numbers (Following/Followers text)
            document.querySelectorAll('[onclick="showFollowing()"] span, [onclick="showFollowers()"] span').forEach(function(span) {
                if (span.style.color || window.getComputedStyle(span).color) {
                    // Only color the text labels, not the numbers
                }
            });
        }

        function applyBannerBackground(config) {
            var banner = document.getElementById('profileBannerArea');
            if (!banner) return;

            // Reset all background properties
            banner.style.backgroundImage = 'none';
            banner.style.backgroundColor = 'transparent';
            banner.style.backgroundSize = '';
            banner.style.backgroundPosition = '';

            if (!config || !config.type) return;

            if (config.type === 'gradient') {
                banner.style.background = config.css;
            } else if (config.type === 'solid') {
                banner.style.background = config.css;
            } else if (config.type === 'pattern') {
                banner.style.backgroundColor = config.baseColor;
                banner.style.backgroundImage = config.patternImage;
                banner.style.backgroundSize = config.patternSize;
            } else if (config.type === 'image' && config.imageData) {
                banner.style.backgroundImage = "url('" + config.imageData + "')";
                banner.style.backgroundSize = 'cover';
                banner.style.backgroundPosition = 'center';
            }
        }

        function applyProfileCustomization() {
            // Load saved customization and apply to profile
            var saved = localStorage.getItem('polleneer_customization');
            if (saved) {
                try { customization = JSON.parse(saved); } catch(e) {}
            }

            // Apply accent color
            if (customization.colors && customization.colors.primary) {
                applyProfileAccentColor(customization.colors.primary);
            }

            // Apply banner background
            if (customization.background && customization.background.type) {
                applyBannerBackground(customization.background);
            }

            // Apply custom CSS
            if (customization.css) {
                var existingStyle = document.getElementById('profileCustomCSS');
                if (!existingStyle) {
                    existingStyle = document.createElement('style');
                    existingStyle.id = 'profileCustomCSS';
                    document.head.appendChild(existingStyle);
                }
                existingStyle.textContent = customization.css;
            }
        }

        // ============================================
        // SIDEBAR FUNCTIONS - FIXED
        // ============================================
        function loadTrendingTopics() {
            const trendingList = document.getElementById('trendingList');
            if (!trendingList) return;
            
            trendingList.innerHTML = TRENDING_TOPICS.map(topic => `
                <li class="trend-item" onclick="searchTag('${topic.tag}')">
                    <div class="trend-category">${topic.category} Â· Trending</div>
                    <div class="trend-tag">${topic.tag}</div>
                    <div class="trend-stats">${topic.posts} posts</div>
                </li>
            `).join('');
        }

        function loadSuggestedUsers() {
            const suggestedUsers = document.getElementById('suggestedUsers');
            if (!suggestedUsers) return;
            
            if (!currentUser) return;
            const suggestions = users.filter(u => u.id !== currentUser.id).slice(0, 4);
            
            suggestedUsers.innerHTML = suggestions.map(user => `
                <div class="user-to-follow">
                    <div class="follow-user-info" onclick="goToUserProfile(${user.id})">
                        <img src="${user.avatar}" alt="User" class="follow-avatar">
                        <div class="follow-details">
                            <h4>${user.displayName}</h4>
                            <p>@${user.username}</p>
                        </div>
                    </div>
                    <button class="follow-btn" onclick="toggleFollow(${user.id})">
                        Follow
                    </button>
                </div>
            `).join('');
        }

        function loadActivityFeed() {
            const activityFeed = document.getElementById('activityFeed');
            if (!activityFeed) return;
            
            const activities = [
                { user: 'FloraCreative', action: 'posted a new artwork', time: '5m ago', icon: 'fas fa-palette' },
                { user: 'TechWorker', action: 'pollinated an idea about AI', time: '12m ago', icon: 'fas fa-retweet' },
                { user: 'ScienceBee', action: 'started a new discussion', time: '25m ago', icon: 'fas fa-comments' },
                { user: 'NewUser123', action: 'joined Polleneer', time: '1h ago', icon: 'fas fa-user-plus' }
            ];
            
            activityFeed.innerHTML = activities.map(activity => `
                <div class="activity-item" onclick="searchUser('${activity.user}')">
                    <div class="activity-icon">
                        <i class="${activity.icon}"></i>
                    </div>
                    <div class="activity-content">
                        <strong>${activity.user}</strong> ${activity.action}
                    </div>
                    <div class="activity-time">${activity.time}</div>
                </div>
            `).join('');
        }

        function loadCommunities() {
            const communitiesGrid = document.getElementById('communitiesGrid');
            if (!communitiesGrid) return;
            
            const communities = [
                { name: 'Art Collective', members: '3.7k', icon: 'A', color: '#FF69B4' },
                { name: 'Tech Innovators', members: '4.2k', icon: 'T', color: '#87CEEB' },
                { name: 'Music Lovers', members: '5.1k', icon: 'M', color: '#9370DB' },
                { name: 'Food & Travel', members: '2.8k', icon: 'F', color: '#FF8C00' },
                { name: 'Gaming Hub', members: '6.3k', icon: 'G', color: '#228B22' },
                { name: 'Book Club', members: '1.9k', icon: 'B', color: '#8B4513' }
            ];
            
            communitiesGrid.innerHTML = communities.map(community => `
                <div class="hive-card" style="flex-direction: column; text-align: center; padding: 20px;">
                    <div class="hive-icon" style="background: ${community.color}; margin-bottom: 10px; width: 60px; height: 60px; align-self: center;">
                        ${community.icon}
                    </div>
                    <div style="text-align: center;">
                        <h4>${community.name}</h4>
                        <div class="hive-members">${community.members} members</div>
                    </div>
                    <button class="follow-btn" style="margin-top: 10px; width: 100%;" onclick="joinCommunity('${community.name}')">
                        Join Community
                    </button>
                    <button class="action-btn" style="margin-top: 5px; width: 100%;" onclick="createCommunity()">
                        <i class="fas fa-plus"></i> Create Similar
                    </button>
                </div>
            `).join('');
        }

        function createCommunity() {
            showToast('Create community feature would open here. In a real app, you would need 50 honey points to create a community.');
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (email === ADMIN_CREDENTIALS.username || email === ADMIN_CREDENTIALS.email) {
                if (password === ADMIN_CREDENTIALS.password) {
                    currentUser = { ...ADMIN_CREDENTIALS };
                    isAdmin = true;
                    document.getElementById('adminPanelBtn').style.display = 'block';
                    showToast('Welcome back, Admin! ðŸ');
                } else {
                    showToast('Invalid password for admin account');
                    return;
                }
            } else {
                const user = users.find(u => u.email === email || u.username === email);
                if (!user || password !== 'password123') {
                    showToast('Invalid credentials. Try: admin/polleneer2024 or any username/password123');
                    return;
                }
                currentUser = { ...user };
                isAdmin = false;
            }
            
            // Ensure currentUser has all required fields for profile
            if (!currentUser.displayName) currentUser.displayName = currentUser.username || 'User';
            if (!currentUser.bio) currentUser.bio = 'Welcome to Polleneer! ðŸ';
            if (!currentUser.joined) currentUser.joined = new Date().toISOString().split('T')[0];
            if (!currentUser.followers) currentUser.followers = 0;
            if (!currentUser.following) currentUser.following = 0;
            if (!currentUser.avatar) currentUser.avatar = 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + (currentUser.username || 'User');
            if (!currentUser.id) currentUser.id = 999;

            localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
            showApp();
            updateUIForUser();
            loadHomeFeed();
            showToast(`Welcome back, ${currentUser.username}! ðŸ`);
        }

        function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const beeRole = document.getElementById('regBeeRole').value;
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match!');
                return;
            }
            
            if (users.some(u => u.username === username)) {
                showToast('Username already taken!');
                return;
            }
            
            if (users.some(u => u.email === email)) {
                showToast('Email already registered!');
                return;
            }
            
            const newUser = {
                id: users.length + 1,
                username: username,
                displayName: username,
                email: email,
                role: beeRole,
                bio: 'New to Polleneer! Ready to start pollinating ideas.',
                honeyPoints: 100,
                followers: 0,
                following: 0,
                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`,
                joined: new Date().toISOString().split('T')[0],
                customization: {}
            };
            
            users.push(newUser);
            currentUser = newUser;
            isAdmin = false;
            
            localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
            showApp();
            updateUIForUser();
            loadHomeFeed();
            showToast(`Welcome to Polleneer, ${username}! ðŸŽ‰ You've earned 100 Honey Points!`);
            showLoginForm();
        }

        function handleGoogleLogin() {
            showToast('Google login would open here.');
        }

        function handleGithubLogin() {
            showToast('GitHub login would open here.');
        }

        function handleForgotPassword(e) {
            e.preventDefault();
            showToast('Password reset email would be sent.');
        }

        function showRegisterForm(e) {
            if (e) e.preventDefault();
            document.querySelector('.auth-card').classList.add('hidden');
            document.getElementById('registerCard').classList.remove('hidden');
        }

        function showLoginForm(e) {
            if (e) e.preventDefault();
            document.getElementById('registerCard').classList.add('hidden');
            document.querySelector('.auth-card').classList.remove('hidden');
        }

        function logout() {
            if (confirm('Are you sure you want to leave the hive?')) {
                currentUser = null;
                isAdmin = false;
                localStorage.removeItem('polleneer_user');
                closeModal('profileMenuModal');
                showAuth();
                showToast('You have been logged out. Come back soon! ðŸ');
            }
        }

        // ============================================
        // UI MANAGEMENT FUNCTIONS
        // ============================================
        function showAuth() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
        }

        function updateUIForUser() {
            if (!currentUser) return;
            
            const avatars = document.querySelectorAll('#currentUserAvatar, #sidebarUserAvatar, #modalUserAvatar, #menuUserAvatar');
            avatars.forEach(avatar => {
                avatar.src = currentUser.avatar;
            });
            
            document.getElementById('sidebarUserName').textContent = currentUser.displayName;
            document.getElementById('menuUserName').textContent = currentUser.displayName;
            document.getElementById('menuUserRole').textContent = `@${currentUser.username} Â· ${getRoleName(currentUser.role)}`;
            document.getElementById('sidebarUserRole').textContent = getRoleName(currentUser.role);
            document.getElementById('sidebarHoneyPoints').textContent = currentUser.honeyPoints.toLocaleString();
            document.getElementById('honeyPoints').textContent = currentUser.honeyPoints.toLocaleString();
            document.getElementById('menuHoneyCount').textContent = currentUser.honeyPoints.toLocaleString();
            document.getElementById('menuFollowingCount').textContent = currentUser.following || 0;
            document.getElementById('menuFollowersCount').textContent = currentUser.followers || 0;
            document.getElementById('adminPanelBtn').style.display = isAdmin ? 'block' : 'none';
        }

        function getRoleName(role) {
            const roles = {
                'queen': 'Queen Bee',
                'worker': 'Worker Bee',
                'drone': 'Drone',
                'honeybee': 'Honey Bee',
                'admin': 'Admin'
            };
            return roles[role] || 'Bee';
        }

        function updateBadgeCounts() {
            const unreadNotifications = notifications.filter(n => !n.read).length;
            const unreadMessages = messages.filter(m => m.unread).length;
            
            document.getElementById('notificationBadge').textContent = unreadNotifications;
            document.getElementById('sidebarNotificationBadge').textContent = unreadNotifications;
            document.getElementById('messageBadge').textContent = unreadMessages;
            document.getElementById('sidebarMessageBadge').textContent = unreadMessages;
        }

        // ============================================
        // THEME AND STYLE FUNCTIONS
        // ============================================
        const THEME_NAMES = {
            dark: 'Night Hive',
            light: 'Sunlit Meadow',
            spring: 'Blossom Fields',
            summer: 'Honey Coast',
            autumn: 'Amber Harvest',
            winter: 'Frost Colony',
            rose: 'Rose Garden',
            crimson: 'Crimson Flame',
            emerald: 'Emerald Grove',
            gold: 'Golden Crown',
            violet: 'Violet Throne',
            steel: 'Steel Fortress',
            ember: 'Ember Blaze',
            cedar: 'Cedar Lodge',
            sapphire: 'Sapphire Depths',
            rainbow: 'Prismatic Hive'
        };

        const THEME_ICONS = {
            dark: 'fa-moon',
            light: 'fa-sun',
            spring: 'fa-seedling',
            summer: 'fa-umbrella-beach',
            autumn: 'fa-leaf',
            winter: 'fa-snowflake',
            rose: 'fa-heart',
            crimson: 'fa-fire',
            emerald: 'fa-tree',
            gold: 'fa-crown',
            violet: 'fa-gem',
            steel: 'fa-shield-alt',
            ember: 'fa-meteor',
            cedar: 'fa-campground',
            sapphire: 'fa-water',
            rainbow: 'fa-rainbow'
        };

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('polleneer_theme', theme);
            updateThemePickerState(theme);
            updateSettingsThemeGrid(theme);
            closeThemePicker();
            showToast(THEME_NAMES[theme] + ' theme activated');
        }

        function toggleTheme() {
            // Legacy support: cycle through themes
            const themes = ['dark', 'light', 'spring', 'summer', 'autumn', 'winter', 'rose', 'crimson', 'emerald', 'gold', 'violet', 'steel', 'ember', 'cedar', 'sapphire', 'rainbow'];
            const current = document.documentElement.getAttribute('data-theme');
            const idx = themes.indexOf(current);
            const next = themes[(idx + 1) % themes.length];
            setTheme(next);
        }

        function toggleThemePicker() {
            const picker = document.getElementById('themePickerDropdown');
            if (!picker) return;
            const isOpen = picker.style.display !== 'none';
            if (isOpen) {
                closeThemePicker();
            } else {
                picker.style.display = 'block';
                updateThemePickerState(document.documentElement.getAttribute('data-theme'));
                // Close on outside click
                setTimeout(() => {
                    document.addEventListener('click', closeThemePickerOutside);
                }, 10);
            }
        }

        function closeThemePicker() {
            const picker = document.getElementById('themePickerDropdown');
            if (picker) picker.style.display = 'none';
            document.removeEventListener('click', closeThemePickerOutside);
        }

        function closeThemePickerOutside(e) {
            const picker = document.getElementById('themePickerDropdown');
            const btn = document.getElementById('themeToggle');
            if (picker && !picker.contains(e.target) && btn && !btn.contains(e.target)) {
                closeThemePicker();
            }
        }

        function updateThemePickerState(theme) {
            // Update active state in picker
            document.querySelectorAll('.theme-picker-option').forEach(opt => {
                opt.classList.toggle('active', opt.getAttribute('data-theme-option') === theme);
            });
        }


        function showThemeModal() {
            // Close profile menu first
            closeAllModals();
            // Open settings and scroll to appearance
            showSettings();
        }

        // Update settings theme grid active state whenever theme changes
        function updateSettingsThemeGrid(theme) {
            document.querySelectorAll('.settings-theme-card').forEach(card => {
                const isActive = card.getAttribute('data-theme-card') === theme;
                card.style.borderColor = isActive ? 'var(--honey-yellow)' : 'transparent';
                card.style.boxShadow = isActive ? '0 0 12px var(--shadow-color)' : 'none';
            });
        }

        function updateThemeIcon(theme) {
            // Legacy â€” no longer uses moon/sun icon, uses palette icon
            // But keep function for backward compatibility
        }

        // ============================================
        // NAVIGATION FUNCTIONS
        // ============================================
        function goToHome() {
            currentPage = 'home';
            document.getElementById('mainContent').innerHTML = `
                <div class="inline-compose">
                    <div class="compose-top">
                        <img src="${currentUser.avatar}" alt="Profile" style="width:40px;height:40px;border-radius:50%;cursor:pointer;" onclick="goToProfile()">
                        <div class="compose-textarea" id="inlinePostContent" contenteditable="true" data-placeholder="What's buzzing in your mind?" oninput="handleInlineCompose(this); debouncedHighlightHashtags(this)" onfocus="expandInlineCompose()" style="outline:none;"></div>
                    </div>
                    <div class="media-preview-inline" id="inlineMediaPreview"></div>
                    <div class="compose-actions hidden" id="inlineComposeActions">
                        <div class="compose-btns">
                            <button onclick="triggerInlineMedia()" title="Media"><i class="fas fa-image"></i></button>
                            <button onclick="showGifPicker()" title="GIF"><span class="gif-label">GIF</span></button>
                            <button onclick="window._emojiTarget='inlinePostContent';showStickerPicker()" title="Stickers"><i class="fas fa-note-sticky"></i></button>
                            <button onclick="showEmojiPickerInline()" title="Emoji"><i class="fas fa-face-smile"></i></button>
                            <button onclick="showLinkModal()" title="Link"><i class="fas fa-link"></i></button>
                            <button onclick="createPollInline()" title="Poll"><i class="fas fa-poll"></i></button>
                            <button onclick="showLocationPicker()" title="Location"><i class="fas fa-map-marker-alt"></i></button>
                            <button onclick="showSchedulePost()" title="Schedule"><i class="fas fa-clock"></i></button>
                            <button onmousedown="event.preventDefault()" onclick="toggleBold()" title="Bold"><i class="fas fa-bold"></i></button>
                            <button onmousedown="event.preventDefault()" onclick="toggleItalic()" title="Italic"><i class="fas fa-italic"></i></button>
                            <input type="file" id="inlineMediaUpload" accept="image/*,video/*" style="display:none;" onchange="handleInlineMediaUpload(event)">
                        </div>
                        <button class="compose-submit" id="inlineBuzzBtn" onclick="submitInlinePost()" disabled>
                            <i class="fas fa-feather-alt"></i> Buzz
                        </button>
                    </div>
                </div>
                <div class="feed" id="homeFeed"></div>
            `;
            loadHomeFeed();
            updateProfileSongPlayerVisibility();
            updateActiveNavLink('home');
        }

        function goToExplore() {
            currentPage = 'explore';
            document.getElementById('mainContent').innerHTML = `
                <div class="customization-panel">
                    <h3 style="margin-bottom: 20px; color: var(--honey-yellow);"><i class="fas fa-hashtag"></i> Explore Polleneer</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                        ${TRENDING_TOPICS.map(topic => `
                            <div class="trend-item" style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; cursor: pointer;" onclick="searchTag('${topic.tag}')">
                                <div class="trend-category">${topic.category} Â· Trending</div>
                                <div class="trend-tag">${topic.tag}</div>
                                <div class="trend-stats">${topic.posts} posts</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="feed" id="exploreFeed"></div>
            `;
            loadExploreFeed();
            updateProfileSongPlayerVisibility();
            updateActiveNavLink('explore');
        }

        function goToProfile(section = 'posts') {
            currentPage = 'profile';
            selectedProfileTab = section;
            const user = currentUser;
            
            document.getElementById('mainContent').innerHTML = `
                <div class="profile-page">
                    <div class="profile-header" id="profileHeader">
                        <div class="profile-banner" id="profileBanner"></div>
                        <div class="profile-info">
                            <img src="${user.avatar}" alt="Profile" class="profile-avatar-large" id="profileAvatar" onclick="changeAvatar()">
                            <div class="profile-details">
                                <div class="profile-name">${user.displayName}</div>
                                <div class="profile-username">@${user.username}${getUserStatusHTML(user)}</div>
                                <div class="profile-bio">${user.bio}</div>
                                <div class="profile-stats">
                                    <div class="stat-item" onclick="showFollowers()">
                                        <div class="stat-number">${user.followers || 0}</div>
                                        <div class="stat-label">Followers</div>
                                    </div>
                                    <div class="stat-item" onclick="showFollowing()">
                                        <div class="stat-number">${user.following || 0}</div>
                                        <div class="stat-label">Following</div>
                                    </div>
                                    <div class="stat-item" onclick="showHoneyShop()">
                                        <div class="stat-number">${user.honeyPoints.toLocaleString()}</div>
                                        <div class="stat-label">Honey Points</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">${user.joined}</div>
                                        <div class="stat-label">Joined</div>
                                    </div>
                                </div>
                                <div class="profile-actions">
                                    <button class="profile-btn primary" onclick="showCustomization()">
                                        <i class="fas fa-paint-brush"></i> Customize Profile
                                    </button>
                                    <button class="profile-btn secondary" onclick="editProfile()">
                                        <i class="fas fa-edit"></i> Edit Profile
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profile song player is now in the right sidebar -->
                    
                    <!-- Bulletin Posts -->
                    <div class="bulletin-section">
                        <h4 style="margin-bottom: 15px;"><i class="fas fa-bullhorn"></i> Bulletin Board</h4>
                        <div class="bulletin-form">
                            <textarea placeholder="Post a bulletin to your profile..." id="bulletinText"></textarea>
                            <div class="bulletin-options">
                                <button class="bulletin-option selected" onclick="addBulletinOption('public')">
                                    <i class="fas fa-globe"></i> Public
                                </button>
                                <button class="bulletin-option" onclick="addBulletinOption('friends')">
                                    <i class="fas fa-user-friends"></i> Friends Only
                                </button>
                                <button class="bulletin-option" onclick="addBulletinOption('survey')">
                                    <i class="fas fa-poll"></i> Survey
                                </button>
                            </div>
                            <button class="pollinate-btn" onclick="postBulletin()" style="width: 100%;">
                                <i class="fas fa-paper-plane"></i> Post Bulletin
                            </button>
                        </div>
                    </div>
                    
                    <!-- Top Friends -->
                    <div class="friends-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4><i class="fas fa-star"></i> Top Friends</h4>
                            <button class="action-btn" onclick="manageFriends()">
                                <i class="fas fa-cog"></i> Manage
                            </button>
                        </div>
                        <div class="friends-grid" id="topFriendsGrid">
                            <!-- Friends will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Profile Tabs -->
                    <div class="customization-tabs" style="margin-bottom: 20px;">
                        <button class="customization-tab ${section === 'posts' ? 'active' : ''}" onclick="switchProfileTab('posts')">
                            <i class="fas fa-feather-alt"></i> Posts
                        </button>
                        <button class="customization-tab ${section === 'comments' ? 'active' : ''}" onclick="switchProfileTab('comments')">
                            <i class="fas fa-comment"></i> Comments
                        </button>
                        <button class="customization-tab ${section === 'media' ? 'active' : ''}" onclick="switchProfileTab('media')">
                            <i class="fas fa-image"></i> Media
                        </button>
                        <button class="customization-tab ${section === 'likes' ? 'active' : ''}" onclick="switchProfileTab('likes')">
                            <i class="fas fa-heart"></i> Likes
                        </button>
                    </div>
                    
                    <div class="feed" id="profileFeed"></div>
                </div>
            `;
            
            applyProfileCustomization();
            loadProfileFeed(section);
            loadTopFriends();
            updateProfileSongPlayerVisibility();
            updateActiveNavLink('profile');

        }

        function goToBookmarks() {
            currentPage = 'bookmarks';
            document.getElementById('mainContent').innerHTML = `
                <div class="customization-panel">
                    <h3 style="margin-bottom: 20px; color: var(--honey-yellow);"><i class="fas fa-bookmark"></i> Bookmarks</h3>
                    <p style="color: var(--text-secondary);">Posts you've saved for later.</p>
                </div>
                <div class="feed" id="bookmarksFeed"></div>
            `;
            loadBookmarksFeed();
            updateProfileSongPlayerVisibility();
            updateActiveNavLink('bookmarks');
        }

        function goToCommunities() {
            currentPage = 'communities';
            document.getElementById('mainContent').innerHTML = `
                <div class="customization-panel">
                    <h3 style="margin-bottom: 20px; color: var(--honey-yellow);"><i class="fas fa-users"></i> Communities</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;" id="communitiesGrid"></div>
                </div>
            `;
            loadCommunities();
            updateProfileSongPlayerVisibility();
            updateActiveNavLink('communities');
        }

        function updateActiveNavLink(page) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Pause profile audio when leaving profile page
            if (page !== 'profile' && typeof profileAudioElement !== 'undefined' && profileAudioElement && !profileAudioElement.paused) {
                profileAudioElement.pause();
            }
            
            const navLinks = {
                'home': document.querySelector('.nav-link[onclick="goToHome()"]'),
                'explore': document.querySelector('.nav-link[onclick="goToExplore()"]'),
                'profile': document.querySelector('.nav-link[onclick="goToProfile()"]'),
                'bookmarks': document.querySelector('.nav-link[onclick="goToBookmarks()"]'),
                'communities': document.querySelector('.nav-link[onclick="goToCommunities()"]')
            };
            
            if (navLinks[page]) {
                navLinks[page].classList.add('active');
            }
        }

        // ============================================
        // POST FUNCTIONS
        // ============================================
        function loadHomeFeed() {
            const feed = document.getElementById('homeFeed');
            if (!feed) return;
            
            feed.innerHTML = posts.map(post => createPostHTML(post)).join('');
        }

        function loadExploreFeed() {
            const feed = document.getElementById('exploreFeed');
            if (!feed) return;
            
            feed.innerHTML = posts.map(post => createPostHTML(post)).join('');
        }

        function loadProfileFeed(section = 'posts') {
            const feed = document.getElementById('profileFeed');
            if (!feed) return;
            
            const userPosts = posts.filter(post => post.userId === currentUser.id);
            feed.innerHTML = userPosts.map(post => createPostHTML(post)).join('');
        }

        function loadBookmarksFeed() {
            const feed = document.getElementById('bookmarksFeed');
            if (!feed) return;
            
            const bookmarkedPosts = posts.filter(post => post.isLiked);
            feed.innerHTML = bookmarkedPosts.map(post => createPostHTML(post)).join('');
        }

        function createPostHTML(post) {
            const user = users.find(u => u.id === post.userId);
            if (!user) return '';
            
            const postComments = comments[post.id] || [];
            
            return `
                <div class="post-card" id="post-${post.id}">
                    <div class="post-header">
                        <div class="post-user" onclick="goToUserProfile(${user.id})">
                            <img src="${user.avatar}" alt="User" class="post-avatar">
                            <div class="user-name-role">
                                <div class="user-name">
                                    ${user.displayName}
                                    <span class="user-role-badge">${getRoleName(user.role)}</span>
                                </div>
                                <div class="post-meta">@${user.username} Â· ${post.createdAt}</div>
                            </div>
                        </div>
                        
                        <div class="post-options">
                            <button class="options-btn" onclick="toggleOptionsMenu(${post.id})">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div class="options-menu" id="options-menu-${post.id}">
                                <button class="option-item" onclick="savePost(${post.id})">
                                    <i class="fas fa-bookmark"></i>
                                    <span>Save post</span>
                                </button>
                                <button class="option-item" onclick="copyPostLink(${post.id})">
                                    <i class="fas fa-link"></i>
                                    <span>Copy link</span>
                                </button>
                                ${post.userId === currentUser.id ? `
                                <button class="option-item" onclick="editPost(${post.id})">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit post</span>
                                </button>
                                <button class="option-item" onclick="deletePost(${post.id})" style="color: #ff6b6b;">
                                    <i class="fas fa-trash"></i>
                                    <span>Delete post</span>
                                </button>
                                ` : `
                                <button class="option-item" onclick="reportPost(${post.id})" style="color: #ff6b6b;">
                                    <i class="fas fa-flag"></i>
                                    <span>Report post</span>
                                </button>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <div class="post-content">${formatPostContent(post.content)}</div>
                    
                    ${post.tags && post.tags.length > 0 ? `
                    <div class="post-tags">
                        ${post.tags.map(tag => `<span class="post-tag" onclick="searchTag('${tag}')">${tag}</span>`).join('')}
                    </div>
                    ` : ''}
                    
                    ${post.media ? `
                    <div class="post-media">
                        <img src="${post.media}" alt="Post media" class="post-image" onclick="viewMedia('${post.media}')">
                    </div>
                    ` : ''}
                    
                    <div class="post-stats">
                        <div class="stat">
                            <i class="fas fa-retweet"></i>
                            <span>${post.pollinations} Pollinations</span>
                        </div>
                        <div class="stat">
                            <i class="fas fa-comment"></i>
                            <span>${post.comments} Comments</span>
                        </div>
                        <div class="stat">
                            <i class="fas fa-heart"></i>
                            <span>${post.likes} Likes</span>
                        </div>
                        <div class="stat">
                            <i class="fas fa-chart-line"></i>
                            <span>${post.views.toLocaleString()} Views</span>
                        </div>
                    </div>
                    
                    <div class="post-actions-bar">
                        <button class="post-action-btn ${post.isLiked ? 'liked' : ''}" onclick="likePost(${post.id})">
                            <i class="${post.isLiked ? 'fas' : 'far'} fa-heart"></i>
                            <span>${post.isLiked ? 'Liked' : 'Like'}</span>
                        </button>
                        <button class="post-action-btn" onclick="toggleComments(${post.id})">
                            <i class="far fa-comment"></i>
                            <span>Comment</span>
                        </button>
                        <button class="post-action-btn ${post.isPollinated ? 'pollinated' : ''}" onclick="pollinatePost(${post.id})">
                            <i class="${post.isPollinated ? 'fas' : 'far'} fa-retweet"></i>
                            <span>${post.isPollinated ? 'Pollinated' : 'Pollinate'}</span>
                        </button>
                        <button class="post-action-btn" onclick="sharePost(${post.id})">
                            <i class="far fa-share-square"></i>
                            <span>Share</span>
                        </button>
                    </div>
                    
                    <div class="comments-section" id="comments-${post.id}">
                        <div id="comments-list-${post.id}">
                            ${postComments.map(comment => `
                                <div class="comment">
                                    <img src="${users.find(u => u.id === comment.userId)?.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=default'}" alt="User" class="comment-avatar">
                                    <div class="comment-content">
                                        <div class="comment-header">
                                            <div class="comment-author">${users.find(u => u.id === comment.userId)?.displayName || 'User'}</div>
                                            <div class="comment-time">${comment.createdAt}</div>
                                        </div>
                                        <div class="comment-text">${comment.text}</div>
                                        <div class="comment-actions">
                                            <button class="comment-action" onclick="likeComment(${post.id}, ${comment.id})">Like</button>
                                            <button class="comment-action" onclick="replyToComment(${post.id}, ${comment.id})">Reply</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="add-comment">
                            <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment..." onkeypress="if(event.key === 'Enter') addComment(${post.id})">
                            <button class="comment-submit-btn" onclick="addComment(${post.id})">Post</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatPostContent(content) {
            return content
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/@(\w+)/g, '<a href="#" onclick="searchUser(\'$1\')" class="hashtag-link" style="color: var(--honey-yellow);">@$1</a>')
                .replace(/#([\w\u00C0-\u024F]+)/g, '<a href="#" onclick="searchTag(\'#$1\')" class="hashtag-link">#$1</a>')
                .replace(/\n/g, '<br>');
        }

        // ============================================
        // POST INTERACTION FUNCTIONS
        // ============================================
        function likePost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            
            post.isLiked = !post.isLiked;
            post.likes += post.isLiked ? 1 : -1;
            
            const postElement = document.getElementById(`post-${postId}`);
            if (postElement) {
                const likeBtn = postElement.querySelector('.post-action-btn');
                const likeIcon = likeBtn.querySelector('i');
                const likeText = likeBtn.querySelector('span');
                
                likeBtn.classList.toggle('liked');
                likeIcon.className = post.isLiked ? 'fas fa-heart' : 'far fa-heart';
                likeText.textContent = post.isLiked ? 'Liked' : 'Like';
                
                const stats = postElement.querySelectorAll('.stat');
                if (stats[2]) {
                    stats[2].querySelector('span').textContent = `${post.likes} Likes`;
                }
                
                likeBtn.classList.add('clicked');
                setTimeout(() => likeBtn.classList.remove('clicked'), 300);
            }
            
            if (post.isLiked && post.userId !== currentUser.id) {
                currentUser.honeyPoints += 5;
                updateUIForUser();
                localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
                showToast('+5 Honey Points for liking a post! ðŸ¯');
            }
        }

        function toggleComments(postId) {
            if (!currentUser) {
                showToast('Please login to comment');
                return;
            }
            
            const commentsSection = document.getElementById(`comments-${postId}`);
            if (commentsSection) {
                commentsSection.classList.toggle('show');
                const commentInput = document.getElementById(`comment-input-${postId}`);
                if (commentInput && commentsSection.classList.contains('show')) {
                    commentInput.focus();
                }
            }
        }

        function addComment(postId) {
            if (!currentUser) {
                showToast('Please login to comment');
                return;
            }
            
            const commentInput = document.getElementById(`comment-input-${postId}`);
            const commentText = commentInput.value.trim();
            
            if (!commentText) {
                showToast('Please enter a comment');
                return;
            }
            
            if (!comments[postId]) {
                comments[postId] = [];
            }
            
            const newComment = {
                id: comments[postId].length + 1,
                userId: currentUser.id,
                text: commentText,
                createdAt: 'Just now'
            };
            
            comments[postId].push(newComment);
            
            const post = posts.find(p => p.id === postId);
            if (post) {
                post.comments += 1;
            }
            
            const commentsList = document.getElementById(`comments-list-${postId}`);
            if (commentsList) {
                const commentHTML = `
                    <div class="comment">
                        <img src="${currentUser.avatar}" alt="User" class="comment-avatar">
                        <div class="comment-content">
                            <div class="comment-header">
                                <div class="comment-author">${currentUser.displayName}</div>
                                <div class="comment-time">Just now</div>
                            </div>
                            <div class="comment-text">${commentText}</div>
                            <div class="comment-actions">
                                <button class="comment-action" onclick="likeComment(${postId}, ${newComment.id})">Like</button>
                                <button class="comment-action" onclick="replyToComment(${postId}, ${newComment.id})">Reply</button>
                            </div>
                        </div>
                    </div>
                `;
                commentsList.innerHTML += commentHTML;
            }
            
            commentInput.value = '';
            
            const postElement = document.getElementById(`post-${postId}`);
            if (postElement) {
                const stats = postElement.querySelectorAll('.stat');
                if (stats[1]) {
                    stats[1].querySelector('span').textContent = `${post.comments} Comments`;
                }
            }
            
            currentUser.honeyPoints += 10;
            updateUIForUser();
            localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
            showToast('+10 Honey Points for commenting! ðŸ¯');
        }

        function likeComment(postId, commentId) {
            showToast('Liked comment!');
        }

        function replyToComment(postId, commentId) {
            const commentInput = document.getElementById(`comment-input-${postId}`);
            commentInput.focus();
            commentInput.value = '@reply ';
            showToast('Ready to reply! Mention added.');
        }

        function pollinatePost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            
            post.isPollinated = !post.isPollinated;
            post.pollinations += post.isPollinated ? 1 : -1;
            
            const postElement = document.getElementById(`post-${postId}`);
            if (postElement) {
                const pollinateBtn = postElement.querySelector('.post-action-btn:nth-child(3)');
                const pollinateIcon = pollinateBtn.querySelector('i');
                const pollinateText = pollinateBtn.querySelector('span');
                
                pollinateBtn.classList.toggle('pollinated');
                pollinateIcon.className = post.isPollinated ? 'fas fa-retweet' : 'far fa-retweet';
                pollinateText.textContent = post.isPollinated ? 'Pollinated' : 'Pollinate';
                
                const stats = postElement.querySelectorAll('.stat');
                if (stats[0]) {
                    stats[0].querySelector('span').textContent = `${post.pollinations} Pollinations`;
                }
                
                pollinateBtn.classList.add('clicked');
                setTimeout(() => pollinateBtn.classList.remove('clicked'), 300);
            }
            
            if (post.isPollinated && post.userId !== currentUser.id) {
                currentUser.honeyPoints += 15;
                updateUIForUser();
                localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
                showToast('+15 Honey Points for pollinating an idea! ðŸ¯');
            }
        }

        function sharePost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            
            const shareUrl = `https://polleneer.com/post/${postId}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast('Post link copied to clipboard! ðŸ“‹');
            }).catch(() => {
                prompt('Copy this link to share:', shareUrl);
            });
        }

        function toggleOptionsMenu(postId) {
            const menu = document.getElementById(`options-menu-${postId}`);
            if (menu) {
                menu.classList.toggle('show');
                
                document.querySelectorAll('.options-menu.show').forEach(otherMenu => {
                    if (otherMenu !== menu) {
                        otherMenu.classList.remove('show');
                    }
                });
            }
        }

        // ============================================
        // POST CREATION FUNCTIONS
        // ============================================
        function submitPost() {
            const content = getPlainText('postContent').trim();
            if (!content) {
                showToast('Please write something before posting!');
                return;
            }
            
            const newPost = {
                id: posts.length + 1,
                userId: currentUser.id,
                content: content,
                tags: extractHashtags(getPlainText('postContent')),
                media: document.getElementById('mediaPreview').querySelector('img')?.src || null,
                likes: 0,
                comments: 0,
                pollinations: 0,
                views: 0,
                createdAt: 'Just now',
                isLiked: false,
                isPollinated: false
            };
            
            posts.unshift(newPost);
            
            clearEditable('postContent');
            // postTags removed
            document.getElementById('mediaPreview').innerHTML = '';
            document.getElementById('postMediaContainer').classList.add('hidden');
            document.getElementById('postPollContainer').classList.add('hidden');
            
            closeModal('createPostModal');
            
            if (currentPage === 'home') {
                loadHomeFeed();
            }
            
            currentUser.honeyPoints += 25;
            updateUIForUser();
            localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
            
            showToast('Post created successfully! +25 Honey Points ðŸ¯');
        }

        function createPoll() {
            const pollContainer = document.getElementById('postPollContainer');
            const pollOptions = document.getElementById('pollOptions');
            
            pollContainer.classList.remove('hidden');
            pollOptions.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" class="form-control" placeholder="Option 1" style="flex: 1;">
                    <button class="action-btn" onclick="removePollOption(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" class="form-control" placeholder="Option 2" style="flex: 1;">
                    <button class="action-btn" onclick="removePollOption(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }

        function addPollOption() {
            const pollOptions = document.getElementById('pollOptions');
            const optionCount = pollOptions.children.length + 1;
            const newOption = document.createElement('div');
            newOption.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" class="form-control" placeholder="Option ${optionCount}" style="flex: 1;">
                    <button class="action-btn" onclick="removePollOption(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            pollOptions.appendChild(newOption);
        }

        function removePollOption(button) {
            button.closest('div[style*="display: flex"]').remove();
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showToast(message) {
            const toast = document.getElementById('notificationToast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function loadTopFriends() {
            const friendsGrid = document.getElementById('topFriendsGrid');
            if (!friendsGrid) return;
            
            const friends = users.filter(u => u.id !== currentUser.id).slice(0, 8);
            
            friendsGrid.innerHTML = friends.map(friend => `
                <div class="friend-card" onclick="goToUserProfile(${friend.id})">
                    <img src="${friend.avatar}" alt="Friend" class="friend-avatar">
                    <div class="friend-name">${friend.username}</div>
                </div>
            `).join('');
        }

        function toggleFollow(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const button = event.target;
            const isFollowing = button.classList.contains('following');
            
            if (isFollowing) {
                button.classList.remove('following');
                button.textContent = 'Follow';
                user.followers -= 1;
                currentUser.following -= 1;
            } else {
                button.classList.add('following');
                button.textContent = 'Following';
                user.followers += 1;
                currentUser.following += 1;
            }
            
            updateUIForUser();
            localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
        }

        function joinCommunity(name) {
            showToast(`Joined ${name} community! ðŸŽ‰`);
        }

        function searchTag(tag) {
            currentPage = 'search';
            const cleanTag = tag.toLowerCase();
            const matchingPosts = posts.filter(p => {
                const contentMatch = p.content && p.content.toLowerCase().includes(cleanTag);
                const tagMatch = p.tags && p.tags.some(t => t.toLowerCase() === cleanTag);
                return contentMatch || tagMatch;
            });
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                        <button onclick="goToHome()" style="background:none;border:none;color:var(--text-primary);cursor:pointer;font-size:20px;"><i class="fas fa-arrow-left"></i></button>
                        <h2 style="color: var(--honey-yellow);"><i class="fas fa-hashtag"></i> ${tag.replace('#','')}</h2>
                        <span style="color: var(--text-secondary); font-size: 14px;">${matchingPosts.length} post${matchingPosts.length !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="feed" id="tagFeed"></div>
                </div>`;
            const feedEl = document.getElementById('tagFeed');
            if (matchingPosts.length === 0) {
                feedEl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary);"><i class="fas fa-hashtag" style="font-size:48px;margin-bottom:15px;opacity:0.3;display:block;"></i><p>No posts found with this hashtag yet.</p></div>';
            } else {
                feedEl.innerHTML = matchingPosts.map(post => createPostHTML(post)).join('');
            }
        }

        function searchUser(username) {
            showToast(`Searching for @${username}...`);
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                showToast(`Searching for "${query}"...`);
            }
        }

        function handleSearch() {
            // Real-time search would be implemented here
        }

        function goToUserProfile(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                alert(`Viewing ${user.username}'s profile.`);
            }
        }

        function showHoneyShop() {
            alert('Honey Shop would open here.');
        }

        function refreshSuggestions() {
            loadSuggestedUsers();
            showToast('Suggestions refreshed!');
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function showCreatePostModal() {
            openModal('createPostModal');
        }

        function showProfileMenu() {
            openModal('profileMenuModal');
        }

        function showCustomization() {
            openModal('customizationModal');
            closeModal('profileMenuModal');
            syncCustomizePanel();
        }

        function showAdminPanel() {
            if (isAdmin) {
                openModal('adminPanelModal');
            }
        }

        function showNotifications() {
            const unreadCount = notifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                notifications.forEach(n => n.read = true);
                updateBadgeCounts();
            }
            
            alert(`You have ${notifications.length} notifications.`);
        }

        function showMessages() {
            const unreadCount = messages.filter(m => m.unread).length;
            if (unreadCount > 0) {
                messages.forEach(m => m.unread = false);
                updateBadgeCounts();
            }
            
            alert(`You have ${messages.length} messages.`);
        }

        function showSettings() {
            currentPage = 'settings';
            alert('Settings panel would open here.');
        }

        function showHelp() {
            alert('Help center would open here.');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Close menus when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.options-btn') && !e.target.closest('.options-menu')) {
                document.querySelectorAll('.options-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });
    


// ============================================
// PHASE 1 FIXES: All broken/stub functions replaced
// ============================================

// 1. showCreatePostModal - was empty, now properly opens modal and sets user avatar
function showCreatePostModal() {
    if (!currentUser) { showToast('Please log in first!'); return; }
    const modalAvatar = document.getElementById('modalUserAvatar');
    if (modalAvatar) modalAvatar.src = currentUser.avatar;
    clearEditable('postContent');
    const mediaPreview = document.getElementById('mediaPreview');
    if (mediaPreview) mediaPreview.style.display = 'none';
    // Tags removed
    const pollContainer = document.getElementById('postPollContainer');
    if (pollContainer) pollContainer.style.display = 'none';
    openModal('createPostModal');
    document.getElementById('postContent').focus();
}

// 2. showHoneyShop - was just an alert, now builds full shop UI
function showHoneyShop() {
    if (!currentUser) { showToast('Please log in first!'); return; }
    const shopItems = [
        { id: 1, name: 'Golden Theme', desc: 'Animated golden background for your profile', cost: 500, icon: 'fa-crown', category: 'Profile' },
        { id: 2, name: 'Hovering Avatar', desc: 'Your avatar floats with a honey glow', cost: 1000, icon: 'fa-ghost', category: 'Profile' },
        { id: 3, name: 'Custom Badge', desc: 'Choose a unique badge for your name', cost: 250, icon: 'fa-certificate', category: 'Profile' },
        { id: 4, name: 'Featured Post (24h)', desc: 'Pin your post to the top of feeds', cost: 1500, icon: 'fa-star', category: 'Posts' },
        { id: 5, name: 'Animated Border', desc: 'Glowing animated border on your posts', cost: 400, icon: 'fa-border-all', category: 'Posts' },
        { id: 6, name: 'Private Hive', desc: 'Create an invite-only community', cost: 1000, icon: 'fa-lock', category: 'Community' },
        { id: 7, name: 'Events Calendar', desc: 'Add events to your hive', cost: 900, icon: 'fa-calendar', category: 'Community' },
        { id: 8, name: 'Stealth Mode', desc: 'Browse without showing online status', cost: 750, icon: 'fa-user-secret', category: 'Social' },
        { id: 9, name: 'Scheduled Posts', desc: 'Queue posts for later', cost: 450, icon: 'fa-clock', category: 'Social' },
        { id: 10, name: 'Virtual Honey Jar', desc: 'Send a honey jar gift to friends', cost: 50, icon: 'fa-jar', category: 'Gifts' },
        { id: 11, name: 'Bee Sticker Pack', desc: '12 animated bee stickers', cost: 150, icon: 'fa-face-smile', category: 'Gifts' },
        { id: 12, name: 'Pollen Burst Effect', desc: 'Sparkle effect when you pollinate', cost: 300, icon: 'fa-sparkles', category: 'Effects' },
        { id: 13, name: 'Nectar Trail', desc: 'Leave a golden trail on visited profiles', cost: 600, icon: 'fa-route', category: 'Effects' },
        { id: 14, name: 'Hive Analytics Pro', desc: 'Detailed stats on your posts', cost: 800, icon: 'fa-chart-line', category: 'Tools' },
        { id: 15, name: 'Auto-Buzz Greeting', desc: 'Auto-welcome new followers', cost: 200, icon: 'fa-hand-wave', category: 'Tools' }
    ];

    const categories = [...new Set(shopItems.map(i => i.category))];

    document.getElementById('mainContent').innerHTML = `
        <div class="customization-panel" style="max-width: 800px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="color: var(--honey-yellow);"><i class="fas fa-store"></i> Honey Shop</h3>
                <div style="background: linear-gradient(135deg, var(--honey-yellow), var(--hive-orange)); padding: 8px 20px; border-radius: 20px; font-weight: bold; color: #000;">
                    ðŸ¯ ${currentUser.honeyPoints.toLocaleString()} Honey Points
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button onclick="filterShop('all')" class="action-btn" style="background: var(--honey-yellow); color: #000; border: none; padding: 6px 15px; border-radius: 20px; cursor: pointer; font-size: 13px;">All</button>
                ${categories.map(c => `<button onclick="filterShop('${c}')" class="action-btn" style="background: var(--bg-card); border: 1px solid var(--border-color); padding: 6px 15px; border-radius: 20px; cursor: pointer; font-size: 13px;">${c}</button>`).join('')}
            </div>

            <div id="shopGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px;">
                ${shopItems.map(item => `
                    <div class="post-card" style="padding: 20px; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='none'">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <i class="fas ${item.icon}" style="font-size: 2em; color: var(--honey-yellow);"></i>
                        </div>
                        <h4 style="margin-bottom: 5px; text-align: center;">${item.name}</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-bottom: 15px;">${item.desc}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--honey-yellow); font-weight: bold;">ðŸ¯ ${item.cost}</span>
                            <button onclick="buyShopItem(${item.id}, '${item.name}', ${item.cost})" 
                                style="background: ${currentUser.honeyPoints >= item.cost ? 'var(--honey-yellow)' : 'var(--bg-input)'}; 
                                       color: ${currentUser.honeyPoints >= item.cost ? '#000' : 'var(--text-secondary)'}; 
                                       border: none; padding: 6px 15px; border-radius: 15px; cursor: pointer; font-size: 12px; font-weight: bold;">
                                ${currentUser.honeyPoints >= item.cost ? 'Buy' : 'Need More'}
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    updateActiveNavLink('shop');
}

function buyShopItem(id, name, cost) {
    if (currentUser.honeyPoints < cost) {
        showToast(`Not enough honey! You need ${cost - currentUser.honeyPoints} more points.`);
        return;
    }
    if (confirm(`Buy "${name}" for ðŸ¯ ${cost} Honey Points?`)) {
        currentUser.honeyPoints -= cost;
        localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
        showToast(`ðŸŽ‰ Purchased "${name}"! -${cost} honey points`);
        showHoneyShop(); // Refresh
    }
}

function filterShop(category) {
    // Re-render with filter - simple approach: re-trigger showHoneyShop
    showHoneyShop();
    if (category !== 'all') {
        const items = document.querySelectorAll('#shopGrid .post-card');
        // Hide items not matching (using data approach isn't possible, so just show toast)
        showToast(`Showing ${category} items`);
    }
}

// 3. showSettings - was empty, now builds full settings page
function showSettings() {
    if (!currentUser) { showToast('Please log in first!'); return; }
    currentPage = 'settings';
    const savedTheme = localStorage.getItem('polleneer_theme') || 'dark';

    document.getElementById('mainContent').innerHTML = `
        <div class="customization-panel">
            <h3 style="margin-bottom: 25px; color: var(--honey-yellow);"><i class="fas fa-cog"></i> Settings</h3>

            <div class="post-card" style="padding: 20px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-user"></i> Account</h4>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 10px; background: var(--bg-input);">
                        <div><strong>Username</strong><br><span style="color: var(--text-secondary); font-size: 13px;">@${currentUser.username}</span></div>
                        <button onclick="editSettingsField('username')" style="background: var(--honey-yellow); color: #000; border: none; padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">Edit</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 10px; background: var(--bg-input);">
                        <div><strong>Email</strong><br><span style="color: var(--text-secondary); font-size: 13px;">${currentUser.email || 'Not set'}</span></div>
                        <button onclick="editSettingsField('email')" style="background: var(--honey-yellow); color: #000; border: none; padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">Edit</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 10px; background: var(--bg-input);">
                        <div><strong>Password</strong><br><span style="color: var(--text-secondary); font-size: 13px;">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span></div>
                        <button onclick="editSettingsField('password')" style="background: var(--honey-yellow); color: #000; border: none; padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">Change</button>
                    </div>
                </div>
            </div>

            <div class="post-card" style="padding: 20px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-palette"></i> Appearance</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;" id="settingsThemeGrid">
                    <button class="settings-theme-card" onclick="setTheme('dark')" data-theme-card="dark" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: #0F0F0F; border: 2px solid #333;"></div>
                        <div style="font-size: 12px; font-weight: 600;">Night Hive</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('light')" data-theme-card="light" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #F5E6B8, #D49B00); border: 2px solid #DEBB6E;"></div>
                        <div style="font-size: 12px; font-weight: 600;">Sunlit Meadow</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('spring')" data-theme-card="spring" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #FFB7C5, #98FB98);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Blossom Fields</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('summer')" data-theme-card="summer" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #FF9F43, #00CEC9);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Honey Coast</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('autumn')" data-theme-card="autumn" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #E67E22, #C0392B);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Amber Harvest</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('winter')" data-theme-card="winter" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #5DADE2, #9B59B6);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Frost Colony</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('rose')" data-theme-card="rose" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #FF1493, #DA70D6);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Rose Garden</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('crimson')" data-theme-card="crimson" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #DC143C, #FF4500);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Crimson Flame</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('emerald')" data-theme-card="emerald" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #00C853, #1B5E20);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Emerald Grove</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('gold')" data-theme-card="gold" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #FFD700, #FFA000);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Golden Crown</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('violet')" data-theme-card="violet" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #9C27B0, #6A1B9A);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Violet Throne</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('steel')" data-theme-card="steel" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #78909C, #37474F);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Steel Fortress</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('ember')" data-theme-card="ember" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #FF6D00, #E65100);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Ember Blaze</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('cedar')" data-theme-card="cedar" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #8D6E63, #4E342E);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Cedar Lodge</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('sapphire')" data-theme-card="sapphire" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #1E88E5, #0D47A1);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Sapphire Depths</div>
                    </button>
                    <button class="settings-theme-card" onclick="setTheme('rainbow')" data-theme-card="rainbow" style="padding: 12px; border-radius: 12px; border: 2px solid transparent; background: var(--bg-input); cursor: pointer; text-align: center; color: var(--text-primary);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; background: linear-gradient(135deg, #FF1493, #FF4500, #FFD700, #00E676, #42A5F5, #CE93D8);"></div>
                        <div style="font-size: 12px; font-weight: 600;">Prismatic Hive</div>
                    </button>
                </div>
            </div>

            <div class="post-card" style="padding: 20px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-lock"></i> Security & Account Access</h4>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input);">
                        <div><strong>Two-Factor Authentication</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Add an extra layer of security to your account</span></div>
                        <button onclick="showToast('2FA setup will be available with backend integration.')" style="background: var(--honey-yellow); color: #000; border: none; padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">Set Up</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input);">
                        <div><strong>Login Activity</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Review recent logins and active sessions</span></div>
                        <button onclick="showLoginActivity()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">View</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input);">
                        <div><strong>Connected Apps</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Manage third-party apps with access to your account</span></div>
                        <button onclick="showToast('Connected apps management coming soon.')" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">Manage</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input);">
                        <div><strong>Login Alerts</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Get notified of unrecognized login attempts</span></div>
                        <input type="checkbox" checked onchange="saveSettingsToggle('loginAlerts', this.checked)" data-setting="loginAlerts" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input);">
                        <div><strong>Password Requirements</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Require strong passwords (8+ chars, mixed case, numbers)</span></div>
                        <input type="checkbox" checked onchange="saveSettingsToggle('strongPassword', this.checked)" data-setting="strongPassword" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                    </div>
                </div>
            </div>

            <div class="post-card" style="padding: 20px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-shield-alt"></i> Privacy & Safety</h4>
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">Control who can see your content and interact with you</p>

                <div style="margin-bottom: 16px;">
                    <h5 style="margin-bottom: 10px; color: var(--honey-yellow); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Account Privacy</h5>
                    <div style="display: grid; gap: 10px;">
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Private Account</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Only approved followers can see your posts</span></div>
                            <input type="checkbox" onchange="saveSettingsToggle('privateAccount', this.checked)" data-setting="privateAccount" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Profile Discoverability</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Allow your profile to appear in search results and suggestions</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('discoverable', this.checked)" data-setting="discoverable" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Show Online Status</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Others can see when you are active</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('showOnline', this.checked)" data-setting="showOnline" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <h5 style="margin-bottom: 10px; color: var(--honey-yellow); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Direct Messages</h5>
                    <div style="display: grid; gap: 10px;">
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Allow Direct Messages</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Let anyone send you messages</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('allowDMs', this.checked)" data-setting="allowDMs" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Message Requests Filter</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Filter message requests from accounts you don't follow</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('filterMsgRequests', this.checked)" data-setting="filterMsgRequests" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Read Receipts</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Let others know when you have read their messages</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('readReceipts', this.checked)" data-setting="readReceipts" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <h5 style="margin-bottom: 10px; color: var(--honey-yellow); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Content & Interactions</h5>
                    <div style="display: grid; gap: 10px;">
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Hide Sensitive Content</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Blur media that may contain sensitive material</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('hideSensitive', this.checked)" data-setting="hideSensitive" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Allow Tagging</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Let others tag you in posts and media</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('allowTagging', this.checked)" data-setting="allowTagging" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Allow Mentions</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Let anyone @mention you in posts</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('allowMentions', this.checked)" data-setting="allowMentions" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Comment Filtering</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Automatically hide comments containing offensive language</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('commentFilter', this.checked)" data-setting="commentFilter" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                    </div>
                </div>

                <div>
                    <h5 style="margin-bottom: 10px; color: var(--honey-yellow); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Blocked & Muted</h5>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input);">
                            <div><strong>Blocked Accounts</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Manage accounts you have blocked</span></div>
                            <button onclick="showBlockedAccounts()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">View</button>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input);">
                            <div><strong>Muted Accounts</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Manage accounts you have muted</span></div>
                            <button onclick="showMutedAccounts()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">View</button>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input);">
                            <div><strong>Muted Words</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Hide posts containing specific words or phrases</span></div>
                            <button onclick="showMutedWords()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">Manage</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="post-card" style="padding: 20px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-bell"></i> Notifications</h4>
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">Choose how and when you want to be notified</p>

                <div style="margin-bottom: 16px;">
                    <h5 style="margin-bottom: 10px; color: var(--honey-yellow); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Push Notifications</h5>
                    <div style="display: grid; gap: 10px;">
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Likes</strong><br><span style="color: var(--text-secondary); font-size: 13px;">When someone likes your post</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('notifLikes', this.checked)" data-setting="notifLikes" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Comments</strong><br><span style="color: var(--text-secondary); font-size: 13px;">When someone comments on your post</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('notifComments', this.checked)" data-setting="notifComments" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Repollinations</strong><br><span style="color: var(--text-secondary); font-size: 13px;">When someone reposts your content</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('notifReposts', this.checked)" data-setting="notifReposts" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>New Followers</strong><br><span style="color: var(--text-secondary); font-size: 13px;">When someone follows you</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('notifFollows', this.checked)" data-setting="notifFollows" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Mentions</strong><br><span style="color: var(--text-secondary); font-size: 13px;">When someone mentions you in a post</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('notifMentions', this.checked)" data-setting="notifMentions" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Direct Messages</strong><br><span style="color: var(--text-secondary); font-size: 13px;">When you receive a new message</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('notifDMs', this.checked)" data-setting="notifDMs" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <h5 style="margin-bottom: 10px; color: var(--honey-yellow); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Email Notifications</h5>
                    <div style="display: grid; gap: 10px;">
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Email Digest</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Receive a daily summary of activity on your account</span></div>
                            <input type="checkbox" onchange="saveSettingsToggle('emailDigest', this.checked)" data-setting="emailDigest" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>New Follower Emails</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Get an email when someone new follows you</span></div>
                            <input type="checkbox" onchange="saveSettingsToggle('emailFollows', this.checked)" data-setting="emailFollows" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Direct Message Emails</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Get an email for unread messages</span></div>
                            <input type="checkbox" onchange="saveSettingsToggle('emailDMs', this.checked)" data-setting="emailDMs" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Product Updates</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Hear about new features and improvements</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('emailProduct', this.checked)" data-setting="emailProduct" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                    </div>
                </div>

                <div>
                    <h5 style="margin-bottom: 10px; color: var(--honey-yellow); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Sound & Vibration</h5>
                    <div style="display: grid; gap: 10px;">
                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                            <div><strong>Notification Sounds</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Play a sound when you receive a notification</span></div>
                            <input type="checkbox" checked onchange="saveSettingsToggle('notifSounds', this.checked)" data-setting="notifSounds" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                        </label>
                    </div>
                </div>
            </div>

            <div class="post-card" style="padding: 20px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-universal-access"></i> Accessibility</h4>
                <div style="display: grid; gap: 10px;">
                    <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                        <div><strong>Reduce Motion</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Minimize animations and auto-playing media</span></div>
                        <input type="checkbox" onchange="saveSettingsToggle('reduceMotion', this.checked)" data-setting="reduceMotion" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                    </label>
                    <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                        <div><strong>High Contrast</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Increase contrast for better readability</span></div>
                        <input type="checkbox" onchange="saveSettingsToggle('highContrast', this.checked)" data-setting="highContrast" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                    </label>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input);">
                        <div><strong>Font Size</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Adjust the text size across the platform</span></div>
                        <select onchange="saveSettingsToggle('fontSize', this.value)" data-setting="fontSize" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 13px;">
                            <option value="small">Small</option>
                            <option value="medium" selected>Medium</option>
                            <option value="large">Large</option>
                            <option value="xlarge">Extra Large</option>
                        </select>
                    </div>
                    <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                        <div><strong>Auto-Play Media</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Automatically play GIFs and videos in feed</span></div>
                        <input type="checkbox" checked onchange="saveSettingsToggle('autoPlayMedia', this.checked)" data-setting="autoPlayMedia" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                    </label>
                </div>
            </div>

            <div class="post-card" style="padding: 20px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-database"></i> Data & Storage</h4>
                <div style="display: grid; gap: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input);">
                        <div><strong>Download Your Data</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Request a copy of all your Polleneer data</span></div>
                        <button onclick="showToast('Data export will be available with backend integration.')" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">Request</button>
                    </div>
                    <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input); cursor: pointer;">
                        <div><strong>Data Saver Mode</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Reduce data usage by loading lower quality images</span></div>
                        <input type="checkbox" onchange="saveSettingsToggle('dataSaver', this.checked)" data-setting="dataSaver" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">
                    </label>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: var(--bg-input);">
                        <div><strong>Clear Cache</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Free up storage by clearing cached data</span></div>
                        <button onclick="if(confirm('Clear all cached data? This won\\\\t delete your account or posts.')) { localStorage.removeItem('polleneer_cache'); showToast('Cache cleared!'); }" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">Clear</button>
                    </div>
                </div>
            </div>

            <div class="post-card" style="padding: 20px; border: 1px solid rgba(255,0,0,0.3);">
                <h4 style="margin-bottom: 15px; color: #FF4444;"><i class="fas fa-exclamation-triangle"></i> Danger Zone</h4>
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">Irreversible actions that affect your account</p>
                <div style="display: grid; gap: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: rgba(255,68,68,0.05); border: 1px solid rgba(255,68,68,0.2);">
                        <div><strong style="color: #FF4444;">Deactivate Account</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Temporarily disable your account. You can reactivate anytime.</span></div>
                        <button onclick="if(confirm('Are you sure you want to deactivate your account? You can reactivate anytime.')) showToast('Account deactivation will be available with backend integration.')" 
                            style="background: transparent; border: 1px solid #FF4444; color: #FF4444; padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">Deactivate</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: rgba(255,68,68,0.05); border: 1px solid rgba(255,68,68,0.2);">
                        <div><strong style="color: #FF4444;">Delete Account</strong><br><span style="color: var(--text-secondary); font-size: 13px;">Permanently delete your account and all data. This cannot be undone.</span></div>
                        <button onclick="if(confirm('This will PERMANENTLY delete your account and all your data. This action CANNOT be undone. Are you absolutely sure?')) showToast('Account deletion will be available with backend integration.')" 
                            style="background: #FF4444; border: none; color: #fff; padding: 6px 15px; border-radius: 10px; cursor: pointer; font-size: 12px;">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    updateActiveNavLink('settings');
    loadSettingsToggles();
}

function editSettingsField(field) {
    const newValue = prompt(`Enter new ${field}:`);
    if (newValue && newValue.trim()) {
        currentUser[field] = newValue.trim();
        localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
        showToast(`${field.charAt(0).toUpperCase() + field.slice(1)} updated!`);
        showSettings();
    }
}

// Settings toggle persistence
function saveSettingsToggle(key, value) {
    var settings = {};
    try { settings = JSON.parse(localStorage.getItem('polleneer_settings') || '{}'); } catch(e) {}
    settings[key] = value;
    localStorage.setItem('polleneer_settings', JSON.stringify(settings));
    showToast('Setting updated');
}

function loadSettingsToggles() {
    var settings = {};
    try { settings = JSON.parse(localStorage.getItem('polleneer_settings') || '{}'); } catch(e) {}
    document.querySelectorAll('[data-setting]').forEach(function(el) {
        var key = el.getAttribute('data-setting');
        if (settings.hasOwnProperty(key)) {
            if (el.type === 'checkbox') el.checked = settings[key];
            else if (el.tagName === 'SELECT') el.value = settings[key];
        }
    });
}

function showLoginActivity() {
    var now = new Date();
    var sessions = [
        { device: 'Chrome on Windows', location: 'Your current session', time: 'Active now', current: true },
        { device: 'Safari on iPhone', location: 'New York, US', time: now.toLocaleDateString() + ' at ' + now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}), current: false },
        { device: 'Firefox on macOS', location: 'Los Angeles, US', time: new Date(now - 86400000).toLocaleDateString(), current: false }
    ];
    var content = '<div style="padding:20px;"><h4 style="margin-bottom:15px;">Login Activity</h4>';
    sessions.forEach(function(s) {
        content += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:var(--bg-input);margin-bottom:8px;">' +
            '<div><strong>' + s.device + '</strong>' + (s.current ? ' <span style="color:var(--honey-yellow);font-size:11px;"> (Current)</span>' : '') +
            '<br><span style="color:var(--text-secondary);font-size:13px;">' + s.location + ' â€” ' + s.time + '</span></div>' +
            (s.current ? '' : '<button onclick="showToast(\'Session revoked\')" style="background:transparent;border:1px solid #FF4444;color:#FF4444;padding:4px 12px;border-radius:8px;cursor:pointer;font-size:12px;">Revoke</button>') +
        '</div>';
    });
    content += '<button onclick="showToast(\'All other sessions revoked\')" style="margin-top:12px;background:#FF4444;border:none;color:#fff;padding:8px 20px;border-radius:10px;cursor:pointer;font-size:13px;width:100%;">Revoke All Other Sessions</button></div>';
    openModal('genericSettingsModal');
    document.getElementById('genericSettingsModalBody').innerHTML = content;
}

function showBlockedAccounts() {
    openModal('genericSettingsModal');
    document.getElementById('genericSettingsModalBody').innerHTML = '<div style="padding:20px;text-align:center;">' +
        '<i class="fas fa-ban" style="font-size:40px;color:var(--text-secondary);margin-bottom:12px;"></i>' +
        '<h4 style="margin-bottom:8px;">No Blocked Accounts</h4>' +
        '<p style="color:var(--text-secondary);font-size:14px;">When you block someone, they won\\t be able to see your profile or contact you.</p></div>';
}

function showMutedAccounts() {
    openModal('genericSettingsModal');
    document.getElementById('genericSettingsModalBody').innerHTML = '<div style="padding:20px;text-align:center;">' +
        '<i class="fas fa-volume-mute" style="font-size:40px;color:var(--text-secondary);margin-bottom:12px;"></i>' +
        '<h4 style="margin-bottom:8px;">No Muted Accounts</h4>' +
        '<p style="color:var(--text-secondary);font-size:14px;">Muted accounts can still follow you and interact, but you won\\t see their posts in your feed.</p></div>';
}

function showMutedWords() {
    openModal('genericSettingsModal');
    document.getElementById('genericSettingsModalBody').innerHTML = '<div style="padding:20px;">' +
        '<h4 style="margin-bottom:12px;">Muted Words</h4>' +
        '<p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Posts containing these words will be hidden from your feed.</p>' +
        '<div style="display:flex;gap:8px;margin-bottom:16px;">' +
            '<input type="text" id="mutedWordInput" placeholder="Add a word or phrase..." style="flex:1;padding:10px 14px;border-radius:10px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);font-size:14px;">' +
            '<button onclick="addMutedWord()" style="background:var(--honey-yellow);color:#000;border:none;padding:10px 18px;border-radius:10px;cursor:pointer;font-weight:600;">Add</button>' +
        '</div>' +
        '<div id="mutedWordsList"></div>' +
        '</div>';
    renderMutedWords();
}

function addMutedWord() {
    var input = document.getElementById('mutedWordInput');
    var word = (input.value || '').trim();
    if (!word) return;
    var words = [];
    try { words = JSON.parse(localStorage.getItem('polleneer_muted_words') || '[]'); } catch(e) {}
    if (words.indexOf(word) === -1) words.push(word);
    localStorage.setItem('polleneer_muted_words', JSON.stringify(words));
    input.value = '';
    renderMutedWords();
    showToast('Word muted: ' + word);
}

function removeMutedWord(word) {
    var words = [];
    try { words = JSON.parse(localStorage.getItem('polleneer_muted_words') || '[]'); } catch(e) {}
    words = words.filter(function(w) { return w !== word; });
    localStorage.setItem('polleneer_muted_words', JSON.stringify(words));
    renderMutedWords();
    showToast('Word unmuted');
}

function renderMutedWords() {
    var words = [];
    try { words = JSON.parse(localStorage.getItem('polleneer_muted_words') || '[]'); } catch(e) {}
    var container = document.getElementById('mutedWordsList');
    if (!container) return;
    if (words.length === 0) {
        container.innerHTML = '<p style="color:var(--text-secondary);font-size:13px;text-align:center;">No muted words yet</p>';
        return;
    }
    container.innerHTML = words.map(function(w) {
        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-radius:8px;background:var(--bg-input);margin-bottom:6px;">' +
            '<span style="font-size:14px;">' + w + '</span>' +
            '<button onclick="removeMutedWord(\'' + w.replace(/'/g, "\\\\'") + '\')" style="background:transparent;border:none;color:#FF4444;cursor:pointer;font-size:16px;"><i class="fas fa-times"></i></button>' +
        '</div>';
    }).join('');
}


// 4. showHelp - was empty, now shows help center
function showHelp() {
    document.getElementById('mainContent').innerHTML = `
        <div class="customization-panel">
            <h3 style="margin-bottom: 25px; color: var(--honey-yellow);"><i class="fas fa-question-circle"></i> Help Center</h3>

            <div id="helpAccordion">
                ${[
                    { q: 'What is Polleneer?', a: 'Polleneer is a bee-themed social platform where your interactions mimic pollination. Every post spreads ideas like pollen, every share cross-pollinates content, and together we build a thriving digital hive.' },
                    { q: 'What are Honey Points?', a: 'Honey Points are our reward currency. Earn them by posting (+25), commenting (+10), getting likes (+5), getting pollinations (+15), gaining followers (+20), and daily logins (+50). Spend them in the Honey Shop!' },
                    { q: 'What are Bee Roles?', a: 'Every member has a role in the hive. You start as a Worker Bee and can evolve through activity: Worker â†’ Creator â†’ Pollinator â†’ Scholar â†’ Social Bee. Earn enough and become a Golden Bee or Legend Bee!' },
                    { q: 'How does Pollination work?', a: 'Pollination is like retweeting â€” you spread someone\'s post to your followers, cross-pollinating ideas across the hive. The original creator earns +15 Honey Points!' },
                    { q: 'What are Hives/Communities?', a: 'Hives are communities where bees with shared interests gather. Create or join hives to find your people and share focused content.' },
                    { q: 'How do I customize my profile?', a: 'Click your profile menu â†’ Customization. You can change colors, backgrounds, add music, and even write custom CSS. Some premium options are available in the Honey Shop.' },
                    { q: 'What is the Golden Hive Algorithm?', a: 'Our algorithm learns what content resonates with you and serves posts that nourish your interests. Unlike other platforms, we optimize for depth of connection, not just engagement.' },
                    { q: 'How do I become a Genesis Pollinator?', a: 'The first 1,000 members are forever etched as Genesis Pollinators â€” founding members of the hive. Your username will be in our Genesis Hall!' },
                ].map((faq, i) => `
                    <div class="post-card" style="padding: 15px; margin-bottom: 10px; cursor: pointer;" onclick="toggleFAQ(${i})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${faq.q}</strong>
                            <i class="fas fa-chevron-down" id="faq-icon-${i}" style="transition: transform 0.3s; color: var(--honey-yellow);"></i>
                        </div>
                        <div id="faq-answer-${i}" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); color: var(--text-secondary); line-height: 1.6;">
                            ${faq.a}
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="post-card" style="padding: 20px; margin-top: 20px; text-align: center;">
                <h4 style="margin-bottom: 10px;">Still need help?</h4>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Reach out to the hive architect</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <a href="https://twitter.com/wegotheaven" target="_blank" style="background: var(--bg-input); padding: 8px 15px; border-radius: 10px; text-decoration: none; color: var(--text-primary);"><i class="fab fa-twitter"></i> @wegotheaven</a>
                    <a href="https://instagram.com/kingoftheinnocent" target="_blank" style="background: var(--bg-input); padding: 8px 15px; border-radius: 10px; text-decoration: none; color: var(--text-primary);"><i class="fab fa-instagram"></i> @kingoftheinnocent</a>
                    <a href="https://tiktok.com/@kingoftheinnocent" target="_blank" style="background: var(--bg-input); padding: 8px 15px; border-radius: 10px; text-decoration: none; color: var(--text-primary);"><i class="fab fa-tiktok"></i> @kingoftheinnocent</a>
                </div>
            </div>
        </div>
    `;
}

function toggleFAQ(index) {
    const answer = document.getElementById(`faq-answer-${index}`);
    const icon = document.getElementById(`faq-icon-${index}`);
    if (answer.style.display === 'none') {
        answer.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
    } else {
        answer.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}



// 5. showProfileMenu - was empty, now properly opens the modal with updated user data
function showProfileMenu() {
    if (!currentUser) return;
    document.getElementById('menuUserAvatar').src = currentUser.avatar;
    document.getElementById('menuUserName').textContent = currentUser.displayName || currentUser.username;
    document.getElementById('menuUserRole').textContent = getRoleName(currentUser.role);
    document.getElementById('menuFollowersCount').textContent = currentUser.followers.toLocaleString();
    document.getElementById('menuFollowingCount').textContent = currentUser.following.toLocaleString();
    document.getElementById('menuHoneyCount').textContent = currentUser.honeyPoints.toLocaleString();
    openModal('profileMenuModal');
}

// 6 & 7. OAuth handlers - show proper "coming soon" with context
function handleGoogleLogin() {
    showToast('ðŸ Google Sign-In coming soon! Use email login for now.');
}

function handleGithubLogin() {
    showToast('ðŸ GitHub Sign-In coming soon! Use email login for now.');
}

// 8. handleForgotPassword - now shows a proper reset form
function handleForgotPassword(e) {
    if (e) e.preventDefault();
    const email = prompt('Enter your email address for password reset:');
    if (email && email.includes('@')) {
        showToast('ðŸ“§ Password reset link sent! Check your email.');
    } else if (email) {
        showToast('Please enter a valid email address.');
    }
}

// 9 & 10 & 11. Search functions - now actually filter and display results
function searchUser(username) {
    const query = username.replace('@', '').toLowerCase();
    const results = users.filter(u => 
        u.username.toLowerCase().includes(query) || 
        (u.displayName && u.displayName.toLowerCase().includes(query))
    );

    if (results.length === 0) {
        showToast(`No users found matching "${username}"`);
        return;
    }

    document.getElementById('mainContent').innerHTML = `
        <div class="customization-panel">
            <h3 style="margin-bottom: 20px; color: var(--honey-yellow);">
                <i class="fas fa-search"></i> User Results for "${username}"
            </h3>
            <div style="display: grid; gap: 10px;">
                ${results.map(user => `
                    <div class="post-card" style="padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer;" onclick="goToUserProfile(${user.id})">
                        <img src="${user.avatar}" alt="${user.username}" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--honey-yellow);">
                        <div style="flex: 1;">
                            <strong>${user.displayName || user.username}</strong>
                            <div style="color: var(--text-secondary); font-size: 13px;">@${user.username} Â· ${getRoleName(user.role)}</div>
                            <div style="color: var(--text-secondary); font-size: 12px; margin-top: 3px;">${user.bio || ''}</div>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: var(--honey-yellow); font-size: 13px;">ðŸ¯ ${user.honeyPoints}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
            <button onclick="goToHome()" style="margin-top: 15px; background: var(--bg-input); border: 1px solid var(--border-color); padding: 8px 20px; border-radius: 10px; cursor: pointer; color: var(--text-primary);">
                <i class="fas fa-arrow-left"></i> Back to Feed
            </button>
        </div>
    `;
}

function searchTag(tag) {
    const query = tag.replace('#', '').toLowerCase();
    const results = posts.filter(p => 
        p.tags && p.tags.some(t => t.toLowerCase().includes(query))
    );

    document.getElementById('mainContent').innerHTML = `
        <div class="customization-panel">
            <h3 style="margin-bottom: 20px; color: var(--honey-yellow);">
                <i class="fas fa-hashtag"></i> ${tag}
            </h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">${results.length} posts</p>
            <div id="tagFeed">${results.length > 0 ? results.map(post => createPostHTML(post)).join('') : '<div class="post-card" style="padding: 30px; text-align: center; color: var(--text-secondary);">No posts found for this tag yet. Be the first to buzz about it! ðŸ</div>'}</div>
            <button onclick="goToHome()" style="margin-top: 15px; background: var(--bg-input); border: 1px solid var(--border-color); padding: 8px 20px; border-radius: 10px; cursor: pointer; color: var(--text-primary);">
                <i class="fas fa-arrow-left"></i> Back to Feed
            </button>
        </div>
    `;
}

function handleSearch() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return;
    const query = searchInput.value.trim();
    if (!query) return;

    if (query.startsWith('@')) {
        searchUser(query);
    } else if (query.startsWith('#')) {
        searchTag(query);
    } else {
        // General search - search both users and posts
        const userResults = users.filter(u => 
            u.username.toLowerCase().includes(query.toLowerCase()) ||
            (u.displayName && u.displayName.toLowerCase().includes(query.toLowerCase())) ||
            (u.bio && u.bio.toLowerCase().includes(query.toLowerCase()))
        );
        const postResults = posts.filter(p => 
            p.content.toLowerCase().includes(query.toLowerCase()) ||
            (p.tags && p.tags.some(t => t.toLowerCase().includes(query.toLowerCase())))
        );

        document.getElementById('mainContent').innerHTML = `
            <div class="customization-panel">
                <h3 style="margin-bottom: 20px; color: var(--honey-yellow);">
                    <i class="fas fa-search"></i> Results for "${query}"
                </h3>

                ${userResults.length > 0 ? `
                    <h4 style="margin-bottom: 10px; color: var(--text-secondary);">People</h4>
                    <div style="display: grid; gap: 10px; margin-bottom: 25px;">
                        ${userResults.slice(0, 5).map(user => `
                            <div class="post-card" style="padding: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="goToUserProfile(${user.id})">
                                <img src="${user.avatar}" alt="${user.username}" style="width: 40px; height: 40px; border-radius: 50%;">
                                <div>
                                    <strong>${user.displayName || user.username}</strong>
                                    <div style="color: var(--text-secondary); font-size: 12px;">@${user.username}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${postResults.length > 0 ? `
                    <h4 style="margin-bottom: 10px; color: var(--text-secondary);">Posts</h4>
                    <div>${postResults.map(post => createPostHTML(post)).join('')}</div>
                ` : ''}

                ${userResults.length === 0 && postResults.length === 0 ? `
                    <div class="post-card" style="padding: 40px; text-align: center;">
                        <i class="fas fa-search" style="font-size: 3em; color: var(--text-secondary); margin-bottom: 15px;"></i>
                        <h4>No results found</h4>
                        <p style="color: var(--text-secondary);">Try searching for users (@name), tags (#topic), or keywords</p>
                    </div>
                ` : ''}

                <button onclick="goToHome()" style="margin-top: 15px; background: var(--bg-input); border: 1px solid var(--border-color); padding: 8px 20px; border-radius: 10px; cursor: pointer; color: var(--text-primary);">
                    <i class="fas fa-arrow-left"></i> Back to Feed
                </button>
            </div>
        `;
    }
}

// 12. createCommunity - now shows a proper creation form
function createCommunity() {
    if (!currentUser) { showToast('Please log in first!'); return; }
    if (currentUser.honeyPoints < 200) {
        showToast(`You need 200 Honey Points to create a hive (you have ${currentUser.honeyPoints}).`);
        return;
    }

    const name = prompt('ðŸ Name your new Hive:');
    if (!name || !name.trim()) return;

    const description = prompt('Describe your Hive (what is it about?):');

    const colors = ['#FF69B4', '#87CEEB', '#9370DB', '#FF8C00', '#228B22', '#FFC30B'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];

    const newCommunity = {
        name: name.trim(),
        members: '1',
        icon: name.trim()[0].toUpperCase(),
        color: randomColor,
        description: description || 'A new hive in Polleneer!'
    };

    currentUser.honeyPoints -= 200;
    localStorage.setItem('polleneer_user', JSON.stringify(currentUser));

    showToast(`ðŸŽ‰ "${name}" hive created! -200 Honey Points`);
    goToCommunities();
}

// 13. joinCommunity - now properly handles join logic with visual feedback
function joinCommunity(name) {
    if (!currentUser) { showToast('Please log in first!'); return; }

    const joinedHives = JSON.parse(localStorage.getItem('polleneer_joined_hives') || '[]');

    if (joinedHives.includes(name)) {
        // Leave
        const idx = joinedHives.indexOf(name);
        joinedHives.splice(idx, 1);
        localStorage.setItem('polleneer_joined_hives', JSON.stringify(joinedHives));
        showToast(`Left ${name} hive`);
    } else {
        // Join
        joinedHives.push(name);
        localStorage.setItem('polleneer_joined_hives', JSON.stringify(joinedHives));
        currentUser.honeyPoints += 20;
        localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
        showToast(`ðŸŽ‰ Joined ${name}! +20 Honey Points`);
    }

    goToCommunities();
}

// 14. manageFriends - now shows followers/following management
function manageFriends() {
    if (!currentUser) { showToast('Please log in first!'); return; }
    closeModal('profileMenuModal');

    const following = users.filter(u => u.id !== currentUser.id);

    document.getElementById('mainContent').innerHTML = `
        <div class="customization-panel">
            <h3 style="margin-bottom: 20px; color: var(--honey-yellow);"><i class="fas fa-users"></i> Friends & Connections</h3>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="tab-following" onclick="switchFriendsTab('following')" style="background: var(--honey-yellow); color: #000; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold;">
                    Following (${currentUser.following})
                </button>
                <button id="tab-followers" onclick="switchFriendsTab('followers')" style="background: var(--bg-input); border: 1px solid var(--border-color); padding: 8px 20px; border-radius: 20px; cursor: pointer; color: var(--text-primary);">
                    Followers (${currentUser.followers})
                </button>
            </div>

            <div id="friendsList" style="display: grid; gap: 10px;">
                ${following.map(user => `
                    <div class="post-card" style="padding: 15px; display: flex; align-items: center; gap: 15px;">
                        <img src="${user.avatar}" alt="${user.username}" style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer;" onclick="goToUserProfile(${user.id})">
                        <div style="flex: 1; cursor: pointer;" onclick="goToUserProfile(${user.id})">
                            <strong>${user.displayName || user.username}</strong>
                            <div style="color: var(--text-secondary); font-size: 13px;">@${user.username} Â· ðŸ¯ ${user.honeyPoints}</div>
                        </div>
                        <button onclick="toggleFollow(${user.id})" style="background: var(--honey-yellow); color: #000; border: none; padding: 6px 15px; border-radius: 15px; cursor: pointer; font-size: 12px;">
                            Following
                        </button>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function switchFriendsTab(tab) {
    document.getElementById('tab-following').style.background = tab === 'following' ? 'var(--honey-yellow)' : 'var(--bg-input)';
    document.getElementById('tab-following').style.color = tab === 'following' ? '#000' : 'var(--text-primary)';
    document.getElementById('tab-followers').style.background = tab === 'followers' ? 'var(--honey-yellow)' : 'var(--bg-input)';
    document.getElementById('tab-followers').style.color = tab === 'followers' ? '#000' : 'var(--text-primary)';
    showToast(`Showing ${tab}`);
}

// 15. refreshSuggestions - now actually shuffles and reloads
function refreshSuggestions() {
    if (!currentUser) return;
    // Shuffle the users array
    const shuffled = users.filter(u => u.id !== currentUser.id).sort(() => Math.random() - 0.5);
    const suggestedUsers = document.getElementById('suggestedUsers');
    if (!suggestedUsers) { 
        showToast('Suggestions refreshed! ðŸ”„'); 
        return; 
    }

    suggestedUsers.innerHTML = shuffled.slice(0, 4).map(user => `
        <div class="user-to-follow">
            <div class="follow-user-info" onclick="goToUserProfile(${user.id})">
                <img src="${user.avatar}" alt="${user.username}" class="follow-avatar">
                <div>
                    <div class="follow-name">${user.displayName || user.username}</div>
                    <div class="follow-username">@${user.username}</div>
                </div>
            </div>
            <button class="follow-btn" onclick="toggleFollow(${user.id})">Follow</button>
        </div>
    `).join('');

    showToast('Suggestions refreshed! ðŸ”„');
}

// 16. likeComment - now properly toggles like on comments
function likeComment(commentId, postId) {
    const likeBtn = document.querySelector(`[data-comment-like="${commentId}"]`);
    if (likeBtn) {
        const isLiked = likeBtn.classList.toggle('liked');
        const icon = likeBtn.querySelector('i') || likeBtn;
        if (isLiked) {
            likeBtn.style.color = 'var(--honey-yellow)';
            currentUser.honeyPoints += 1;
            showToast('ðŸ’› Liked comment!');
        } else {
            likeBtn.style.color = '';
            currentUser.honeyPoints -= 1;
        }
        localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
    } else {
        showToast('ðŸ’› Liked comment!');
    }
}

// 17. showAdminPanel - now works for all users but restricts non-admins
function showAdminPanel() {
    if (!currentUser || (currentUser.role !== 'queen' && currentUser.role !== 'admin' && !isAdmin)) {
        showToast('\ud83d\udd12 Admin access required. Only Queen/King Bees can access the admin panel.');
        return;
    }
    initAdminPanel();
    openModal('adminPanelModal');
}

// ==================== ADMIN PANEL FUNCTIONS ====================

// ---- Admin Tab Navigation ----
function switchAdminTab(tab) {
    document.querySelectorAll('.admin-section').forEach(function(s) { s.classList.remove('active'); });
    document.querySelectorAll('.admin-sidebar-btn').forEach(function(b) { b.classList.remove('active'); });
    var section = document.getElementById('admin' + tab.charAt(0).toUpperCase() + tab.slice(1));
    if (section) section.classList.add('active');
    var btns = document.querySelectorAll('.admin-sidebar-btn');
    btns.forEach(function(b) { if (b.textContent.trim().toLowerCase().replace(/\s+/g,'').indexOf(tab) > -1 || b.getAttribute('onclick').indexOf("'" + tab + "'") > -1) b.classList.add('active'); });

    // Initialize tab data
    if (tab === 'dashboard') initAdminDashboard();
    else if (tab === 'users') initAdminUsers();
    else if (tab === 'moderation') initAdminModeration();
    else if (tab === 'config') initAdminConfig();
    else if (tab === 'announcements') initAdminAnnouncements();
    else if (tab === 'analytics') initAdminAnalytics();
    else if (tab === 'roles') initAdminRoles();
    else if (tab === 'auditlog') initAdminAuditLog();
}

// ---- Mock Data Store ----
var adminData = {
    reports: [],
    announcements: [],
    auditLog: [],
    customRoles: [],
    siteConfig: {},
    mutedWords: []
};

function loadAdminData() {
    try {
        var saved = JSON.parse(localStorage.getItem('polleneer_admin_data') || '{}');
        if (saved.reports) adminData.reports = saved.reports;
        if (saved.announcements) adminData.announcements = saved.announcements;
        if (saved.auditLog) adminData.auditLog = saved.auditLog;
        if (saved.customRoles) adminData.customRoles = saved.customRoles;
        if (saved.siteConfig) adminData.siteConfig = saved.siteConfig;
        if (saved.mutedWords) adminData.mutedWords = saved.mutedWords;
    } catch(e) {}
    // Seed some default reports if empty
    if (adminData.reports.length === 0) {
        adminData.reports = [
            { id: 1, type: 'spam', reporter: 'honeybee42', target: 'spammer99', content: 'Suspicious link posted in community feed', status: 'pending', date: new Date(Date.now() - 3600000).toISOString() },
            { id: 2, type: 'harassment', reporter: 'blossom_queen', target: 'angry_wasp', content: 'Offensive comments on multiple posts', status: 'pending', date: new Date(Date.now() - 7200000).toISOString() },
            { id: 3, type: 'inappropriate', reporter: 'garden_lover', target: 'edgy_poster', content: 'Inappropriate image in profile picture', status: 'resolved', date: new Date(Date.now() - 86400000).toISOString() }
        ];
    }
    if (adminData.auditLog.length === 0) {
        adminData.auditLog = [
            { action: 'config_change', admin: 'admin', detail: 'Changed default theme to Night Hive', time: new Date(Date.now() - 1800000).toISOString() },
            { action: 'user_role', admin: 'admin', detail: 'Promoted honeybee42 to Worker Bee', time: new Date(Date.now() - 3600000).toISOString() },
            { action: 'content_remove', admin: 'admin', detail: 'Removed spam post by spammer99', time: new Date(Date.now() - 7200000).toISOString() },
            { action: 'announcement', admin: 'admin', detail: 'Published: Welcome to Polleneer Beta!', time: new Date(Date.now() - 86400000).toISOString() },
            { action: 'user_ban', admin: 'admin', detail: 'Banned toxic_user for repeated violations', time: new Date(Date.now() - 172800000).toISOString() }
        ];
    }
    if (adminData.announcements.length === 0) {
        adminData.announcements = [
            { id: 1, title: 'Welcome to Polleneer Beta!', message: 'We are excited to launch our beta. Report any bugs to the admin team.', type: 'info', display: 'banner', active: true, date: new Date(Date.now() - 86400000).toISOString() }
        ];
    }
}

function saveAdminData() {
    localStorage.setItem('polleneer_admin_data', JSON.stringify(adminData));
}

function addAuditEntry(action, detail) {
    adminData.auditLog.unshift({ action: action, admin: currentUser ? currentUser.username : 'admin', detail: detail, time: new Date().toISOString() });
    saveAdminData();
}

// ---- DASHBOARD ----
function initAdminDashboard() {
    var totalUsers = (typeof users !== 'undefined' && users.length) ? users.length : 12;
    var totalPosts = (typeof posts !== 'undefined' && posts.length) ? posts.length : 47;
    var pendingReports = adminData.reports.filter(function(r) { return r.status === 'pending'; }).length;
    var activeAnnouncements = adminData.announcements.filter(function(a) { return a.active; }).length;

    document.getElementById('adminStatGrid').innerHTML =
        '<div class="admin-stat-card"><div class="stat-icon" style="background: rgba(100,181,246,0.2); color: #64B5F6;"><i class="fas fa-users"></i></div><div class="stat-value">' + totalUsers + '</div><div class="stat-label">Total Users</div><div class="stat-change positive"><i class="fas fa-arrow-up"></i> +3 this week</div></div>' +
        '<div class="admin-stat-card"><div class="stat-icon" style="background: rgba(255,195,11,0.2); color: #FFC30B;"><i class="fas fa-pen"></i></div><div class="stat-value">' + totalPosts + '</div><div class="stat-label">Total Posts</div><div class="stat-change positive"><i class="fas fa-arrow-up"></i> +12 today</div></div>' +
        '<div class="admin-stat-card"><div class="stat-icon" style="background: rgba(76,175,80,0.2); color: #4CAF50;"><i class="fas fa-signal"></i></div><div class="stat-value">' + Math.floor(totalUsers * 0.6) + '</div><div class="stat-label">Active Now</div><div class="stat-change positive"><i class="fas fa-circle" style="font-size:8px;"></i> Online</div></div>' +
        '<div class="admin-stat-card"><div class="stat-icon" style="background: rgba(255,152,0,0.2); color: #FF9800;"><i class="fas fa-flag"></i></div><div class="stat-value">' + pendingReports + '</div><div class="stat-label">Pending Reports</div><div class="stat-change ' + (pendingReports > 0 ? 'negative' : 'positive') + '">' + (pendingReports > 0 ? '<i class="fas fa-exclamation-circle"></i> Needs review' : '<i class="fas fa-check"></i> All clear') + '</div></div>';

    // Weekly chart
    var bars = [15, 22, 18, 30, 25, 35, 28];
    var max = Math.max.apply(null, bars);
    document.getElementById('adminWeeklyChart').innerHTML = bars.map(function(v) {
        return '<div class="admin-chart-bar" style="height: ' + (v / max * 100) + '%; position: relative;" title="' + v + ' posts"><span style="position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 11px; color: var(--text-secondary);">' + v + '</span></div>';
    }).join('');

    // Recent activity
    var activities = [
        { icon: 'fa-user-plus', color: '#64B5F6', text: '<strong>pollen_seeker</strong> joined the hive', time: '2 min ago' },
        { icon: 'fa-pen', color: '#FFC30B', text: '<strong>honeybee42</strong> created a new post', time: '5 min ago' },
        { icon: 'fa-heart', color: '#FF69B4', text: '<strong>blossom_queen</strong> liked 3 posts', time: '12 min ago' },
        { icon: 'fa-comment', color: '#4CAF50', text: '<strong>garden_lover</strong> commented on a post', time: '18 min ago' },
        { icon: 'fa-flag', color: '#FF9800', text: 'New report filed by <strong>honeybee42</strong>', time: '1 hr ago' },
        { icon: 'fa-crown', color: '#FFC30B', text: '<strong>admin</strong> updated site configuration', time: '2 hrs ago' }
    ];
    document.getElementById('adminRecentActivity').innerHTML = activities.map(function(a) {
        return '<div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 13px;">' +
            '<i class="fas ' + a.icon + '" style="color: ' + a.color + '; width: 20px; text-align: center;"></i>' +
            '<span style="flex: 1;">' + a.text + '</span>' +
            '<span style="color: var(--text-secondary); font-size: 11px; white-space: nowrap;">' + a.time + '</span></div>';
    }).join('');
}

// ---- USER MANAGEMENT ----
function initAdminUsers() {
    var usersList = (typeof users !== 'undefined' && users.length) ? users : [
        { id: 1, username: 'honeybee42', email: 'honeybee42@polleneer.com', displayName: 'Honey Bee', role: 'worker', status: 'active', joined: '2026-01-15', avatar: '', posts: 23, followers: 156 },
        { id: 2, username: 'blossom_queen', email: 'blossom@polleneer.com', displayName: 'Blossom Queen', role: 'queen', status: 'active', joined: '2026-01-10', avatar: '', posts: 45, followers: 892 },
        { id: 3, username: 'garden_lover', email: 'garden@polleneer.com', displayName: 'Garden Lover', role: 'worker', status: 'active', joined: '2026-02-01', avatar: '', posts: 12, followers: 67 },
        { id: 4, username: 'spammer99', email: 'spam@mail.com', displayName: 'Spammer', role: 'drone', status: 'suspended', joined: '2026-02-10', avatar: '', posts: 3, followers: 0 },
        { id: 5, username: 'pollen_seeker', email: 'pollen@polleneer.com', displayName: 'Pollen Seeker', role: 'worker', status: 'active', joined: '2026-02-18', avatar: '', posts: 5, followers: 23 },
        { id: 6, username: 'angry_wasp', email: 'wasp@mail.com', displayName: 'Angry Wasp', role: 'drone', status: 'banned', joined: '2026-02-05', avatar: '', posts: 8, followers: 2 },
        { id: 7, username: 'nectar_lord', email: 'nectar@polleneer.com', displayName: 'Nectar Lord', role: 'queen', status: 'active', joined: '2026-01-20', avatar: '', posts: 67, followers: 1204 },
        { id: 8, username: 'buzz_creator', email: 'buzz@polleneer.com', displayName: 'Buzz Creator', role: 'worker', status: 'active', joined: '2026-02-14', avatar: '', posts: 15, followers: 89 }
    ];
    window._adminUsersList = usersList;
    renderAdminUsers(usersList);
}

function renderAdminUsers(list) {
    var tbody = document.getElementById('adminUserTableBody');
    tbody.innerHTML = list.map(function(u) {
        var roleClass = (u.role === 'queen' || u.role === 'admin') ? 'queen' : (u.role === 'worker' ? 'worker' : 'drone');
        var statusClass = u.status === 'active' ? 'active' : (u.status === 'banned' ? 'banned' : 'suspended');
        var avatar = u.avatar || ('https://api.dicebear.com/7.x/avataaars/svg?seed=' + u.username);
        return '<tr>' +
            '<td><div style="display: flex; align-items: center; gap: 10px;"><img src="' + avatar + '" style="width: 36px; height: 36px; border-radius: 50%; background: var(--bg-secondary);"><div><strong>' + (u.displayName || u.username) + '</strong><br><span style="color: var(--text-secondary); font-size: 12px;">@' + u.username + '</span></div></div></td>' +
            '<td><span class="admin-badge ' + roleClass + '">' + (u.role || 'drone') + '</span></td>' +
            '<td><span class="admin-badge ' + statusClass + '">' + (u.status || 'active') + '</span></td>' +
            '<td style="font-size: 13px; color: var(--text-secondary);">' + (u.joined || 'N/A') + '</td>' +
            '<td>' + (u.posts || 0) + '</td>' +
            '<td><div style="display: flex; gap: 6px;">' +
                '<button class="admin-action-btn" onclick="adminEditUser(\'' + u.username + '\')" title="Edit"><i class="fas fa-edit"></i></button>' +
                '<button class="admin-action-btn" onclick="adminChangeRole(\'' + u.username + '\')" title="Change Role"><i class="fas fa-crown"></i></button>' +
                (u.status !== 'banned' ? '<button class="admin-action-btn danger" onclick="adminBanUser(\'' + u.username + '\')" title="Ban"><i class="fas fa-ban"></i></button>' : '<button class="admin-action-btn success" onclick="adminUnbanUser(\'' + u.username + '\')" title="Unban"><i class="fas fa-check"></i></button>') +
            '</div></td>' +
        '</tr>';
    }).join('');
}

function filterAdminUsers() {
    var search = (document.getElementById('adminUserSearch').value || '').toLowerCase();
    var role = document.getElementById('adminUserRoleFilter').value;
    var status = document.getElementById('adminUserStatusFilter').value;
    var list = (window._adminUsersList || []).filter(function(u) {
        if (search && u.username.toLowerCase().indexOf(search) === -1 && (u.displayName || '').toLowerCase().indexOf(search) === -1 && (u.email || '').toLowerCase().indexOf(search) === -1) return false;
        if (role && u.role !== role) return false;
        if (status && u.status !== status) return false;
        return true;
    });
    renderAdminUsers(list);
}

function adminEditUser(username) {
    showToast('Edit user: @' + username + ' â€” Full editor coming with backend integration.');
    addAuditEntry('user_role', 'Opened editor for @' + username);
}

function adminChangeRole(username) {
    var roles = ['queen', 'worker', 'drone'];
    var user = (window._adminUsersList || []).find(function(u) { return u.username === username; });
    if (!user) return;
    var currentIdx = roles.indexOf(user.role || 'drone');
    var nextRole = roles[(currentIdx + 1) % roles.length];
    if (confirm('Change @' + username + ' role to ' + nextRole.toUpperCase() + '?')) {
        user.role = nextRole;
        renderAdminUsers(window._adminUsersList);
        showToast('Role updated: @' + username + ' is now ' + nextRole);
        addAuditEntry('user_role', 'Changed @' + username + ' role to ' + nextRole);
    }
}

function adminBanUser(username) {
    if (confirm('Ban @' + username + '? They will lose access to Polleneer.')) {
        var user = (window._adminUsersList || []).find(function(u) { return u.username === username; });
        if (user) { user.status = 'banned'; renderAdminUsers(window._adminUsersList); }
        showToast('Banned: @' + username);
        addAuditEntry('user_ban', 'Banned @' + username);
    }
}

function adminUnbanUser(username) {
    if (confirm('Unban @' + username + '?')) {
        var user = (window._adminUsersList || []).find(function(u) { return u.username === username; });
        if (user) { user.status = 'active'; renderAdminUsers(window._adminUsersList); }
        showToast('Unbanned: @' + username);
        addAuditEntry('user_ban', 'Unbanned @' + username);
    }
}

// ---- CONTENT MODERATION ----
function initAdminModeration() {
    switchModerationTab('reports');
}

function switchModerationTab(tab) {
    document.getElementById('moderationReports').style.display = tab === 'reports' ? 'block' : 'none';
    document.getElementById('moderationFlagged').style.display = tab === 'flagged' ? 'block' : 'none';
    document.getElementById('moderationMutedWords').style.display = tab === 'mutedwords' ? 'block' : 'none';

    var btns = document.querySelectorAll('#adminModeration > div:first-of-type .admin-action-btn');
    btns.forEach(function(b) { b.style.fontWeight = ''; b.style.borderColor = 'var(--border-color)'; b.style.color = 'var(--text-primary)'; });
    var activeBtn = document.getElementById('modTab' + tab.charAt(0).toUpperCase() + tab.slice(1));
    if (activeBtn) { activeBtn.style.fontWeight = '600'; activeBtn.style.borderColor = 'var(--flower-pink)'; activeBtn.style.color = 'var(--flower-pink)'; }

    if (tab === 'reports') renderReports();
    else if (tab === 'flagged') renderFlagged();
    else if (tab === 'mutedwords') renderAdminMutedWords();
}

function renderReports() {
    var pending = adminData.reports.filter(function(r) { return r.status === 'pending'; });
    var resolved = adminData.reports.filter(function(r) { return r.status === 'resolved'; });
    document.getElementById('reportCount').textContent = pending.length;

    var html = '';
    if (pending.length === 0) {
        html += '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-check-circle" style="font-size: 40px; color: #4CAF50; margin-bottom: 12px; display: block;"></i>No pending reports â€” the hive is peaceful!</div>';
    } else {
        html += '<h4 style="margin-bottom: 12px; color: #FF9800;">Pending (' + pending.length + ')</h4>';
        pending.forEach(function(r) {
            html += '<div class="admin-report-card">' +
                '<div style="flex: 1;"><div style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;"><span class="admin-badge" style="background: rgba(255,152,0,0.2); color: #FF9800;">' + r.type + '</span><span style="font-size: 12px; color: var(--text-secondary);">Reported by @' + r.reporter + '</span></div>' +
                '<p style="font-size: 14px; margin-bottom: 6px;">' + r.content + '</p>' +
                '<span style="font-size: 12px; color: var(--text-secondary);">Target: @' + r.target + ' Â· ' + new Date(r.date).toLocaleDateString() + '</span></div>' +
                '<div style="display: flex; gap: 6px; flex-shrink: 0;">' +
                    '<button class="admin-action-btn success" onclick="resolveReport(' + r.id + ')"><i class="fas fa-check"></i> Resolve</button>' +
                    '<button class="admin-action-btn danger" onclick="removeAndResolve(' + r.id + ')"><i class="fas fa-trash"></i> Remove Content</button>' +
                '</div></div>';
        });
    }
    if (resolved.length > 0) {
        html += '<h4 style="margin: 20px 0 12px; color: #4CAF50;">Resolved (' + resolved.length + ')</h4>';
        resolved.forEach(function(r) {
            html += '<div class="admin-report-card resolved"><div><span class="admin-badge" style="background: rgba(76,175,80,0.2); color: #4CAF50;">resolved</span> <span style="font-size: 12px; color: var(--text-secondary);">' + r.type + ' â€” @' + r.target + '</span><br><span style="font-size: 13px; color: var(--text-secondary);">' + r.content + '</span></div></div>';
        });
    }
    document.getElementById('moderationReports').innerHTML = html;
}

function resolveReport(id) {
    var r = adminData.reports.find(function(r) { return r.id === id; });
    if (r) { r.status = 'resolved'; saveAdminData(); renderReports(); showToast('Report resolved'); addAuditEntry('content_remove', 'Resolved report #' + id); }
}

function removeAndResolve(id) {
    var r = adminData.reports.find(function(r) { return r.id === id; });
    if (r && confirm('Remove content from @' + r.target + ' and resolve report?')) {
        r.status = 'resolved';
        saveAdminData(); renderReports();
        showToast('Content removed and report resolved');
        addAuditEntry('content_remove', 'Removed content from @' + r.target + ' (report #' + id + ')');
    }
}

function renderFlagged() {
    document.getElementById('moderationFlagged').innerHTML =
        '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-robot" style="font-size: 40px; margin-bottom: 12px; display: block;"></i>' +
        '<h4 style="margin-bottom: 8px;">Auto-Moderation</h4>' +
        '<p style="font-size: 14px;">AI-powered content filtering will automatically flag suspicious content when backend integration is complete.</p>' +
        '<div style="margin-top: 20px; text-align: left;">' +
            '<div class="admin-toggle-row"><div><strong>Spam Detection</strong><span>Automatically detect and hide spam posts</span></div><input type="checkbox" checked style="width: 20px; height: 20px; accent-color: var(--honey-yellow);"></div>' +
            '<div class="admin-toggle-row"><div><strong>NSFW Filter</strong><span>Blur potentially sensitive images</span></div><input type="checkbox" checked style="width: 20px; height: 20px; accent-color: var(--honey-yellow);"></div>' +
            '<div class="admin-toggle-row"><div><strong>Link Scanner</strong><span>Check posted links against known malware databases</span></div><input type="checkbox" checked style="width: 20px; height: 20px; accent-color: var(--honey-yellow);"></div>' +
            '<div class="admin-toggle-row"><div><strong>Toxicity Detection</strong><span>Flag comments with high toxicity scores</span></div><input type="checkbox" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);"></div>' +
        '</div></div>';
}

function renderAdminMutedWords() {
    var words = adminData.mutedWords || [];
    var html = '<div style="display: flex; gap: 8px; margin-bottom: 16px;">' +
        '<input type="text" class="admin-input" id="adminMutedWordInput" placeholder="Add a word or phrase to mute site-wide..." style="flex: 1;">' +
        '<button class="admin-btn primary" onclick="addAdminMutedWord()" style="white-space: nowrap;">Add Word</button></div>';
    if (words.length === 0) {
        html += '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No muted words configured. Posts containing muted words will be hidden from all feeds.</p>';
    } else {
        html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
        words.forEach(function(w) {
            html += '<div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; background: var(--bg-input); border: 1px solid var(--border-color); font-size: 13px;">' +
                '<span>' + w + '</span>' +
                '<button onclick="removeAdminMutedWord(\'' + w.replace(/'/g, "\\'") + '\')" style="background: none; border: none; color: #FF4444; cursor: pointer; font-size: 14px; padding: 0;"><i class="fas fa-times"></i></button></div>';
        });
        html += '</div>';
    }
    document.getElementById('moderationMutedWords').innerHTML = html;
}

function addAdminMutedWord() {
    var input = document.getElementById('adminMutedWordInput');
    var word = (input.value || '').trim();
    if (!word) return;
    if (adminData.mutedWords.indexOf(word) === -1) adminData.mutedWords.push(word);
    saveAdminData();
    input.value = '';
    renderAdminMutedWords();
    showToast('Muted word added: ' + word);
    addAuditEntry('config_change', 'Added muted word: ' + word);
}

function removeAdminMutedWord(word) {
    adminData.mutedWords = adminData.mutedWords.filter(function(w) { return w !== word; });
    saveAdminData();
    renderAdminMutedWords();
    showToast('Muted word removed');
}

// ---- SITE CONFIGURATION ----
function initAdminConfig() {
    var features = [
        { key: 'dms', label: 'Direct Messages', desc: 'Allow users to send private messages', default: true },
        { key: 'communities', label: 'Communities', desc: 'Enable community groups and discussions', default: true },
        { key: 'gifs', label: 'GIF Picker', desc: 'Allow GIF search and sharing in posts', default: true },
        { key: 'stickers', label: 'Sticker Picker', desc: 'Enable sticker sharing in posts', default: true },
        { key: 'profileSongs', label: 'Profile Songs', desc: 'Allow users to set a profile song', default: true },
        { key: 'customThemes', label: 'Custom Themes', desc: 'Allow users to customize their theme', default: true },
        { key: 'avatarBorders', label: 'Avatar Border Effects', desc: 'Enable animated avatar borders', default: true },
        { key: 'bannerBorders', label: 'Banner Border Effects', desc: 'Enable animated banner borders', default: true },
        { key: 'scheduling', label: 'Post Scheduling', desc: 'Allow users to schedule posts for later', default: true },
        { key: 'analytics', label: 'User Analytics', desc: 'Show analytics dashboard to users', default: true },
        { key: 'registration', label: 'Open Registration', desc: 'Allow new users to register', default: true },
        { key: 'maintenance', label: 'Maintenance Mode', desc: 'Show maintenance page to non-admin users', default: false }
    ];

    var html = '';
    features.forEach(function(f) {
        var enabled = adminData.siteConfig.hasOwnProperty(f.key) ? adminData.siteConfig[f.key] : f.default;
        html += '<div class="admin-toggle-row">' +
            '<div><strong>' + f.label + '</strong><span>' + f.desc + '</span></div>' +
            '<input type="checkbox" ' + (enabled ? 'checked' : '') + ' onchange="toggleAdminFeature(\'' + f.key + '\', this.checked)" style="width: 20px; height: 20px; accent-color: var(--honey-yellow);">' +
        '</div>';
    });
    document.getElementById('adminFeatureToggles').innerHTML = html;

    // Load saved config values
    if (adminData.siteConfig.defaultTheme) document.getElementById('adminDefaultTheme').value = adminData.siteConfig.defaultTheme;
    if (adminData.siteConfig.maxPostLength) document.getElementById('adminMaxPostLength').value = adminData.siteConfig.maxPostLength;
    if (adminData.siteConfig.maxUpload) document.getElementById('adminMaxUpload').value = adminData.siteConfig.maxUpload;
}

function toggleAdminFeature(key, enabled) {
    adminData.siteConfig[key] = enabled;
    saveAdminData();
    showToast((enabled ? 'Enabled' : 'Disabled') + ': ' + key);
    addAuditEntry('config_change', (enabled ? 'Enabled' : 'Disabled') + ' feature: ' + key);
}

function saveAdminConfig() {
    adminData.siteConfig.defaultTheme = document.getElementById('adminDefaultTheme').value;
    adminData.siteConfig.siteStyle = document.getElementById('adminSiteStyleNew').value;
    adminData.siteConfig.borderRadius = document.getElementById('adminBorderRadiusNew').value;
    adminData.siteConfig.accentColor = document.getElementById('adminAccentColor').value;
    adminData.siteConfig.bgOverride = document.getElementById('adminBgOverride').value;
    adminData.siteConfig.fontFamily = document.getElementById('adminFontFamilyNew').value;
    adminData.siteConfig.maxPostLength = document.getElementById('adminMaxPostLength').value;
    adminData.siteConfig.maxUpload = document.getElementById('adminMaxUpload').value;
    adminData.siteConfig.postsPerPage = document.getElementById('adminPostsPerPage').value;
    saveAdminData();
    showToast('Site configuration saved!');
    addAuditEntry('config_change', 'Saved site configuration');
}

function resetAdminConfig() {
    if (confirm('Reset all site configuration to defaults?')) {
        adminData.siteConfig = {};
        saveAdminData();
        initAdminConfig();
        showToast('Configuration reset to defaults');
        addAuditEntry('config_change', 'Reset site configuration to defaults');
    }
}

// ---- ANNOUNCEMENTS ----
function initAdminAnnouncements() {
    renderAnnouncements();
}

function publishAnnouncement() {
    var title = document.getElementById('announcementTitle').value.trim();
    var message = document.getElementById('announcementMessage').value.trim();
    var type = document.getElementById('announcementType').value;
    var display = document.getElementById('announcementDisplay').value;
    var duration = document.getElementById('announcementDuration').value;

    if (!title || !message) { showToast('Please fill in title and message'); return; }

    adminData.announcements.unshift({
        id: Date.now(),
        title: title,
        message: message,
        type: type,
        display: display,
        duration: duration,
        active: true,
        date: new Date().toISOString()
    });
    saveAdminData();

    document.getElementById('announcementTitle').value = '';
    document.getElementById('announcementMessage').value = '';

    renderAnnouncements();
    showToast('Announcement published!');
    addAuditEntry('announcement', 'Published: ' + title);

    if (display === 'banner') showAnnouncementBanner(title, message, type);
}

function renderAnnouncements() {
    var html = '';
    if (adminData.announcements.length === 0) {
        html = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No announcements yet.</p>';
    } else {
        adminData.announcements.forEach(function(a) {
            var typeColors = { info: '#64B5F6', warning: '#FF9800', success: '#4CAF50', urgent: '#FF4444' };
            html += '<div class="admin-announcement-card" style="border-left: 3px solid ' + (typeColors[a.type] || '#64B5F6') + '; ' + (!a.active ? 'opacity: 0.5;' : '') + '">' +
                '<div style="display: flex; justify-content: space-between; align-items: flex-start;">' +
                    '<div><strong>' + a.title + '</strong>' +
                        '<span class="admin-badge" style="margin-left: 8px; background: rgba(' + (a.type === 'urgent' ? '255,68,68' : a.type === 'warning' ? '255,152,0' : a.type === 'success' ? '76,175,80' : '100,181,246') + ',0.2); color: ' + (typeColors[a.type] || '#64B5F6') + ';">' + a.type + '</span>' +
                        (a.active ? '<span class="admin-badge active" style="margin-left: 4px;">live</span>' : '<span class="admin-badge suspended" style="margin-left: 4px;">ended</span>') +
                    '<p style="font-size: 13px; color: var(--text-secondary); margin-top: 6px;">' + a.message + '</p>' +
                    '<span style="font-size: 11px; color: var(--text-secondary);">' + new Date(a.date).toLocaleString() + ' Â· ' + a.display + '</span></div>' +
                    '<div style="display: flex; gap: 6px;">' +
                        (a.active ? '<button class="admin-action-btn" onclick="toggleAnnouncement(' + a.id + ')"><i class="fas fa-pause"></i></button>' : '<button class="admin-action-btn success" onclick="toggleAnnouncement(' + a.id + ')"><i class="fas fa-play"></i></button>') +
                        '<button class="admin-action-btn danger" onclick="deleteAnnouncement(' + a.id + ')"><i class="fas fa-trash"></i></button>' +
                    '</div>' +
                '</div></div>';
        });
    }
    document.getElementById('adminAnnouncementsList').innerHTML = html;
}

function toggleAnnouncement(id) {
    var a = adminData.announcements.find(function(a) { return a.id === id; });
    if (a) { a.active = !a.active; saveAdminData(); renderAnnouncements(); showToast(a.active ? 'Announcement reactivated' : 'Announcement paused'); }
}

function deleteAnnouncement(id) {
    if (confirm('Delete this announcement permanently?')) {
        adminData.announcements = adminData.announcements.filter(function(a) { return a.id !== id; });
        saveAdminData();
        renderAnnouncements();
        showToast('Announcement deleted');
    }
}

function showAnnouncementBanner(title, message, type) {
    var colors = { info: '#1565C0', warning: '#E65100', success: '#2E7D32', urgent: '#C62828' };
    var banner = document.createElement('div');
    banner.id = 'announcementBanner';
    banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:10000;padding:12px 20px;background:' + (colors[type] || '#1565C0') + ';color:#fff;display:flex;align-items:center;justify-content:center;gap:12px;font-size:14px;box-shadow:0 2px 10px rgba(0,0,0,0.3);';
    banner.innerHTML = '<i class="fas fa-bullhorn"></i> <strong>' + title + '</strong> â€” ' + message + ' <button onclick="this.parentElement.remove()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;padding:4px 12px;border-radius:6px;cursor:pointer;margin-left:12px;">Dismiss</button>';
    var existing = document.getElementById('announcementBanner');
    if (existing) existing.remove();
    document.body.prepend(banner);
}

// ---- ANALYTICS ----
function initAdminAnalytics() {
    refreshAnalytics();
}

function refreshAnalytics() {
    var totalUsers = (typeof users !== 'undefined' && users.length) ? users.length : 12;
    var totalPosts = (typeof posts !== 'undefined' && posts.length) ? posts.length : 47;

    document.getElementById('analyticsStatGrid').innerHTML =
        '<div class="admin-stat-card"><div class="stat-value">' + totalUsers + '</div><div class="stat-label">Total Users</div></div>' +
        '<div class="admin-stat-card"><div class="stat-value">' + totalPosts + '</div><div class="stat-label">Total Posts</div></div>' +
        '<div class="admin-stat-card"><div class="stat-value">' + Math.floor(totalPosts * 3.2) + '</div><div class="stat-label">Total Likes</div></div>' +
        '<div class="admin-stat-card"><div class="stat-value">' + Math.floor(totalPosts * 1.8) + '</div><div class="stat-label">Total Comments</div></div>' +
        '<div class="admin-stat-card"><div class="stat-value">' + Math.floor(totalUsers * 0.7 * 100) / 100 + '</div><div class="stat-label">Avg Posts/User</div></div>' +
        '<div class="admin-stat-card"><div class="stat-value">' + Math.floor(Math.random() * 20 + 60) + '%</div><div class="stat-label">Retention Rate</div></div>';

    // User growth chart
    var growth = [3, 5, 8, 6, 10, 7, totalUsers];
    var maxG = Math.max.apply(null, growth);
    document.getElementById('analyticsUserGrowth').innerHTML = growth.map(function(v) {
        return '<div class="admin-chart-bar" style="height: ' + (v / maxG * 100) + '%;"><span style="position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 11px; color: var(--text-secondary);">' + v + '</span></div>';
    }).join('');
    document.getElementById('analyticsUserLabels').innerHTML = ['Week 1','Week 2','Week 3','Week 4','Week 5','Week 6','Week 7'].map(function(l) { return '<span>' + l + '</span>'; }).join('');

    // Engagement chart
    var eng = [65, 72, 58, 80, 75, 85, 78];
    var maxE = Math.max.apply(null, eng);
    document.getElementById('analyticsEngagement').innerHTML = eng.map(function(v) {
        return '<div class="admin-chart-bar" style="height: ' + (v / maxE * 100) + '%; background: linear-gradient(to top, #4CAF50, rgba(76,175,80,0.3));"><span style="position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 11px; color: var(--text-secondary);">' + v + '%</span></div>';
    }).join('');
    document.getElementById('analyticsEngLabels').innerHTML = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map(function(l) { return '<span>' + l + '</span>'; }).join('');

    // Top posts
    document.getElementById('analyticsTopPosts').innerHTML = 
        '<div style="display:grid;gap:10px;">' +
        [{ user: 'blossom_queen', content: 'Just discovered the most amazing honey farm!', likes: 45, comments: 12 },
         { user: 'nectar_lord', content: 'My journey to becoming a beekeeper...', likes: 38, comments: 23 },
         { user: 'honeybee42', content: 'Check out this sunflower field!', likes: 31, comments: 8 }
        ].map(function(p, i) {
            return '<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-input);border-radius:10px;">' +
                '<span style="font-size:20px;font-weight:700;color:var(--flower-pink);width:30px;">#' + (i+1) + '</span>' +
                '<div style="flex:1;"><strong>@' + p.user + '</strong><br><span style="font-size:13px;color:var(--text-secondary);">' + p.content + '</span></div>' +
                '<div style="text-align:right;font-size:12px;color:var(--text-secondary);"><div><i class="fas fa-heart" style="color:#FF69B4;"></i> ' + p.likes + '</div><div><i class="fas fa-comment"></i> ' + p.comments + '</div></div></div>';
        }).join('') + '</div>';
}

// ---- ROLES & PERMISSIONS ----
function initAdminRoles() {
    var defaultRoles = [
        { name: 'Queen Bee', icon: 'crown', color: '#FFC30B', permissions: ['all'], description: 'Full admin access. Platform royalty.', count: 2 },
        { name: 'Worker Bee', icon: 'hard-hat', color: '#4CAF50', permissions: ['post', 'comment', 'like', 'dm', 'community'], description: 'Standard user with all basic features.', count: 8 },
        { name: 'Drone', icon: 'user', color: '#64B5F6', permissions: ['post', 'comment', 'like'], description: 'New or restricted user with limited features.', count: 3 }
    ];

    var allRoles = defaultRoles.concat(adminData.customRoles || []);

    var html = '';
    allRoles.forEach(function(role) {
        html += '<div class="admin-card" style="border-left: 3px solid ' + role.color + ';">' +
            '<div style="display: flex; justify-content: space-between; align-items: flex-start;">' +
                '<div><h4 style="color: ' + role.color + '; margin-bottom: 4px;"><i class="fas fa-' + role.icon + '"></i> ' + role.name + '</h4>' +
                '<p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">' + role.description + '</p>' +
                '<div style="display: flex; flex-wrap: wrap; gap: 4px;">' +
                    role.permissions.map(function(p) { return '<span style="padding: 2px 8px; border-radius: 4px; background: var(--bg-secondary); font-size: 11px; color: var(--text-secondary); border: 1px solid var(--border-color);">' + p + '</span>'; }).join('') +
                '</div></div>' +
                '<div style="text-align: right;"><span style="font-size: 24px; font-weight: 700; color: ' + role.color + ';">' + (role.count || 0) + '</span><br><span style="font-size: 11px; color: var(--text-secondary);">members</span></div>' +
            '</div></div>';
    });
    document.getElementById('adminRolesList').innerHTML = html;

    // Permission checkboxes
    var perms = ['post', 'comment', 'like', 'dm', 'community', 'moderate', 'analytics', 'admin'];
    document.getElementById('newRolePermissions').innerHTML = perms.map(function(p) {
        return '<label style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 8px; background: var(--bg-input); cursor: pointer; font-size: 13px;"><input type="checkbox" value="' + p + '" ' + (p === 'post' || p === 'comment' || p === 'like' ? 'checked' : '') + ' style="accent-color: var(--honey-yellow);"> ' + p.charAt(0).toUpperCase() + p.slice(1) + '</label>';
    }).join('');
}

function createCustomRole() {
    var name = document.getElementById('newRoleName').value.trim();
    var color = document.getElementById('newRoleColor').value;
    var icon = document.getElementById('newRoleIcon').value;
    if (!name) { showToast('Please enter a role name'); return; }

    var perms = [];
    document.querySelectorAll('#newRolePermissions input:checked').forEach(function(cb) { perms.push(cb.value); });

    adminData.customRoles.push({ name: name, icon: icon, color: color, permissions: perms, description: 'Custom role', count: 0 });
    saveAdminData();
    document.getElementById('newRoleName').value = '';
    initAdminRoles();
    showToast('Role created: ' + name);
    addAuditEntry('user_role', 'Created custom role: ' + name);
}

// ---- AUDIT LOG ----
function initAdminAuditLog() {
    filterAuditLog();
}

function filterAuditLog() {
    var actionFilter = document.getElementById('auditActionFilter').value;
    var timeFilter = document.getElementById('auditTimeFilter').value;
    var now = Date.now();
    var cutoff = 0;
    if (timeFilter === '24h') cutoff = now - 86400000;
    else if (timeFilter === '7d') cutoff = now - 604800000;
    else if (timeFilter === '30d') cutoff = now - 2592000000;

    var entries = adminData.auditLog.filter(function(e) {
        if (actionFilter && e.action !== actionFilter) return false;
        if (cutoff && new Date(e.time).getTime() < cutoff) return false;
        return true;
    });

    var iconMap = { user_ban: 'fa-ban', user_role: 'fa-crown', content_remove: 'fa-trash', config_change: 'fa-cog', announcement: 'fa-bullhorn' };
    var colorMap = { user_ban: '#FF4444', user_role: '#FFC30B', content_remove: '#FF9800', config_change: '#64B5F6', announcement: '#4CAF50' };

    if (entries.length === 0) {
        document.getElementById('adminAuditLogEntries').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No audit log entries found for this filter.</div>';
        return;
    }

    document.getElementById('adminAuditLogEntries').innerHTML = entries.map(function(e) {
        var icon = iconMap[e.action] || 'fa-info-circle';
        var color = colorMap[e.action] || 'var(--text-secondary)';
        var time = new Date(e.time);
        var timeStr = time.toLocaleDateString() + ' ' + time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        return '<div class="admin-log-entry">' +
            '<i class="fas ' + icon + '" style="color: ' + color + '; margin-top: 2px; width: 20px; text-align: center;"></i>' +
            '<div style="flex: 1;"><strong>@' + (e.admin || 'admin') + '</strong> ' + e.detail + '</div>' +
            '<span class="log-time">' + timeStr + '</span></div>';
    }).join('');
}

// ---- ADMIN PANEL INIT ----
function initAdminPanel() {
    loadAdminData();
    initAdminDashboard();
}

// ==================== ADMIN PANEL V2 â€” PROFILE VIEWER, HONEY POINTS, VIOLATIONS, NOTES, BULK, APPEALS, MOD LOG, CONTENT SEARCH ====================

var adminViewingUser = null;

// ---- Extended adminData fields ----
function ensureAdminDataV2() {
    if (!adminData.userWarnings) adminData.userWarnings = {};
    if (!adminData.userNotes) adminData.userNotes = {};
    if (!adminData.editBans) adminData.editBans = {};
    if (!adminData.honeyHistory) adminData.honeyHistory = {};
    if (!adminData.appeals) adminData.appeals = [];
    if (!adminData.modLog) adminData.modLog = [];
    if (!adminData.userHoneyOverrides) adminData.userHoneyOverrides = {};

    // Seed appeals if empty
    if (adminData.appeals.length === 0) {
        adminData.appeals = [
            { id: 1, username: 'angry_wasp', type: 'ban_appeal', reason: 'I was having a bad day and I apologize for my behavior. It wont happen again. Please give me another chance.', status: 'pending', date: new Date(Date.now() - 43200000).toISOString(), decision: null, decidedBy: null },
            { id: 2, username: 'spammer99', type: 'warning_appeal', reason: 'The links I posted were legitimate resources for beekeeping, not spam. I can provide context.', status: 'pending', date: new Date(Date.now() - 86400000).toISOString(), decision: null, decidedBy: null }
        ];
    }
}

// ---- PROFILE VIEWER ----
function openAdminProfileViewer(username) {
    ensureAdminDataV2();
    var user = (window._adminUsersList || []).find(function(u) { return u.username === username; });
    if (!user) { showToast('User not found'); return; }
    adminViewingUser = user;

    document.getElementById('adminUsers').querySelector('h3').style.display = 'none';
    document.getElementById('adminUsers').querySelector('div[style*="display: flex"]').style.display = 'none';
    document.getElementById('adminUsers').querySelector('div[style*="overflow-x"]').style.display = 'none';
    var bulkBar = document.getElementById('adminBulkBar');
    if (bulkBar) bulkBar.style.display = 'none';
    document.getElementById('adminProfileViewer').style.display = 'block';

    var avatar = user.avatar || ('https://api.dicebear.com/7.x/avataaars/svg?seed=' + user.username);
    document.getElementById('adminProfileAvatar').src = avatar;
    document.getElementById('adminProfileUsername').textContent = '@' + user.username;
    document.getElementById('adminProfileHandle').textContent = '@' + user.username;
    document.getElementById('adminProfileDisplayName').textContent = user.displayName || user.username;
    document.getElementById('adminProfileBio').textContent = user.bio || 'No bio set';

    var hp = adminData.userHoneyOverrides[user.username] !== undefined ? adminData.userHoneyOverrides[user.username] : (user.honeyPoints || 0);
    document.getElementById('adminProfileHoneyPoints').textContent = hp.toLocaleString();

    var roleEl = document.getElementById('adminProfileRole');
    roleEl.textContent = user.role || 'drone';
    roleEl.className = 'admin-badge ' + ((user.role === 'queen' || user.role === 'admin') ? 'queen' : user.role === 'worker' ? 'worker' : 'drone');

    var statusEl = document.getElementById('adminProfileStatus');
    statusEl.textContent = user.status || 'active';
    statusEl.className = 'admin-badge ' + (user.status === 'active' ? 'active' : user.status === 'banned' ? 'banned' : 'suspended');

    // Banner
    var bannerEl = document.getElementById('adminProfileBanner');
    if (user.banner) {
        bannerEl.innerHTML = '<img src="' + user.banner + '" alt="Banner">';
    } else {
        bannerEl.innerHTML = '';
        bannerEl.style.background = 'linear-gradient(135deg, var(--flower-pink), var(--honey-yellow))';
    }

    renderAdminHoneyHistory(user.username);
    renderAdminWarnings(user.username);
    renderAdminEditLock(user.username);
    renderAdminNotes(user.username);
}

function closeAdminProfileViewer() {
    document.getElementById('adminProfileViewer').style.display = 'none';
    document.getElementById('adminUsers').querySelector('h3').style.display = '';
    var divs = document.getElementById('adminUsers').querySelectorAll(':scope > div');
    divs.forEach(function(d) { if (d.id !== 'adminProfileViewer') d.style.display = ''; });
    adminViewingUser = null;
}

// ---- RESET PROFILE ELEMENTS ----
function adminResetAvatar() {
    if (!adminViewingUser) return;
    if (!confirm('Reset @' + adminViewingUser.username + "'s avatar to default? This will issue a warning.")) return;
    adminViewingUser.avatar = '';
    document.getElementById('adminProfileAvatar').src = 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + adminViewingUser.username;
    addUserWarning(adminViewingUser.username, 'Avatar was reset to default by admin due to violation.', 'profile_reset');
    addModLogEntry('profile_reset', 'Reset avatar for @' + adminViewingUser.username);
    addAuditEntry('content_remove', 'Reset avatar for @' + adminViewingUser.username);
    applyEditBan(adminViewingUser.username, 24);
    renderAdminUsers(window._adminUsersList);
    showToast('Avatar reset + warning issued + 24h edit ban applied');
    renderAdminWarnings(adminViewingUser.username);
    renderAdminEditLock(adminViewingUser.username);
}

function adminResetBanner() {
    if (!adminViewingUser) return;
    if (!confirm('Reset @' + adminViewingUser.username + "'s banner to default? This will issue a warning.")) return;
    adminViewingUser.banner = '';
    var bannerEl = document.getElementById('adminProfileBanner');
    bannerEl.innerHTML = '';
    bannerEl.style.background = 'linear-gradient(135deg, var(--flower-pink), var(--honey-yellow))';
    addUserWarning(adminViewingUser.username, 'Banner was reset to default by admin due to violation.', 'profile_reset');
    addModLogEntry('profile_reset', 'Reset banner for @' + adminViewingUser.username);
    addAuditEntry('content_remove', 'Reset banner for @' + adminViewingUser.username);
    applyEditBan(adminViewingUser.username, 24);
    renderAdminUsers(window._adminUsersList);
    showToast('Banner reset + warning issued + 24h edit ban applied');
    renderAdminWarnings(adminViewingUser.username);
    renderAdminEditLock(adminViewingUser.username);
}

function adminResetBio() {
    if (!adminViewingUser) return;
    if (!confirm('Reset @' + adminViewingUser.username + "'s bio to default? This will issue a warning.")) return;
    adminViewingUser.bio = 'Welcome to Polleneer!';
    document.getElementById('adminProfileBio').textContent = 'Welcome to Polleneer!';
    addUserWarning(adminViewingUser.username, 'Bio was reset to default by admin due to violation.', 'profile_reset');
    addModLogEntry('profile_reset', 'Reset bio for @' + adminViewingUser.username);
    addAuditEntry('content_remove', 'Reset bio for @' + adminViewingUser.username);
    applyEditBan(adminViewingUser.username, 24);
    showToast('Bio reset + warning issued + 24h edit ban applied');
    renderAdminWarnings(adminViewingUser.username);
    renderAdminEditLock(adminViewingUser.username);
}

function adminResetAll() {
    if (!adminViewingUser) return;
    if (!confirm('Reset ALL profile elements (avatar, banner, bio) for @' + adminViewingUser.username + '?')) return;
    adminViewingUser.avatar = '';
    adminViewingUser.banner = '';
    adminViewingUser.bio = 'Welcome to Polleneer!';
    document.getElementById('adminProfileAvatar').src = 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + adminViewingUser.username;
    var bannerEl = document.getElementById('adminProfileBanner');
    bannerEl.innerHTML = '';
    bannerEl.style.background = 'linear-gradient(135deg, var(--flower-pink), var(--honey-yellow))';
    document.getElementById('adminProfileBio').textContent = 'Welcome to Polleneer!';
    addUserWarning(adminViewingUser.username, 'All profile elements (avatar, banner, bio) were reset by admin due to violation.', 'profile_reset');
    addModLogEntry('profile_reset', 'Reset all profile elements for @' + adminViewingUser.username);
    addAuditEntry('content_remove', 'Reset all profile elements for @' + adminViewingUser.username);
    applyEditBan(adminViewingUser.username, 24);
    renderAdminUsers(window._adminUsersList);
    showToast('Full profile reset + warning + 24h edit ban applied');
    renderAdminWarnings(adminViewingUser.username);
    renderAdminEditLock(adminViewingUser.username);
}

// ---- HONEY POINTS MANAGEMENT ----
function adminApplyHoneyPoints() {
    if (!adminViewingUser) return;
    var action = document.getElementById('adminHoneyAction').value;
    var amount = parseInt(document.getElementById('adminHoneyAmount').value) || 0;
    var reason = document.getElementById('adminHoneyReason').value;
    if (amount <= 0 && action !== 'set') { showToast('Enter a valid amount'); return; }

    var username = adminViewingUser.username;
    var currentHP = adminData.userHoneyOverrides[username] !== undefined ? adminData.userHoneyOverrides[username] : (adminViewingUser.honeyPoints || 0);
    var newHP = currentHP;
    var detail = '';

    if (action === 'add') {
        newHP = currentHP + amount;
        detail = 'Added ' + amount + ' Honey Points to @' + username + ' (Reason: ' + reason + ')';
    } else if (action === 'deduct') {
        newHP = Math.max(0, currentHP - amount);
        detail = 'Deducted ' + amount + ' Honey Points from @' + username + ' (Reason: ' + reason + ')';
    } else if (action === 'set') {
        newHP = amount;
        detail = 'Set @' + username + ' Honey Points to ' + amount + ' (Reason: ' + reason + ')';
    }

    adminData.userHoneyOverrides[username] = newHP;
    if (!adminData.honeyHistory[username]) adminData.honeyHistory[username] = [];
    adminData.honeyHistory[username].unshift({
        action: action,
        amount: amount,
        reason: reason,
        oldHP: currentHP,
        newHP: newHP,
        admin: currentUser ? currentUser.username : 'admin',
        time: new Date().toISOString()
    });

    document.getElementById('adminProfileHoneyPoints').textContent = newHP.toLocaleString();
    saveAdminData();
    addModLogEntry('honey_adjust', detail);
    addAuditEntry('config_change', detail);
    renderAdminHoneyHistory(username);

    // Send warning notification if deduction for violation
    if (action === 'deduct' && (reason === 'violation' || reason === 'illegal')) {
        addUserWarning(username, 'Honey Points deducted: -' + amount + ' (' + reason + ')', 'honey_penalty');
    }

    showToast(detail);
}

function renderAdminHoneyHistory(username) {
    var history = (adminData.honeyHistory && adminData.honeyHistory[username]) || [];
    var el = document.getElementById('adminHoneyHistory');
    if (history.length === 0) {
        el.innerHTML = '<div style="text-align: center; padding: 10px; color: var(--text-secondary);">No Honey Points adjustments</div>';
        return;
    }
    el.innerHTML = history.slice(0, 10).map(function(h) {
        var icon = h.action === 'add' ? '<i class="fas fa-plus-circle" style="color: #4CAF50;"></i>' : h.action === 'deduct' ? '<i class="fas fa-minus-circle" style="color: #FF4444;"></i>' : '<i class="fas fa-equals" style="color: #64B5F6;"></i>';
        return '<div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border-color);">' +
            icon + ' <span>' + h.oldHP + ' â†’ ' + h.newHP + '</span> <span style="color: var(--text-secondary); font-size: 11px; margin-left: auto;">' + h.reason + ' Â· ' + new Date(h.time).toLocaleDateString() + '</span></div>';
    }).join('');
}

// ---- VIOLATIONS & WARNINGS ----
function addUserWarning(username, message, type) {
    if (!adminData.userWarnings[username]) adminData.userWarnings[username] = [];
    adminData.userWarnings[username].unshift({
        id: Date.now(),
        message: message,
        type: type || 'warning',
        admin: currentUser ? currentUser.username : 'admin',
        time: new Date().toISOString(),
        acknowledged: false
    });
    saveAdminData();
}

function adminIssueWarning() {
    if (!adminViewingUser) return;
    var type = document.getElementById('adminViolationType').value;
    var note = document.getElementById('adminViolationNote').value.trim();
    var message = 'Warning: ' + type.replace(/_/g, ' ') + (note ? ' â€” ' + note : '');
    addUserWarning(adminViewingUser.username, message, 'warning');
    addModLogEntry('warning', 'Issued warning to @' + adminViewingUser.username + ': ' + type);
    addAuditEntry('user_ban', 'Warned @' + adminViewingUser.username + ': ' + type);
    document.getElementById('adminViolationNote').value = '';
    renderAdminWarnings(adminViewingUser.username);
    showToast('Warning issued to @' + adminViewingUser.username);
}

function adminIssueWarningWithBan() {
    if (!adminViewingUser) return;
    var type = document.getElementById('adminViolationType').value;
    var note = document.getElementById('adminViolationNote').value.trim();
    var message = 'Warning: ' + type.replace(/_/g, ' ') + ' â€” 24-hour profile edit ban applied.' + (note ? ' Note: ' + note : '');
    addUserWarning(adminViewingUser.username, message, 'warning_ban');
    applyEditBan(adminViewingUser.username, 24);
    addModLogEntry('edit_ban', 'Warned + 24h edit ban on @' + adminViewingUser.username + ': ' + type);
    addAuditEntry('user_ban', 'Warned + 24h edit ban on @' + adminViewingUser.username + ': ' + type);
    document.getElementById('adminViolationNote').value = '';
    renderAdminWarnings(adminViewingUser.username);
    renderAdminEditLock(adminViewingUser.username);
    showToast('Warning + 24h edit ban applied to @' + adminViewingUser.username);
}

function adminIssueWarningResetBan() {
    if (!adminViewingUser) return;
    if (!confirm('This will RESET avatar/banner/bio, issue a warning, AND apply a 24h edit ban. Proceed?')) return;
    adminResetAll();
}

function renderAdminWarnings(username) {
    var warnings = (adminData.userWarnings && adminData.userWarnings[username]) || [];
    var el = document.getElementById('adminUserWarnings');
    if (warnings.length === 0) {
        el.innerHTML = '<div style="text-align: center; padding: 10px; color: var(--text-secondary); font-size: 13px;">No warnings on record</div>';
        return;
    }
    el.innerHTML = '<h5 style="margin-bottom: 8px; color: var(--text-secondary); font-size: 12px;">Warning History (' + warnings.length + ')</h5>' +
        warnings.slice(0, 10).map(function(w) {
            return '<div class="admin-warning-card' + (w.type === 'warning_ban' ? ' active' : '') + '">' +
                '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">' +
                    '<span style="font-size: 12px; font-weight: 600; color: ' + (w.type === 'warning_ban' ? '#FF4444' : '#FF9800') + ';"><i class="fas fa-' + (w.type === 'warning_ban' ? 'ban' : 'exclamation-triangle') + '"></i> ' + (w.type === 'warning_ban' ? 'Warning + Edit Ban' : w.type === 'profile_reset' ? 'Profile Reset' : w.type === 'honey_penalty' ? 'Honey Points Penalty' : 'Warning') + '</span>' +
                    '<span style="font-size: 11px; color: var(--text-secondary);">by @' + w.admin + '</span>' +
                '</div>' +
                '<p style="font-size: 13px; margin-bottom: 4px;">' + w.message + '</p>' +
                '<span style="font-size: 11px; color: var(--text-secondary);">' + new Date(w.time).toLocaleString() + '</span>' +
            '</div>';
        }).join('');
}


// ---- 24-HOUR EDIT BAN ----
function applyEditBan(username, hours) {
    var expiry = Date.now() + (hours * 3600000);
    adminData.editBans[username] = { expiry: expiry, appliedBy: currentUser ? currentUser.username : 'admin', appliedAt: new Date().toISOString() };
    saveAdminData();
}

function isEditBanned(username) {
    if (!adminData.editBans || !adminData.editBans[username]) return false;
    return Date.now() < adminData.editBans[username].expiry;
}

function renderAdminEditLock(username) {
    var el = document.getElementById('adminEditLockStatus');
    if (isEditBanned(username)) {
        var ban = adminData.editBans[username];
        var remaining = ban.expiry - Date.now();
        var hours = Math.floor(remaining / 3600000);
        var mins = Math.floor((remaining % 3600000) / 60000);
        el.innerHTML = '<div style="display: flex; align-items: center; justify-content: space-between;">' +
            '<div><span style="color: #FF4444; font-weight: 600;"><i class="fas fa-lock"></i> LOCKED</span>' +
            '<span style="margin-left: 10px; font-size: 13px; color: var(--text-secondary);">' + hours + 'h ' + mins + 'm remaining</span>' +
            '<br><span style="font-size: 12px; color: var(--text-secondary);">Applied by @' + ban.appliedBy + ' at ' + new Date(ban.appliedAt).toLocaleString() + '</span></div>' +
            '<button class="admin-action-btn success" onclick="adminRemoveEditBan(\'' + username + '\')"><i class="fas fa-unlock"></i> Remove Ban</button></div>' +
            '<p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">User cannot change avatar, banner, or bio until the lock expires.</p>';
    } else {
        el.innerHTML = '<div style="display: flex; align-items: center; justify-content: space-between;">' +
            '<span style="color: #4CAF50; font-weight: 600;"><i class="fas fa-unlock"></i> No active edit ban</span>' +
            '<button class="admin-action-btn" onclick="adminManualEditBan(\'' + username + '\')"><i class="fas fa-lock"></i> Apply 24h Ban</button></div>';
    }
}

function adminRemoveEditBan(username) {
    delete adminData.editBans[username];
    saveAdminData();
    renderAdminEditLock(username);
    addModLogEntry('edit_ban', 'Removed edit ban for @' + username);
    addAuditEntry('user_ban', 'Removed edit ban for @' + username);
    showToast('Edit ban removed for @' + username);
}

function adminManualEditBan(username) {
    applyEditBan(username, 24);
    renderAdminEditLock(username);
    addModLogEntry('edit_ban', 'Manually applied 24h edit ban on @' + username);
    addAuditEntry('user_ban', 'Applied 24h edit ban on @' + username);
    showToast('24h edit ban applied to @' + username);
}

// ---- ADMIN NOTES (Internal) ----
function adminAddNote() {
    if (!adminViewingUser) return;
    var input = document.getElementById('adminNoteInput');
    var text = input.value.trim();
    if (!text) return;
    var username = adminViewingUser.username;
    if (!adminData.userNotes[username]) adminData.userNotes[username] = [];
    adminData.userNotes[username].unshift({
        text: text,
        admin: currentUser ? currentUser.username : 'admin',
        time: new Date().toISOString()
    });
    saveAdminData();
    input.value = '';
    renderAdminNotes(username);
    showToast('Note added');
}

function renderAdminNotes(username) {
    var notes = (adminData.userNotes && adminData.userNotes[username]) || [];
    var el = document.getElementById('adminNotesHistory');
    if (notes.length === 0) {
        el.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-secondary); font-size: 13px;">No admin notes for this user</div>';
        return;
    }
    el.innerHTML = notes.map(function(n) {
        return '<div class="admin-note-entry"><div style="display: flex; justify-content: space-between; margin-bottom: 4px;">' +
            '<strong style="font-size: 12px;">@' + n.admin + '</strong>' +
            '<span style="font-size: 11px; color: var(--text-secondary);">' + new Date(n.time).toLocaleString() + '</span></div>' +
            '<p style="margin: 0;">' + n.text + '</p></div>';
    }).join('');
}

// ---- BULK ACTIONS ----
var adminSelectedUsers = [];

function toggleAdminUserSelect(username, checkbox) {
    if (checkbox.checked) {
        if (adminSelectedUsers.indexOf(username) === -1) adminSelectedUsers.push(username);
    } else {
        adminSelectedUsers = adminSelectedUsers.filter(function(u) { return u !== username; });
    }
    updateAdminBulkBar();
}

function toggleAdminSelectAll(masterCheckbox) {
    var checkboxes = document.querySelectorAll('#adminUserTableBody .admin-user-checkbox');
    checkboxes.forEach(function(cb) {
        cb.checked = masterCheckbox.checked;
        var username = cb.getAttribute('data-username');
        if (masterCheckbox.checked) {
            if (adminSelectedUsers.indexOf(username) === -1) adminSelectedUsers.push(username);
        }
    });
    if (!masterCheckbox.checked) adminSelectedUsers = [];
    updateAdminBulkBar();
}

function updateAdminBulkBar() {
    var bar = document.getElementById('adminBulkBar');
    if (!bar) return;
    if (adminSelectedUsers.length > 0) {
        bar.style.display = 'flex';
        document.getElementById('adminBulkCount').textContent = adminSelectedUsers.length + ' user' + (adminSelectedUsers.length > 1 ? 's' : '') + ' selected';
    } else {
        bar.style.display = 'none';
    }
}

function adminBulkAction(action) {
    if (adminSelectedUsers.length === 0) return;
    var count = adminSelectedUsers.length;

    if (action === 'ban') {
        if (!confirm('Ban ' + count + ' users?')) return;
        adminSelectedUsers.forEach(function(username) {
            var user = (window._adminUsersList || []).find(function(u) { return u.username === username; });
            if (user) user.status = 'banned';
            addModLogEntry('user_ban', 'Bulk banned @' + username);
        });
        addAuditEntry('user_ban', 'Bulk banned ' + count + ' users');
        showToast('Banned ' + count + ' users');
    } else if (action === 'warn') {
        if (!confirm('Send warning to ' + count + ' users?')) return;
        adminSelectedUsers.forEach(function(username) {
            addUserWarning(username, 'Bulk warning issued by admin', 'warning');
            addModLogEntry('warning', 'Bulk warned @' + username);
        });
        addAuditEntry('user_ban', 'Bulk warned ' + count + ' users');
        showToast('Warning sent to ' + count + ' users');
    } else if (action === 'role') {
        var newRole = prompt('Enter new role (queen, worker, drone):');
        if (!newRole || ['queen', 'worker', 'drone'].indexOf(newRole) === -1) return;
        adminSelectedUsers.forEach(function(username) {
            var user = (window._adminUsersList || []).find(function(u) { return u.username === username; });
            if (user) user.role = newRole;
            addModLogEntry('user_ban', 'Bulk role change @' + username + ' to ' + newRole);
        });
        addAuditEntry('user_role', 'Bulk changed ' + count + ' users to ' + newRole);
        showToast('Changed ' + count + ' users to ' + newRole);
    }

    adminSelectedUsers = [];
    renderAdminUsers(window._adminUsersList);
    updateAdminBulkBar();
}

// ---- APPEALS ----
function initAdminAppeals() {
    ensureAdminDataV2();
    switchAppealTab('pending');
}

function switchAppealTab(tab) {
    var tabs = ['pending', 'approved', 'denied'];
    tabs.forEach(function(t) {
        var btn = document.getElementById('appealTab' + t.charAt(0).toUpperCase() + t.slice(1));
        if (btn) { btn.style.fontWeight = t === tab ? '600' : ''; btn.style.borderColor = t === tab ? 'var(--flower-pink)' : 'var(--border-color)'; btn.style.color = t === tab ? 'var(--flower-pink)' : 'var(--text-primary)'; }
    });

    var appeals = adminData.appeals.filter(function(a) { return a.status === tab; });
    var pending = adminData.appeals.filter(function(a) { return a.status === 'pending'; });
    document.getElementById('appealPendingCount').textContent = pending.length;

    var el = document.getElementById('adminAppealsList');
    if (appeals.length === 0) {
        var emptyMsg = tab === 'pending' ? 'No pending appeals' : tab === 'approved' ? 'No approved appeals' : 'No denied appeals';
        el.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-' + (tab === 'pending' ? 'inbox' : tab === 'approved' ? 'check-circle' : 'times-circle') + '" style="font-size: 40px; margin-bottom: 12px; display: block;"></i>' + emptyMsg + '</div>';
        return;
    }

    el.innerHTML = appeals.map(function(a) {
        var typeLabel = a.type === 'ban_appeal' ? 'Ban Appeal' : a.type === 'warning_appeal' ? 'Warning Appeal' : 'Edit Ban Appeal';
        return '<div class="admin-appeal-card ' + a.status + '">' +
            '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">' +
                '<div><strong>@' + a.username + '</strong> <span class="admin-badge" style="margin-left: 6px; background: rgba(100,181,246,0.2); color: #64B5F6;">' + typeLabel + '</span></div>' +
                '<span style="font-size: 12px; color: var(--text-secondary);">' + new Date(a.date).toLocaleString() + '</span>' +
            '</div>' +
            '<p style="font-size: 14px; margin-bottom: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">"' + a.reason + '"</p>' +
            (a.status === 'pending' ?
                '<div style="display: flex; gap: 8px;">' +
                    '<button class="admin-btn primary" onclick="decideAppeal(' + a.id + ', \'approved\')" style="background: #4CAF50;"><i class="fas fa-check"></i> Approve</button>' +
                    '<button class="admin-btn secondary" onclick="decideAppeal(' + a.id + ', \'denied\')" style="border-color: rgba(255,68,68,0.5); color: #FF4444;"><i class="fas fa-times"></i> Deny</button>' +
                    '<button class="admin-action-btn" onclick="openAdminProfileViewer(\'' + a.username + '\'); switchAdminTab(\'users\');"><i class="fas fa-user"></i> View Profile</button>' +
                '</div>' :
                '<div style="font-size: 13px; color: var(--text-secondary);"><i class="fas fa-' + (a.status === 'approved' ? 'check' : 'times') + '"></i> ' + (a.status === 'approved' ? 'Approved' : 'Denied') + ' by @' + (a.decidedBy || 'admin') + '</div>'
            ) +
        '</div>';
    }).join('');
}

function decideAppeal(id, decision) {
    var appeal = adminData.appeals.find(function(a) { return a.id === id; });
    if (!appeal) return;

    var actionLabel = decision === 'approved' ? 'Approve' : 'Deny';
    if (!confirm(actionLabel + ' appeal from @' + appeal.username + '?')) return;

    appeal.status = decision;
    appeal.decidedBy = currentUser ? currentUser.username : 'admin';
    appeal.decidedAt = new Date().toISOString();

    if (decision === 'approved') {
        // Unban user if ban appeal
        if (appeal.type === 'ban_appeal') {
            var user = (window._adminUsersList || []).find(function(u) { return u.username === appeal.username; });
            if (user) user.status = 'active';
            renderAdminUsers(window._adminUsersList);
        }
        // Remove edit ban if edit_ban appeal
        if (appeal.type === 'edit_ban_appeal') {
            delete adminData.editBans[appeal.username];
        }
        addUserWarning(appeal.username, 'Your appeal has been approved. Your restrictions have been lifted.', 'appeal_approved');
    } else {
        addUserWarning(appeal.username, 'Your appeal has been reviewed and denied. The current restrictions remain in place.', 'appeal_denied');
    }

    saveAdminData();
    addModLogEntry('appeal_decision', actionLabel + 'd appeal from @' + appeal.username + ' (' + appeal.type + ')');
    addAuditEntry('user_ban', actionLabel + 'd appeal from @' + appeal.username);
    switchAppealTab('pending');
    showToast('Appeal ' + decision);
}

// ---- MOD ACTIVITY LOG ----
function addModLogEntry(action, detail) {
    ensureAdminDataV2();
    adminData.modLog.unshift({
        action: action,
        moderator: currentUser ? currentUser.username : 'admin',
        detail: detail,
        time: new Date().toISOString()
    });
    saveAdminData();
}

function initAdminModLog() {
    ensureAdminDataV2();
    filterModLog();
}

function filterModLog() {
    var modFilter = document.getElementById('modLogModFilter').value;
    var actionFilter = document.getElementById('modLogActionFilter').value;

    var entries = adminData.modLog.filter(function(e) {
        if (modFilter && e.moderator !== modFilter) return false;
        if (actionFilter && e.action !== actionFilter) return false;
        return true;
    });

    var iconMap = { warning: 'fa-exclamation-triangle', edit_ban: 'fa-lock', profile_reset: 'fa-undo-alt', honey_adjust: 'fa-coins', report_resolved: 'fa-flag', appeal_decision: 'fa-gavel', user_ban: 'fa-ban' };
    var colorMap = { warning: '#FF9800', edit_ban: '#FF4444', profile_reset: '#64B5F6', honey_adjust: '#FFC30B', report_resolved: '#4CAF50', appeal_decision: '#9C27B0', user_ban: '#FF4444' };

    var el = document.getElementById('adminModLogEntries');
    if (entries.length === 0) {
        el.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No moderator actions found for this filter.</div>';
        return;
    }

    el.innerHTML = entries.slice(0, 100).map(function(e) {
        var icon = iconMap[e.action] || 'fa-info-circle';
        var color = colorMap[e.action] || 'var(--text-secondary)';
        return '<div class="admin-mod-log-entry">' +
            '<i class="fas ' + icon + '" style="color: ' + color + '; margin-top: 2px; width: 20px; text-align: center;"></i>' +
            '<div style="flex: 1;"><strong>@' + e.moderator + '</strong> ' + e.detail + '</div>' +
            '<span style="color: var(--text-secondary); white-space: nowrap; font-size: 12px;">' + new Date(e.time).toLocaleString() + '</span></div>';
    }).join('');
}

// ---- CONTENT SEARCH ----
function initAdminContentSearch() {
    document.getElementById('adminContentSearchResults').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-search-plus" style="font-size: 40px; margin-bottom: 12px; display: block;"></i>Search posts by keyword, username, or content to investigate reports and find specific posts.</div>';
}

function adminSearchContent() {
    var query = (document.getElementById('adminContentSearchInput').value || '').toLowerCase().trim();
    var typeFilter = document.getElementById('adminContentTypeFilter').value;
    if (!query) { showToast('Enter a search query'); return; }

    var postsList = (typeof posts !== 'undefined' && posts.length) ? posts : [];
    var results = postsList.filter(function(p) {
        var matchesQuery = (p.content || '').toLowerCase().indexOf(query) > -1 ||
            (p.username || '').toLowerCase().indexOf(query) > -1 ||
            (p.displayName || '').toLowerCase().indexOf(query) > -1;
        if (typeFilter && p.type && p.type !== typeFilter) return false;
        return matchesQuery;
    });

    var el = document.getElementById('adminContentSearchResults');
    if (results.length === 0) {
        el.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-search" style="font-size: 40px; margin-bottom: 12px; display: block;"></i>No results found for "' + query + '"</div>';
        return;
    }

    el.innerHTML = '<p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">' + results.length + ' result' + (results.length > 1 ? 's' : '') + ' found</p>' +
        results.slice(0, 50).map(function(p) {
            var avatar = (p.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + (p.username || 'user'));
            return '<div class="admin-content-search-result">' +
                '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">' +
                    '<div style="display: flex; align-items: center; gap: 8px;">' +
                        '<img src="' + avatar + '" style="width: 32px; height: 32px; border-radius: 50%; background: var(--bg-secondary);">' +
                        '<div><strong>' + (p.displayName || p.username || 'User') + '</strong> <span style="color: var(--text-secondary); font-size: 12px;">@' + (p.username || 'user') + '</span></div>' +
                    '</div>' +
                    '<div style="display: flex; gap: 6px;">' +
                        '<button class="admin-action-btn danger" onclick="adminRemovePost(' + (p.id || 0) + ')"><i class="fas fa-trash"></i> Remove</button>' +
                        '<button class="admin-action-btn" onclick="adminFlagPost(' + (p.id || 0) + ')"><i class="fas fa-flag"></i> Flag</button>' +
                    '</div>' +
                '</div>' +
                '<p style="font-size: 14px;">' + (p.content || '(no content)') + '</p>' +
                (p.image ? '<img src="' + p.image + '" style="max-width: 200px; border-radius: 8px; margin-top: 8px;">' : '') +
                '<div style="margin-top: 6px; font-size: 12px; color: var(--text-secondary);"><i class="fas fa-heart"></i> ' + (p.likes || 0) + ' Â· <i class="fas fa-comment"></i> ' + ((p.comments && p.comments.length) || 0) + ' Â· ' + (p.time || '') + '</div>' +
            '</div>';
        }).join('');
}

function adminRemovePost(postId) {
    if (!confirm('Remove this post? This cannot be undone.')) return;
    if (typeof posts !== 'undefined') {
        var idx = posts.findIndex(function(p) { return p.id === postId; });
        if (idx > -1) {
            var removed = posts.splice(idx, 1)[0];
            addModLogEntry('content_remove', 'Removed post by @' + (removed.username || 'unknown'));
            addAuditEntry('content_remove', 'Removed post #' + postId + ' by @' + (removed.username || 'unknown'));
        }
    }
    adminSearchContent();
    showToast('Post removed');
}

function adminFlagPost(postId) {
    ensureAdminDataV2();
    adminData.reports.push({
        id: Date.now(),
        type: 'admin_flagged',
        reporter: currentUser ? currentUser.username : 'admin',
        target: 'post #' + postId,
        content: 'Flagged by admin during content search',
        status: 'pending',
        date: new Date().toISOString()
    });
    saveAdminData();
    addModLogEntry('report_resolved', 'Flagged post #' + postId + ' during content search');
    showToast('Post flagged for review');
}

// ---- EDIT BAN ENFORCEMENT (hook into profile edit functions) ----
function checkEditBan() {
    if (!currentUser) return false;
    ensureAdminDataV2();
    if (isEditBanned(currentUser.username)) {
        var ban = adminData.editBans[currentUser.username];
        var remaining = ban.expiry - Date.now();
        var hours = Math.floor(remaining / 3600000);
        var mins = Math.floor((remaining % 3600000) / 60000);
        showToast('Your profile editing is locked for ' + hours + 'h ' + mins + 'm due to a violation. Contact admin if you believe this is an error.');
        return true;
    }
    return false;
}

// ---- Update switchAdminTab to handle new tabs ----
(function() {
    var _origSwitchTab = switchAdminTab;
    switchAdminTab = function(tab) {
        // Close profile viewer if switching tabs
        if (tab !== 'users' && document.getElementById('adminProfileViewer').style.display === 'block') {
            closeAdminProfileViewer();
        }

        // Handle new tabs
        if (tab === 'appeals') {
            document.querySelectorAll('.admin-section').forEach(function(s) { s.classList.remove('active'); });
            document.querySelectorAll('.admin-sidebar-btn').forEach(function(b) { b.classList.remove('active'); });
            document.getElementById('adminAppeals').classList.add('active');
            document.querySelectorAll('.admin-sidebar-btn').forEach(function(b) { if (b.getAttribute('onclick') && b.getAttribute('onclick').indexOf("'appeals'") > -1) b.classList.add('active'); });
            initAdminAppeals();
            return;
        }
        if (tab === 'modlog') {
            document.querySelectorAll('.admin-section').forEach(function(s) { s.classList.remove('active'); });
            document.querySelectorAll('.admin-sidebar-btn').forEach(function(b) { b.classList.remove('active'); });
            document.getElementById('adminModlog').classList.add('active');
            document.querySelectorAll('.admin-sidebar-btn').forEach(function(b) { if (b.getAttribute('onclick') && b.getAttribute('onclick').indexOf("'modlog'") > -1) b.classList.add('active'); });
            initAdminModLog();
            return;
        }
        if (tab === 'contentsearch') {
            document.querySelectorAll('.admin-section').forEach(function(s) { s.classList.remove('active'); });
            document.querySelectorAll('.admin-sidebar-btn').forEach(function(b) { b.classList.remove('active'); });
            document.getElementById('adminContentsearch').classList.add('active');
            document.querySelectorAll('.admin-sidebar-btn').forEach(function(b) { if (b.getAttribute('onclick') && b.getAttribute('onclick').indexOf("'contentsearch'") > -1) b.classList.add('active'); });
            initAdminContentSearch();
            return;
        }

        _origSwitchTab(tab);
    };
})();

// ---- Update renderAdminUsers to include bulk checkboxes + HP column + view profile button ----
(function() {
    var _origRenderUsers = renderAdminUsers;
    renderAdminUsers = function(list) {
        adminSelectedUsers = [];
        var tbody = document.getElementById('adminUserTableBody');
        tbody.innerHTML = list.map(function(u) {
            var roleClass = (u.role === 'queen' || u.role === 'admin') ? 'queen' : (u.role === 'worker' ? 'worker' : 'drone');
            var statusClass = u.status === 'active' ? 'active' : (u.status === 'banned' ? 'banned' : 'suspended');
            var avatar = u.avatar || ('https://api.dicebear.com/7.x/avataaars/svg?seed=' + u.username);
            var hp = (adminData.userHoneyOverrides && adminData.userHoneyOverrides[u.username] !== undefined) ? adminData.userHoneyOverrides[u.username] : (u.honeyPoints || 0);
            var isBanned = isEditBanned(u.username);
            return '<tr>' +
                '<td><input type="checkbox" class="admin-user-checkbox" data-username="' + u.username + '" onchange="toggleAdminUserSelect(\'' + u.username + '\', this)" style="accent-color: var(--honey-yellow);"></td>' +
                '<td><div style="display: flex; align-items: center; gap: 10px;"><img src="' + avatar + '" style="width: 36px; height: 36px; border-radius: 50%; background: var(--bg-secondary);"><div><strong>' + (u.displayName || u.username) + '</strong><br><span style="color: var(--text-secondary); font-size: 12px;">@' + u.username + '</span></div></div></td>' +
                '<td><span class="admin-badge ' + roleClass + '">' + (u.role || 'drone') + '</span></td>' +
                '<td><span class="admin-badge ' + statusClass + '">' + (u.status || 'active') + '</span>' + (isBanned ? ' <span class="admin-badge" style="background: rgba(255,68,68,0.2); color: #FF4444; font-size: 9px;">EDIT BAN</span>' : '') + '</td>' +
                '<td style="font-size: 13px; color: var(--text-secondary);">' + (u.joined || 'N/A') + '</td>' +
                '<td style="color: var(--honey-yellow); font-weight: 600;"><i class="fas fa-coins" style="font-size: 11px;"></i> ' + hp.toLocaleString() + '</td>' +
                '<td>' + (u.posts || 0) + '</td>' +
                '<td><div style="display: flex; gap: 6px;">' +
                    '<button class="admin-action-btn" onclick="openAdminProfileViewer(\'' + u.username + '\')" title="View Profile"><i class="fas fa-user-edit"></i></button>' +
                    '<button class="admin-action-btn" onclick="adminChangeRole(\'' + u.username + '\')" title="Change Role"><i class="fas fa-crown"></i></button>' +
                    (u.status !== 'banned' ? '<button class="admin-action-btn danger" onclick="adminBanUser(\'' + u.username + '\')" title="Ban"><i class="fas fa-ban"></i></button>' : '<button class="admin-action-btn success" onclick="adminUnbanUser(\'' + u.username + '\')" title="Unban"><i class="fas fa-check"></i></button>') +
                '</div></td>' +
            '</tr>';
        }).join('');
        updateAdminBulkBar();
    };
})();

// ---- Update initAdminPanel to load V2 data ----
(function() {
    var _origInitPanel = initAdminPanel;
    initAdminPanel = function() {
        _origInitPanel();
        ensureAdminDataV2();
    };
})();



// 18. showCustomization - now properly opens with modal management
function showCustomization() {
    closeModal('profileMenuModal');

    // Load saved customization into modal UI
    var saved = localStorage.getItem('polleneer_customization');
    if (saved) {
        try {
            var cfg = JSON.parse(saved);
            // Load saved color
            if (cfg.colors && cfg.colors.primary) {
                selectedColor = cfg.colors.primary;
                selectColor(selectedColor);
            }
            // Load saved background
            if (cfg.background && cfg.background.type) {
                selectedBackground = cfg.background.type;
                if (cfg.background.type === 'gradient') {
                    selectedGradDirection = cfg.background.direction || '135deg';
                    var gc1 = document.getElementById('bgGradColor1');
                    var gc2 = document.getElementById('bgGradColor2');
                    if (gc1) gc1.value = cfg.background.color1 || '#FFC30B';
                    if (gc2) gc2.value = cfg.background.color2 || '#FF8C00';
                    document.querySelectorAll('.grad-dir-btn').forEach(function(btn) {
                        btn.classList.remove('active');
                        if (btn.getAttribute('data-dir') === selectedGradDirection) btn.classList.add('active');
                    });
                } else if (cfg.background.type === 'solid') {
                    var sc = document.getElementById('bgSolidColor');
                    if (sc) sc.value = cfg.background.color || '#1a1a2e';
                } else if (cfg.background.type === 'pattern') {
                    selectedPattern = cfg.background.pattern || 'honeycomb';
                    var bc = document.getElementById('bgPatternBaseColor');
                    var pc = document.getElementById('bgPatternColor');
                    if (bc) bc.value = cfg.background.baseColor || '#1a1a2e';
                    if (pc) pc.value = cfg.background.patternColor || '#FFC30B';
                    document.querySelectorAll('.pattern-option').forEach(function(opt) {
                        opt.classList.remove('active');
                        if (opt.getAttribute('data-pattern') === selectedPattern) opt.classList.add('active');
                    });
                } else if (cfg.background.type === 'image' && cfg.background.imageData) {
                    bgImageData = cfg.background.imageData;
                    var preview = document.getElementById('bgImagePreview');
                    var container = document.getElementById('bgImagePreviewContainer');
                    if (preview) preview.src = bgImageData;
                    if (container) container.style.display = 'block';
                }
                // Update type buttons
                document.querySelectorAll('.bg-type-btn').forEach(function(btn) {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-bg-type') === selectedBackground) btn.classList.add('active');
                });
            }
            // Load saved CSS
            if (cfg.css) {
                var cssEditor = document.getElementById('customCSSEditor');
                if (cssEditor) cssEditor.value = cfg.css;
            }
        } catch(e) {}
    }

    openModal('customizationModal');
    switchCustomizationTab('colors');

    // Delay to let modal render, then update previews
    setTimeout(function() {
        setBackground(selectedBackground);
        updateBgPreview();
    }, 100);
}

// 19. editProfile - now opens bio editor with pre-filled data
function editProfile() {
    if (!currentUser) return;
    closeModal('profileMenuModal');

    document.getElementById('bioText').value = currentUser.bio || '';
    openModal('bioModal');
}

// 20. goToUserProfile - now shows a full profile page for other users
function goToUserProfile(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) { 
        showToast('User not found');
        return; 
    }

    // If viewing own profile, go to regular profile
    if (currentUser && user.id === currentUser.id) {
        goToProfile();
        return;
    }

    const userPosts = posts.filter(p => p.userId === user.id);
    const isFollowing = JSON.parse(localStorage.getItem('polleneer_following_' + currentUser.id) || '[]').includes(user.id);

    document.getElementById('mainContent').innerHTML = `
        <div class="profile-page">
            <div class="profile-banner" style="background: linear-gradient(135deg, var(--honey-yellow), var(--hive-orange)); height: 150px; border-radius: 15px; margin-bottom: -50px; position: relative;">
                <button onclick="goToHome()" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>

            <div style="padding: 0 20px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px;">
                    <img src="${user.avatar}" alt="${user.username}" style="width: 90px; height: 90px; border-radius: 50%; border: 4px solid var(--bg-primary); position: relative; z-index: 1;">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="showToast('Message feature coming soon!')" style="background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-primary); width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <button id="followBtn-${user.id}" onclick="toggleFollowUser(${user.id})" 
                            style="background: ${isFollowing ? 'transparent' : 'var(--honey-yellow)'}; 
                                   color: ${isFollowing ? 'var(--text-primary)' : '#000'}; 
                                   border: ${isFollowing ? '1px solid var(--border-color)' : 'none'}; 
                                   padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold;">
                            ${isFollowing ? 'Following' : 'Follow'}
                        </button>
                    </div>
                </div>

                <h3 style="margin-bottom: 2px;">${user.displayName || user.username}</h3>
                <div style="color: var(--text-secondary); margin-bottom: 8px;">@${user.username}</div>
                <div style="display: inline-block; background: linear-gradient(135deg, var(--honey-yellow), var(--hive-orange)); padding: 3px 12px; border-radius: 10px; font-size: 12px; color: #000; font-weight: bold; margin-bottom: 10px;">
                    ${getRoleName(user.role)}
                </div>
                <p style="margin-bottom: 15px; line-height: 1.5;">${user.bio || ''}</p>

                <div style="display: flex; gap: 20px; margin-bottom: 20px; color: var(--text-secondary); font-size: 14px;">
                    <span><strong style="color: var(--text-primary);">${user.following}</strong> Following</span>
                    <span><strong style="color: var(--text-primary);">${user.followers}</strong> Followers</span>
                    <span>ðŸ¯ <strong style="color: var(--honey-yellow);">${user.honeyPoints.toLocaleString()}</strong></span>
                </div>
            </div>

            <div style="border-top: 1px solid var(--border-color); padding-top: 15px;">
                <h4 style="margin-bottom: 15px; padding: 0 20px; color: var(--text-secondary);">Posts (${userPosts.length})</h4>
                ${userPosts.length > 0 ? userPosts.map(post => createPostHTML(post)).join('') : 
                '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">No posts yet</div>'}
            </div>
        </div>
    `;
}

function toggleFollowUser(userId) {
    const following = JSON.parse(localStorage.getItem('polleneer_following_' + currentUser.id) || '[]');
    const idx = following.indexOf(userId);
    const btn = document.getElementById('followBtn-' + userId);

    if (idx > -1) {
        following.splice(idx, 1);
        currentUser.following = Math.max(0, (currentUser.following || 0) - 1);
        if (btn) {
            btn.textContent = 'Follow';
            btn.style.background = 'var(--honey-yellow)';
            btn.style.color = '#000';
            btn.style.border = 'none';
        }
        showToast('Unfollowed');
    } else {
        following.push(userId);
        currentUser.following = (currentUser.following || 0) + 1;
        currentUser.honeyPoints += 5;
        if (btn) {
            btn.textContent = 'Following';
            btn.style.background = 'transparent';
            btn.style.color = 'var(--text-primary)';
            btn.style.border = '1px solid var(--border-color)';
        }
        showToast('ðŸ Following! +5 Honey Points');
    }

    localStorage.setItem('polleneer_following_' + currentUser.id, JSON.stringify(following));
    localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
}

// BONUS: Fix showNotifications - was just an alert
function showNotifications() {
    if (!currentUser) return;

    const unreadCount = notifications.filter(n => !n.read).length;
    notifications.forEach(n => n.read = true);
    updateBadgeCounts();

    document.getElementById('mainContent').innerHTML = `
        <div class="customization-panel">
            <h3 style="margin-bottom: 20px; color: var(--honey-yellow);"><i class="fas fa-bell"></i> Notifications</h3>
            ${notifications.length > 0 ? notifications.map(n => `
                <div class="post-card" style="padding: 15px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; ${!n.read ? 'border-left: 3px solid var(--honey-yellow);' : ''}">
                    <i class="fas fa-${n.text.includes('liked') ? 'heart' : n.text.includes('pollinated') ? 'retweet' : n.text.includes('following') ? 'user-plus' : 'fire'}" 
                       style="color: var(--honey-yellow); font-size: 1.2em;"></i>
                    <div style="flex: 1;">
                        <div>${n.text}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 3px;">${n.time}</div>
                    </div>
                </div>
            `).join('') : '<div class="post-card" style="padding: 30px; text-align: center; color: var(--text-secondary);">No notifications yet. Start buzzing! ðŸ</div>'}
        </div>
    `;
}

// (showMessages #2 removed - replaced by full DM system)

// ============================================
// PHASE 2: Missing X/Twitter Features
// ============================================

// ===== ENHANCED POST COMPOSER =====
// Add GIF, Sticker, Emoji, and Location buttons to the create post modal

// GIF Search using Tenor/GIPHY-style interface
function showGifPicker() {
    const gifModal = document.createElement('div');
    gifModal.id = 'gifPickerOverlay';
    gifModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10000;display:flex;align-items:center;justify-content:center;';
    gifModal.onclick = function(e) { if(e.target === gifModal) gifModal.remove(); };

    gifModal.innerHTML = `
        <div id="gifPickerContainer" style="background:var(--bg-card);border-radius:16px;width:95%;max-width:480px;height:75vh;max-height:520px;overflow:hidden;display:flex;flex-direction:column;">
            <div style="padding:12px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border-color);">
                <button onclick="document.getElementById('gifPickerOverlay').remove()" style="background:none;border:none;color:var(--text-primary);font-size:18px;cursor:pointer;padding:4px;"><i class="fas fa-times"></i></button>
                <div style="flex:1;position:relative;">
                    <input type="text" id="gifSearchInput" placeholder="Search for GIFs" oninput="searchGifsDebounced(this.value)"
                        style="width:100%;padding:10px 16px 10px 36px;border-radius:20px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);font-size:14px;outline:none;">
                    <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-secondary);font-size:14px;"></i>
                </div>
            </div>
            <div id="gifResults" style="flex:1;overflow-y:auto;padding:8px;"></div>
        </div>
    `;

    document.body.appendChild(gifModal);
    document.getElementById('gifSearchInput').focus();
    // Show categories on open
    showGifCategories();
}

const GIPHY_API_KEY = 'lKalAN02l9iiqHEfYNZLrMSTnYtKPsgw';
let _gifSearchTimeout = null;
let _gifOffset = 0;
let _gifQuery = '';
let _gifLoading = false;

// Category tiles â€” like X/Twitter's default GIF view
const GIF_CATEGORIES = [
    { name: 'Agree', query: 'agree', gif: 'https://media.giphy.com/media/3oKIPlifLxdigaLKEo/200.gif' },
    { name: 'Applause', query: 'applause', gif: 'https://media.giphy.com/media/l0HlBO7eyXzSZkJri/200.gif' },
    { name: 'Awww', query: 'aww cute', gif: 'https://media.giphy.com/media/3oKIPnAiaMCws8nOsE/200.gif' },
    { name: 'Dance', query: 'dance', gif: 'https://media.giphy.com/media/l0HlBO7eyXzSZkJri/200.gif' },
    { name: 'Deal With It', query: 'deal with it', gif: 'https://media.giphy.com/media/xT0xeJpnrWC3XWblEk/200.gif' },
    { name: 'Do Not Want', query: 'no nope', gif: 'https://media.giphy.com/media/26ufdipQqU2lhNA4g/200.gif' },
    { name: 'Eww', query: 'eww gross', gif: 'https://media.giphy.com/media/3ohzdIuqJoo8QdKlnW/200.gif' },
    { name: 'Facepalm', query: 'facepalm', gif: 'https://media.giphy.com/media/l0MYt5jPR6QX5APm0/200.gif' },
    { name: 'Fist Bump', query: 'fist bump', gif: 'https://media.giphy.com/media/l4pTfx2qLszoacZRS/200.gif' },
    { name: 'Happy', query: 'happy', gif: 'https://media.giphy.com/media/l0HlNaQ6gWfllcjDO/200.gif' },
    { name: 'Hearts', query: 'hearts love', gif: 'https://media.giphy.com/media/3o7TKSjRrfIPjeiVyM/200.gif' },
    { name: 'High Five', query: 'high five', gif: 'https://media.giphy.com/media/xT9IgG50Fb7Mi0prBC/200.gif' },
    { name: 'Hug', query: 'hug', gif: 'https://media.giphy.com/media/l41YtZOb9EUABnuqA/200.gif' },
    { name: 'IDK', query: 'shrug idk', gif: 'https://media.giphy.com/media/3oKIPnAiaMCws8nOsE/200.gif' },
    { name: 'Laughing', query: 'laughing lol', gif: 'https://media.giphy.com/media/3ohzdIuqJoo8QdKlnW/200.gif' },
    { name: 'Mic Drop', query: 'mic drop', gif: 'https://media.giphy.com/media/xT0xeJpnrWC3XWblEk/200.gif' },
    { name: 'OMG', query: 'omg shocked', gif: 'https://media.giphy.com/media/l0MYt5jPR6QX5APm0/200.gif' },
    { name: 'Please', query: 'please beg', gif: 'https://media.giphy.com/media/l0HlNaQ6gWfllcjDO/200.gif' },
    { name: 'Popcorn', query: 'popcorn watching', gif: 'https://media.giphy.com/media/l41YtZOb9EUABnuqA/200.gif' },
    { name: 'SAD', query: 'sad cry', gif: 'https://media.giphy.com/media/l0HlBO7eyXzSZkJri/200.gif' },
    { name: 'Scared', query: 'scared', gif: 'https://media.giphy.com/media/26ufdipQqU2lhNA4g/200.gif' },
    { name: 'Seriously', query: 'seriously really', gif: 'https://media.giphy.com/media/3oKIPnAiaMCws8nOsE/200.gif' },
    { name: 'Slow Clap', query: 'slow clap', gif: 'https://media.giphy.com/media/xT9IgG50Fb7Mi0prBC/200.gif' },
    { name: 'SMH', query: 'smh shake head', gif: 'https://media.giphy.com/media/3ohzdIuqJoo8QdKlnW/200.gif' },
    { name: 'Thank You', query: 'thank you thanks', gif: 'https://media.giphy.com/media/l0HlNaQ6gWfllcjDO/200.gif' },
    { name: 'Thumbs Down', query: 'thumbs down', gif: 'https://media.giphy.com/media/3o7TKSjRrfIPjeiVyM/200.gif' },
    { name: 'Thumbs Up', query: 'thumbs up', gif: 'https://media.giphy.com/media/l4pTfx2qLszoacZRS/200.gif' },
    { name: 'Win', query: 'win celebrate', gif: 'https://media.giphy.com/media/xT0xeJpnrWC3XWblEk/200.gif' },
    { name: 'Yolo', query: 'yolo', gif: 'https://media.giphy.com/media/l0MYt5jPR6QX5APm0/200.gif' },
    { name: 'You Got This', query: 'you got this', gif: 'https://media.giphy.com/media/l0HlBO7eyXzSZkJri/200.gif' },
];

function showGifCategories() {
    const results = document.getElementById('gifResults');
    if (!results) return;
    // Fetch actual GIFs for each category using GIPHY search (first result per category)
    // But for speed, show static category tiles immediately, then lazy-load preview GIFs
    results.style.cssText = 'flex:1;overflow-y:auto;padding:8px;display:grid;grid-template-columns:repeat(2,1fr);gap:6px;';
    results.innerHTML = GIF_CATEGORIES.map(cat => `
        <div onclick="gifCategoryClick('${cat.query}')" 
             style="position:relative;border-radius:10px;overflow:hidden;cursor:pointer;height:90px;background:var(--bg-input);"
             class="gif-cat-tile" data-query="${cat.query}">
            <div style="position:absolute;inset:0;background:linear-gradient(transparent 40%,rgba(0,0,0,0.7));z-index:1;"></div>
            <div style="position:absolute;bottom:8px;left:10px;z-index:2;color:white;font-weight:700;font-size:13px;text-shadow:0 1px 3px rgba(0,0,0,0.5);">${cat.name}</div>
        </div>
    `).join('');

    // Lazy-load actual GIF thumbnails for category tiles
    loadCategoryThumbnails();
}

function loadCategoryThumbnails() {
    // Use a single trending call to get preview GIFs for all category tiles
    fetch('https://api.giphy.com/v1/gifs/trending?api_key=' + GIPHY_API_KEY + '&limit=30&rating=g')
        .then(r => r.json())
        .then(data => {
            const tiles = document.querySelectorAll('.gif-cat-tile');
            tiles.forEach((tile, i) => {
                const gif = data.data[i % data.data.length];
                if (gif) {
                    const url = gif.images.fixed_width.url;
                    tile.style.backgroundImage = 'url(' + url + ')';
                    tile.style.backgroundSize = 'cover';
                    tile.style.backgroundPosition = 'center';
                }
            });
        })
        .catch(() => {}); // Tiles stay with solid bg color, still clickable
}

function gifCategoryClick(query) {
    const input = document.getElementById('gifSearchInput');
    if (input) input.value = query;
    _gifOffset = 0;
    _gifQuery = query;
    loadGifResults(query, false);
}

function searchGifsDebounced(query) {
    clearTimeout(_gifSearchTimeout);
    if (!query.trim()) {
        showGifCategories();
        return;
    }
    _gifSearchTimeout = setTimeout(() => {
        _gifOffset = 0;
        _gifQuery = query.trim();
        loadGifResults(_gifQuery, false);
    }, 300);
}

function loadGifResults(query, append) {
    const results = document.getElementById('gifResults');
    if (!results || _gifLoading) return;
    _gifLoading = true;

    if (!append) {
        // Switch to masonry-style grid for search results
        results.style.cssText = 'flex:1;overflow-y:auto;padding:4px;display:flex;flex-wrap:wrap;gap:4px;align-content:flex-start;';
        results.innerHTML = '<div style="width:100%;text-align:center;padding:20px;color:var(--text-secondary);"><i class="fas fa-spinner fa-spin"></i></div>';
    }

    const limit = 30;
    fetch('https://api.giphy.com/v1/gifs/search?api_key=' + GIPHY_API_KEY + '&q=' + encodeURIComponent(query) + '&limit=' + limit + '&offset=' + _gifOffset + '&rating=g')
        .then(r => r.json())
        .then(data => {
            _gifLoading = false;
            if (!data.data || data.data.length === 0) {
                if (!append) {
                    results.innerHTML = '<div style="width:100%;text-align:center;padding:30px;color:var(--text-secondary);">No GIFs found</div>';
                }
                return;
            }

            const html = data.data.map(g => {
                const w = parseInt(g.images.fixed_width_small.width) || 100;
                const h = parseInt(g.images.fixed_width_small.height) || 100;
                const aspect = h / w;
                const displayW = 110;
                const displayH = Math.round(displayW * aspect);
                return '<img src="' + g.images.fixed_width_small.url + '" alt="' + (g.title || '').replace(/"/g, '') + '" ' +
                    'style="width:' + displayW + 'px;height:' + displayH + 'px;border-radius:8px;cursor:pointer;object-fit:cover;flex-shrink:0;" ' +
                    'loading="lazy" onclick="selectGif(\'' + g.images.original.url + '\')" ' +
                    'onerror="this.style.display=\'none\'">';
            }).join('');

            if (append) {
                // Remove the loading sentinel if present
                const sentinel = document.getElementById('gifLoadMore');
                if (sentinel) sentinel.remove();
                results.insertAdjacentHTML('beforeend', html);
            } else {
                results.innerHTML = html;
            }

            _gifOffset += data.data.length;

            // Add infinite scroll sentinel if more results exist
            if (data.pagination && _gifOffset < data.pagination.total_count) {
                const sentinel = document.createElement('div');
                sentinel.id = 'gifLoadMore';
                sentinel.style.cssText = 'width:100%;text-align:center;padding:15px;color:var(--text-secondary);';
                sentinel.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                results.appendChild(sentinel);

                // Observe sentinel for infinite scroll
                setupGifInfiniteScroll();
            }
        })
        .catch(() => {
            _gifLoading = false;
            if (!append) {
                results.innerHTML = '<div style="width:100%;text-align:center;padding:20px;color:var(--text-secondary);">Could not load GIFs</div>';
            }
        });
}

let _gifScrollObserver = null;
function setupGifInfiniteScroll() {
    if (_gifScrollObserver) _gifScrollObserver.disconnect();
    const sentinel = document.getElementById('gifLoadMore');
    if (!sentinel) return;

    _gifScrollObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !_gifLoading && _gifQuery) {
                loadGifResults(_gifQuery, true);
            }
        });
    }, { root: document.getElementById('gifResults'), threshold: 0.1 });

    _gifScrollObserver.observe(sentinel);
}

// Keep old function names as no-ops for compatibility
function getDefaultGifs() { return ''; }
function searchGifs(q) { searchGifsDebounced(q); }
function renderGiphyResults(gifs) { return ''; }

function selectGif(url) {
    const preview = document.getElementById('mediaPreview');
    if (preview) {
        preview.style.display = 'block';
        preview.innerHTML = `
            <div style="position:relative;display:inline-block;">
                <img src="${url}" style="max-width:100%;border-radius:10px;max-height:200px;">
                <button onclick="removeMedia()" style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.7);border:none;color:white;width:25px;height:25px;border-radius:50%;cursor:pointer;">&times;</button>
            </div>
        `;
    }
    const overlay = document.getElementById('gifPickerOverlay');
    if (overlay) overlay.remove();
    showToast('GIF added! ðŸŽ¬');
}

function removeMedia() {
    const preview = document.getElementById('mediaPreview');
    if (preview) {
        preview.style.display = 'none';
        preview.innerHTML = '';
    }
}

// Sticker Picker
function showStickerPicker() {
    const stickerModal = document.createElement('div');
    stickerModal.id = 'stickerPickerOverlay';
    stickerModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    stickerModal.onclick = function(e) { if(e.target === stickerModal) stickerModal.remove(); };

    const beeStickers = [
        { emoji: '\u{1f41d}', name: 'Bee' }, { emoji: '\u{1f36f}', name: 'Honey' }, { emoji: '\u{1f338}', name: 'Flower' },
        { emoji: '\u{1f33b}', name: 'Sunflower' }, { emoji: '\u{1f41b}', name: 'Bug' }, { emoji: '\u{1f98b}', name: 'Butterfly' },
        { emoji: '\u{1f33a}', name: 'Hibiscus' }, { emoji: '\u{1f337}', name: 'Tulip' }, { emoji: '\u{1fabB}', name: 'Lavender' },
        { emoji: '\u{1f33c}', name: 'Blossom' }, { emoji: '\u{1f3f5}\ufe0f', name: 'Rosette' }, { emoji: '\u{1f490}', name: 'Bouquet' },
        { emoji: '\u{1fab4}', name: 'Plant' }, { emoji: '\u{1f33f}', name: 'Herb' }, { emoji: '\u{1f343}', name: 'Leaf' },
        { emoji: '\u{1f33e}', name: 'Rice' }, { emoji: '\u{1fab9}', name: 'Nest' }, { emoji: '\u{1f41e}', name: 'Lady Bug' },
    ];

    const funStickers = [
        { emoji: '\u2b50', name: 'Star' }, { emoji: '\u2728', name: 'Sparkles' }, { emoji: '\u{1f4ab}', name: 'Dizzy' },
        { emoji: '\u{1f525}', name: 'Fire' }, { emoji: '\u{1f49b}', name: 'Yellow Heart' }, { emoji: '\u{1f9e1}', name: 'Orange Heart' },
        { emoji: '\u{1f451}', name: 'Crown' }, { emoji: '\u{1f3c6}', name: 'Trophy' }, { emoji: '\u{1f3af}', name: 'Bullseye' },
        { emoji: '\u{1f4aa}', name: 'Strong' }, { emoji: '\u{1f680}', name: 'Rocket' }, { emoji: '\u26a1', name: 'Lightning' },
        { emoji: '\u{1f389}', name: 'Party' }, { emoji: '\u{1f38a}', name: 'Confetti' }, { emoji: '\u{1f973}', name: 'Celebrate' },
        { emoji: '\u{1f60e}', name: 'Cool' }, { emoji: '\u{1f929}', name: 'Starstruck' }, { emoji: '\u{1f4af}', name: '100' },
    ];

    stickerModal.innerHTML = `
        <div style="background:var(--bg-card);border-radius:15px;width:90%;max-width:450px;max-height:75vh;overflow:hidden;display:flex;flex-direction:column;">
            <div style="padding:15px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;">
                <h3 style="color:var(--honey-yellow);"><i class="fas fa-note-sticky"></i> Stickers</h3>
                <button onclick="document.getElementById('stickerPickerOverlay').remove()" style="background:none;border:none;color:var(--text-primary);font-size:1.5em;cursor:pointer;">&times;</button>
            </div>
            <div style="display:flex;border-bottom:1px solid var(--border-color);">
                <button onclick="showStickerTab('emoji')" id="stickerTabEmoji" style="flex:1;padding:10px;background:var(--honey-yellow);color:#000;border:none;cursor:pointer;font-weight:bold;font-size:13px;">Emoji</button>
                <button onclick="showStickerTab('giphy')" id="stickerTabGiphy" style="flex:1;padding:10px;background:transparent;color:var(--text-secondary);border:none;cursor:pointer;font-weight:bold;font-size:13px;">GIPHY Stickers</button>
            </div>
            <div id="stickerContent" style="padding:15px;overflow-y:auto;max-height:55vh;">
                <h4 style="margin-bottom:10px;color:var(--honey-yellow);font-size:13px;">\u{1f41d} BEE HIVE</h4>
                <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:5px;margin-bottom:20px;">
                    ${beeStickers.map(s => '<button onclick="insertSticker(\'' + s.emoji + '\')" title="' + s.name + '" style="font-size:28px;padding:8px;background:var(--bg-input);border:1px solid transparent;border-radius:10px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor=\'var(--honey-yellow)\';this.style.transform=\'scale(1.2)\'" onmouseout="this.style.borderColor=\'transparent\';this.style.transform=\'scale(1)\'">' + s.emoji + '</button>').join('')}
                </div>
                <h4 style="margin-bottom:10px;color:var(--honey-yellow);font-size:13px;">\u2b50 POPULAR</h4>
                <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:5px;">
                    ${funStickers.map(s => '<button onclick="insertSticker(\'' + s.emoji + '\')" title="' + s.name + '" style="font-size:28px;padding:8px;background:var(--bg-input);border:1px solid transparent;border-radius:10px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor=\'var(--honey-yellow)\';this.style.transform=\'scale(1.2)\'" onmouseout="this.style.borderColor=\'transparent\';this.style.transform=\'scale(1)\'">' + s.emoji + '</button>').join('')}
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(stickerModal);
}

function showStickerTab(tab) {
    const emojiBtn = document.getElementById('stickerTabEmoji');
    const giphyBtn = document.getElementById('stickerTabGiphy');
    const contentDiv = document.getElementById('stickerContent');

    if (tab === 'emoji') {
        emojiBtn.style.background = 'var(--honey-yellow)';
        emojiBtn.style.color = '#000';
        giphyBtn.style.background = 'transparent';
        giphyBtn.style.color = 'var(--text-secondary)';
        // Re-render emoji tab
        document.getElementById('stickerPickerOverlay').remove();
        showStickerPicker();
    } else {
        emojiBtn.style.background = 'transparent';
        emojiBtn.style.color = 'var(--text-secondary)';
        giphyBtn.style.background = 'var(--honey-yellow)';
        giphyBtn.style.color = '#000';
        contentDiv.innerHTML = `
            <div style="padding:8px 4px;">
                <div style="position:relative;">
                    <input type="text" id="stickerSearchInput" placeholder="Search for Stickers" oninput="searchGiphyStickersDebounced(this.value)"
                        style="width:100%;padding:10px 16px 10px 36px;border-radius:20px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);font-size:14px;outline:none;">
                    <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-secondary);font-size:14px;"></i>
                </div>
            </div>
            <div id="giphyStickerResults" style="padding:4px;overflow-y:auto;max-height:45vh;"></div>
        `;
        // Show sticker categories by default
        showStickerCategories();
        const input = document.getElementById('stickerSearchInput');
        if (input) input.focus();
    }
}

// Sticker categories â€” like the GIF picker approach
const STICKER_CATEGORIES = [
    { name: 'Love', query: 'love heart' },
    { name: 'Happy', query: 'happy smile' },
    { name: 'Sad', query: 'sad cry' },
    { name: 'Angry', query: 'angry mad' },
    { name: 'Yes', query: 'yes agree thumbs up' },
    { name: 'No', query: 'no disagree' },
    { name: 'Celebrate', query: 'celebrate party' },
    { name: 'Thank You', query: 'thank you thanks' },
    { name: 'LOL', query: 'laughing lol funny' },
    { name: 'OMG', query: 'omg shocked surprised' },
    { name: 'Cool', query: 'cool sunglasses' },
    { name: 'Hi', query: 'hi hello wave' },
    { name: 'Bye', query: 'bye goodbye' },
    { name: 'Hug', query: 'hug' },
    { name: 'Dance', query: 'dance' },
    { name: 'Food', query: 'food yummy' },
    { name: 'Animals', query: 'cute animals' },
    { name: 'Fire', query: 'fire lit' },
    { name: 'Stars', query: 'stars sparkle' },
    { name: 'Clap', query: 'clap applause' },
];

let _stickerSearchTimeout = null;
let _stickerOffset = 0;
let _stickerQuery = '';
let _stickerLoading = false;
let _stickerScrollObserver = null;

function showStickerCategories() {
    const results = document.getElementById('giphyStickerResults');
    if (!results) return;
    results.style.cssText = 'padding:4px;overflow-y:auto;max-height:45vh;display:grid;grid-template-columns:repeat(2,1fr);gap:6px;';
    results.innerHTML = STICKER_CATEGORIES.map(cat => `
        <div onclick="stickerCategoryClick('${cat.query}')"
             style="position:relative;border-radius:10px;overflow:hidden;cursor:pointer;height:80px;background:var(--bg-input);"
             class="sticker-cat-tile" data-query="${cat.query}">
            <div style="position:absolute;inset:0;background:linear-gradient(transparent 30%,rgba(0,0,0,0.7));z-index:1;"></div>
            <div style="position:absolute;bottom:8px;left:10px;z-index:2;color:white;font-weight:700;font-size:13px;text-shadow:0 1px 3px rgba(0,0,0,0.5);">${cat.name}</div>
        </div>
    `).join('');

    // Load preview stickers for tiles from trending
    loadStickerCategoryThumbnails();
}

function loadStickerCategoryThumbnails() {
    fetch('https://api.giphy.com/v1/stickers/trending?api_key=' + GIPHY_API_KEY + '&limit=20&rating=g')
        .then(r => r.json())
        .then(data => {
            const tiles = document.querySelectorAll('.sticker-cat-tile');
            tiles.forEach((tile, i) => {
                const sticker = data.data[i % data.data.length];
                if (sticker) {
                    const url = sticker.images.fixed_width.url;
                    tile.style.backgroundImage = 'url(' + url + ')';
                    tile.style.backgroundSize = 'cover';
                    tile.style.backgroundPosition = 'center';
                }
            });
        })
        .catch(() => {});
}

function stickerCategoryClick(query) {
    const input = document.getElementById('stickerSearchInput');
    if (input) input.value = query;
    _stickerOffset = 0;
    _stickerQuery = query;
    loadStickerResults(query, false);
}

function searchGiphyStickersDebounced(query) {
    clearTimeout(_stickerSearchTimeout);
    if (!query.trim()) {
        showStickerCategories();
        return;
    }
    _stickerSearchTimeout = setTimeout(() => {
        _stickerOffset = 0;
        _stickerQuery = query.trim();
        loadStickerResults(_stickerQuery, false);
    }, 300);
}

// Keep old name for compatibility
function searchGiphyStickers(query) { searchGiphyStickersDebounced(query); }

function loadStickerResults(query, append) {
    const results = document.getElementById('giphyStickerResults');
    if (!results || _stickerLoading) return;
    _stickerLoading = true;

    if (!append) {
        results.style.cssText = 'padding:4px;overflow-y:auto;max-height:45vh;display:flex;flex-wrap:wrap;gap:4px;align-content:flex-start;';
        results.innerHTML = '<div style="width:100%;text-align:center;padding:20px;color:var(--text-secondary);"><i class="fas fa-spinner fa-spin"></i></div>';
    }

    const limit = 25;
    fetch('https://api.giphy.com/v1/stickers/search?api_key=' + GIPHY_API_KEY + '&q=' + encodeURIComponent(query) + '&limit=' + limit + '&offset=' + _stickerOffset + '&rating=g')
        .then(r => r.json())
        .then(data => {
            _stickerLoading = false;
            if (!data.data || data.data.length === 0) {
                if (!append) {
                    results.innerHTML = '<div style="width:100%;text-align:center;padding:30px;color:var(--text-secondary);">No stickers found</div>';
                }
                return;
            }

            const html = data.data.map(s => {
                const w = parseInt(s.images.fixed_width_small.width) || 100;
                const h = parseInt(s.images.fixed_width_small.height) || 100;
                const aspect = h / w;
                const displayW = 100;
                const displayH = Math.round(displayW * aspect);
                return '<img src="' + s.images.fixed_width_small.url + '" alt="' + (s.title || '').replace(/"/g, '') + '" ' +
                    'style="width:' + displayW + 'px;height:' + displayH + 'px;border-radius:8px;cursor:pointer;object-fit:cover;flex-shrink:0;background:transparent;" ' +
                    'loading="lazy" onclick="selectGiphySticker(\'' + s.images.original.url + '\')" ' +
                    'onerror="this.style.display=\'none\'">';
            }).join('');

            if (append) {
                const sentinel = document.getElementById('stickerLoadMore');
                if (sentinel) sentinel.remove();
                results.insertAdjacentHTML('beforeend', html);
            } else {
                results.innerHTML = html;
            }

            _stickerOffset += data.data.length;

            // Infinite scroll sentinel
            if (data.pagination && _stickerOffset < data.pagination.total_count) {
                const sentinel = document.createElement('div');
                sentinel.id = 'stickerLoadMore';
                sentinel.style.cssText = 'width:100%;text-align:center;padding:15px;color:var(--text-secondary);';
                sentinel.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                results.appendChild(sentinel);
                setupStickerInfiniteScroll();
            }
        })
        .catch(() => {
            _stickerLoading = false;
            if (!append) {
                results.innerHTML = '<div style="width:100%;text-align:center;padding:20px;color:var(--text-secondary);">Could not load stickers</div>';
            }
        });
}

function setupStickerInfiniteScroll() {
    if (_stickerScrollObserver) _stickerScrollObserver.disconnect();
    const sentinel = document.getElementById('stickerLoadMore');
    if (!sentinel) return;

    _stickerScrollObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !_stickerLoading && _stickerQuery) {
                loadStickerResults(_stickerQuery, true);
            }
        });
    }, { root: document.getElementById('giphyStickerResults'), threshold: 0.1 });

    _stickerScrollObserver.observe(sentinel);
}

// Keep old function as no-op
function loadGiphyStickers(q) { if(q) { _stickerQuery = q; loadStickerResults(q, false); } else { showStickerCategories(); } }

function selectGiphySticker(url) {
    selectGif(url);
    const overlay = document.getElementById('stickerPickerOverlay');
    if (overlay) overlay.remove();
}

function insertSticker(emoji) {
    const el = document.getElementById('postContent');
    if (el) {
        if (el.contentEditable === 'true') {
            el.focus();
            document.execCommand('insertText', false, emoji);
        } else {
            const start = el.selectionStart;
            const end = el.selectionEnd;
            el.value = el.value.substring(0, start) + emoji + el.value.substring(end);
            el.selectionStart = el.selectionEnd = start + emoji.length;
            el.focus();
        }
    }
    const overlay = document.getElementById('stickerPickerOverlay');
    if (overlay) overlay.remove();
}

// Emoji Picker (built-in, keyboard-style)
function showEmojiPicker() {
    var existingPicker = document.getElementById('emojiPickerOverlay');
    if (existingPicker) { existingPicker.remove(); return; }

    var emojiModal = document.createElement('div');
    emojiModal.id = 'emojiPickerOverlay';
    emojiModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    emojiModal.onclick = function(e) { if(e.target === emojiModal) emojiModal.remove(); };

    var categories = {
        'Smileys & People': ['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜†','ðŸ˜…','ðŸ¤£','ðŸ˜‚','ðŸ™‚','ðŸ™ƒ','ðŸ« ','ðŸ˜‰','ðŸ˜Š','ðŸ˜‡','ðŸ¥°','ðŸ˜','ðŸ¤©','ðŸ˜˜','ðŸ˜—','â˜ºï¸','ðŸ˜š','ðŸ˜‹','ðŸ˜›','ðŸ˜œ','ðŸ¤ª','ðŸ˜','ðŸ¤‘','ðŸ¤—','ðŸ¤­','ðŸ«¢','ðŸ«£','ðŸ¤«','ðŸ¤”','ðŸ«¡','ðŸ¤','ðŸ¤¨','ðŸ˜','ðŸ˜‘','ðŸ˜¶','ðŸ«¥','ðŸ˜','ðŸ˜’','ðŸ™„','ðŸ˜¬','ðŸ¤¥','ðŸ˜Œ','ðŸ˜”','ðŸ˜ª','ðŸ¤¤','ðŸ˜´','ðŸ˜·','ðŸ¤’','ðŸ¤•','ðŸ¤¢','ðŸ¤®','ðŸ¥µ','ðŸ¥¶','ðŸ¥´','ðŸ˜µ','ðŸ˜µâ€ðŸ’«','ðŸ¤¯','ðŸ¤ ','ðŸ¥³','ðŸ¥¸','ðŸ˜Ž','ðŸ¤“','ðŸ§','ðŸ˜•','ðŸ«¤','ðŸ˜Ÿ','ðŸ™','â˜¹ï¸','ðŸ˜®','ðŸ˜¯','ðŸ˜²','ðŸ˜³','ðŸ¥º','ðŸ¥¹','ðŸ˜¦','ðŸ˜§','ðŸ˜¨','ðŸ˜°','ðŸ˜¥','ðŸ˜¢','ðŸ˜­','ðŸ˜±','ðŸ˜–','ðŸ˜£','ðŸ˜ž','ðŸ˜“','ðŸ˜©','ðŸ˜«','ðŸ¥±','ðŸ˜¤','ðŸ˜¡','ðŸ˜ ','ðŸ¤¬','ðŸ˜ˆ','ðŸ‘¿','ðŸ’€','â˜ ï¸','ðŸ’©','ðŸ¤¡','ðŸ‘¹','ðŸ‘º','ðŸ‘»','ðŸ‘½','ðŸ‘¾','ðŸ¤–','ðŸ˜º','ðŸ˜¸','ðŸ˜¹','ðŸ˜»','ðŸ˜¼','ðŸ˜½','ðŸ™€','ðŸ˜¿','ðŸ˜¾','ðŸ™ˆ','ðŸ™‰','ðŸ™Š','ðŸ‘‹','ðŸ¤š','ðŸ–ï¸','âœ‹','ðŸ––','ðŸ«±','ðŸ«²','ðŸ«³','ðŸ«´','ðŸ‘Œ','ðŸ¤Œ','ðŸ¤','âœŒï¸','ðŸ¤ž','ðŸ«°','ðŸ¤Ÿ','ðŸ¤˜','ðŸ¤™','ðŸ‘ˆ','ðŸ‘‰','ðŸ‘†','ðŸ–•','ðŸ‘‡','â˜ï¸','ðŸ«µ','ðŸ‘','ðŸ‘Ž','âœŠ','ðŸ‘Š','ðŸ¤›','ðŸ¤œ','ðŸ‘','ðŸ™Œ','ðŸ«¶','ðŸ‘','ðŸ¤²','ðŸ¤','ðŸ™','âœï¸','ðŸ’…','ðŸ¤³','ðŸ’ª','ðŸ¦¾','ðŸ¦¿','ðŸ¦µ','ðŸ¦¶','ðŸ‘‚','ðŸ¦»','ðŸ‘ƒ','ðŸ§ ','ðŸ«€','ðŸ«','ðŸ¦·','ðŸ¦´','ðŸ‘€','ðŸ‘ï¸','ðŸ‘…','ðŸ‘„','ðŸ«¦','ðŸ‘¶','ðŸ§’','ðŸ‘¦','ðŸ‘§','ðŸ§‘','ðŸ‘±','ðŸ‘¨','ðŸ§”','ðŸ‘©','ðŸ§“','ðŸ‘´','ðŸ‘µ','ðŸ™','ðŸ™Ž','ðŸ™…','ðŸ™†','ðŸ’','ðŸ™‹','ðŸ§','ðŸ™‡','ðŸ¤¦','ðŸ¤·','ðŸ‘®','ðŸ•µï¸','ðŸ’‚','ðŸ¥·','ðŸ‘·','ðŸ«…','ðŸ¤´','ðŸ‘¸','ðŸ‘³','ðŸ‘²','ðŸ§•','ðŸ¤µ','ðŸ‘°','ðŸ¤°','ðŸ«„','ðŸ«ƒ','ðŸ¤±','ðŸ‘¼','ðŸŽ…','ðŸ¤¶','ðŸ¦¸','ðŸ¦¹','ðŸ§™','ðŸ§š','ðŸ§›','ðŸ§œ','ðŸ§','ðŸ§ž','ðŸ§Ÿ','ðŸ§Œ','ðŸ’†','ðŸ’‡','ðŸš¶','ðŸ§','ðŸ§Ž','ðŸƒ','ðŸ’ƒ','ðŸ•º','ðŸ•´ï¸','ðŸ‘¯','ðŸ§–','ðŸ§—','ðŸ¤¸','â›¹ï¸','ðŸ‹ï¸','ðŸš´','ðŸšµ','ðŸ¤¼','ðŸ¤½','ðŸ¤¾','ðŸ¤º','â›·ï¸','ðŸ‚','ðŸŒï¸','ðŸ‡','ðŸ„','ðŸš£','ðŸŠ','ðŸ¤¹','ðŸ§˜','ðŸ›€','ðŸ›Œ','ðŸ‘­','ðŸ‘«','ðŸ‘¬','ðŸ’','ðŸ’‘','ðŸ‘ª','ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦','ðŸ‘¨â€ðŸ‘©â€ðŸ‘§','ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦','ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦','ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§','ðŸ‘¨â€ðŸ‘¦','ðŸ‘¨â€ðŸ‘§','ðŸ‘©â€ðŸ‘¦','ðŸ‘©â€ðŸ‘§','ðŸ—£ï¸','ðŸ‘¤','ðŸ‘¥','ðŸ«‚'],
        'Animals & Nature': ['ðŸ¶','ðŸ±','ðŸ­','ðŸ¹','ðŸ°','ðŸ¦Š','ðŸ»','ðŸ¼','ðŸ»â€â„ï¸','ðŸ¨','ðŸ¯','ðŸ¦','ðŸ®','ðŸ·','ðŸ½','ðŸ¸','ðŸµ','ðŸ™ˆ','ðŸ™‰','ðŸ™Š','ðŸ’','ðŸ”','ðŸ§','ðŸ¦','ðŸ¤','ðŸ£','ðŸ¥','ðŸ¦†','ðŸ¦…','ðŸ¦‰','ðŸ¦‡','ðŸº','ðŸ—','ðŸ´','ðŸ¦„','ðŸ','ðŸª±','ðŸ›','ðŸ¦‹','ðŸŒ','ðŸž','ðŸœ','ðŸª°','ðŸª²','ðŸª³','ðŸ¦Ÿ','ðŸ¦—','ðŸ•·ï¸','ðŸ•¸ï¸','ðŸ¦‚','ðŸ¢','ðŸ','ðŸ¦Ž','ðŸ¦–','ðŸ¦•','ðŸ™','ðŸ¦‘','ðŸ¦','ðŸ¦ž','ðŸ¦€','ðŸª¸','ðŸ¡','ðŸ ','ðŸŸ','ðŸ¬','ðŸ³','ðŸ‹','ðŸ¦ˆ','ðŸŠ','ðŸ…','ðŸ†','ðŸ¦“','ðŸ¦','ðŸ¦§','ðŸ˜','ðŸ¦›','ðŸ¦','ðŸª','ðŸ«','ðŸ¦’','ðŸ¦˜','ðŸ¦¬','ðŸƒ','ðŸ‚','ðŸ„','ðŸŽ','ðŸ–','ðŸ','ðŸ‘','ðŸ¦™','ðŸ','ðŸ¦Œ','ðŸ•','ðŸ©','ðŸ¦®','ðŸ•â€ðŸ¦º','ðŸˆ','ðŸˆâ€â¬›','ðŸª¶','ðŸ“','ðŸ¦ƒ','ðŸ¦¤','ðŸ¦š','ðŸ¦œ','ðŸ¦¢','ðŸ¦©','ðŸ•Šï¸','ðŸ‡','ðŸ¦','ðŸ¦¨','ðŸ¦¡','ðŸ¦«','ðŸ¦¦','ðŸ¦¥','ðŸ','ðŸ€','ðŸ¿ï¸','ðŸ¦”','ðŸ¾','ðŸ‰','ðŸ²','ðŸŒµ','ðŸŽ„','ðŸŒ²','ðŸŒ³','ðŸŒ´','ðŸªµ','ðŸŒ±','ðŸŒ¿','â˜˜ï¸','ðŸ€','ðŸŽ','ðŸª´','ðŸŽ‹','ðŸƒ','ðŸ‚','ðŸ','ðŸªº','ðŸª¹','ðŸ„','ðŸŒ¾','ðŸ’','ðŸŒ·','ðŸŒ¹','ðŸ¥€','ðŸŒº','ðŸŒ¸','ðŸŒ¼','ðŸŒ»','ðŸŒž','ðŸŒ','ðŸŒ›','ðŸŒœ','ðŸŒš','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜','ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ™','ðŸŒŽ','ðŸŒ','ðŸŒ','ðŸª','ðŸ’«','â­','ðŸŒŸ','âœ¨','âš¡','â˜„ï¸','ðŸ’¥','ðŸ”¥','ðŸŒªï¸','ðŸŒˆ','â˜€ï¸','ðŸŒ¤ï¸','â›…','ðŸŒ¥ï¸','â˜ï¸','ðŸŒ¦ï¸','ðŸŒ§ï¸','â›ˆï¸','ðŸŒ©ï¸','ðŸŒ¨ï¸','â„ï¸','â˜ƒï¸','â›„','ðŸŒ¬ï¸','ðŸ’¨','ðŸ’§','ðŸ’¦','ðŸ«§','â˜”','â˜‚ï¸','ðŸŒŠ','ðŸŒ«ï¸'],
        'Food & Drink': ['ðŸ','ðŸŽ','ðŸ','ðŸŠ','ðŸ‹','ðŸŒ','ðŸ‰','ðŸ‡','ðŸ“','ðŸ«','ðŸˆ','ðŸ’','ðŸ‘','ðŸ¥­','ðŸ','ðŸ¥¥','ðŸ¥','ðŸ…','ðŸ†','ðŸ¥‘','ðŸ¥¦','ðŸ¥¬','ðŸ¥’','ðŸŒ¶ï¸','ðŸ«‘','ðŸŒ½','ðŸ¥•','ðŸ«’','ðŸ§„','ðŸ§…','ðŸ«›','ðŸ¥”','ðŸ ','ðŸ«š','ðŸ¥','ðŸ¥¯','ðŸž','ðŸ¥–','ðŸ¥¨','ðŸ§€','ðŸ¥š','ðŸ³','ðŸ§ˆ','ðŸ¥ž','ðŸ§‡','ðŸ¥“','ðŸ¥©','ðŸ—','ðŸ–','ðŸŒ­','ðŸ”','ðŸŸ','ðŸ•','ðŸ«“','ðŸ¥ª','ðŸ¥™','ðŸ§†','ðŸŒ®','ðŸŒ¯','ðŸ«”','ðŸ¥—','ðŸ¥˜','ðŸ«•','ðŸ¥«','ðŸ','ðŸœ','ðŸ²','ðŸ›','ðŸ£','ðŸ±','ðŸ¥Ÿ','ðŸ¦ª','ðŸ¤','ðŸ™','ðŸš','ðŸ˜','ðŸ¥','ðŸ¥ ','ðŸ¥®','ðŸ¢','ðŸ¡','ðŸ§','ðŸ¨','ðŸ¦','ðŸ¥§','ðŸ§','ðŸ°','ðŸŽ‚','ðŸ®','ðŸ­','ðŸ¬','ðŸ«','ðŸ©','ðŸª','ðŸŒ°','ðŸ¥œ','ðŸ¯','ðŸ¥›','ðŸ¼','ðŸ«–','â˜•','ðŸµ','ðŸ§ƒ','ðŸ¥¤','ðŸ§‹','ðŸ«™','ðŸ¶','ðŸº','ðŸ»','ðŸ¥‚','ðŸ·','ðŸ«—','ðŸ¥ƒ','ðŸ¸','ðŸ¹','ðŸ§‰','ðŸ¾','ðŸ§Š','ðŸ¥„','ðŸ´','ðŸ½ï¸','ðŸ¥£','ðŸ¥¡','ðŸ¥¢','ðŸ§‚'],
        'Activities': ['âš½','ðŸ€','ðŸˆ','âš¾','ðŸ¥Ž','ðŸŽ¾','ðŸ','ðŸ‰','ðŸ¥','ðŸŽ±','ðŸª€','ðŸ“','ðŸ¸','ðŸ’','ðŸ‘','ðŸ¥','ðŸ','ðŸªƒ','ðŸ¥…','â›³','ðŸª','ðŸ¹','ðŸŽ£','ðŸ¤¿','ðŸ¥Š','ðŸ¥‹','ðŸŽ½','ðŸ›¹','ðŸ›¼','ðŸ›·','â›¸ï¸','ðŸ¥Œ','ðŸŽ¿','â›·ï¸','ðŸ‚','ðŸª‚','ðŸ‹ï¸','ðŸ¤¼','ðŸ¤¸','â›¹ï¸','ðŸ¤º','ðŸ¤¾','ðŸŒï¸','ðŸ‡','ðŸ§˜','ðŸ„','ðŸŠ','ðŸ¤½','ðŸš£','ðŸ§—','ðŸš´','ðŸšµ','ðŸŽ–ï¸','ðŸ†','ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰','ðŸ…','ðŸŽª','ðŸ¤¹','ðŸŽ­','ðŸ©°','ðŸŽ¨','ðŸŽ¬','ðŸŽ¤','ðŸŽ§','ðŸŽ¼','ðŸŽ¹','ðŸ¥','ðŸª˜','ðŸŽ·','ðŸŽº','ðŸª—','ðŸŽ¸','ðŸª•','ðŸŽ»','ðŸªˆ','ðŸŽ²','â™Ÿï¸','ðŸŽ¯','ðŸŽ³','ðŸŽ®','ðŸ•¹ï¸','ðŸ§©','ðŸŽ°','ðŸŽ´','ðŸ€„','ðŸƒ','ðŸ‘¾','ðŸŽ©','ðŸ“¸','ðŸ“·'],
        'Travel & Places': ['ðŸš—','ðŸš•','ðŸš™','ðŸšŒ','ðŸšŽ','ðŸŽï¸','ðŸš“','ðŸš‘','ðŸš’','ðŸš','ðŸ›»','ðŸšš','ðŸš›','ðŸšœ','ðŸ¦¯','ðŸ¦½','ðŸ¦¼','ðŸ›´','ðŸš²','ðŸ›µ','ðŸï¸','ðŸ›º','ðŸš¨','ðŸš”','ðŸš','ðŸš˜','ðŸš–','ðŸ›ž','ðŸš¡','ðŸš ','ðŸšŸ','ðŸšƒ','ðŸš‹','ðŸšž','ðŸš','ðŸš„','ðŸš…','ðŸšˆ','ðŸš‚','ðŸš†','ðŸš‡','ðŸšŠ','ðŸš‰','âœˆï¸','ðŸ›«','ðŸ›¬','ðŸ›©ï¸','ðŸ’º','ðŸ›°ï¸','ðŸš€','ðŸ›¸','ðŸš','ðŸ›¶','â›µ','ðŸš¤','ðŸ›¥ï¸','ðŸ›³ï¸','â›´ï¸','ðŸš¢','âš“','ðŸ›Ÿ','ðŸª','â›½','ðŸš§','ðŸš¦','ðŸš¥','ðŸš','ðŸ—ºï¸','ðŸ—¿','ðŸ—½','ðŸ—¼','ðŸ°','ðŸ¯','ðŸŸï¸','ðŸŽ¡','ðŸŽ¢','ðŸŽ ','â›²','â›±ï¸','ðŸ–ï¸','ðŸï¸','ðŸœï¸','ðŸŒ‹','â›°ï¸','ðŸ”ï¸','ðŸ—»','ðŸ•ï¸','ðŸ›–','ðŸ ','ðŸ¡','ðŸ˜ï¸','ðŸšï¸','ðŸ—ï¸','ðŸ­','ðŸ¢','ðŸ¬','ðŸ£','ðŸ¤','ðŸ¥','ðŸ¦','ðŸ¨','ðŸª','ðŸ«','ðŸ©','ðŸ’’','ðŸ›ï¸','â›ª','ðŸ•Œ','ðŸ•','ðŸ›•','ðŸ•‹','â›©ï¸','ðŸ›¤ï¸','ðŸ›£ï¸','ðŸ—¾','ðŸŽ‘','ðŸžï¸','ðŸŒ…','ðŸŒ„','ðŸŒ ','ðŸŽ‡','ðŸŽ†','ðŸŒ‡','ðŸŒ†','ðŸ™ï¸','ðŸŒƒ','ðŸŒŒ','ðŸŒ‰','ðŸŒ'],
        'Objects': ['âŒš','ðŸ“±','ðŸ“²','ðŸ’»','âŒ¨ï¸','ðŸ–¥ï¸','ðŸ–¨ï¸','ðŸ–±ï¸','ðŸ–²ï¸','ðŸ•¹ï¸','ðŸ—œï¸','ðŸ’½','ðŸ’¾','ðŸ’¿','ðŸ“€','ðŸ“¼','ðŸ“·','ðŸ“¸','ðŸ“¹','ðŸŽ¥','ðŸ“½ï¸','ðŸŽžï¸','ðŸ“ž','â˜Žï¸','ðŸ“Ÿ','ðŸ“ ','ðŸ“º','ðŸ“»','ðŸŽ™ï¸','ðŸŽšï¸','ðŸŽ›ï¸','ðŸ§­','â±ï¸','â²ï¸','â°','ðŸ•°ï¸','âŒ›','â³','ðŸ“¡','ðŸ”‹','ðŸª«','ðŸ”Œ','ðŸ’¡','ðŸ”¦','ðŸ•¯ï¸','ðŸª”','ðŸ§¯','ðŸ›¢ï¸','ðŸª™','ðŸ’¸','ðŸ’µ','ðŸ’´','ðŸ’¶','ðŸ’·','ðŸªª','ðŸ’³','ðŸ’°','ðŸ’Ž','âš–ï¸','ðŸªœ','ðŸ§°','ðŸª›','ðŸ”§','ðŸ”¨','âš’ï¸','ðŸ› ï¸','â›ï¸','ðŸªš','ðŸ”©','âš™ï¸','ðŸª¤','ðŸ§±','â›“ï¸','ðŸ§²','ðŸ”«','ðŸ’£','ðŸ§¨','ðŸª“','ðŸ”ª','ðŸ—¡ï¸','âš”ï¸','ðŸ›¡ï¸','ðŸš¬','âš°ï¸','ðŸª¦','âš±ï¸','ðŸº','ðŸ”®','ðŸ“¿','ðŸ§¿','ðŸª¬','ðŸ’ˆ','âš—ï¸','ðŸ”­','ðŸ”¬','ðŸ•³ï¸','ðŸ©¹','ðŸ©º','ðŸ©»','ðŸ©¼','ðŸ’Š','ðŸ’‰','ðŸ©¸','ðŸ§¬','ðŸ¦ ','ðŸ§«','ðŸ§ª','ðŸŒ¡ï¸','ðŸ§¹','ðŸª ','ðŸ§º','ðŸ§»','ðŸš½','ðŸš°','ðŸš¿','ðŸ›','ðŸ›€','ðŸ§¼','ðŸª¥','ðŸª’','ðŸ§½','ðŸª£','ðŸ§´','ðŸ›Žï¸','ðŸ”‘','ðŸ—ï¸','ðŸšª','ðŸª‘','ðŸ›‹ï¸','ðŸ›ï¸','ðŸ›Œ','ðŸ§¸','ðŸª†','ðŸ–¼ï¸','ðŸªž','ðŸªŸ','ðŸ›ï¸','ðŸ›’','ðŸŽ','ðŸŽˆ','ðŸŽ','ðŸŽ€','ðŸª„','ðŸª…','ðŸŽŠ','ðŸŽ‰','ðŸŽŽ','ðŸ®','ðŸŽ','ðŸ§§','âœ‰ï¸','ðŸ“©','ðŸ“¨','ðŸ“§','ðŸ’Œ','ðŸ“¥','ðŸ“¤','ðŸ“¦','ðŸ·ï¸','ðŸª§','ðŸ“ª','ðŸ“«','ðŸ“¬','ðŸ“­','ðŸ“®','ðŸ“¯','ðŸ“œ','ðŸ“ƒ','ðŸ“„','ðŸ“‘','ðŸ§¾','ðŸ“Š','ðŸ“ˆ','ðŸ“‰','ðŸ—’ï¸','ðŸ—“ï¸','ðŸ“†','ðŸ“…','ðŸ—‘ï¸','ðŸ“‡','ðŸ—ƒï¸','ðŸ—³ï¸','ðŸ—„ï¸','ðŸ“‹','ðŸ“','ðŸ“‚','ðŸ—‚ï¸','ðŸ—žï¸','ðŸ“°','ðŸ““','ðŸ“”','ðŸ“’','ðŸ“•','ðŸ“—','ðŸ“˜','ðŸ“™','ðŸ“š','ðŸ“–','ðŸ”–','ðŸ§·','ðŸ”—','ðŸ“Ž','ðŸ–‡ï¸','ðŸ“','ðŸ“','ðŸ§®','ðŸ“Œ','ðŸ“','âœ‚ï¸','ðŸ–Šï¸','ðŸ–‹ï¸','âœ’ï¸','ðŸ–Œï¸','ðŸ–ï¸','ðŸ“','âœï¸','ðŸ”','ðŸ”Ž','ðŸ”','ðŸ”','ðŸ”’','ðŸ”“'],
        'Symbols': ['â¤ï¸','ðŸ§¡','ðŸ’›','ðŸ’š','ðŸ’™','ðŸ’œ','ðŸ–¤','ðŸ¤','ðŸ¤Ž','â¤ï¸â€ðŸ”¥','â¤ï¸â€ðŸ©¹','ðŸ’”','â£ï¸','ðŸ’•','ðŸ’ž','ðŸ’“','ðŸ’—','ðŸ’–','ðŸ’˜','ðŸ’','ðŸ’Ÿ','â˜®ï¸','âœï¸','â˜ªï¸','ðŸ•‰ï¸','â˜¸ï¸','âœ¡ï¸','ðŸ”¯','ðŸ•Ž','â˜¯ï¸','â˜¦ï¸','ðŸ›','â›Ž','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™Ž','â™','â™','â™‘','â™’','â™“','ðŸ†”','âš›ï¸','ðŸ‰‘','â˜¢ï¸','â˜£ï¸','ðŸ“´','ðŸ“³','ðŸˆ¶','ðŸˆš','ðŸˆ¸','ðŸˆº','ðŸˆ·ï¸','âœ´ï¸','ðŸ†š','ðŸ’®','ðŸ‰','ãŠ™ï¸','ãŠ—ï¸','ðŸˆ´','ðŸˆµ','ðŸˆ¹','ðŸˆ²','ðŸ…°ï¸','ðŸ…±ï¸','ðŸ†Ž','ðŸ†‘','ðŸ…¾ï¸','ðŸ†˜','âŒ','â­•','ðŸ›‘','â›”','ðŸ“›','ðŸš«','ðŸ’¯','ðŸ’¢','â™¨ï¸','ðŸš·','ðŸš¯','ðŸš³','ðŸš±','ðŸ”ž','ðŸ“µ','ðŸš­','â—','â•','â“','â”','â€¼ï¸','â‰ï¸','ðŸ”…','ðŸ”†','ã€½ï¸','âš ï¸','ðŸš¸','ðŸ”±','âšœï¸','ðŸ”°','â™»ï¸','âœ…','ðŸˆ¯','ðŸ’¹','â‡ï¸','âœ³ï¸','âŽ','ðŸŒ','ðŸ’ ','â“‚ï¸','ðŸŒ€','ðŸ’¤','ðŸ§','ðŸš¾','â™¿','ðŸ…¿ï¸','ðŸ›—','ðŸˆ³','ðŸˆ‚ï¸','ðŸ›‚','ðŸ›ƒ','ðŸ›„','ðŸ›…','ðŸš¹','ðŸšº','ðŸš¼','âš§ï¸','ðŸš»','ðŸš®','ðŸŽ¦','ðŸ“¶','ðŸˆ','ðŸ”£','â„¹ï¸','ðŸ”¤','ðŸ”¡','ðŸ” ','ðŸ†™','ðŸ†—','ðŸ†’','ðŸ†•','ðŸ†“','0ï¸âƒ£','1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£','9ï¸âƒ£','ðŸ”Ÿ','ðŸ”¢','#ï¸âƒ£','*ï¸âƒ£','âï¸','â–¶ï¸','â©','â­ï¸','â¯ï¸','â—€ï¸','âª','â®ï¸','ðŸ”¼','â«','ðŸ”½','â¬','â¸ï¸','â¹ï¸','âºï¸','âï¸','ðŸŽ¦','ðŸ”…','ðŸ”†','ðŸ“¶','ðŸ”€','ðŸ”','ðŸ”‚','â–¶ï¸','ðŸ”ƒ','ðŸ”„','ðŸ”™','ðŸ”š','ðŸ”›','ðŸ”œ','ðŸ”'],
        'Flags': ['ðŸ','ðŸš©','ðŸŽŒ','ðŸ´','ðŸ³ï¸','ðŸ³ï¸â€ðŸŒˆ','ðŸ³ï¸â€âš§ï¸','ðŸ´â€â˜ ï¸','ðŸ‡¦ðŸ‡«','ðŸ‡¦ðŸ‡±','ðŸ‡©ðŸ‡¿','ðŸ‡¦ðŸ‡¸','ðŸ‡¦ðŸ‡©','ðŸ‡¦ðŸ‡´','ðŸ‡¦ðŸ‡®','ðŸ‡¦ðŸ‡¬','ðŸ‡¦ðŸ‡·','ðŸ‡¦ðŸ‡²','ðŸ‡¦ðŸ‡¼','ðŸ‡¦ðŸ‡º','ðŸ‡¦ðŸ‡¹','ðŸ‡¦ðŸ‡¿','ðŸ‡§ðŸ‡¸','ðŸ‡§ðŸ‡­','ðŸ‡§ðŸ‡©','ðŸ‡§ðŸ‡§','ðŸ‡§ðŸ‡¾','ðŸ‡§ðŸ‡ª','ðŸ‡§ðŸ‡¿','ðŸ‡§ðŸ‡¯','ðŸ‡§ðŸ‡²','ðŸ‡§ðŸ‡¹','ðŸ‡§ðŸ‡´','ðŸ‡§ðŸ‡¦','ðŸ‡§ðŸ‡¼','ðŸ‡§ðŸ‡·','ðŸ‡§ðŸ‡³','ðŸ‡§ðŸ‡¬','ðŸ‡§ðŸ‡«','ðŸ‡§ðŸ‡®','ðŸ‡°ðŸ‡­','ðŸ‡¨ðŸ‡²','ðŸ‡¨ðŸ‡¦','ðŸ‡¨ðŸ‡»','ðŸ‡¨ðŸ‡«','ðŸ‡¹ðŸ‡©','ðŸ‡¨ðŸ‡±','ðŸ‡¨ðŸ‡³','ðŸ‡¨ðŸ‡´','ðŸ‡°ðŸ‡²','ðŸ‡¨ðŸ‡¬','ðŸ‡¨ðŸ‡©','ðŸ‡¨ðŸ‡·','ðŸ‡­ðŸ‡·','ðŸ‡¨ðŸ‡º','ðŸ‡¨ðŸ‡¾','ðŸ‡¨ðŸ‡¿','ðŸ‡©ðŸ‡°','ðŸ‡©ðŸ‡¯','ðŸ‡©ðŸ‡²','ðŸ‡©ðŸ‡´','ðŸ‡ªðŸ‡¨','ðŸ‡ªðŸ‡¬','ðŸ‡¸ðŸ‡»','ðŸ‡¬ðŸ‡¶','ðŸ‡ªðŸ‡·','ðŸ‡ªðŸ‡ª','ðŸ‡¸ðŸ‡¿','ðŸ‡ªðŸ‡¹','ðŸ‡«ðŸ‡¯','ðŸ‡«ðŸ‡®','ðŸ‡«ðŸ‡·','ðŸ‡¬ðŸ‡¦','ðŸ‡¬ðŸ‡²','ðŸ‡¬ðŸ‡ª','ðŸ‡©ðŸ‡ª','ðŸ‡¬ðŸ‡­','ðŸ‡¬ðŸ‡·','ðŸ‡¬ðŸ‡©','ðŸ‡¬ðŸ‡¹','ðŸ‡¬ðŸ‡³','ðŸ‡¬ðŸ‡¾','ðŸ‡­ðŸ‡¹','ðŸ‡­ðŸ‡³','ðŸ‡­ðŸ‡°','ðŸ‡­ðŸ‡º','ðŸ‡®ðŸ‡¸','ðŸ‡®ðŸ‡³','ðŸ‡®ðŸ‡©','ðŸ‡®ðŸ‡·','ðŸ‡®ðŸ‡¶','ðŸ‡®ðŸ‡ª','ðŸ‡®ðŸ‡±','ðŸ‡®ðŸ‡¹','ðŸ‡¯ðŸ‡²','ðŸ‡¯ðŸ‡µ','ðŸ‡¯ðŸ‡´','ðŸ‡°ðŸ‡¿','ðŸ‡°ðŸ‡ª','ðŸ‡°ðŸ‡·','ðŸ‡°ðŸ‡¼','ðŸ‡±ðŸ‡¦','ðŸ‡±ðŸ‡§','ðŸ‡±ðŸ‡·','ðŸ‡±ðŸ‡¾','ðŸ‡±ðŸ‡¹','ðŸ‡±ðŸ‡º','ðŸ‡²ðŸ‡¬','ðŸ‡²ðŸ‡¾','ðŸ‡²ðŸ‡±','ðŸ‡²ðŸ‡¹','ðŸ‡²ðŸ‡½','ðŸ‡²ðŸ‡³','ðŸ‡²ðŸ‡¦','ðŸ‡²ðŸ‡¿','ðŸ‡²ðŸ‡²','ðŸ‡³ðŸ‡¦','ðŸ‡³ðŸ‡µ','ðŸ‡³ðŸ‡±','ðŸ‡³ðŸ‡¿','ðŸ‡³ðŸ‡®','ðŸ‡³ðŸ‡ª','ðŸ‡³ðŸ‡¬','ðŸ‡°ðŸ‡µ','ðŸ‡³ðŸ‡´','ðŸ‡´ðŸ‡²','ðŸ‡µðŸ‡°','ðŸ‡µðŸ‡¦','ðŸ‡µðŸ‡¬','ðŸ‡µðŸ‡¾','ðŸ‡µðŸ‡ª','ðŸ‡µðŸ‡­','ðŸ‡µðŸ‡±','ðŸ‡µðŸ‡¹','ðŸ‡µðŸ‡·','ðŸ‡¶ðŸ‡¦','ðŸ‡·ðŸ‡´','ðŸ‡·ðŸ‡º','ðŸ‡·ðŸ‡¼','ðŸ‡¸ðŸ‡¦','ðŸ‡¸ðŸ‡³','ðŸ‡·ðŸ‡¸','ðŸ‡¸ðŸ‡¬','ðŸ‡¸ðŸ‡°','ðŸ‡¸ðŸ‡®','ðŸ‡¸ðŸ‡´','ðŸ‡¿ðŸ‡¦','ðŸ‡ªðŸ‡¸','ðŸ‡±ðŸ‡°','ðŸ‡¸ðŸ‡©','ðŸ‡¸ðŸ‡ª','ðŸ‡¨ðŸ‡­','ðŸ‡¸ðŸ‡¾','ðŸ‡¹ðŸ‡¼','ðŸ‡¹ðŸ‡¿','ðŸ‡¹ðŸ‡­','ðŸ‡¹ðŸ‡¬','ðŸ‡¹ðŸ‡¹','ðŸ‡¹ðŸ‡³','ðŸ‡¹ðŸ‡·','ðŸ‡ºðŸ‡¬','ðŸ‡ºðŸ‡¦','ðŸ‡¦ðŸ‡ª','ðŸ‡¬ðŸ‡§','ðŸ‡ºðŸ‡¸','ðŸ‡ºðŸ‡¾','ðŸ‡ºðŸ‡¿','ðŸ‡»ðŸ‡ª','ðŸ‡»ðŸ‡³','ðŸ‡¾ðŸ‡ª','ðŸ‡¿ðŸ‡²','ðŸ‡¿ðŸ‡¼']
    };

    var catIcons = {
        'Smileys & People': 'fa-face-smile',
        'Animals & Nature': 'fa-paw',
        'Food & Drink': 'fa-utensils',
        'Activities': 'fa-futbol',
        'Travel & Places': 'fa-plane',
        'Objects': 'fa-lightbulb',
        'Symbols': 'fa-heart',
        'Flags': 'fa-flag'
    };

    var catKeys = Object.keys(categories);
    var activeCat = catKeys[0];

    var tabsHTML = '<div id="emojiTabBar" style="display:flex;gap:0;border-bottom:1px solid var(--border-color);padding:0 8px;">';
    catKeys.forEach(function(cat, i) {
        tabsHTML += '<button class="emoji-cat-tab' + (i === 0 ? ' active' : '') + '" data-cat="' + cat + '" onclick="switchEmojiCategory(\'' + cat.replace(/'/g, "\\'") + '\')" ' +
            'style="flex:1;padding:10px 4px;border:none;background:none;cursor:pointer;font-size:15px;color:' + (i === 0 ? 'var(--honey-yellow)' : 'var(--text-secondary)') + ';position:relative;transition:color 0.2s;" ' +
            'title="' + cat + '"><i class="fas ' + (catIcons[cat] || 'fa-icons') + '"></i></button>';
    });
    tabsHTML += '</div>';

    var gridHTML = '<div id="emojiGrid" style="padding:10px;overflow-y:auto;flex:1;display:flex;flex-wrap:wrap;gap:2px;align-content:flex-start;">';
    categories[activeCat].forEach(function(em) {
        gridHTML += '<button onclick="insertEmojiFromPicker(\'' + em + '\')" style="font-size:24px;padding:4px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:none;border:none;cursor:pointer;border-radius:8px;transition:background 0.15s;" onmouseover="this.style.background=\'var(--bg-input)\'" onmouseout="this.style.background=\'\'"">' + em + '</button>';
    });
    gridHTML += '</div>';

    emojiModal.innerHTML = '<div style="background:var(--bg-card);border-radius:16px;width:92%;max-width:440px;height:480px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 12px 40px rgba(0,0,0,0.4);">' +
        '<div style="padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;">' +
            '<h3 style="color:var(--honey-yellow);margin:0;font-size:16px;"><i class="fas fa-face-smile"></i> Emoji</h3>' +
            '<button onclick="document.getElementById(\'emojiPickerOverlay\').remove()" style="background:none;border:none;color:var(--text-primary);font-size:1.3em;cursor:pointer;">&times;</button>' +
        '</div>' +
        '<div style="padding:8px 12px;">' +
            '<input type="text" id="emojiSearchInput" placeholder="Search emoji..." oninput="searchEmojis(this.value)" style="width:100%;padding:8px 12px;border-radius:16px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);font-size:13px;outline:none;box-sizing:border-box;">' +
        '</div>' +
        tabsHTML +
        '<div id="emojiCatLabel" style="padding:6px 14px;font-size:12px;color:var(--text-secondary);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">' + activeCat + '</div>' +
        gridHTML +
    '</div>';

    document.body.appendChild(emojiModal);

    // Store categories globally for tab switching
    window._emojiCategories = categories;
}

function switchEmojiCategory(cat) {
    var categories = window._emojiCategories;
    if (!categories || !categories[cat]) return;

    // Update tab active state
    document.querySelectorAll('.emoji-cat-tab').forEach(function(tab) {
        var isActive = tab.getAttribute('data-cat') === cat;
        tab.style.color = isActive ? 'var(--honey-yellow)' : 'var(--text-secondary)';
        tab.className = 'emoji-cat-tab' + (isActive ? ' active' : '');
    });

    // Update label
    var label = document.getElementById('emojiCatLabel');
    if (label) label.textContent = cat;

    // Update grid
    var grid = document.getElementById('emojiGrid');
    if (!grid) return;
    var html = '';
    categories[cat].forEach(function(em) {
        html += '<button onclick="insertEmojiFromPicker(\'' + em + '\')" style="font-size:24px;padding:4px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:none;border:none;cursor:pointer;border-radius:8px;transition:background 0.15s;" onmouseover="this.style.background=\'var(--bg-input)\'" onmouseout="this.style.background=\'\'"">' + em + '</button>';
    });
    grid.innerHTML = html;

    // Clear search
    var searchInput = document.getElementById('emojiSearchInput');
    if (searchInput) searchInput.value = '';
}

function searchEmojis(query) {
    query = query.toLowerCase().trim();
    var categories = window._emojiCategories;
    if (!categories) return;
    var grid = document.getElementById('emojiGrid');
    if (!grid) return;

    if (!query) {
        // Show first category
        var firstCat = Object.keys(categories)[0];
        switchEmojiCategory(firstCat);
        return;
    }

    // Simple: show all emojis from all categories (native emoji rendering means the browser handles display)
    // For search, we match against a basic emoji description map
    var html = '';
    var count = 0;
    Object.values(categories).forEach(function(emojis) {
        emojis.forEach(function(em) {
            // Show all on short queries, filter nothing for now (emoji search is complex)
            if (query.length < 2) return;
            html += '<button onclick="insertEmojiFromPicker(\'' + em + '\')" style="font-size:24px;padding:4px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:none;border:none;cursor:pointer;border-radius:8px;transition:background 0.15s;" onmouseover="this.style.background=\'var(--bg-input)\'" onmouseout="this.style.background=\'\'"">' + em + '</button>';
            count++;
        });
    });

    if (count === 0) {
        html = '<div style="text-align:center;padding:30px;color:var(--text-secondary);">No emoji found</div>';
    }
    grid.innerHTML = html;

    // Update label
    var label = document.getElementById('emojiCatLabel');
    if (label) label.textContent = 'Search Results (' + count + ')';
}

function insertEmojiFromPicker(emoji) {
    // Reaction mode â€” if triggered from "More" button in DM reaction picker
    if (window._emojiInsertMode === 'reaction' && window._dmReactionMsgId) {
        var msgId = window._dmReactionMsgId;
        window._emojiInsertMode = null;
        window._dmReactionMsgId = null;
        dmToggleReaction(dmActiveConvId, msgId, emoji);
        document.getElementById('emojiPickerOverlay').remove();
        dmRefreshChat();
        return;
    }

    // Try the DM input first, then contentEditable compose areas
    var dmInput = document.getElementById('dmTextInput');
    if (dmInput && dmInput.offsetParent !== null) {
        // DM input is visible
        var pos = dmInput.selectionStart || dmInput.value.length;
        dmInput.value = dmInput.value.substring(0, pos) + emoji + dmInput.value.substring(pos);
        dmInput.selectionStart = dmInput.selectionEnd = pos + emoji.length;
        dmInput.focus();
        dmInput.dispatchEvent(new Event('input'));
        return;
    }

    // Try contentEditable target
    var targetId = window._emojiTarget || 'postContent';
    var target = document.getElementById(targetId);
    if (target && target.isContentEditable) {
        target.focus();
        document.execCommand('insertText', false, emoji);
        if (typeof handleInlineCompose === 'function' && targetId === 'inlinePostContent') {
            handleInlineCompose(target);
        }
    } else if (target) {
        // Fallback for regular inputs
        var pos = target.selectionStart || target.value.length;
        target.value = target.value.substring(0, pos) + emoji + target.value.substring(pos);
        target.selectionStart = target.selectionEnd = pos + emoji.length;
        target.focus();
    }

    document.getElementById('emojiPickerOverlay').remove();
}

function insertEmoji(emoji) {
    const targetId = window._emojiTarget || 'postContent';
    const el = document.getElementById(targetId);
    if (!el) return;
    if (el.contentEditable === 'true') {
        el.focus();
        document.execCommand('insertText', false, emoji);
    } else {
        const start = el.selectionStart;
        const end = el.selectionEnd;
        el.value = el.value.substring(0, start) + emoji + el.value.substring(end);
        el.selectionStart = el.selectionEnd = start + emoji.length;
        el.focus();
    }
    window._emojiTarget = 'postContent';
}

// Location tagging
function showLocationPicker() {
    const location = prompt('ðŸ“ Add your location:');
    if (location && location.trim()) {
        const locationTag = document.createElement('div');
        locationTag.id = 'postLocation';
        locationTag.style.cssText = 'display:flex;align-items:center;gap:5px;padding:8px 12px;background:var(--bg-input);border-radius:20px;font-size:13px;color:var(--honey-yellow);margin-top:10px;width:fit-content;';
        locationTag.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${location.trim()} <button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;margin-left:5px;">&times;</button>`;

        const textarea = document.getElementById('postContent');
        if (textarea && textarea.parentElement) {
            textarea.parentElement.appendChild(locationTag);
        }
        showToast('ðŸ“ Location added!');
    }
}

// Schedule post
function showSchedulePost() {
    const now = new Date();
    const min = now.toISOString().slice(0, 16);

    const scheduleModal = document.createElement('div');
    scheduleModal.id = 'schedulePostOverlay';
    scheduleModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    scheduleModal.onclick = function(e) { if(e.target === scheduleModal) scheduleModal.remove(); };

    scheduleModal.innerHTML = `
        <div style="background:var(--bg-card);border-radius:15px;padding:25px;width:90%;max-width:350px;">
            <h3 style="margin-bottom:15px;color:var(--honey-yellow);"><i class="fas fa-clock"></i> Schedule Buzz</h3>
            <input type="datetime-local" id="scheduleDateTime" min="${min}" 
                style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);font-size:14px;margin-bottom:15px;">
            <div style="display:flex;gap:10px;">
                <button onclick="confirmSchedule()" style="flex:1;background:var(--honey-yellow);color:#000;border:none;padding:10px;border-radius:10px;cursor:pointer;font-weight:bold;">Schedule</button>
                <button onclick="document.getElementById('schedulePostOverlay').remove()" style="flex:1;background:var(--bg-input);border:1px solid var(--border-color);padding:10px;border-radius:10px;cursor:pointer;color:var(--text-primary);">Cancel</button>
            </div>
        </div>
    `;

    document.body.appendChild(scheduleModal);
}

function confirmSchedule() {
    const dt = document.getElementById('scheduleDateTime').value;
    if (!dt) { showToast('Please select a date and time'); return; }

    const scheduled = new Date(dt);
    const now = new Date();
    if (scheduled <= now) { showToast('Please select a future time'); return; }

    const diffMs = scheduled - now;
    const hours = Math.floor(diffMs / 3600000);
    const mins = Math.floor((diffMs % 3600000) / 60000);

    document.getElementById('schedulePostOverlay').remove();
    showToast(`â° Post scheduled for ${scheduled.toLocaleString()} (in ${hours}h ${mins}m)`);
}



// ===== ENHANCED NOTIFICATIONS =====
function showNotifications() {
    if (!currentUser) return;
    currentPage = 'notifications';

    // Richer notification data
    if (notifications.length <= 4) {
        notifications = [
            { id: 1, type: 'like', text: 'FloraCreative liked your post', user: 'FloraCreative', time: '5m ago', read: false, postId: 1 },
            { id: 2, type: 'pollinate', text: 'TechWorker pollinated your idea', user: 'TechWorker', time: '12m ago', read: false, postId: 2 },
            { id: 3, type: 'follow', text: 'ScienceBee started following you', user: 'ScienceBee', time: '1h ago', read: true },
            { id: 4, type: 'trending', text: 'Your post is trending! ðŸ”¥', time: '2h ago', read: true, postId: 1 },
            { id: 5, type: 'mention', text: 'ArtistBee mentioned you in a comment', user: 'ArtistBee', time: '3h ago', read: true, postId: 3 },
            { id: 6, type: 'like', text: 'GardenFairy and 3 others liked your post', user: 'GardenFairy', time: '5h ago', read: true, postId: 2 },
            { id: 7, type: 'honey', text: 'You earned 200 Honey Points this week! ðŸ¯', time: '1d ago', read: true },
            { id: 8, type: 'system', text: 'Welcome to Polleneer! Complete your profile for +100 points', time: '2d ago', read: true },
        ];
    }

    notifications.forEach(n => n.read = true);
    updateBadgeCounts();

    const iconMap = { like: 'fa-heart', pollinate: 'fa-retweet', follow: 'fa-user-plus', trending: 'fa-fire', mention: 'fa-at', honey: 'fa-coins', system: 'fa-bell', comment: 'fa-comment' };
    const colorMap = { like: '#FF6B6B', pollinate: '#4ECDC4', follow: '#45B7D1', trending: '#FF8C00', mention: '#9B59B6', honey: '#FFC30B', system: '#87CEEB', comment: '#2ECC71' };

    document.getElementById('mainContent').innerHTML = `
        <div class="customization-panel">
            <h3 style="margin-bottom: 5px; color: var(--honey-yellow);"><i class="fas fa-bell"></i> Notifications</h3>
            <div style="display:flex;gap:10px;margin-bottom:20px;border-bottom:1px solid var(--border-color);padding-bottom:15px;">
                <button id="notif-tab-all" onclick="filterNotifications('all')" style="background:var(--honey-yellow);color:#000;border:none;padding:6px 18px;border-radius:20px;cursor:pointer;font-weight:bold;font-size:13px;">All</button>
                <button id="notif-tab-mentions" onclick="filterNotifications('mention')" style="background:var(--bg-input);border:1px solid var(--border-color);padding:6px 18px;border-radius:20px;cursor:pointer;font-size:13px;color:var(--text-primary);">Mentions</button>
                <button id="notif-tab-likes" onclick="filterNotifications('like')" style="background:var(--bg-input);border:1px solid var(--border-color);padding:6px 18px;border-radius:20px;cursor:pointer;font-size:13px;color:var(--text-primary);">Likes</button>
            </div>
            <div id="notificationsList">
                ${notifications.map(n => `
                    <div class="post-card" style="padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:background 0.2s;" 
                         onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''"
                         onclick="${n.postId ? `viewThread(${n.postId})` : n.user ? `searchUser('${n.user}')` : ''}" data-notif-type="${n.type}">
                        <div style="width:40px;height:40px;border-radius:50%;background:${colorMap[n.type] || '#666'};display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                            <i class="fas ${iconMap[n.type] || 'fa-bell'}" style="color:white;"></i>
                        </div>
                        <div style="flex:1;min-width:0;">
                            <div style="line-height:1.4;">${n.text}</div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:3px;">${n.time}</div>
                        </div>
                        ${!n.read ? '<div style="width:8px;height:8px;border-radius:50%;background:var(--honey-yellow);flex-shrink:0;"></div>' : ''}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function filterNotifications(type) {
    ['all','mentions','likes'].forEach(t => {
        const btn = document.getElementById(`notif-tab-${t}`);
        if(btn) { btn.style.background = 'var(--bg-input)'; btn.style.color = 'var(--text-primary)'; }
    });
    const activeTab = document.getElementById(`notif-tab-${type === 'mention' ? 'mentions' : type === 'like' ? 'likes' : 'all'}`);
    if(activeTab) { activeTab.style.background = 'var(--honey-yellow)'; activeTab.style.color = '#000'; }

    const items = document.querySelectorAll('[data-notif-type]');
    items.forEach(item => {
        item.style.display = (type === 'all' || item.dataset.notifType === type) ? 'flex' : 'none';
    });
}

// ===== THREAD / REPLY VIEW =====
function viewThread(postId) {
    const post = posts.find(p => p.id === postId);
    if (!post) { showToast('Post not found'); return; }

    const user = users.find(u => u.id === post.userId);
    if (!user) return;

    const postComments = comments[postId] || SAMPLE_COMMENTS[postId] || [];

    document.getElementById('mainContent').innerHTML = `
        <div style="max-width:700px;margin:0 auto;">
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;padding:10px 0;">
                <button onclick="goToHome()" style="background:none;border:none;color:var(--text-primary);cursor:pointer;font-size:1.2em;"><i class="fas fa-arrow-left"></i></button>
                <h3>Thread</h3>
            </div>

            <!-- Main post (expanded) -->
            <div class="post-card" style="padding:20px;">
                <div style="display:flex;gap:12px;margin-bottom:15px;">
                    <img src="${user.avatar}" alt="${user.username}" style="width:48px;height:48px;border-radius:50%;cursor:pointer;" onclick="goToUserProfile(${user.id})">
                    <div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <strong style="cursor:pointer;" onclick="goToUserProfile(${user.id})">${user.displayName || user.username}</strong>
                            ${user.role === 'queen' || user.role === 'admin' ? '<i class="fas fa-check-circle" style="color:var(--honey-yellow);font-size:14px;" title="Verified"></i>' : ''}
                            <span class="user-role-badge" style="font-size:11px;">${getRoleName(user.role)}</span>
                        </div>
                        <div style="color:var(--text-secondary);font-size:13px;">@${user.username}</div>
                    </div>
                </div>

                <div style="font-size:16px;line-height:1.6;margin-bottom:15px;">${formatPostContent(post.content)}</div>

                ${post.tags && post.tags.length > 0 ? `<div style="margin-bottom:12px;">${post.tags.map(t => `<span style="color:var(--honey-yellow);cursor:pointer;margin-right:8px;" onclick="searchTag('${t}')">${t}</span>`).join('')}</div>` : ''}

                ${post.media ? `<img src="${post.media}" style="width:100%;border-radius:12px;margin-bottom:15px;max-height:400px;object-fit:cover;">` : ''}

                <div style="color:var(--text-secondary);font-size:13px;padding:12px 0;border-top:1px solid var(--border-color);border-bottom:1px solid var(--border-color);">
                    ${post.createdAt} Â· <span style="color:var(--text-primary);font-weight:bold;">${(post.views || 0).toLocaleString()}</span> Views
                </div>

                <div style="display:flex;gap:20px;padding:12px 0;border-bottom:1px solid var(--border-color);font-size:14px;">
                    <span><strong>${post.pollinations || 0}</strong> <span style="color:var(--text-secondary);">Pollinations</span></span>
                    <span><strong>${post.likes || 0}</strong> <span style="color:var(--text-secondary);">Likes</span></span>
                    <span><strong>${postComments.length}</strong> <span style="color:var(--text-secondary);">Replies</span></span>
                </div>

                <div style="display:flex;justify-content:space-around;padding:8px 0;border-bottom:1px solid var(--border-color);">
                    <button onclick="toggleComments(${post.id})" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:8px;border-radius:50%;transition:color 0.2s;" onmouseover="this.style.color='var(--sky-blue)'" onmouseout="this.style.color='var(--text-secondary)'"><i class="far fa-comment"></i></button>
                    <button onclick="pollinatePost(${post.id})" style="background:none;border:none;color:${post.isPollinated ? 'var(--leaf-green)' : 'var(--text-secondary)'};cursor:pointer;padding:8px;border-radius:50%;"><i class="${post.isPollinated ? 'fas' : 'far'} fa-retweet"></i></button>
                    <button onclick="quotePollinate(${post.id})" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:8px;border-radius:50%;" onmouseover="this.style.color='var(--honey-yellow)'" onmouseout="this.style.color='var(--text-secondary)'" title="Quote Pollinate"><i class="fas fa-quote-left"></i></button>
                    <button onclick="likePost(${post.id})" style="background:none;border:none;color:${post.isLiked ? '#FF6B6B' : 'var(--text-secondary)'};cursor:pointer;padding:8px;border-radius:50%;"><i class="${post.isLiked ? 'fas' : 'far'} fa-heart"></i></button>
                    <button onclick="sharePost(${post.id})" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:8px;border-radius:50%;" onmouseover="this.style.color='var(--sky-blue)'" onmouseout="this.style.color='var(--text-secondary)'"><i class="fas fa-share-from-square"></i></button>
                </div>
            </div>

            <!-- Reply composer -->
            <div class="post-card" style="padding:15px;margin-top:2px;display:flex;gap:12px;">
                <img src="${currentUser.avatar}" alt="You" style="width:36px;height:36px;border-radius:50%;">
                <div style="flex:1;">
                    <textarea id="thread-reply-input" placeholder="Post your reply..." style="width:100%;background:transparent;border:none;color:var(--text-primary);resize:none;font-size:15px;min-height:50px;outline:none;font-family:inherit;"></textarea>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                        <div style="display:flex;gap:12px;">
                            <button onclick="document.getElementById('mediaUpload').click()" style="background:none;border:none;color:var(--honey-yellow);cursor:pointer;"><i class="fas fa-image"></i></button>
                            <button onclick="showGifPicker()" style="background:none;border:none;color:var(--honey-yellow);cursor:pointer;font-weight:bold;font-size:13px;">GIF</button>
                            <button onclick="showEmojiPicker()" style="background:none;border:none;color:var(--honey-yellow);cursor:pointer;"><i class="fas fa-face-smile"></i></button>
                        </div>
                        <button onclick="submitThreadReply(${post.id})" style="background:var(--honey-yellow);color:#000;border:none;padding:8px 20px;border-radius:20px;cursor:pointer;font-weight:bold;font-size:13px;">Reply</button>
                    </div>
                </div>
            </div>

            <!-- Replies -->
            <div id="threadReplies" style="margin-top:2px;">
                ${postComments.map(c => {
                    const commenter = users.find(u => u.id === c.userId) || { username: 'Unknown', displayName: 'Unknown', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Unknown' };
                    return `
                        <div class="post-card" style="padding:15px;margin-top:2px;display:flex;gap:12px;">
                            <img src="${commenter.avatar}" alt="${commenter.username}" style="width:36px;height:36px;border-radius:50%;cursor:pointer;" onclick="goToUserProfile(${c.userId})">
                            <div style="flex:1;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                    <strong style="font-size:14px;cursor:pointer;" onclick="goToUserProfile(${c.userId})">${commenter.displayName || commenter.username}</strong>
                                    <span style="color:var(--text-secondary);font-size:13px;">@${commenter.username} Â· ${c.createdAt}</span>
                                </div>
                                <div style="line-height:1.5;margin-bottom:8px;">${c.text}</div>
                                <div style="display:flex;gap:20px;">
                                    <button onclick="likeComment(${c.id}, ${post.id})" data-comment-like="${c.id}" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:13px;"><i class="far fa-heart"></i> Like</button>
                                    <button onclick="replyToComment(${post.id}, ${c.id})" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:13px;"><i class="far fa-comment"></i> Reply</button>
                                    <button onclick="pollinatePost(${post.id})" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:13px;"><i class="far fa-retweet"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}

                ${postComments.length === 0 ? '<div class="post-card" style="padding:30px;margin-top:2px;text-align:center;color:var(--text-secondary);">No replies yet. Be the first to buzz! ðŸ</div>' : ''}
            </div>
        </div>
    `;
}

function submitThreadReply(postId) {
    const input = document.getElementById('thread-reply-input');
    if (!input) return;
    const text = input.value.trim();
    if (!text) { showToast('Write something first!'); return; }

    if (!comments[postId]) comments[postId] = [];
    const newComment = { id: Date.now(), userId: currentUser.id, text: text, createdAt: 'Just now' };
    comments[postId].push(newComment);

    const post = posts.find(p => p.id === postId);
    if (post) post.comments += 1;

    currentUser.honeyPoints += 10;
    localStorage.setItem('polleneer_user', JSON.stringify(currentUser));

    showToast('Reply posted! +10 Honey Points ðŸ¯');
    viewThread(postId);
}

// ===== QUOTE POLLINATION (Quote Retweet) =====
function quotePollinate(postId) {
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    const user = users.find(u => u.id === post.userId);
    if (!user) return;

    const quoteModal = document.createElement('div');
    quoteModal.id = 'quotePollinateOverlay';
    quoteModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    quoteModal.onclick = function(e) { if(e.target === quoteModal) quoteModal.remove(); };

    quoteModal.innerHTML = `
        <div style="background:var(--bg-card);border-radius:15px;width:90%;max-width:550px;overflow:hidden;">
            <div style="padding:15px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;">
                <h3 style="color:var(--honey-yellow);"><i class="fas fa-quote-left"></i> Quote Pollinate</h3>
                <button onclick="document.getElementById('quotePollinateOverlay').remove()" style="background:none;border:none;color:var(--text-primary);font-size:1.5em;cursor:pointer;">&times;</button>
            </div>
            <div style="padding:15px;">
                <div style="display:flex;gap:12px;margin-bottom:12px;">
                    <img src="${currentUser.avatar}" style="width:40px;height:40px;border-radius:50%;">
                    <textarea id="quoteText" placeholder="Add your thoughts..." style="flex:1;background:transparent;border:none;color:var(--text-primary);resize:none;font-size:15px;min-height:60px;outline:none;font-family:inherit;"></textarea>
                </div>

                <!-- Quoted post preview -->
                <div style="border:1px solid var(--border-color);border-radius:12px;padding:12px;margin-bottom:15px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <img src="${user.avatar}" style="width:20px;height:20px;border-radius:50%;">
                        <strong style="font-size:13px;">${user.displayName || user.username}</strong>
                        <span style="color:var(--text-secondary);font-size:12px;">@${user.username} Â· ${post.createdAt}</span>
                    </div>
                    <div style="font-size:13px;color:var(--text-secondary);line-height:1.4;">${post.content.substring(0, 150)}${post.content.length > 150 ? '...' : ''}</div>
                </div>

                <div style="display:flex;justify-content:flex-end;">
                    <button onclick="submitQuotePollination(${postId})" style="background:var(--honey-yellow);color:#000;border:none;padding:10px 25px;border-radius:20px;cursor:pointer;font-weight:bold;">Pollinate</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(quoteModal);
    document.getElementById('quoteText').focus();
}

function submitQuotePollination(postId) {
    const quoteText = document.getElementById('quoteText').value.trim();
    const originalPost = posts.find(p => p.id === postId);
    if (!originalPost) return;
    const originalUser = users.find(u => u.id === originalPost.userId);

    const newPost = {
        id: posts.length + 100,
        userId: currentUser.id,
        content: quoteText ? quoteText + '\n\n' : '',
        quotedPost: { postId: postId, content: originalPost.content.substring(0, 200), username: originalUser ? originalUser.username : 'Unknown', avatar: originalUser ? originalUser.avatar : '' },
        tags: [],
        likes: 0, comments: 0, pollinations: 0, views: 0,
        createdAt: 'Just now',
        isLiked: false, isPollinated: false
    };

    posts.unshift(newPost);
    originalPost.pollinations += 1;

    currentUser.honeyPoints += 15;
    localStorage.setItem('polleneer_user', JSON.stringify(currentUser));

    document.getElementById('quotePollinateOverlay').remove();
    showToast('ðŸ Quote pollinated! +15 Honey Points');

    if (currentPage === 'home') goToHome();
}

// ===== ANALYTICS DASHBOARD =====
function showAnalytics() {
    if (!currentUser) return;

    const myPosts = posts.filter(p => p.userId === currentUser.id);
    const totalLikes = myPosts.reduce((sum, p) => sum + (p.likes || 0), 0);
    const totalViews = myPosts.reduce((sum, p) => sum + (p.views || 0), 0);
    const totalPollinations = myPosts.reduce((sum, p) => sum + (p.pollinations || 0), 0);
    const totalComments = myPosts.reduce((sum, p) => sum + (p.comments || 0), 0);
    const engagementRate = totalViews > 0 ? (((totalLikes + totalComments + totalPollinations) / totalViews) * 100).toFixed(1) : 0;

    document.getElementById('mainContent').innerHTML = `
        <div class="customization-panel" style="max-width:800px;margin:0 auto;">
            <h3 style="margin-bottom:25px;color:var(--honey-yellow);"><i class="fas fa-chart-line"></i> Analytics Dashboard</h3>

            <!-- Key Metrics -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:25px;">
                ${[
                    { label: 'Total Views', value: totalViews.toLocaleString(), icon: 'fa-eye', color: '#87CEEB' },
                    { label: 'Total Likes', value: totalLikes.toLocaleString(), icon: 'fa-heart', color: '#FF6B6B' },
                    { label: 'Pollinations', value: totalPollinations.toLocaleString(), icon: 'fa-retweet', color: '#4ECDC4' },
                    { label: 'Comments', value: totalComments.toLocaleString(), icon: 'fa-comment', color: '#9B59B6' },
                    { label: 'Engagement', value: engagementRate + '%', icon: 'fa-chart-pie', color: '#FF8C00' },
                    { label: 'Honey Earned', value: currentUser.honeyPoints.toLocaleString(), icon: 'fa-coins', color: '#FFC30B' },
                ].map(m => `
                    <div class="post-card" style="padding:18px;text-align:center;">
                        <i class="fas ${m.icon}" style="font-size:1.5em;color:${m.color};margin-bottom:8px;"></i>
                        <div style="font-size:24px;font-weight:bold;margin-bottom:4px;">${m.value}</div>
                        <div style="font-size:12px;color:var(--text-secondary);">${m.label}</div>
                    </div>
                `).join('')}
            </div>

            <!-- Engagement Bar Chart -->
            <div class="post-card" style="padding:20px;margin-bottom:15px;">
                <h4 style="margin-bottom:15px;">Post Performance</h4>
                ${myPosts.length > 0 ? myPosts.slice(0, 5).map((p, i) => {
                    const maxLikes = Math.max(...myPosts.map(pp => pp.likes || 1));
                    const barWidth = ((p.likes || 0) / maxLikes * 100);
                    return `
                        <div style="margin-bottom:12px;cursor:pointer;" onclick="viewThread(${p.id})">
                            <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;">
                                <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;">${p.content.substring(0, 50)}...</span>
                                <span style="color:var(--text-secondary);">${p.likes} â¤ï¸</span>
                            </div>
                            <div style="background:var(--bg-input);border-radius:5px;height:8px;overflow:hidden;">
                                <div style="background:linear-gradient(90deg,var(--honey-yellow),var(--hive-orange));height:100%;width:${barWidth}%;border-radius:5px;transition:width 0.5s;"></div>
                            </div>
                        </div>
                    `;
                }).join('') : '<div style="text-align:center;color:var(--text-secondary);padding:20px;">Create your first post to see analytics!</div>'}
            </div>

            <!-- Follower Growth -->
            <div class="post-card" style="padding:20px;">
                <h4 style="margin-bottom:15px;">Profile Stats</h4>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;text-align:center;">
                    <div>
                        <div style="font-size:28px;font-weight:bold;color:var(--honey-yellow);">${currentUser.followers}</div>
                        <div style="font-size:12px;color:var(--text-secondary);">Followers</div>
                    </div>
                    <div>
                        <div style="font-size:28px;font-weight:bold;color:var(--hive-orange);">${currentUser.following}</div>
                        <div style="font-size:12px;color:var(--text-secondary);">Following</div>
                    </div>
                    <div>
                        <div style="font-size:28px;font-weight:bold;color:var(--leaf-green);">${myPosts.length}</div>
                        <div style="font-size:12px;color:var(--text-secondary);">Posts</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}



// ===== VERIFIED BADGES =====
// Override createPostHTML to add verified badges and quote pollination support
const _originalCreatePostHTML = createPostHTML;
function createPostHTML(post) {
    let html = _originalCreatePostHTML(post);

    // Add verified badge for queen/admin users
    const user = users.find(u => u.id === post.userId);
    if (user && (user.role === 'queen' || user.role === 'admin')) {
        html = html.replace(
            `<span class="user-role-badge">${getRoleName(user.role)}</span>`,
            `<i class="fas fa-check-circle" style="color:var(--honey-yellow);font-size:13px;" title="Verified Bee"></i> <span class="user-role-badge">${getRoleName(user.role)}</span>`
        );
    }

    // If this post has a quoted post, add the quote card
    if (post.quotedPost) {
        const quoteHTML = `
            <div style="border:1px solid var(--border-color);border-radius:12px;padding:12px;margin:10px 0;cursor:pointer;" onclick="viewThread(${post.quotedPost.postId})">
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
                    <img src="${post.quotedPost.avatar}" style="width:18px;height:18px;border-radius:50%;">
                    <span style="font-size:12px;font-weight:bold;">@${post.quotedPost.username}</span>
                </div>
                <div style="font-size:13px;color:var(--text-secondary);line-height:1.3;">${post.quotedPost.content}${post.quotedPost.content.length >= 200 ? '...' : ''}</div>
            </div>
        `;
        // Insert before the post stats
        html = html.replace('class="post-stats"', 'class="quoted-inject"></div>' + quoteHTML + '<div class="post-stats"');
    }

    // Make posts clickable to view thread
    html = html.replace(
        `<div class="post-content"`,
        `<div class="post-content" onclick="viewThread(${post.id})" style="cursor:pointer;"`
    );

    return html;
}

// ===== USER LISTS =====
function showLists() {
    if (!currentUser) return;

    const savedLists = JSON.parse(localStorage.getItem('polleneer_lists_' + currentUser.id) || '[]');

    // Default lists if none exist
    if (savedLists.length === 0) {
        savedLists.push(
            { id: 1, name: 'Favorite Bees', description: 'My top pollinating friends', members: [2, 3], isPrivate: false },
            { id: 2, name: 'Tech Hive', description: 'Tech-focused bees', members: [3], isPrivate: false }
        );
        localStorage.setItem('polleneer_lists_' + currentUser.id, JSON.stringify(savedLists));
    }

    document.getElementById('mainContent').innerHTML = `
        <div class="customization-panel" style="max-width:700px;margin:0 auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="color:var(--honey-yellow);"><i class="fas fa-list"></i> Lists</h3>
                <button onclick="createNewList()" style="background:var(--honey-yellow);color:#000;border:none;padding:8px 18px;border-radius:20px;cursor:pointer;font-weight:bold;font-size:13px;">
                    <i class="fas fa-plus"></i> New List
                </button>
            </div>

            <div style="display:grid;gap:10px;">
                ${savedLists.map(list => `
                    <div class="post-card" style="padding:18px;cursor:pointer;transition:transform 0.2s;" 
                         onclick="viewList(${list.id})"
                         onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='none'">
                        <div style="display:flex;justify-content:space-between;align-items:start;">
                            <div>
                                <h4 style="margin-bottom:4px;">${list.name} ${list.isPrivate ? '<i class="fas fa-lock" style="font-size:12px;color:var(--text-secondary);"></i>' : ''}</h4>
                                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">${list.description}</p>
                                <div style="display:flex;gap:5px;">
                                    ${list.members.slice(0, 3).map(mid => {
                                        const member = users.find(u => u.id === mid);
                                        return member ? `<img src="${member.avatar}" style="width:24px;height:24px;border-radius:50%;border:2px solid var(--bg-card);">` : '';
                                    }).join('')}
                                    ${list.members.length > 3 ? `<span style="font-size:12px;color:var(--text-secondary);padding-top:5px;">+${list.members.length - 3}</span>` : ''}
                                </div>
                            </div>
                            <span style="font-size:13px;color:var(--text-secondary);">${list.members.length} members</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function createNewList() {
    const name = prompt('Name your new list:');
    if (!name || !name.trim()) return;
    const desc = prompt('Add a description (optional):') || '';

    const savedLists = JSON.parse(localStorage.getItem('polleneer_lists_' + currentUser.id) || '[]');
    savedLists.push({
        id: Date.now(),
        name: name.trim(),
        description: desc.trim(),
        members: [],
        isPrivate: false
    });
    localStorage.setItem('polleneer_lists_' + currentUser.id, JSON.stringify(savedLists));
    showToast(`List "${name}" created! ðŸ“‹`);
    showLists();
}

function viewList(listId) {
    const savedLists = JSON.parse(localStorage.getItem('polleneer_lists_' + currentUser.id) || '[]');
    const list = savedLists.find(l => l.id === listId);
    if (!list) return;

    const memberUsers = list.members.map(mid => users.find(u => u.id === mid)).filter(Boolean);
    const memberPosts = posts.filter(p => list.members.includes(p.userId));

    document.getElementById('mainContent').innerHTML = `
        <div style="max-width:700px;margin:0 auto;">
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
                <button onclick="showLists()" style="background:none;border:none;color:var(--text-primary);cursor:pointer;font-size:1.2em;"><i class="fas fa-arrow-left"></i></button>
                <div>
                    <h3>${list.name}</h3>
                    <span style="font-size:13px;color:var(--text-secondary);">${list.members.length} members Â· ${memberPosts.length} posts</span>
                </div>
            </div>

            <div style="display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;padding-bottom:5px;">
                ${memberUsers.map(u => `
                    <div style="text-align:center;flex-shrink:0;cursor:pointer;" onclick="goToUserProfile(${u.id})">
                        <img src="${u.avatar}" style="width:45px;height:45px;border-radius:50%;border:2px solid var(--honey-yellow);">
                        <div style="font-size:11px;margin-top:3px;max-width:60px;overflow:hidden;text-overflow:ellipsis;">@${u.username}</div>
                    </div>
                `).join('')}
                <div style="text-align:center;flex-shrink:0;cursor:pointer;" onclick="addMemberToList(${list.id})">
                    <div style="width:45px;height:45px;border-radius:50%;border:2px dashed var(--border-color);display:flex;align-items:center;justify-content:center;color:var(--text-secondary);">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div style="font-size:11px;margin-top:3px;color:var(--text-secondary);">Add</div>
                </div>
            </div>

            <div>
                ${memberPosts.length > 0 ? memberPosts.map(p => createPostHTML(p)).join('') : 
                '<div class="post-card" style="padding:30px;text-align:center;color:var(--text-secondary);">No posts from list members yet.</div>'}
            </div>
        </div>
    `;
}

function addMemberToList(listId) {
    const username = prompt('Enter username to add:');
    if (!username) return;
    const user = users.find(u => u.username.toLowerCase() === username.toLowerCase().replace('@', ''));
    if (!user) { showToast('User not found'); return; }

    const savedLists = JSON.parse(localStorage.getItem('polleneer_lists_' + currentUser.id) || '[]');
    const list = savedLists.find(l => l.id === listId);
    if (!list) return;

    if (list.members.includes(user.id)) { showToast('User already in list'); return; }
    list.members.push(user.id);
    localStorage.setItem('polleneer_lists_' + currentUser.id, JSON.stringify(savedLists));
    showToast(`Added @${user.username} to "${list.name}" ðŸ`);
    viewList(listId);
}

// ===== DIRECT MESSAGES SYSTEM (FULL) =====

// =============================================
// DIRECT MESSAGES SYSTEM â€” FULL IMPLEMENTATION
// =============================================

// --- DM Data Model & Persistence ---
var dmData = JSON.parse(localStorage.getItem('polleneer_dm_data') || 'null') || {
    conversations: {},
    messageRequests: [],
    archivedConvIds: [],
    version: 1
};

function saveDMData() {
    localStorage.setItem('polleneer_dm_data', JSON.stringify(dmData));
}

function dmGenerateId() {
    return 'dm_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 6);
}

function dmGetConversation(userId) {
    return Object.values(dmData.conversations).find(c => c.participantId === userId);
}

function dmGetOrCreateConversation(userId) {
    var existing = dmGetConversation(userId);
    if (existing) return existing;
    var user = users.find(function(u) { return u.id === userId; });
    if (!user) return null;
    var convId = dmGenerateId();
    dmData.conversations[convId] = {
        id: convId,
        participantId: userId,
        messages: [],
        pinned: false,
        muted: false,
        unreadCount: 0,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };
    saveDMData();
    return dmData.conversations[convId];
}

function dmAddMessage(convId, text, opts) {
    opts = opts || {};
    var conv = dmData.conversations[convId];
    if (!conv) return null;
    var msg = {
        id: dmGenerateId(),
        from: opts.from || 'me',
        text: text,
        time: new Date().toISOString(),
        status: opts.from === 'me' ? 'sent' : 'delivered',
        replyTo: opts.replyTo || null,
        image: opts.image || null,
        reactions: {},
        edited: false,
        deleted: false
    };
    conv.messages.push(msg);
    conv.updatedAt = new Date().toISOString();
    if (msg.from !== 'me') {
        conv.unreadCount = (conv.unreadCount || 0) + 1;
    }
    saveDMData();
    return msg;
}

function dmMarkRead(convId) {
    var conv = dmData.conversations[convId];
    if (!conv) return;
    conv.unreadCount = 0;
    conv.messages.forEach(function(m) {
        if (m.from !== 'me' && m.status !== 'read') m.status = 'read';
    });
    saveDMData();
    dmUpdateGlobalBadge();
}

function dmDeleteMessage(convId, msgId) {
    var conv = dmData.conversations[convId];
    if (!conv) return;
    var msg = conv.messages.find(function(m) { return m.id === msgId; });
    if (msg) {
        msg.deleted = true;
        msg.text = '';
        msg.image = null;
        saveDMData();
    }
}

function dmEditMessage(convId, msgId, newText) {
    var conv = dmData.conversations[convId];
    if (!conv) return;
    var msg = conv.messages.find(function(m) { return m.id === msgId; });
    if (msg && msg.from === 'me' && !msg.deleted) {
        msg.text = newText;
        msg.edited = true;
        saveDMData();
    }
}

function dmToggleReaction(convId, msgId, emoji) {
    var conv = dmData.conversations[convId];
    if (!conv) return;
    var msg = conv.messages.find(function(m) { return m.id === msgId; });
    if (!msg || msg.deleted) return;
    if (!msg.reactions) msg.reactions = {};
    if (msg.reactions[emoji]) {
        delete msg.reactions[emoji];
    } else {
        msg.reactions[emoji] = 'me';
    }
    saveDMData();
}

function dmTogglePin(convId) {
    var conv = dmData.conversations[convId];
    if (!conv) return;
    conv.pinned = !conv.pinned;
    saveDMData();
}

function dmToggleMute(convId) {
    var conv = dmData.conversations[convId];
    if (!conv) return;
    conv.muted = !conv.muted;
    saveDMData();
}

function dmArchiveConversation(convId) {
    if (!dmData.archivedConvIds.includes(convId)) {
        dmData.archivedConvIds.push(convId);
    }
    saveDMData();
}

function dmUnarchiveConversation(convId) {
    dmData.archivedConvIds = dmData.archivedConvIds.filter(function(id) { return id !== convId; });
    saveDMData();
}

function dmDeleteConversation(convId) {
    delete dmData.conversations[convId];
    dmData.archivedConvIds = dmData.archivedConvIds.filter(function(id) { return id !== convId; });
    saveDMData();
}

function dmGetSortedConversations(tab) {
    var convs = Object.values(dmData.conversations);
    if (tab === 'archive') {
        convs = convs.filter(function(c) { return dmData.archivedConvIds.includes(c.id); });
    } else {
        convs = convs.filter(function(c) { return !dmData.archivedConvIds.includes(c.id); });
    }
    // Pinned first, then by updatedAt
    convs.sort(function(a, b) {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return new Date(b.updatedAt) - new Date(a.updatedAt);
    });
    return convs;
}

function dmGetTotalUnread() {
    return Object.values(dmData.conversations).reduce(function(sum, c) {
        if (dmData.archivedConvIds.includes(c.id)) return sum;
        return sum + (c.unreadCount || 0);
    }, 0);
}

function dmUpdateGlobalBadge() {
    var total = dmGetTotalUnread();
    var badges = ['messageBadge', 'sidebarMessageBadge'];
    badges.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
            el.textContent = total;
            el.style.display = total > 0 ? '' : 'none';
        }
    });
}

function dmFormatTime(isoStr) {
    var d = new Date(isoStr);
    var now = new Date();
    var diffMs = now - d;
    var diffMin = Math.floor(diffMs / 60000);
    if (diffMin < 1) return 'Just now';
    if (diffMin < 60) return diffMin + 'm ago';
    var diffHr = Math.floor(diffMin / 60);
    if (diffHr < 24) return diffHr + 'h ago';
    var diffDay = Math.floor(diffHr / 24);
    if (diffDay < 7) return diffDay + 'd ago';
    return d.toLocaleDateString();
}

function dmFormatChatTime(isoStr) {
    var d = new Date(isoStr);
    var h = d.getHours();
    var m = d.getMinutes();
    var ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return h + ':' + (m < 10 ? '0' : '') + m + ' ' + ampm;
}

function dmFormatDateSep(isoStr) {
    var d = new Date(isoStr);
    var now = new Date();
    var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    var msgDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    var diffDays = Math.round((today - msgDate) / 86400000);
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return d.toLocaleDateString(undefined, { weekday: 'long' });
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: d.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
}

// Seed sample conversations on first load
function dmSeedSampleData() {
    if (Object.keys(dmData.conversations).length > 0) return;
    var sampleConvs = [
        { userId: 2, messages: [
            { from: 'them', text: 'Hey! Loved your garden post! The cross-pollination idea is brilliant \ud83c\udf38', ago: 600000 },
            { from: 'me', text: 'Thanks! Been thinking about how bee behavior can inspire social platform design.', ago: 480000 },
            { from: 'them', text: 'That\'s exactly what makes Polleneer special. The pollination metaphor is so natural.', ago: 300000 },
            { from: 'me', text: 'Right? Every interaction should feel like a flower visit \ud83c\udf38', ago: 180000 },
            { from: 'them', text: 'Would love to collaborate on some ideas! Maybe we can create a hive together?', ago: 60000 },
            { from: 'them', text: 'Also check out this new hexagonal design pattern I found!', ago: 30000 }
        ]},
        { userId: 3, messages: [
            { from: 'them', text: 'Can we collaborate on that algorithm? I have some ideas for the swarm optimization', ago: 3600000 },
            { from: 'me', text: 'Absolutely! Send me what you have and I\'ll review it.', ago: 3000000 },
            { from: 'them', text: 'Sent! Let me know your thoughts on the clustering approach.', ago: 2400000 }
        ]},
        { userId: 4, messages: [
            { from: 'them', text: 'The bee colony simulation results are fascinating!', ago: 10800000 },
            { from: 'me', text: 'I know! The emergent behavior patterns are exactly what we need.', ago: 9000000 }
        ]},
        { userId: 5, messages: [
            { from: 'them', text: 'I designed a new hexagonal logo concept for Polleneer \ud83c\udfa8', ago: 86400000 },
            { from: 'me', text: 'That looks incredible! Can you make the honeycombs glow?', ago: 82800000 },
            { from: 'them', text: 'Already on it! \u2728', ago: 79200000 }
        ]}
    ];

    sampleConvs.forEach(function(sc) {
        var conv = dmGetOrCreateConversation(sc.userId);
        if (!conv) return;
        sc.messages.forEach(function(m) {
            var msg = {
                id: dmGenerateId(),
                from: m.from,
                text: m.text,
                time: new Date(Date.now() - m.ago).toISOString(),
                status: m.from === 'me' ? 'read' : 'read',
                replyTo: null,
                image: null,
                reactions: {},
                edited: false,
                deleted: false
            };
            conv.messages.push(msg);
        });
        conv.updatedAt = conv.messages[conv.messages.length - 1].time;
        // Give first conv unread messages
        if (sc.userId === 2) {
            conv.unreadCount = 2;
            conv.messages[conv.messages.length - 1].status = 'delivered';
            conv.messages[conv.messages.length - 2].status = 'delivered';
        }
        if (sc.userId === 3) conv.unreadCount = 1;
    });
    saveDMData();
}

// --- DM Active state ---
var dmActiveConvId = null;
var dmActiveTab = 'inbox';
var dmReplyToMsg = null;
var dmEditingMsg = null;
var dmPendingImage = null;
var dmSearchOpen = false;
var dmSearchMatches = [];
var dmSearchIdx = -1;


// --- Conversation List View ---
function showMessages(tab) {
    if (!currentUser) return;
    currentPage = 'messages';
    dmActiveConvId = null;
    dmActiveTab = tab || dmActiveTab || 'inbox';

    dmSeedSampleData();
    dmUpdateGlobalBadge();

    var convs = dmGetSortedConversations(dmActiveTab === 'archive' ? 'archive' : 'inbox');
    var totalUnread = dmGetTotalUnread();

    var convListHTML = '';
    if (convs.length === 0) {
        var emptyIcon = dmActiveTab === 'archive' ? 'fa-archive' : 'fa-envelope-open';
        var emptyTitle = dmActiveTab === 'archive' ? 'No archived messages' : 'No messages yet';
        var emptyDesc = dmActiveTab === 'archive' ? 'Archived conversations will appear here.' : 'Start a conversation â€” tap the New button above.';
        convListHTML = '<div class="dm-empty"><i class="fas ' + emptyIcon + '"></i><h4>' + emptyTitle + '</h4><p>' + emptyDesc + '</p></div>';
    } else {
        convListHTML = '<div style="display:grid;gap:2px;" id="dmConvList">';
        convs.forEach(function(conv) {
            var user = users.find(function(u) { return u.id === conv.participantId; });
            if (!user) return;
            var lastMsg = conv.messages.length > 0 ? conv.messages[conv.messages.length - 1] : null;
            var preview = lastMsg ? (lastMsg.deleted ? 'This message was deleted' : (lastMsg.image && !lastMsg.text ? '\ud83d\uddbc\ufe0f Photo' : lastMsg.text)) : 'No messages yet';
            if (lastMsg && lastMsg.from === 'me') preview = 'You: ' + preview;
            var timeStr = lastMsg ? dmFormatTime(lastMsg.time) : '';
            var status = getUserStatus(user);
            var statusClass = status.status;

            var icons = '';
            if (conv.pinned) icons += '<i class="fas fa-thumbtack dm-conv-pin"></i>';
            if (conv.muted) icons += '<i class="fas fa-bell-slash dm-conv-mute"></i>';

            convListHTML += '<div class="dm-conv-card post-card' + (conv.unreadCount > 0 ? ' unread' : '') + (conv.pinned ? ' pinned' : '') + '" ' +
                'onclick="openConversation(\'' + conv.id + '\')" ' +
                'oncontextmenu="dmShowContextMenu(event, \'' + conv.id + '\')">' +
                '<div class="dm-conv-avatar-wrap">' +
                    '<img src="' + user.avatar + '" alt="' + (user.displayName || user.username) + '" class="dm-conv-avatar">' +
                    '<div class="dm-conv-status ' + statusClass + '"></div>' +
                '</div>' +
                '<div class="dm-conv-body">' +
                    '<div class="dm-conv-top">' +
                        '<strong class="dm-conv-name">' + (user.displayName || user.username) + '</strong>' +
                        '<div style="display:flex;align-items:center;gap:6px;">' +
                            '<div class="dm-conv-icons">' + icons + '</div>' +
                            '<span class="dm-conv-time">' + timeStr + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div style="display:flex;align-items:center;gap:8px;">' +
                        '<div class="dm-conv-preview" style="flex:1;">' + preview + '</div>' +
                        (conv.unreadCount > 0 ? '<div class="dm-conv-unread-badge">' + conv.unreadCount + '</div>' : '') +
                    '</div>' +
                '</div>' +
            '</div>';
        });
        convListHTML += '</div>';
    }

    var archiveCount = dmData.archivedConvIds.length;

    document.getElementById('mainContent').innerHTML =
        '<div class="dm-list-container">' +
            '<div class="dm-header">' +
                '<h3><i class="fas fa-envelope"></i> Messages</h3>' +
                '<button class="dm-new-btn" onclick="newDirectMessage()"><i class="fas fa-pen"></i> New</button>' +
            '</div>' +
            '<div class="dm-tabs">' +
                '<button class="dm-tab' + (dmActiveTab === 'inbox' ? ' active' : '') + '" onclick="showMessages(\'inbox\')">Inbox' + (totalUnread > 0 ? ' <span class="tab-badge">' + totalUnread + '</span>' : '') + '</button>' +
                '<button class="dm-tab' + (dmActiveTab === 'requests' ? ' active' : '') + '" onclick="showMessages(\'requests\')">Requests</button>' +
                '<button class="dm-tab' + (dmActiveTab === 'archive' ? ' active' : '') + '" onclick="showMessages(\'archive\')">Archive' + (archiveCount > 0 ? ' <span class="tab-badge">' + archiveCount + '</span>' : '') + '</button>' +
            '</div>' +
            '<div class="dm-search"><i class="fas fa-search"></i><input type="text" id="dmListSearch" placeholder="Search conversations..." oninput="dmFilterConversations(this.value)"></div>' +
            convListHTML +
        '</div>';

    updateActiveNavLink('messages');
}

function dmFilterConversations(query) {
    query = query.toLowerCase().trim();
    var cards = document.querySelectorAll('.dm-conv-card');
    cards.forEach(function(card) {
        var name = card.querySelector('.dm-conv-name');
        var preview = card.querySelector('.dm-conv-preview');
        var text = (name ? name.textContent : '') + ' ' + (preview ? preview.textContent : '');
        card.style.display = text.toLowerCase().includes(query) ? '' : 'none';
    });
}

// --- Context Menu ---
var dmContextMenuConvId = null;

function dmShowContextMenu(e, convId) {
    e.preventDefault();
    e.stopPropagation();
    dmContextMenuConvId = convId;
    var conv = dmData.conversations[convId];
    if (!conv) return;
    var isArchived = dmData.archivedConvIds.includes(convId);

    var menuEl = document.getElementById('dmContextMenu');
    if (!menuEl) {
        menuEl = document.createElement('div');
        menuEl.id = 'dmContextMenu';
        menuEl.className = 'dm-context-menu';
        document.body.appendChild(menuEl);
    }

    menuEl.innerHTML =
        '<button class="dm-context-item" onclick="dmContextAction(\'pin\')"><i class="fas fa-thumbtack"></i> ' + (conv.pinned ? 'Unpin' : 'Pin') + '</button>' +
        '<button class="dm-context-item" onclick="dmContextAction(\'mute\')"><i class="fas fa-bell-slash"></i> ' + (conv.muted ? 'Unmute' : 'Mute') + '</button>' +
        '<button class="dm-context-item" onclick="dmContextAction(\'markread\')"><i class="fas fa-check-double"></i> Mark as read</button>' +
        '<button class="dm-context-item" onclick="dmContextAction(\'' + (isArchived ? 'unarchive' : 'archive') + '\')"><i class="fas fa-archive"></i> ' + (isArchived ? 'Unarchive' : 'Archive') + '</button>' +
        '<button class="dm-context-item danger" onclick="dmContextAction(\'delete\')"><i class="fas fa-trash"></i> Delete conversation</button>';

    menuEl.style.left = Math.min(e.clientX, window.innerWidth - 200) + 'px';
    menuEl.style.top = Math.min(e.clientY, window.innerHeight - 250) + 'px';
    menuEl.classList.add('show');

    setTimeout(function() {
        document.addEventListener('click', dmHideContextMenu);
    }, 10);
}

function dmHideContextMenu() {
    var m = document.getElementById('dmContextMenu');
    if (m) m.classList.remove('show');
    document.removeEventListener('click', dmHideContextMenu);
}

function dmContextAction(action) {
    dmHideContextMenu();
    var convId = dmContextMenuConvId;
    if (!convId) return;
    switch (action) {
        case 'pin': dmTogglePin(convId); break;
        case 'mute': dmToggleMute(convId); break;
        case 'markread': dmMarkRead(convId); break;
        case 'archive': dmArchiveConversation(convId); break;
        case 'unarchive': dmUnarchiveConversation(convId); break;
        case 'delete':
            if (confirm('Delete this conversation? This cannot be undone.')) {
                dmDeleteConversation(convId);
            }
            break;
    }
    showMessages(dmActiveTab);
}

// --- New DM Modal ---
function newDirectMessage() {
    var existingOverlay = document.getElementById('dmNewModalOverlay');
    if (existingOverlay) existingOverlay.remove();

    var userItems = '';
    // Recent conversations first, then all users
    var recentIds = dmGetSortedConversations('inbox').map(function(c) { return c.participantId; }).slice(0, 5);
    var allUsers = users.filter(function(u) { return u.id !== currentUser.id; });
    // Sort: recent first
    allUsers.sort(function(a, b) {
        var aIdx = recentIds.indexOf(a.id);
        var bIdx = recentIds.indexOf(b.id);
        if (aIdx >= 0 && bIdx < 0) return -1;
        if (aIdx < 0 && bIdx >= 0) return 1;
        if (aIdx >= 0 && bIdx >= 0) return aIdx - bIdx;
        return 0;
    });

    allUsers.forEach(function(u) {
        var isRecent = recentIds.includes(u.id);
        userItems += '<div class="dm-new-user-item" onclick="dmStartConversation(' + u.id + ')">' +
            '<img src="' + u.avatar + '" alt="' + (u.displayName || u.username) + '">' +
            '<div>' +
                '<div class="user-name">' + (u.displayName || u.username) + (isRecent ? ' <span style="font-size:11px;color:var(--text-secondary);font-weight:normal;">\u00b7 Recent</span>' : '') + '</div>' +
                '<div class="user-handle">@' + u.username + '</div>' +
            '</div>' +
        '</div>';
    });

    var overlay = document.createElement('div');
    overlay.id = 'dmNewModalOverlay';
    overlay.className = 'dm-new-modal-overlay show';
    overlay.innerHTML =
        '<div class="dm-new-modal">' +
            '<div class="dm-new-modal-header">' +
                '<h4>New Message</h4>' +
                '<button class="dm-new-modal-close" onclick="dmCloseNewModal()"><i class="fas fa-times"></i></button>' +
            '</div>' +
            '<div class="dm-new-modal-search">' +
                '<input type="text" id="dmNewSearch" placeholder="Search people..." oninput="dmFilterNewUsers(this.value)" autofocus>' +
            '</div>' +
            '<div class="dm-new-modal-list" id="dmNewUserList">' + userItems + '</div>' +
        '</div>';
    overlay.addEventListener('click', function(e) { if (e.target === overlay) dmCloseNewModal(); });
    document.body.appendChild(overlay);
    setTimeout(function() { var inp = document.getElementById('dmNewSearch'); if (inp) inp.focus(); }, 100);
}

function dmCloseNewModal() {
    var el = document.getElementById('dmNewModalOverlay');
    if (el) el.remove();
}

function dmFilterNewUsers(query) {
    query = query.toLowerCase().trim();
    var items = document.querySelectorAll('.dm-new-user-item');
    items.forEach(function(item) {
        var text = item.textContent.toLowerCase();
        item.style.display = text.includes(query) ? '' : 'none';
    });
}

function dmStartConversation(userId) {
    dmCloseNewModal();
    var conv = dmGetOrCreateConversation(userId);
    if (conv) openConversation(conv.id);
}


// --- Chat View ---
function openConversation(convId) {
    var conv = dmData.conversations[convId];
    if (!conv) return;
    dmActiveConvId = convId;
    dmReplyToMsg = null;
    dmEditingMsg = null;
    dmPendingImage = null;
    dmSearchOpen = false;

    dmMarkRead(convId);

    var user = users.find(function(u) { return u.id === conv.participantId; });
    if (!user) return;
    var status = getUserStatus(user);

    var statusDotClass = status.status;
    var statusText = status.status === 'online' ? 'Online' : (status.status === 'away' ? 'Away' : status.tooltip || 'Offline');

    document.getElementById('mainContent').innerHTML =
        '<div class="dm-container" id="dmChatContainer">' +
            '<!-- Header -->' +
            '<div class="dm-chat-header">' +
                '<button class="dm-back-btn" onclick="showMessages()"><i class="fas fa-arrow-left"></i></button>' +
                '<img src="' + user.avatar + '" style="width:40px;height:40px;border-radius:50%;cursor:pointer;" onclick="goToUserProfile(' + user.id + ')">' +
                '<div class="dm-chat-user-info" onclick="goToUserProfile(' + user.id + ')">' +
                    '<strong>' + (user.displayName || user.username) + '</strong>' +
                    '<div class="dm-chat-user-status"><span class="online-dot ' + statusDotClass + '"></span> ' + statusText + '</div>' +
                '</div>' +
                '<div class="dm-chat-header-actions">' +
                    '<button class="dm-chat-header-btn" onclick="dmToggleChatSearch()" title="Search"><i class="fas fa-search"></i></button>' +
                    '<button class="dm-chat-header-btn" onclick="dmShowInfoPanel(\'' + convId + '\')" title="Info"><i class="fas fa-info-circle"></i></button>' +
                '</div>' +
            '</div>' +
            '<!-- Search bar -->' +
            '<div class="dm-search-bar" id="dmChatSearchBar">' +
                '<input type="text" id="dmChatSearchInput" placeholder="Search in conversation..." oninput="dmSearchInConversation(this.value)">' +
                '<div class="search-nav" id="dmSearchNav"><span id="dmSearchCount"></span>' +
                    '<button onclick="dmSearchPrev()"><i class="fas fa-chevron-up"></i></button>' +
                    '<button onclick="dmSearchNext()"><i class="fas fa-chevron-down"></i></button>' +
                '</div>' +
                '<button class="search-close" onclick="dmToggleChatSearch()"><i class="fas fa-times"></i></button>' +
            '</div>' +
            '<!-- Messages -->' +
            '<div class="dm-messages" id="dmMessages" onscroll="dmHandleScroll()">' +
                dmRenderMessages(conv) +
                '<div class="dm-typing-indicator" id="dmTypingIndicator">' +
                    '<div class="dm-typing-dots"><span></span><span></span><span></span></div>' +
                '</div>' +
            '</div>' +
            '<!-- Scroll to bottom -->' +
            '<button class="dm-scroll-bottom" id="dmScrollBottom" onclick="dmScrollToBottom()"><i class="fas fa-chevron-down"></i></button>' +
            '<!-- Input Area -->' +
            '<div class="dm-input-area">' +
                '<div class="dm-image-preview" id="dmImagePreview"></div>' +
                '<div class="dm-reply-bar" id="dmReplyBar">' +
                    '<i class="fas fa-reply" style="color:var(--honey-yellow);"></i>' +
                    '<span class="reply-text" id="dmReplyText"></span>' +
                    '<button class="reply-close" onclick="dmCancelReply()"><i class="fas fa-times"></i></button>' +
                '</div>' +
                '<div class="dm-edit-bar" id="dmEditBar">' +
                    '<span class="edit-label">Editing</span>' +
                    '<span class="edit-text" id="dmEditText"></span>' +
                    '<button class="edit-close" onclick="dmCancelEdit()"><i class="fas fa-times"></i></button>' +
                '</div>' +
                '<div class="dm-input-row">' +
                    '<div class="dm-attach-btns">' +
                        '<button class="dm-attach-btn" onclick="dmAttachImage()" title="Image"><i class="fas fa-image"></i></button>' +
                        '<button class="dm-attach-btn" onclick="window._emojiTarget=\'dmTextInput\';showStickerPicker()" title="Sticker"><i class="fas fa-note-sticky"></i></button>' +
                        '<button class="dm-attach-btn" onclick="dmShowEmojiForChat()" title="Emoji"><i class="fas fa-face-smile"></i></button>' +
                    '</div>' +
                    '<input type="text" class="dm-text-input" id="dmTextInput" placeholder="Send a message..." ' +
                        'onkeydown="dmHandleKeydown(event)" oninput="dmHandleInput()">' +
                    '<input type="file" id="dmFileInput" accept="image/*" style="display:none;" onchange="dmHandleFileSelect(event)">' +
                    '<button class="dm-send-btn" id="dmSendBtn" onclick="sendDM()" disabled><i class="fas fa-paper-plane"></i></button>' +
                '</div>' +
            '</div>' +
        '</div>';

    dmScrollToBottom();
}

function dmRenderMessages(conv) {
    if (conv.messages.length === 0) {
        var user = users.find(function(u) { return u.id === conv.participantId; });
        return '<div class="dm-empty" style="padding:40px 20px;"><i class="fas fa-comments"></i><h4>Start of conversation</h4><p>Say hello to ' + (user ? user.displayName || user.username : 'this user') + '!</p></div>';
    }

    var html = '';
    var lastDate = '';
    var lastFrom = '';

    conv.messages.forEach(function(msg, idx) {
        // Date separator
        var msgDate = dmFormatDateSep(msg.time);
        if (msgDate !== lastDate) {
            html += '<div class="dm-date-sep"><span>' + msgDate + '</span></div>';
            lastDate = msgDate;
            lastFrom = '';
        }

        var isGrouped = msg.from === lastFrom && idx > 0 && !conv.messages[idx-1].deleted;
        var rowClass = 'dm-msg-row ' + (msg.from === 'me' ? 'sent' : 'received') + (isGrouped ? ' grouped' : '');

        if (msg.deleted) {
            html += '<div class="' + rowClass + '" data-msg-id="' + msg.id + '">' +
                '<div class="dm-msg-bubble"><div class="dm-msg-deleted"><i class="fas fa-ban"></i> This message was deleted</div></div>' +
            '</div>';
            lastFrom = msg.from;
            return;
        }

        var replyQuote = '';
        if (msg.replyTo) {
            var replied = conv.messages.find(function(m) { return m.id === msg.replyTo; });
            if (replied && !replied.deleted) {
                replyQuote = '<div class="dm-msg-reply-quote" onclick="dmScrollToMessage(\'' + replied.id + '\')">' +
                    '<strong style="font-size:11px;">' + (replied.from === 'me' ? 'You' : (users.find(function(u){return u.id===conv.participantId;})?.displayName || 'User')) + '</strong><br>' +
                    replied.text.substring(0, 60) + (replied.text.length > 60 ? '...' : '') +
                '</div>';
            }
        }

        var imageHtml = '';
        if (msg.image) {
            imageHtml = '<img src="' + msg.image + '" class="dm-msg-image" onclick="viewMedia(\'' + msg.image + '\')">';
        }

        var reactionsHtml = '';
        if (msg.reactions && Object.keys(msg.reactions).length > 0) {
            reactionsHtml = '<div class="dm-msg-reactions">';
            Object.keys(msg.reactions).forEach(function(emoji) {
                reactionsHtml += '<span class="dm-msg-reaction" onclick="dmToggleReaction(\'' + conv.id + '\', \'' + msg.id + '\', \'' + emoji + '\'); dmRefreshChat();">' + emoji + '</span>';
            });
            reactionsHtml += '</div>';
        }

        var checkHtml = '';
        if (msg.from === 'me') {
            if (msg.status === 'sent') checkHtml = '<i class="fas fa-check dm-check sent"></i>';
            else if (msg.status === 'delivered') checkHtml = '<i class="fas fa-check-double dm-check delivered"></i>';
            else if (msg.status === 'read') checkHtml = '<i class="fas fa-check-double dm-check read"></i>';
        }

        var editedHtml = msg.edited ? '<span class="dm-msg-edited">(edited)</span>' : '';

        // Hover actions
        var actionsHtml = '<div class="dm-msg-actions">' +
            '<button class="dm-msg-action-btn" onclick="event.stopPropagation(); dmStartReply(\'' + msg.id + '\')" title="Reply"><i class="fas fa-reply"></i></button>' +
            '<button class="dm-msg-action-btn" onclick="event.stopPropagation(); dmShowReactionPicker(\'' + msg.id + '\')" title="React"><i class="fas fa-face-smile"></i></button>';
        if (msg.from === 'me') {
            actionsHtml += '<button class="dm-msg-action-btn" onclick="event.stopPropagation(); dmStartEdit(\'' + msg.id + '\')" title="Edit"><i class="fas fa-pen"></i></button>';
        }
        actionsHtml += '<button class="dm-msg-action-btn" onclick="event.stopPropagation(); dmDeleteMsgUI(\'' + msg.id + '\')" title="Delete"><i class="fas fa-trash"></i></button>' +
        '</div>';

        html += '<div class="' + rowClass + '" data-msg-id="' + msg.id + '">' +
            actionsHtml +
            '<div class="dm-msg-bubble">' +
                replyQuote +
                imageHtml +
                (msg.text ? '<div style="line-height:1.45;">' + dmFormatMsgText(msg.text) + editedHtml + '</div>' : '') +
                '<div class="dm-msg-meta">' + dmFormatChatTime(msg.time) + ' ' + checkHtml + '</div>' +
                reactionsHtml +
            '</div>' +
        '</div>';

        lastFrom = msg.from;
    });

    return html;
}

function dmFormatMsgText(text) {
    // Escape HTML, then format links, bold, italic
    text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    // URLs
    text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:inherit;text-decoration:underline;">$1</a>');
    // Bold **text**
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    // Italic *text*
    text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
    return text;
}

function dmRefreshChat() {
    if (!dmActiveConvId) return;
    var conv = dmData.conversations[dmActiveConvId];
    if (!conv) return;
    var container = document.getElementById('dmMessages');
    if (!container) return;
    var wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50;
    var typingEl = document.getElementById('dmTypingIndicator');
    var typingClass = typingEl ? typingEl.className : 'dm-typing-indicator';
    container.innerHTML = dmRenderMessages(conv) +
        '<div class="dm-typing-indicator" id="dmTypingIndicator" class="' + typingClass + '">' +
            '<div class="dm-typing-dots"><span></span><span></span><span></span></div>' +
        '</div>';
    if (wasAtBottom) dmScrollToBottom();
}

function dmScrollToBottom() {
    setTimeout(function() {
        var el = document.getElementById('dmMessages');
        if (el) el.scrollTop = el.scrollHeight;
    }, 50);
}

function dmScrollToMessage(msgId) {
    var el = document.querySelector('[data-msg-id="' + msgId + '"]');
    if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.querySelector('.dm-msg-bubble').classList.add('dm-msg-highlight');
        setTimeout(function() {
            el.querySelector('.dm-msg-bubble').classList.remove('dm-msg-highlight');
        }, 2000);
    }
}

function dmHandleScroll() {
    var el = document.getElementById('dmMessages');
    var fab = document.getElementById('dmScrollBottom');
    if (!el || !fab) return;
    var atBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 100;
    fab.classList.toggle('show', !atBottom);
}


// --- Send Message ---
function sendDM() {
    var input = document.getElementById('dmTextInput');
    var text = input ? input.value.trim() : '';
    var image = dmPendingImage;

    if (!text && !image) return;
    if (!dmActiveConvId) return;

    if (dmEditingMsg) {
        // Editing existing message
        dmEditMessage(dmActiveConvId, dmEditingMsg.id, text);
        dmCancelEdit();
        dmRefreshChat();
        input.value = '';
        dmUpdateSendBtn();
        return;
    }

    var opts = { from: 'me' };
    if (dmReplyToMsg) opts.replyTo = dmReplyToMsg.id;
    if (image) opts.image = image;

    dmAddMessage(dmActiveConvId, text, opts);
    input.value = '';
    dmPendingImage = null;
    dmCancelReply();
    dmHideImagePreview();
    dmUpdateSendBtn();
    dmRefreshChat();
    dmScrollToBottom();
    dmUpdateGlobalBadge();

    // Simulate read receipt after 1s and reply after 2-4s
    var convId = dmActiveConvId;
    setTimeout(function() {
        var conv = dmData.conversations[convId];
        if (!conv) return;
        var lastMsg = conv.messages.filter(function(m) { return m.from === 'me'; }).pop();
        if (lastMsg) { lastMsg.status = 'delivered'; saveDMData(); dmRefreshChat(); }
    }, 800);

    setTimeout(function() {
        var conv = dmData.conversations[convId];
        if (!conv) return;
        var lastMsg = conv.messages.filter(function(m) { return m.from === 'me'; }).pop();
        if (lastMsg) { lastMsg.status = 'read'; saveDMData(); dmRefreshChat(); }
    }, 1500);

    // Typing indicator + auto-reply
    setTimeout(function() {
        if (dmActiveConvId !== convId) return;
        var typing = document.getElementById('dmTypingIndicator');
        if (typing) typing.classList.add('show');
        dmScrollToBottom();
    }, 2000);

    var replyDelay = 3000 + Math.random() * 2000;
    setTimeout(function() {
        var typing = document.getElementById('dmTypingIndicator');
        if (typing) typing.classList.remove('show');

        var conv = dmData.conversations[convId];
        if (!conv) return;
        var replies = [
            'That sounds great! \ud83d\udc1d', 'Absolutely! Let\'s make it happen.',
            'Love that idea! \ud83c\udf6f', 'I\'m in! When should we start?',
            'Amazing, let me think about it! \u2728', 'Totally agree!',
            'That\'s a really interesting perspective \ud83d\ude4c', 'Can\'t wait to see how it turns out!',
            'You always have the best ideas \ud83d\udc9b', 'Let\'s do it! \ud83d\ude80'
        ];
        var reply = replies[Math.floor(Math.random() * replies.length)];
        dmAddMessage(convId, reply, { from: 'them' });

        if (dmActiveConvId === convId) {
            dmMarkRead(convId);
            dmRefreshChat();
            dmScrollToBottom();
        }
        dmUpdateGlobalBadge();
    }, replyDelay);
}

function dmHandleKeydown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendDM();
    }
    if (e.key === 'Escape') {
        if (dmEditingMsg) dmCancelEdit();
        else if (dmReplyToMsg) dmCancelReply();
    }
}

function dmHandleInput() {
    dmUpdateSendBtn();
}

function dmUpdateSendBtn() {
    var input = document.getElementById('dmTextInput');
    var btn = document.getElementById('dmSendBtn');
    if (!input || !btn) return;
    btn.disabled = !input.value.trim() && !dmPendingImage;
}

// --- Reply ---
function dmStartReply(msgId) {
    var conv = dmData.conversations[dmActiveConvId];
    if (!conv) return;
    var msg = conv.messages.find(function(m) { return m.id === msgId; });
    if (!msg || msg.deleted) return;
    dmReplyToMsg = msg;
    dmCancelEdit();
    var user = users.find(function(u) { return u.id === conv.participantId; });
    var name = msg.from === 'me' ? 'yourself' : (user ? user.displayName || user.username : 'User');
    var bar = document.getElementById('dmReplyBar');
    var text = document.getElementById('dmReplyText');
    if (bar) bar.classList.add('show');
    if (text) text.textContent = 'Replying to ' + name + ': ' + msg.text.substring(0, 50);
    document.getElementById('dmTextInput').focus();
}

function dmCancelReply() {
    dmReplyToMsg = null;
    var bar = document.getElementById('dmReplyBar');
    if (bar) bar.classList.remove('show');
}

// --- Edit ---
function dmStartEdit(msgId) {
    var conv = dmData.conversations[dmActiveConvId];
    if (!conv) return;
    var msg = conv.messages.find(function(m) { return m.id === msgId; });
    if (!msg || msg.deleted || msg.from !== 'me') return;
    dmEditingMsg = msg;
    dmCancelReply();
    var bar = document.getElementById('dmEditBar');
    var text = document.getElementById('dmEditText');
    if (bar) bar.classList.add('show');
    if (text) text.textContent = msg.text.substring(0, 50);
    var input = document.getElementById('dmTextInput');
    if (input) { input.value = msg.text; input.focus(); }
    dmUpdateSendBtn();
}

function dmCancelEdit() {
    dmEditingMsg = null;
    var bar = document.getElementById('dmEditBar');
    if (bar) bar.classList.remove('show');
    var input = document.getElementById('dmTextInput');
    if (input) input.value = '';
    dmUpdateSendBtn();
}

// --- Delete ---
function dmDeleteMsgUI(msgId) {
    if (!confirm('Delete this message?')) return;
    dmDeleteMessage(dmActiveConvId, msgId);
    dmRefreshChat();
}

// --- Reactions ---
function dmShowReactionPicker(msgId) {
    // Remove existing picker
    var existing = document.querySelector('.dm-reaction-picker.show');
    if (existing) existing.remove();

    var msgEl = document.querySelector('[data-msg-id="' + msgId + '"]');
    if (!msgEl) return;

    // Quick reactions â€” most popular, matching Instagram/X style
    var quickEmojis = ['\u2764\ufe0f', '\ud83d\ude02', '\ud83d\ude2e', '\ud83d\udc4d', '\ud83d\ude22', '\ud83d\udd25', '\ud83c\udf6f', '\ud83d\udc1d', '\ud83d\ude4c', '\ud83d\ude0d', '\ud83d\udc4f', '\ud83d\ude4f'];
    var picker = document.createElement('div');
    picker.className = 'dm-reaction-picker show';
    picker.style.cssText = 'position:absolute;top:-44px;display:flex;background:var(--bg-card);border:1px solid var(--border-color);border-radius:24px;padding:4px 6px;gap:2px;box-shadow:0 4px 16px rgba(0,0,0,0.35);z-index:100;align-items:center;';
    if (msgEl.classList.contains('sent')) {
        picker.style.right = '0';
    } else {
        picker.style.left = '0';
    }

    quickEmojis.forEach(function(emoji) {
        var btn = document.createElement('button');
        btn.style.cssText = 'font-size:20px;cursor:pointer;padding:4px 5px;border-radius:8px;transition:all 0.15s;border:none;background:none;line-height:1;';
        btn.textContent = emoji;
        btn.onmouseover = function() { this.style.transform = 'scale(1.3)'; this.style.background = 'var(--bg-input)'; };
        btn.onmouseout = function() { this.style.transform = 'scale(1)'; this.style.background = 'none'; };
        btn.onclick = function(e) {
            e.stopPropagation();
            dmToggleReaction(dmActiveConvId, msgId, emoji);
            picker.remove();
            dmRefreshChat();
        };
        picker.appendChild(btn);
    });

    // "More" button to open full emoji picker for reactions
    var moreBtn = document.createElement('button');
    moreBtn.style.cssText = 'font-size:14px;cursor:pointer;padding:4px 6px;border-radius:8px;transition:all 0.15s;border:none;background:none;color:var(--text-secondary);margin-left:2px;';
    moreBtn.innerHTML = '<i class="fas fa-plus"></i>';
    moreBtn.title = 'More emoji';
    moreBtn.onmouseover = function() { this.style.background = 'var(--bg-input)'; this.style.color = 'var(--honey-yellow)'; };
    moreBtn.onmouseout = function() { this.style.background = 'none'; this.style.color = 'var(--text-secondary)'; };
    moreBtn.onclick = function(e) {
        e.stopPropagation();
        picker.remove();
        dmShowFullReactionPicker(msgId);
    };
    picker.appendChild(moreBtn);

    msgEl.style.position = 'relative';
    msgEl.appendChild(picker);

    setTimeout(function() {
        document.addEventListener('click', function removePicker(ev) {
            if (picker.parentNode) picker.remove();
            document.removeEventListener('click', removePicker);
        });
    }, 10);
}

function dmShowFullReactionPicker(msgId) {
    // Open the full emoji picker but in "reaction mode"
    window._dmReactionMsgId = msgId;
    window._emojiInsertMode = 'reaction';
    showEmojiPicker();
}

// Override insertEmojiFromPicker to handle reaction mode
var _origInsertEmojiFromPicker = typeof insertEmojiFromPicker === 'function' ? insertEmojiFromPicker : null;


// --- Image Attachment ---
function dmAttachImage() {
    var input = document.getElementById('dmFileInput');
    if (input) input.click();
}

function dmHandleFileSelect(e) {
    var file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { showToast('Only images are supported'); return; }
    if (file.size > 5 * 1024 * 1024) { showToast('Image must be under 5MB'); return; }

    var reader = new FileReader();
    reader.onload = function(ev) {
        dmPendingImage = ev.target.result;
        dmShowImagePreview(dmPendingImage);
        dmUpdateSendBtn();
    };
    reader.readAsDataURL(file);
    e.target.value = '';
}

function dmShowImagePreview(src) {
    var container = document.getElementById('dmImagePreview');
    if (!container) return;
    container.innerHTML = '<img src="' + src + '"><button class="remove-btn" onclick="dmRemoveImage()"><i class="fas fa-times"></i></button>';
    container.classList.add('show');
}

function dmHideImagePreview() {
    var container = document.getElementById('dmImagePreview');
    if (container) { container.classList.remove('show'); container.innerHTML = ''; }
}

function dmRemoveImage() {
    dmPendingImage = null;
    dmHideImagePreview();
    dmUpdateSendBtn();
}

// --- Emoji for DM ---
function dmShowEmojiForChat() {
    window._emojiTarget = 'dmTextInput';
    if (typeof showEmojiPicker === 'function') showEmojiPicker();
    else if (typeof showEmojiPickerInline === 'function') showEmojiPickerInline();
}

// --- In-Conversation Search ---
function dmToggleChatSearch() {
    dmSearchOpen = !dmSearchOpen;
    var bar = document.getElementById('dmChatSearchBar');
    if (bar) bar.classList.toggle('show', dmSearchOpen);
    if (dmSearchOpen) {
        var inp = document.getElementById('dmChatSearchInput');
        if (inp) { inp.value = ''; inp.focus(); }
    } else {
        // Clear highlights
        document.querySelectorAll('.dm-msg-highlight').forEach(function(el) {
            el.classList.remove('dm-msg-highlight');
        });
        dmSearchMatches = [];
        dmSearchIdx = -1;
    }
}

function dmSearchInConversation(query) {
    query = query.toLowerCase().trim();
    dmSearchMatches = [];
    dmSearchIdx = -1;

    // Clear all highlights
    document.querySelectorAll('.dm-msg-highlight').forEach(function(el) {
        el.classList.remove('dm-msg-highlight');
    });

    if (!query) {
        document.getElementById('dmSearchCount').textContent = '';
        return;
    }

    var conv = dmData.conversations[dmActiveConvId];
    if (!conv) return;

    conv.messages.forEach(function(msg) {
        if (!msg.deleted && msg.text && msg.text.toLowerCase().includes(query)) {
            dmSearchMatches.push(msg.id);
        }
    });

    document.getElementById('dmSearchCount').textContent = dmSearchMatches.length > 0 ? '0/' + dmSearchMatches.length : 'No results';

    if (dmSearchMatches.length > 0) {
        dmSearchIdx = dmSearchMatches.length - 1;
        dmHighlightSearchResult();
    }
}

function dmSearchPrev() {
    if (dmSearchMatches.length === 0) return;
    dmSearchIdx = (dmSearchIdx - 1 + dmSearchMatches.length) % dmSearchMatches.length;
    dmHighlightSearchResult();
}

function dmSearchNext() {
    if (dmSearchMatches.length === 0) return;
    dmSearchIdx = (dmSearchIdx + 1) % dmSearchMatches.length;
    dmHighlightSearchResult();
}

function dmHighlightSearchResult() {
    document.querySelectorAll('.dm-msg-highlight').forEach(function(el) {
        el.classList.remove('dm-msg-highlight');
    });
    var msgId = dmSearchMatches[dmSearchIdx];
    var el = document.querySelector('[data-msg-id="' + msgId + '"] .dm-msg-bubble');
    if (el) {
        el.classList.add('dm-msg-highlight');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    document.getElementById('dmSearchCount').textContent = (dmSearchIdx + 1) + '/' + dmSearchMatches.length;
}

// --- Conversation Info Panel ---
function dmShowInfoPanel(convId) {
    var conv = dmData.conversations[convId];
    if (!conv) return;
    var user = users.find(function(u) { return u.id === conv.participantId; });
    if (!user) return;

    // Collect shared media
    var sharedMedia = conv.messages.filter(function(m) { return m.image && !m.deleted; });
    var mediaGrid = '';
    if (sharedMedia.length > 0) {
        mediaGrid = '<div class="dm-info-media-grid">';
        sharedMedia.slice(-9).forEach(function(m) {
            mediaGrid += '<img src="' + m.image + '" onclick="viewMedia(\'' + m.image + '\')">';
        });
        mediaGrid += '</div>';
    } else {
        mediaGrid = '<p style="color:var(--text-secondary);font-size:13px;">No shared media yet</p>';
    }

    var status = getUserStatus(user);

    // Remove existing panel
    var existing = document.getElementById('dmInfoPanel');
    if (existing) existing.remove();

    var panel = document.createElement('div');
    panel.id = 'dmInfoPanel';
    panel.className = 'dm-info-panel';
    panel.innerHTML =
        '<div class="dm-info-panel-header">' +
            '<strong>Conversation Info</strong>' +
            '<button class="dm-info-panel-close" onclick="dmCloseInfoPanel()"><i class="fas fa-times"></i></button>' +
        '</div>' +
        '<div class="dm-info-panel-body">' +
            '<div class="dm-info-user">' +
                '<img src="' + user.avatar + '">' +
                '<div><strong style="font-size:16px;">' + (user.displayName || user.username) + '</strong></div>' +
                '<div style="color:var(--text-secondary);font-size:13px;">@' + user.username + ' \u00b7 ' + status.label + '</div>' +
                '<div style="color:var(--text-secondary);font-size:12px;margin-top:4px;">' + (user.bio || '') + '</div>' +
            '</div>' +
            '<div class="dm-info-section">' +
                '<h5>Shared Media (' + sharedMedia.length + ')</h5>' +
                mediaGrid +
            '</div>' +
            '<div class="dm-info-section">' +
                '<h5>Actions</h5>' +
                '<button class="dm-info-action" onclick="dmToggleMute(\'' + convId + '\'); dmCloseInfoPanel(); showToast(\'Toggled mute\');"><i class="fas fa-bell-slash"></i> ' + (conv.muted ? 'Unmute' : 'Mute') + ' notifications</button>' +
                '<button class="dm-info-action" onclick="goToUserProfile(' + user.id + '); dmCloseInfoPanel();"><i class="fas fa-user"></i> View profile</button>' +
                '<button class="dm-info-action danger" onclick="if(confirm(\'Block this user?\')) { showToast(\'User blocked\'); dmCloseInfoPanel(); }"><i class="fas fa-ban"></i> Block user</button>' +
                '<button class="dm-info-action danger" onclick="if(confirm(\'Report this user?\')) { showToast(\'Report submitted\'); dmCloseInfoPanel(); }"><i class="fas fa-flag"></i> Report</button>' +
            '</div>' +
        '</div>';

    document.body.appendChild(panel);
    setTimeout(function() { panel.classList.add('show'); }, 10);

    // Close on overlay click
    var overlay = document.createElement('div');
    overlay.id = 'dmInfoOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;z-index:9996;';
    overlay.onclick = dmCloseInfoPanel;
    document.body.appendChild(overlay);
}

function dmCloseInfoPanel() {
    var panel = document.getElementById('dmInfoPanel');
    if (panel) { panel.classList.remove('show'); setTimeout(function() { panel.remove(); }, 300); }
    var overlay = document.getElementById('dmInfoOverlay');
    if (overlay) overlay.remove();
}

// Init DM on page load
(function() {
    dmSeedSampleData();
    dmUpdateGlobalBadge();
})();


// ===== CLEAN showCreatePostModal (buttons now in HTML template) =====
function showCreatePostModal() {
    if (!currentUser) { showToast('Please log in first!'); return; }
    const modalAvatar = document.getElementById('modalUserAvatar');
    if (modalAvatar) modalAvatar.src = currentUser.avatar;
    const postContent = document.getElementById('postContent');
    if (postContent) { postContent.textContent = ''; postContent.innerHTML = ''; }
    const mediaPreview = document.getElementById('mediaPreview');
    if (mediaPreview) { mediaPreview.style.display = 'none'; mediaPreview.innerHTML = ''; }
    const mediaContainer = document.getElementById('postMediaContainer');
    if (mediaContainer) mediaContainer.classList.add('hidden');
    const pollContainer = document.getElementById('postPollContainer');
    if (pollContainer) pollContainer.classList.add('hidden');
    const oldLocation = document.getElementById('postLocation');
    if (oldLocation) oldLocation.remove();
    openModal('createPostModal');
    if (postContent) postContent.focus();
}

// ===== ADD NAV LINKS FOR NEW FEATURES =====
// Override goToHome to add new nav buttons in sidebar
// goToHome sidebar injection handled via DOMContentLoaded + MutationObserver
// (removed _originalGoToHome override to prevent circular reference issues)

function injectSidebarExtras() {
    // Add Analytics and Lists to the sidebar if not present
    setTimeout(() => {
        const sidebar = document.querySelector('.left-sidebar nav, .sidebar-nav');
        if (sidebar && !document.getElementById('nav-analytics')) {
            // Find the communities nav item to insert after it
            const navItems = sidebar.querySelectorAll('a, .nav-link, [onclick]');
            const lastNavItem = navItems[navItems.length - 1];

            if (lastNavItem && lastNavItem.parentElement) {
                const analyticsLink = document.createElement('a');
                analyticsLink.id = 'nav-analytics';
                analyticsLink.href = '#';
                analyticsLink.className = lastNavItem.className;
                analyticsLink.onclick = function(e) { e.preventDefault(); showAnalytics(); };
                analyticsLink.innerHTML = '<i class="fas fa-chart-line"></i><span>Analytics</span>';
                lastNavItem.parentElement.insertBefore(analyticsLink, lastNavItem.nextSibling);

                const listsLink = document.createElement('a');
                listsLink.id = 'nav-lists';
                listsLink.href = '#';
                listsLink.className = lastNavItem.className;
                listsLink.onclick = function(e) { e.preventDefault(); showLists(); };
                listsLink.innerHTML = '<i class="fas fa-list"></i><span>Lists</span>';
                analyticsLink.parentElement.insertBefore(listsLink, analyticsLink.nextSibling);
            }
        }
    }, 500);
}

// Run sidebar injection on load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(injectSidebarExtras, 3000);
});

// ===== MAKE TRENDING TOPICS CLICKABLE =====
function loadTrendingTopics() {
    const trendingList = document.getElementById('trendingList');
    if (!trendingList) return;

    trendingList.innerHTML = TRENDING_TOPICS.map(topic => `
        <li class="trend-item" onclick="searchTag('${topic.tag}')" style="cursor:pointer;padding:12px;border-radius:10px;transition:background 0.2s;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''">
            <div class="trend-category" style="font-size:12px;color:var(--text-secondary);">${topic.category} Â· Trending</div>
            <div class="trend-tag" style="font-weight:bold;margin:3px 0;">${topic.tag}</div>
            <div class="trend-stats" style="font-size:12px;color:var(--text-secondary);">${topic.posts} posts</div>
        </li>
    `).join('');
}

// ===== UPDATE goToCommunities TO USE JOIN/LEAVE TOGGLE =====
function goToCommunities() {
    currentPage = 'communities';
    const joinedHives = JSON.parse(localStorage.getItem('polleneer_joined_hives') || '[]');

    const communities = [
        { name: 'Art Collective', members: '3.7k', icon: 'A', color: '#FF69B4', desc: 'For visual artists, digital creators, and art lovers' },
        { name: 'Tech Innovators', members: '4.2k', icon: 'T', color: '#87CEEB', desc: 'Cutting-edge tech discussions and innovation' },
        { name: 'Music Lovers', members: '5.1k', icon: 'M', color: '#9370DB', desc: 'Share and discover amazing music' },
        { name: 'Food & Travel', members: '2.9k', icon: 'F', color: '#FF8C00', desc: 'Foodie adventures and travel stories' },
        { name: 'Gaming Hive', members: '6.3k', icon: 'G', color: '#228B22', desc: 'Gamers unite! Reviews, streams, and esports' },
        { name: 'Science & Nature', members: '3.1k', icon: 'S', color: '#FFC30B', desc: 'Explore the wonders of the natural world' },
    ];

    document.getElementById('mainContent').innerHTML = `
        <div class="customization-panel" style="max-width:700px;margin:0 auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="color:var(--honey-yellow);"><i class="fas fa-users"></i> Communities</h3>
                <button onclick="createCommunity()" style="background:var(--honey-yellow);color:#000;border:none;padding:8px 18px;border-radius:20px;cursor:pointer;font-weight:bold;font-size:13px;">
                    <i class="fas fa-plus"></i> Create Hive
                </button>
            </div>

            <div style="display:grid;gap:12px;">
                ${communities.map(c => {
                    const isJoined = joinedHives.includes(c.name);
                    return `
                        <div class="post-card" style="padding:18px;display:flex;align-items:center;gap:15px;">
                            <div style="width:55px;height:55px;border-radius:12px;background:${c.color};display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;color:white;flex-shrink:0;">${c.icon}</div>
                            <div style="flex:1;">
                                <h4 style="margin-bottom:3px;">${c.name}</h4>
                                <p style="font-size:12px;color:var(--text-secondary);margin-bottom:5px;">${c.desc}</p>
                                <span style="font-size:12px;color:var(--text-secondary);">${c.members} members</span>
                            </div>
                            <button onclick="joinCommunity('${c.name}')" 
                                style="background:${isJoined ? 'transparent' : c.color};color:${isJoined ? 'var(--text-primary)' : 'white'};border:${isJoined ? '1px solid var(--border-color)' : 'none'};padding:8px 18px;border-radius:20px;cursor:pointer;font-weight:bold;font-size:13px;white-space:nowrap;">
                                ${isJoined ? 'Joined âœ“' : 'Join'}
                            </button>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
    updateActiveNavLink('communities');
}




// ===== INLINE COMPOSE FUNCTIONS (Home Page X-style) =====
function expandInlineCompose() {
    const actions = document.getElementById('inlineComposeActions');
    if (actions) actions.classList.remove('hidden');
    const textarea = document.getElementById('inlinePostContent');
    if (textarea) textarea.style.minHeight = '80px';
}

function handleInlineCompose(el) {
    const btn = document.getElementById('inlineBuzzBtn');
    const text = el.contentEditable === 'true' ? (el.innerText || el.textContent || '').trim() : (el.value || '').trim();
    if (btn) btn.disabled = !text;
    // Auto-resize for contentEditable
    if (el.contentEditable === 'true') {
        el.style.minHeight = Math.min(Math.max(el.scrollHeight, 28), 200) + 'px';
    } else {
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 200) + 'px';
    }
}

function triggerInlineMedia() {
    document.getElementById('inlineMediaUpload').click();
}

function handleInlineMediaUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const preview = document.getElementById('inlineMediaPreview');
    if (!preview) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        preview.style.display = 'block';
        preview.innerHTML = `
            <div style="position:relative;display:inline-block;margin-top:10px;">
                <img src="${e.target.result}" style="max-width:100%;max-height:200px;border-radius:12px;">
                <button onclick="clearInlineMedia()" style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.7);border:none;color:white;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px;">&times;</button>
            </div>
        `;
        const btn = document.getElementById('inlineBuzzBtn');
        if (btn) btn.disabled = false;
    };
    reader.readAsDataURL(file);
}

function clearInlineMedia() {
    const preview = document.getElementById('inlineMediaPreview');
    if (preview) { preview.style.display = 'none'; preview.innerHTML = ''; }
    const input = document.getElementById('inlineMediaUpload');
    if (input) input.value = '';
    // Re-check if buzz button should be disabled
    const el = document.getElementById('inlinePostContent');
    const btn = document.getElementById('inlineBuzzBtn');
    if (btn && el) {
        const text = el.contentEditable === 'true' ? (el.innerText || '').trim() : (el.value || '').trim();
        btn.disabled = !text;
    }
}

function showEmojiPickerInline() {
    window._emojiTarget = 'inlinePostContent';
    showEmojiPicker();
}

// Override insertEmoji to support both modal and inline
const _origInsertEmoji = typeof insertEmoji === 'function' ? insertEmoji : null;
function insertEmoji(emoji) {
    const targetId = window._emojiTarget || 'postContent';
    const el = document.getElementById(targetId);
    if (!el) return;
    if (el.contentEditable === 'true') {
        el.focus();
        document.execCommand('insertText', false, emoji);
    } else {
        const start = el.selectionStart;
        const end = el.selectionEnd;
        el.value = el.value.substring(0, start) + emoji + el.value.substring(end);
        el.selectionStart = el.selectionEnd = start + emoji.length;
        el.focus();
        if (targetId === 'inlinePostContent') {
            const btn = document.getElementById('inlineBuzzBtn');
            if (btn) btn.disabled = !el.value.trim();
        }
    }
    window._emojiTarget = 'postContent';
}

// Same for insertSticker
const _origInsertSticker = typeof insertSticker === 'function' ? insertSticker : null;
function insertSticker(emoji) {
    const targetId = window._emojiTarget || 'postContent';
    const el = document.getElementById(targetId);
    if (el) {
        if (el.contentEditable === 'true') {
            el.focus();
            document.execCommand('insertText', false, emoji);
        } else {
            const start = el.selectionStart;
            const end = el.selectionEnd;
            el.value = el.value.substring(0, start) + emoji + el.value.substring(end);
            el.selectionStart = el.selectionEnd = start + emoji.length;
            el.focus();
            if (targetId === 'inlinePostContent') {
                const btn = document.getElementById('inlineBuzzBtn');
                if (btn) btn.disabled = !el.value.trim();
            }
        }
    }
    const overlay = document.getElementById('stickerPickerOverlay');
    if (overlay) overlay.remove();
    window._emojiTarget = 'postContent';
}

function createPollInline() {
    // For polls, open the full modal since polls need more space
    showCreatePostModal();
    setTimeout(function() { createPoll(); }, 300);
}

function submitInlinePost() {
    const el = document.getElementById('inlinePostContent');
    if (!el) return;
    const rawText = el.contentEditable === 'true' ? getPlainText('inlinePostContent') : (el.value || '');
    if (!rawText.trim()) return;
    if (!currentUser) { showToast('Please log in first!'); return; }

    const mediaPreview = document.getElementById('inlineMediaPreview');
    const mediaImg = mediaPreview ? mediaPreview.querySelector('img') : null;

    const inlineText = rawText.trim();
    const newPost = {
        id: posts.length + 1,
        userId: currentUser.id,
        content: inlineText,
        tags: extractHashtags(inlineText),
        media: mediaImg ? mediaImg.src : null,
        likes: 0,
        comments: 0,
        pollinations: 0,
        views: 0,
        createdAt: 'Just now',
        isLiked: false,
        isPollinated: false
    };

    posts.unshift(newPost);

    // Clear compose area
    if (el.contentEditable === 'true') {
        el.innerHTML = '';
    } else {
        el.value = '';
    }
    el.style.height = 'auto';
    el.style.minHeight = '28px';
    if (mediaPreview) { mediaPreview.style.display = 'none'; mediaPreview.innerHTML = ''; }
    const inlineUpload = document.getElementById('inlineMediaUpload');
    if (inlineUpload) inlineUpload.value = '';
    const btn = document.getElementById('inlineBuzzBtn');
    if (btn) btn.disabled = true;
    const actions = document.getElementById('inlineComposeActions');
    if (actions) actions.classList.add('hidden');

    // Reload feed
    if (currentPage === 'home') {
        loadHomeFeed();
    }

    currentUser.honeyPoints += 25;
    updateUIForUser();
    localStorage.setItem('polleneer_user', JSON.stringify(currentUser));

    showToast('Buzz posted! +25 Honey Points ðŸ¯');
}

// Also override selectGif to support inline target
const _origSelectGif = typeof selectGif === 'function' ? selectGif : null;
function selectGif(url) {
    // Check if we're in inline mode
    const inlinePreview = document.getElementById('inlineMediaPreview');
    const inlineCompose = document.getElementById('inlineComposeActions');
    const isInline = inlineCompose && !inlineCompose.classList.contains('hidden');

    if (isInline && inlinePreview) {
        inlinePreview.style.display = 'block';
        inlinePreview.innerHTML = `
            <div style="position:relative;display:inline-block;margin-top:10px;">
                <img src="${url}" style="max-width:100%;border-radius:12px;max-height:200px;">
                <button onclick="clearInlineMedia()" style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.7);border:none;color:white;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px;">&times;</button>
            </div>
        `;
        const btn = document.getElementById('inlineBuzzBtn');
        if (btn) btn.disabled = false;
    } else {
        // Modal mode
        const preview = document.getElementById('mediaPreview');
        if (preview) {
            preview.style.display = 'block';
            preview.innerHTML = `
                <div style="position:relative;display:inline-block;">
                    <img src="${url}" style="max-width:100%;border-radius:10px;max-height:200px;">
                    <button onclick="removeMedia()" style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.7);border:none;color:white;width:25px;height:25px;border-radius:50%;cursor:pointer;">&times;</button>
                </div>
            `;
        }
    }
    const overlay = document.getElementById('gifPickerOverlay');
    if (overlay) overlay.remove();
    showToast('GIF added! ðŸŽ¬');
}



// ============================================
// PHASE 2.5 FIXES: Profile Page + Inline Compose Functions
// ============================================

// FIX 1: ADMIN_CREDENTIALS - add missing fields
(function() {
    if (typeof ADMIN_CREDENTIALS !== 'undefined') {
        if (!ADMIN_CREDENTIALS.id) ADMIN_CREDENTIALS.id = 999;
        if (!ADMIN_CREDENTIALS.displayName) ADMIN_CREDENTIALS.displayName = ADMIN_CREDENTIALS.username || 'Admin';
        if (!ADMIN_CREDENTIALS.bio) ADMIN_CREDENTIALS.bio = 'Bee Keeper of Polleneer. Building the future of social media. ðŸ';
        if (!ADMIN_CREDENTIALS.joined) ADMIN_CREDENTIALS.joined = '2024-01-01';
        if (!ADMIN_CREDENTIALS.followers) ADMIN_CREDENTIALS.followers = 1200;
        if (!ADMIN_CREDENTIALS.following) ADMIN_CREDENTIALS.following = 247;
        if (!ADMIN_CREDENTIALS.avatar) ADMIN_CREDENTIALS.avatar = 'https://api.dicebear.com/7.x/avataaars/svg?seed=BeeKeeper';
    }

    // Also fix currentUser if already loaded from localStorage and missing fields
    if (typeof currentUser !== 'undefined' && currentUser) {
        if (!currentUser.displayName) currentUser.displayName = currentUser.username || 'User';
        if (!currentUser.bio) currentUser.bio = 'Welcome to Polleneer! ðŸ';
        if (!currentUser.joined) currentUser.joined = new Date().toISOString().split('T')[0];
        if (!currentUser.followers) currentUser.followers = 0;
        if (!currentUser.following) currentUser.following = 0;
        if (!currentUser.avatar) currentUser.avatar = 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + (currentUser.username || 'User');
        if (!currentUser.id) currentUser.id = 999;
    }
})();

// Login field population moved into main handleLogin

// FIX 2: Completely redesigned goToProfile with X/Twitter-style layout
function goToProfile(section) {
    section = section || 'posts';
    currentPage = 'profile';
    selectedProfileTab = section;

    // Ensure user fields exist
    if (currentUser) {
        if (!currentUser.displayName) currentUser.displayName = currentUser.username || 'User';
        if (!currentUser.bio) currentUser.bio = '';
        if (!currentUser.joined) currentUser.joined = new Date().toISOString().split('T')[0];
        if (!currentUser.followers) currentUser.followers = 0;
        if (!currentUser.following) currentUser.following = 0;
        if (!currentUser.avatar) currentUser.avatar = 'https://api.dicebear.com/7.x/avataaars/svg?seed=User';
        if (!currentUser.id) currentUser.id = 999;
    }

    const user = currentUser;
    const bannerUrl = user.bannerImage || localStorage.getItem('polleneer_banner_' + user.id) || '';
    let bannerStyle = '';
    if (bannerUrl) {
        bannerStyle = `background-image:url('${bannerUrl}');background-size:cover;background-position:center;`;
    } else {
        // Check saved customization for banner background
        var savedCustom = localStorage.getItem('polleneer_customization');
        var bgConfig = null;
        if (savedCustom) {
            try { bgConfig = JSON.parse(savedCustom).background; } catch(e) {}
        }
        if (bgConfig && bgConfig.type === 'gradient' && bgConfig.css) {
            bannerStyle = 'background:' + bgConfig.css + ';';
        } else if (bgConfig && bgConfig.type === 'solid' && bgConfig.css) {
            bannerStyle = 'background:' + bgConfig.css + ';';
        } else if (bgConfig && bgConfig.type === 'pattern' && bgConfig.baseColor) {
            bannerStyle = 'background-color:' + bgConfig.baseColor + ';background-image:' + bgConfig.patternImage + ';background-size:' + bgConfig.patternSize + ';';
        } else if (bgConfig && bgConfig.type === 'image' && bgConfig.imageData) {
            bannerStyle = "background-image:url('" + bgConfig.imageData + "');background-size:cover;background-position:center;";
        } else {
            bannerStyle = 'background:linear-gradient(135deg, var(--honey-yellow), var(--hive-orange));';
        }
    }

    document.getElementById('mainContent').innerHTML = `
        <div style="max-width:800px;margin:0 auto;">
            <!-- Banner (clickable to change, like X) -->
            <div class="banner-border-wrapper" id="bannerBorderWrapper" data-banner-style="${getBannerBorderStyle()}">
            <div id="profileBannerArea" style="position:relative;height:200px;border-radius:var(--site-radius, 15px) var(--site-radius, 15px) 0 0;${bannerStyle}cursor:pointer;overflow:hidden;" onclick="changeBanner()">
                <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0);transition:background 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.4)';this.querySelector('.cam-icon').style.opacity='1'" onmouseout="this.style.background='rgba(0,0,0,0)';this.querySelector('.cam-icon').style.opacity='0'">
                    <div class="cam-icon" style="opacity:0;transition:opacity 0.2s;color:white;font-size:24px;"><i class="fas fa-camera"></i></div>
                </div>
                <input type="file" id="bannerUpload" accept="image/*" style="display:none;" onchange="handleBannerUpload(event)">
            </div>
            </div>

            <!-- Profile Info Section -->
            <div style="background:var(--bg-card);padding:0 20px 20px;border-radius:0 0 var(--site-radius, 15px) var(--site-radius, 15px);border:1px solid var(--border-color);border-top:none;position:relative;z-index:2;">
                <!-- Avatar (overlapping banner) -->
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div style="margin-top:-65px;position:relative;z-index:10;">
                        <div class="avatar-border-container" id="avatarBorderContainer" data-border-style="${getAvatarBorderStyle()}">
                            <img src="${user.avatar}" alt="Profile" id="profileAvatar" 
                                style="width:130px;height:130px;border-radius:50%;border:4px solid var(--bg-card);object-fit:cover;cursor:pointer;background:var(--bg-card);" 
                                onclick="changeAvatar()">
                        </div>
                    </div>

                    <!-- Action Buttons (proper X-style) -->
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="showCustomization()" 
                            style="padding:8px 18px;border-radius:20px;border:1px solid var(--border-color);background:transparent;color:var(--text-primary);cursor:pointer;font-weight:600;font-size:14px;transition:background 0.2s;display:flex;align-items:center;gap:6px;"
                            onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background='transparent'">
                            <i class="fas fa-paint-brush" style="font-size:13px;"></i> Customize
                        </button>
                        <button onclick="editProfileFull()"
                            style="padding:8px 18px;border-radius:20px;background:var(--honey-yellow);color:#000;border:none;cursor:pointer;font-weight:600;font-size:14px;display:flex;align-items:center;gap:6px;">
                            <i class="fas fa-edit" style="font-size:13px;"></i> Edit Profile
                        </button>
                    </div>
                </div>

                <!-- Name & Username -->
                <div style="margin-top:10px;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <h2 style="font-size:22px;font-weight:800;margin:0;">${user.displayName || user.username}</h2>
                        ${user.role === 'queen' || user.role === 'admin' ? '<i class="fas fa-check-circle" style="color:var(--honey-yellow);font-size:18px;" title="Verified Bee"></i>' : ''}
                        <span style="background:var(--honey-yellow);color:#000;padding:2px 10px;border-radius:10px;font-size:11px;font-weight:700;">${(typeof getRoleName === 'function' ? getRoleName(user.role) : user.role) || 'Bee'}</span>
                    </div>
                    <div style="color:var(--text-secondary);font-size:15px;margin-top:2px;display:flex;align-items:center;">@${user.username}${getUserStatusHTML(user)}</div>
                </div>

                <!-- Bio -->
                <div style="margin-top:12px;font-size:15px;line-height:1.6;max-width:600px;">${user.bio || '<span style="color:var(--text-secondary);font-style:italic;">Add a bio to tell the hive about yourself</span>'}</div>

                <!-- Mood/Status -->
                <div class="profile-mood-status" id="profileMoodStatus" onclick="openMoodEditor()" title="Click to set your mood">
                    ${getMoodStatusHTML()}
                </div>

                <!-- Joined date + location -->
                <div style="display:flex;gap:16px;margin-top:12px;color:var(--text-secondary);font-size:14px;">
                    <span><i class="fas fa-calendar" style="margin-right:4px;"></i> Joined ${user.joined || 'recently'}</span>
                    ${user.location ? '<span><i class="fas fa-map-marker-alt" style="margin-right:4px;"></i> ' + user.location + '</span>' : ''}
                </div>

                <!-- Stats row -->
                <div style="display:flex;gap:20px;margin-top:14px;font-size:14px;">
                    <span style="cursor:pointer;" onclick="showFollowing()"><strong>${user.following || 0}</strong> <span style="color:var(--text-secondary);">Following</span></span>
                    <span style="cursor:pointer;" onclick="showFollowers()"><strong>${user.followers || 0}</strong> <span style="color:var(--text-secondary);">Followers</span></span>
                    <span style="cursor:pointer;" onclick="showHoneyShop()"><strong style="color:var(--honey-yellow);">${(user.honeyPoints || 0).toLocaleString()}</strong> <span style="color:var(--text-secondary);">Honey Points ðŸ¯</span></span>
                </div>
            </div>

            <!-- Profile song player moved to right sidebar -->

            <!-- Bulletin Board -->
            <div style="background:var(--bg-card);border-radius:var(--site-radius, 15px);padding:20px;margin-top:10px;border:1px solid var(--border-color);">
                <h4 style="margin-bottom:12px;"><i class="fas fa-bullhorn"></i> Bulletin Board</h4>
                <div class="bulletin-form">
                    <textarea placeholder="Post a bulletin to your profile..." id="bulletinText" style="width:100%;min-height:60px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:10px;padding:10px;color:var(--text-primary);resize:none;font-family:inherit;"></textarea>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                        <div style="display:flex;gap:8px;">
                            <button class="action-btn" onclick="addBulletinOption('public')" style="font-size:12px;"><i class="fas fa-globe"></i> Public</button>
                            <button class="action-btn" onclick="addBulletinOption('friends')" style="font-size:12px;"><i class="fas fa-user-friends"></i> Friends</button>
                        </div>
                        <button class="pollinate-btn" onclick="postBulletin()" style="padding:8px 20px;font-size:13px;">
                            <i class="fas fa-paper-plane"></i> Post
                        </button>
                    </div>
                </div>
            </div>

            <!-- Top Friends -->
            <div style="background:var(--bg-card);border-radius:var(--site-radius, 15px);padding:20px;margin-top:10px;border:1px solid var(--border-color);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h4><i class="fas fa-star"></i> Top Friends</h4>
                    <button class="action-btn" onclick="manageFriends()" style="font-size:12px;"><i class="fas fa-cog"></i> Manage</button>
                </div>
                <div class="friends-grid" id="topFriendsGrid"></div>
            </div>

            <!-- Profile Tabs -->
            <div style="display:flex;border-bottom:1px solid var(--border-color);margin-top:10px;background:var(--bg-card);border-radius:var(--site-radius, 15px) var(--site-radius, 15px) 0 0;overflow:hidden;">
                ${['posts','comments','media','likes'].map(tab => `
                    <button onclick="switchProfileTab('${tab}')" 
                        style="flex:1;padding:14px;border:none;background:transparent;color:${section === tab ? 'var(--honey-yellow)' : 'var(--text-secondary)'};cursor:pointer;font-weight:${section === tab ? '700' : '400'};font-size:14px;border-bottom:${section === tab ? '3px solid var(--honey-yellow)' : '3px solid transparent'};transition:all 0.2s;"
                        onmouseover="if(this.style.borderBottomColor==='transparent')this.style.background='var(--bg-input)'" onmouseout="this.style.background='transparent'">
                        <i class="fas fa-${tab === 'posts' ? 'feather-alt' : tab === 'comments' ? 'comment' : tab === 'media' ? 'image' : 'heart'}"></i> ${tab.charAt(0).toUpperCase() + tab.slice(1)}
                    </button>
                `).join('')}
            </div>

            <div id="pinnedPostArea"></div>
            <div id="profileFeed" style="min-height:200px;"></div>
        </div>
    `;

    if (typeof applyProfileCustomization === 'function') applyProfileCustomization();
    if (typeof loadProfileFeed === 'function') loadProfileFeed(section);
    if (typeof loadTopFriends === 'function') loadTopFriends();
    if (typeof loadPinnedPost === 'function') loadPinnedPost();
    if (typeof applyAvatarBorderColors === 'function') applyAvatarBorderColors();
    if (typeof applyBannerBorderColors === 'function') applyBannerBorderColors();
    updateActiveNavLink('profile');
    applyProfileCustomization();
}

// FIX 3: Banner upload (like X)
function changeBanner() {
    document.getElementById('bannerUpload').click();
}

function handleBannerUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const bannerArea = document.getElementById('profileBannerArea');
        if (bannerArea) {
            bannerArea.style.backgroundImage = `url('${e.target.result}')`;
            bannerArea.style.backgroundSize = 'cover';
            bannerArea.style.backgroundPosition = 'center';
            bannerArea.style.background = ''; // Clear gradient
            bannerArea.style.backgroundImage = `url('${e.target.result}')`;
            bannerArea.style.backgroundSize = 'cover';
            bannerArea.style.backgroundPosition = 'center';
        }
        // Save to localStorage
        if (currentUser) {
            currentUser.bannerImage = e.target.result;
            localStorage.setItem('polleneer_banner_' + currentUser.id, e.target.result);
            localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
        }
        showToast('Banner updated! ðŸ“¸');
    };
    reader.readAsDataURL(file);
}

// FIX 4: Full Edit Profile modal (not just bio)
function editProfileFull() {
    const user = currentUser;

    const editModal = document.createElement('div');
    editModal.id = 'editProfileOverlay';
    editModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    editModal.onclick = function(e) { if(e.target === editModal) editModal.remove(); };

    editModal.innerHTML = `
        <div style="background:var(--bg-card);border-radius:15px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;">
            <div style="padding:15px 20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;">
                <h3 style="color:var(--honey-yellow);"><i class="fas fa-edit"></i> Edit Profile</h3>
                <button onclick="document.getElementById('editProfileOverlay').remove()" style="background:none;border:none;color:var(--text-primary);font-size:1.5em;cursor:pointer;">&times;</button>
            </div>
            <div style="padding:20px;">
                <div style="margin-bottom:18px;">
                    <label style="display:block;font-weight:600;margin-bottom:6px;font-size:14px;">Display Name</label>
                    <input type="text" id="editDisplayName" value="${user.displayName || ''}" 
                        style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);font-size:15px;" maxlength="50">
                </div>
                <div style="margin-bottom:18px;">
                    <label style="display:block;font-weight:600;margin-bottom:6px;font-size:14px;">Bio</label>
                    <textarea id="editBioText" rows="3" maxlength="160"
                        style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);font-size:15px;resize:none;font-family:inherit;">${user.bio || ''}</textarea>
                    <div style="text-align:right;font-size:12px;color:var(--text-secondary);margin-top:4px;"><span id="bioCharCount">${(user.bio || '').length}</span>/160</div>
                </div>
                <div style="margin-bottom:18px;">
                    <label style="display:block;font-weight:600;margin-bottom:6px;font-size:14px;">Location</label>
                    <input type="text" id="editLocation" value="${user.location || ''}" placeholder="Where are you based?"
                        style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);font-size:15px;" maxlength="30">
                </div>
                <div style="margin-bottom:18px;">
                    <label style="display:block;font-weight:600;margin-bottom:6px;font-size:14px;">Website</label>
                    <input type="url" id="editWebsite" value="${user.website || ''}" placeholder="https://your-site.com"
                        style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);font-size:15px;">
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button onclick="document.getElementById('editProfileOverlay').remove()" 
                        style="padding:10px 20px;border-radius:20px;border:1px solid var(--border-color);background:transparent;color:var(--text-primary);cursor:pointer;font-size:14px;">Cancel</button>
                    <button onclick="saveProfileEdits()" 
                        style="padding:10px 25px;border-radius:20px;background:var(--honey-yellow);color:#000;border:none;cursor:pointer;font-weight:700;font-size:14px;">Save</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(editModal);

    // Bio character counter
    const bioTextarea = document.getElementById('editBioText');
    if (bioTextarea) {
        bioTextarea.oninput = function() {
            document.getElementById('bioCharCount').textContent = this.value.length;
        };
    }
}

function saveProfileEdits() {
    const displayName = document.getElementById('editDisplayName').value.trim();
    const bio = document.getElementById('editBioText').value.trim();
    const location = document.getElementById('editLocation').value.trim();
    const website = document.getElementById('editWebsite').value.trim();

    if (displayName) currentUser.displayName = displayName;
    currentUser.bio = bio;
    currentUser.location = location;
    currentUser.website = website;

    localStorage.setItem('polleneer_user', JSON.stringify(currentUser));
    document.getElementById('editProfileOverlay').remove();

    // Refresh profile
    goToProfile(selectedProfileTab || 'posts');
    showToast('Profile updated! âœ¨');
}


// ============================================
// HASHTAG HIGHLIGHTING, BOLD/ITALIC, HELPERS
// ============================================

function extractHashtags(text) {
    const matches = text.match(/#[\w\u00C0-\u024F]+/g);
    return matches ? [...new Set(matches)] : [];
}

function getPlainText(elementId) {
    const el = document.getElementById(elementId);
    if (!el) return '';
    if (el.contentEditable === 'true') {
        // Extract text preserving line breaks and bold/italic markers
        let text = '';
        function walk(node) {
            if (node.nodeType === 3) {
                text += node.textContent;
            } else if (node.nodeName === 'BR') {
                text += '\n';
            } else if (node.nodeName === 'DIV' || node.nodeName === 'P') {
                if (text && !text.endsWith('\n')) text += '\n';
                for (const child of node.childNodes) walk(child);
            } else if (node.nodeName === 'B' || node.nodeName === 'STRONG') {
                text += '**';
                for (const child of node.childNodes) walk(child);
                text += '**';
            } else if (node.nodeName === 'I' || node.nodeName === 'EM') {
                text += '*';
                for (const child of node.childNodes) walk(child);
                text += '*';
            } else {
                for (const child of node.childNodes) walk(child);
            }
        }
        for (const child of el.childNodes) walk(child);
        return text;
    }
    return el.value || el.textContent || '';
}

function clearEditable(elementId) {
    const el = document.getElementById(elementId);
    if (!el) return;
    if (el.contentEditable === 'true') {
        el.innerHTML = '';
    } else {
        el.value = '';
    }
}

// Track the last known selection inside a compose area
let _lastComposeRange = null;
let _hashtagDebounceTimer = null;

// Debounced hashtag highlighter â€” waits 600ms after typing stops
// This prevents hashtag DOM manipulation from breaking execCommand toggle state
function debouncedHighlightHashtags(el) {
    clearTimeout(_hashtagDebounceTimer);
    _hashtagDebounceTimer = setTimeout(() => {
        highlightHashtags(el);
    }, 600);
}

document.addEventListener('selectionchange', function() {
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    const container = range.commonAncestorContainer;
    // Check if selection is inside a compose area
    const node = container.nodeType === 3 ? container.parentNode : container;
    if (node && node.closest && (node.closest('#postContent') || node.closest('#inlinePostContent'))) {
        _lastComposeRange = range.cloneRange();
    }
    // Update bold/italic button active states
    updateFormatButtonStates();
});

function updateFormatButtonStates() {
    try {
        const isBold = document.queryCommandState('bold');
        const isItalic = document.queryCommandState('italic');
        // Update all bold buttons
        document.querySelectorAll('[onclick="toggleBold()"]').forEach(btn => {
            btn.style.background = isBold ? 'var(--honey-yellow)' : '';
            btn.style.color = isBold ? '#000' : '';
            btn.style.borderRadius = isBold ? '6px' : '';
        });
        // Update all italic buttons
        document.querySelectorAll('[onclick="toggleItalic()"]').forEach(btn => {
            btn.style.background = isItalic ? 'var(--honey-yellow)' : '';
            btn.style.color = isItalic ? '#000' : '';
            btn.style.borderRadius = isItalic ? '6px' : '';
        });
    } catch(e) {}
}

function toggleBold() {
    const active = getActiveCompose();
    if (!active) return;
    active.focus();
    // Restore saved selection/cursor position
    if (_lastComposeRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(_lastComposeRange);
    }
    document.execCommand('bold', false, null);
    updateFormatButtonStates();
}

function toggleItalic() {
    const active = getActiveCompose();
    if (!active) return;
    active.focus();
    // Restore saved selection/cursor position
    if (_lastComposeRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(_lastComposeRange);
    }
    document.execCommand('italic', false, null);
    updateFormatButtonStates();
}

function getActiveCompose() {
    // Check which compose area is visible/active
    const modal = document.getElementById('createPostModal');
    if (modal && (modal.classList.contains('show') || modal.classList.contains('active'))) {
        return document.getElementById('postContent');
    }
    // Check if modal is visible via computed style
    if (modal && getComputedStyle(modal).display !== 'none' && getComputedStyle(modal).visibility !== 'hidden' && getComputedStyle(modal).opacity !== '0') {
        return document.getElementById('postContent');
    }
    // Fallback to inline compose
    const inline = document.getElementById('inlinePostContent');
    if (inline && inline.offsetParent !== null) return inline;
    // Last resort
    return document.getElementById('postContent') || document.getElementById('inlinePostContent');
}

// Live hashtag highlighting in contentEditable
function highlightHashtags(el) {
    // Walk text nodes only â€” preserves bold/italic/other formatting
    const sel = window.getSelection();
    if (!sel.rangeCount) return;

    // Save cursor
    const range = sel.getRangeAt(0);
    const preCaretRange = range.cloneRange();
    preCaretRange.selectNodeContents(el);
    preCaretRange.setEnd(range.endContainer, range.endOffset);
    const caretOffset = preCaretRange.toString().length;

    const text = el.innerText || el.textContent;
    if (!text.includes('#')) return; // No hashtags, skip

    const hashtagRegex = /#[\w\u00C0-\u024F]+/g;
    let changed = false;

    // Collect text nodes
    const textNodes = [];
    const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null, false);
    let node;
    while (node = walker.nextNode()) {
        textNodes.push(node);
    }

    // Process each text node for hashtags
    textNodes.forEach(tn => {
        if (!hashtagRegex.test(tn.textContent)) return;
        hashtagRegex.lastIndex = 0; // Reset regex

        // Check if this text node is already inside a hashtag span
        if (tn.parentNode && tn.parentNode.dataset && tn.parentNode.dataset.hashtag) return;

        const frag = document.createDocumentFragment();
        let lastIdx = 0;
        let match;
        hashtagRegex.lastIndex = 0;

        while ((match = hashtagRegex.exec(tn.textContent)) !== null) {
            changed = true;
            // Text before the hashtag
            if (match.index > lastIdx) {
                frag.appendChild(document.createTextNode(tn.textContent.slice(lastIdx, match.index)));
            }
            // Hashtag span
            const span = document.createElement('span');
            span.style.color = 'var(--honey-yellow)';
            span.style.fontWeight = '500';
            span.dataset.hashtag = 'true';
            span.textContent = match[0];
            frag.appendChild(span);
            lastIdx = match.index + match[0].length;
        }

        // Remaining text after last hashtag
        if (lastIdx < tn.textContent.length) {
            frag.appendChild(document.createTextNode(tn.textContent.slice(lastIdx)));
        }

        if (changed && frag.childNodes.length > 0) {
            tn.parentNode.replaceChild(frag, tn);
        }
    });

    if (changed) {
        restoreCaret(el, caretOffset);
    }
}

function restoreCaret(el, offset) {
    const sel = window.getSelection();
    const range = document.createRange();
    let currentOffset = 0;
    let found = false;

    function walkNodes(node) {
        if (found) return;
        if (node.nodeType === 3) {
            const len = node.textContent.length;
            if (currentOffset + len >= offset) {
                range.setStart(node, offset - currentOffset);
                range.collapse(true);
                found = true;
                return;
            }
            currentOffset += len;
        } else {
            for (const child of node.childNodes) {
                walkNodes(child);
                if (found) return;
            }
        }
    }

    walkNodes(el);
    if (found) {
        sel.removeAllRanges();
        sel.addRange(range);
    } else {
        // Fallback: put cursor at end
        range.selectNodeContents(el);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    const activeEl = document.activeElement;
    if (!activeEl || (activeEl.contentEditable !== 'true' && activeEl.tagName !== 'TEXTAREA')) return;
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        document.execCommand('bold', false, null);
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
        e.preventDefault();
        document.execCommand('italic', false, null);
    }
});

// Paste handler â€” strip formatting
document.addEventListener('DOMContentLoaded', function() {
    // Paste handler for all contentEditable compose areas
    document.addEventListener('paste', function(e) {
        const el = e.target;
        if (el && el.contentEditable === 'true' && (el.id === 'postContent' || el.id === 'inlinePostContent')) {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text/plain');
            document.execCommand('insertText', false, text);
        }
    });
});




// =====================================================================
// FEATURE 1: ANIMATED AVATAR BORDER SYSTEM
// =====================================================================
const AVATAR_BORDER_STYLES = [
    { id: 'none', name: 'None', icon: 'fas fa-ban', desc: 'No border effect' },
    { id: 'rotating', name: 'Rotating Gradient', icon: 'fas fa-sync-alt', desc: 'Spinning gradient ring' },
    { id: 'pulse', name: 'Pulsing Glow', icon: 'fas fa-heartbeat', desc: 'Breathing glow effect' },
    { id: 'static', name: 'Gradient Ring', icon: 'fas fa-circle', desc: 'Solid gradient border' },
    { id: 'rainbow', name: 'Rainbow Spin', icon: 'fas fa-rainbow', desc: 'Full spectrum rotation' },
    { id: 'neon', name: 'Neon Pulse', icon: 'fas fa-lightbulb', desc: 'Intense neon glow burst' },
    { id: 'fire', name: 'Fire Ring', icon: 'fas fa-fire', desc: 'Blazing flames around avatar' },
    { id: 'electric', name: 'Electric Bolt', icon: 'fas fa-bolt', desc: 'Lightning strike flashes' },
    { id: 'double', name: 'Double Ring', icon: 'far fa-circle', desc: 'Two concentric borders' },
    { id: 'dashed', name: 'Dashed Spin', icon: 'fas fa-spinner', desc: 'Rotating dashed circle' },
    { id: 'orbit', name: 'Shadow Orbit', icon: 'fas fa-satellite', desc: 'Orbiting shadow glow' },
    { id: 'hexagon', name: 'Hexagon Frame', icon: 'fas fa-hexagon-alt', desc: 'Bee-themed hex shape' }
];

function getAvatarBorderStyle() {
    try {
        var saved = localStorage.getItem('polleneer_avatar_border');
        if (saved) { var d = JSON.parse(saved); return d.style || 'none'; }
    } catch(e) {}
    return 'none';
}

function getAvatarBorderColors() {
    try {
        var saved = localStorage.getItem('polleneer_avatar_border');
        if (saved) { var d = JSON.parse(saved); return { accent: d.accent || '', accent2: d.accent2 || '' }; }
    } catch(e) {}
    return { accent: '', accent2: '' };
}

function applyAvatarBorderColors() {
    var container = document.getElementById('avatarBorderContainer');
    if (!container) return;
    var colors = getAvatarBorderColors();
    if (colors.accent) container.style.setProperty('--avatar-accent', colors.accent);
    if (colors.accent2) container.style.setProperty('--avatar-accent2', colors.accent2);
}

function setAvatarBorder(style, accent, accent2) {
    var data = { style: style, accent: accent || '', accent2: accent2 || '' };
    localStorage.setItem('polleneer_avatar_border', JSON.stringify(data));
    var container = document.getElementById('avatarBorderContainer');
    if (container) {
        container.setAttribute('data-border-style', style);
        if (accent) container.style.setProperty('--avatar-accent', accent);
        if (accent2) container.style.setProperty('--avatar-accent2', accent2);
    }
    // Update preview in settings if open
    var preview = document.getElementById('avatarBorderPreview');
    if (preview) {
        preview.setAttribute('data-border-style', style);
        if (accent) preview.style.setProperty('--avatar-accent', accent);
        if (accent2) preview.style.setProperty('--avatar-accent2', accent2);
    }
    updateBorderStyleButtons(style);
}

function updateBorderStyleButtons(activeStyle) {
    document.querySelectorAll('.border-style-btn').forEach(function(btn) {
        var isActive = btn.getAttribute('data-style') === activeStyle;
        btn.style.borderColor = isActive ? 'var(--honey-yellow)' : 'var(--border-color)';
        btn.style.background = isActive ? 'var(--honey-yellow)11' : 'var(--bg-input)';
    });
}

function renderAvatarBorderSettings() {
    var current = getAvatarBorderStyle();
    var colors = getAvatarBorderColors();
    var accent1 = colors.accent || '#FFC30B';
    var accent2 = colors.accent2 || '#FF8C00';

    return '<div style="padding:16px;">' +
        '<h4 style="margin-bottom:14px;"><i class="fas fa-circle-notch"></i> Avatar Border Effect</h4>' +

        '<div style="display:flex;justify-content:center;margin-bottom:20px;">' +
            '<div class="avatar-border-container" id="avatarBorderPreview" data-border-style="' + current + '" style="--avatar-accent:' + accent1 + ';--avatar-accent2:' + accent2 + ';">' +
                '<img src="' + (currentUser ? currentUser.avatar : '') + '" style="width:100px;height:100px;border-radius:50%;border:4px solid var(--bg-card);object-fit:cover;background:var(--bg-card);">' +
            '</div>' +
        '</div>' +

        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:16px;">' +
            AVATAR_BORDER_STYLES.map(function(s) {
                var isActive = s.id === current;
                return '<button class="border-style-btn" data-style="' + s.id + '" onclick="setAvatarBorder(\'' + s.id + '\', document.getElementById(\'borderAccent1\').value, document.getElementById(\'borderAccent2\').value)" ' +
                    'style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:2px solid ' + (isActive ? 'var(--honey-yellow)' : 'var(--border-color)') + ';background:' + (isActive ? 'var(--honey-yellow)11' : 'var(--bg-input)') + ';cursor:pointer;color:var(--text-primary);transition:all 0.2s;text-align:left;">' +
                    '<i class="' + s.icon + '" style="color:var(--honey-yellow);width:20px;text-align:center;"></i>' +
                    '<div><div style="font-weight:600;font-size:13px;">' + s.name + '</div><div style="font-size:11px;color:var(--text-secondary);">' + s.desc + '</div></div>' +
                '</button>';
            }).join('') +
        '</div>' +

        '<div style="display:flex;gap:12px;align-items:center;">' +
            '<label style="font-size:13px;color:var(--text-secondary);white-space:nowrap;">Primary</label>' +
            '<input type="color" id="borderAccent1" value="' + accent1 + '" onchange="setAvatarBorder(getAvatarBorderStyle(), this.value, document.getElementById(\'borderAccent2\').value)" style="width:40px;height:32px;border:none;cursor:pointer;border-radius:6px;">' +
            '<label style="font-size:13px;color:var(--text-secondary);white-space:nowrap;">Secondary</label>' +
            '<input type="color" id="borderAccent2" value="' + accent2 + '" onchange="setAvatarBorder(getAvatarBorderStyle(), document.getElementById(\'borderAccent1\').value, this.value)" style="width:40px;height:32px;border:none;cursor:pointer;border-radius:6px;">' +
        '</div>' +
    '</div>';
}



// =====================================================================
// BANNER BORDER EFFECT SYSTEM
// =====================================================================
const BANNER_BORDER_STYLES = [
    { id: 'none', name: 'None', icon: 'fas fa-ban', desc: 'No border effect' },
    { id: 'rotating', name: 'Rotating Gradient', icon: 'fas fa-sync-alt', desc: 'Spinning gradient frame' },
    { id: 'pulse', name: 'Pulsing Glow', icon: 'fas fa-heartbeat', desc: 'Breathing glow effect' },
    { id: 'static', name: 'Gradient Frame', icon: 'fas fa-square', desc: 'Solid gradient border' },
    { id: 'rainbow', name: 'Rainbow Frame', icon: 'fas fa-rainbow', desc: 'Full spectrum rotation' },
    { id: 'neon', name: 'Neon Glow', icon: 'fas fa-lightbulb', desc: 'Intense neon glow burst' },
    { id: 'fire', name: 'Fire Frame', icon: 'fas fa-fire', desc: 'Blazing flames on top' },
    { id: 'electric', name: 'Electric Frame', icon: 'fas fa-bolt', desc: 'Lightning strike flashes' },
    { id: 'double', name: 'Double Border', icon: 'far fa-square', desc: 'Two concentric borders' },
    { id: 'orbit', name: 'Shadow Orbit', icon: 'fas fa-satellite', desc: 'Orbiting shadow glow' }
];

function getBannerBorderStyle() {
    try {
        var saved = localStorage.getItem('polleneer_banner_border');
        if (saved) { var d = JSON.parse(saved); return d.style || 'none'; }
    } catch(e) {}
    return 'none';
}

function getBannerBorderColors() {
    try {
        var saved = localStorage.getItem('polleneer_banner_border');
        if (saved) { var d = JSON.parse(saved); return { accent: d.accent || '', accent2: d.accent2 || '' }; }
    } catch(e) {}
    return { accent: '', accent2: '' };
}

function applyBannerBorderColors() {
    var wrapper = document.getElementById('bannerBorderWrapper');
    if (!wrapper) return;
    var colors = getBannerBorderColors();
    if (colors.accent) wrapper.style.setProperty('--banner-accent', colors.accent);
    if (colors.accent2) wrapper.style.setProperty('--banner-accent2', colors.accent2);
}

function setBannerBorder(style, accent, accent2) {
    var data = { style: style, accent: accent || '', accent2: accent2 || '' };
    localStorage.setItem('polleneer_banner_border', JSON.stringify(data));
    var wrapper = document.getElementById('bannerBorderWrapper');
    if (wrapper) {
        wrapper.setAttribute('data-banner-style', style);
        if (accent) wrapper.style.setProperty('--banner-accent', accent);
        if (accent2) wrapper.style.setProperty('--banner-accent2', accent2);
    }
    var preview = document.getElementById('bannerBorderPreview');
    if (preview) {
        preview.setAttribute('data-banner-style', style);
        if (accent) preview.style.setProperty('--banner-accent', accent);
        if (accent2) preview.style.setProperty('--banner-accent2', accent2);
    }
    updateBannerStyleButtons(style);
}

function updateBannerStyleButtons(activeStyle) {
    document.querySelectorAll('.banner-style-btn').forEach(function(btn) {
        var isActive = btn.getAttribute('data-style') === activeStyle;
        btn.style.borderColor = isActive ? 'var(--honey-yellow)' : 'var(--border-color)';
        btn.style.background = isActive ? 'var(--honey-yellow)11' : 'var(--bg-input)';
    });
}

function renderBannerBorderSettings() {
    var current = getBannerBorderStyle();
    var colors = getBannerBorderColors();
    var accent1 = colors.accent || '#FFC30B';
    var accent2 = colors.accent2 || '#FF8C00';
    var bannerBg = 'linear-gradient(135deg, var(--honey-yellow), var(--hive-orange))';
    try {
        var savedCustom = localStorage.getItem('polleneer_customization');
        if (savedCustom) {
            var bgConfig = JSON.parse(savedCustom).background;
            if (bgConfig && bgConfig.css) bannerBg = bgConfig.css;
        }
    } catch(e) {}

    return '<div style="padding:16px;">' +
        '<h4 style="margin-bottom:14px;"><i class="fas fa-image"></i> Banner Border Effect</h4>' +

        '<div style="display:flex;justify-content:center;margin-bottom:20px;">' +
            '<div class="banner-border-wrapper" id="bannerBorderPreview" data-banner-style="' + current + '" style="--banner-accent:' + accent1 + ';--banner-accent2:' + accent2 + ';width:280px;">' +
                '<div style="height:80px;border-radius:12px;background:' + bannerBg + ';"></div>' +
            '</div>' +
        '</div>' +

        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px;">' +
            BANNER_BORDER_STYLES.map(function(s) {
                var isActive = s.id === current;
                return '<button class="banner-style-btn" data-style="' + s.id + '" onclick="setBannerBorder(\'' + s.id + '\', document.getElementById(\'bannerAccent1\').value, document.getElementById(\'bannerAccent2\').value)" ' +
                    'style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:2px solid ' + (isActive ? 'var(--honey-yellow)' : 'var(--border-color)') + ';background:' + (isActive ? 'var(--honey-yellow)11' : 'var(--bg-input)') + ';cursor:pointer;color:var(--text-primary);transition:all 0.2s;text-align:left;">' +
                    '<i class="' + s.icon + '" style="color:var(--honey-yellow);width:20px;text-align:center;"></i>' +
                    '<div><div style="font-weight:600;font-size:13px;">' + s.name + '</div><div style="font-size:11px;color:var(--text-secondary);">' + s.desc + '</div></div>' +
                '</button>';
            }).join('') +
        '</div>' +

        '<div style="display:flex;gap:12px;align-items:center;">' +
            '<label style="font-size:13px;color:var(--text-secondary);white-space:nowrap;">Primary</label>' +
            '<input type="color" id="bannerAccent1" value="' + accent1 + '" onchange="setBannerBorder(getBannerBorderStyle(), this.value, document.getElementById(\'bannerAccent2\').value)" style="width:40px;height:32px;border:none;cursor:pointer;border-radius:6px;">' +
            '<label style="font-size:13px;color:var(--text-secondary);white-space:nowrap;">Secondary</label>' +
            '<input type="color" id="bannerAccent2" value="' + accent2 + '" onchange="setBannerBorder(getBannerBorderStyle(), document.getElementById(\'bannerAccent1\').value, this.value)" style="width:40px;height:32px;border:none;cursor:pointer;border-radius:6px;">' +
        '</div>' +
    '</div>';
}

// =====================================================================
// FEATURE 2: PROFILE MOOD / STATUS
// =====================================================================
const MOOD_PRESETS = [
    { emoji: '\u{1F41D}', label: 'Busy bee' },
    { emoji: '\u{1F33B}', label: 'Feeling sunny' },
    { emoji: '\u{1F3B5}', label: 'Vibing' },
    { emoji: '\u{1F4AA}', label: 'Grinding' },
    { emoji: '\u{2615}', label: 'Coffee time' },
    { emoji: '\u{1F680}', label: 'Building' },
    { emoji: '\u{1F31F}', label: 'Feeling blessed' },
    { emoji: '\u{1F634}', label: 'ZzZ' },
    { emoji: '\u{1F525}', label: 'On fire' },
    { emoji: '\u{1F389}', label: 'Celebrating' },
    { emoji: '\u{1F4AD}', label: 'Thinking deep' },
    { emoji: '\u{1F33F}', label: 'Touching grass' }
];

function getMoodStatus() {
    try {
        var saved = localStorage.getItem('polleneer_mood');
        if (saved) return JSON.parse(saved);
    } catch(e) {}
    return null;
}

function getMoodStatusHTML() {
    var mood = getMoodStatus();
    if (mood && mood.emoji && mood.text) {
        return '<span class="mood-emoji">' + mood.emoji + '</span><span class="mood-text">' + escapeHtml(mood.text) + '</span>';
    }
    return '<i class="far fa-smile" style="opacity:0.5;"></i><span class="mood-text" style="font-style:italic;">Set your mood...</span>';
}

function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function openMoodEditor() {
    var current = getMoodStatus();
    var currentEmoji = current ? current.emoji : '';
    var currentText = current ? current.text : '';

    var overlay = document.createElement('div');
    overlay.className = 'mood-editor-overlay';
    overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
    overlay.innerHTML = '<div class="mood-editor-card">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">' +
            '<h3 style="margin:0;"><i class="fas fa-smile-beam" style="color:var(--honey-yellow);"></i> Set Your Mood</h3>' +
            '<button onclick="this.closest(\'.mood-editor-overlay\').remove()" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:20px;"><i class="fas fa-times"></i></button>' +
        '</div>' +

        '<div style="display:flex;gap:8px;margin-bottom:14px;">' +
            '<input type="text" id="moodEmojiInput" value="' + currentEmoji + '" placeholder="\u{1F41D}" maxlength="4" style="width:50px;text-align:center;font-size:24px;padding:8px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:10px;color:var(--text-primary);">' +
            '<input type="text" id="moodTextInput" value="' + escapeHtml(currentText) + '" placeholder="What are you up to?" maxlength="60" style="flex:1;padding:8px 12px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:10px;color:var(--text-primary);font-size:14px;">' +
        '</div>' +

        '<div style="margin-bottom:16px;">' +
            '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Quick picks:</div>' +
            '<div style="display:flex;flex-wrap:wrap;gap:6px;">' +
                MOOD_PRESETS.map(function(p) {
                    return '<button onclick="document.getElementById(\'moodEmojiInput\').value=\'' + p.emoji + '\';document.getElementById(\'moodTextInput\').value=\'' + p.label + '\';" ' +
                        'style="padding:6px 10px;border-radius:20px;border:1px solid var(--border-color);background:var(--bg-input);cursor:pointer;color:var(--text-primary);font-size:12px;transition:all 0.2s;display:flex;align-items:center;gap:4px;" ' +
                        'onmouseover="this.style.borderColor=\'var(--honey-yellow)\'" onmouseout="this.style.borderColor=\'var(--border-color)\'">' +
                        '<span>' + p.emoji + '</span> ' + p.label +
                    '</button>';
                }).join('') +
            '</div>' +
        '</div>' +

        '<div style="display:flex;gap:8px;justify-content:flex-end;">' +
            '<button onclick="clearMood();this.closest(\'.mood-editor-overlay\').remove();" style="padding:8px 16px;border-radius:20px;border:1px solid var(--border-color);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:13px;">Clear</button>' +
            '<button onclick="saveMood();this.closest(\'.mood-editor-overlay\').remove();" style="padding:8px 20px;border-radius:20px;border:none;background:var(--honey-yellow);color:#000;cursor:pointer;font-weight:600;font-size:13px;">Save</button>' +
        '</div>' +
    '</div>';
    document.body.appendChild(overlay);
    document.getElementById('moodTextInput').focus();
}

function saveMood() {
    var emoji = document.getElementById('moodEmojiInput').value.trim();
    var text = document.getElementById('moodTextInput').value.trim();
    if (!text) { clearMood(); return; }
    var data = { emoji: emoji || '\u{1F41D}', text: text, updatedAt: Date.now() };
    localStorage.setItem('polleneer_mood', JSON.stringify(data));
    updateMoodDisplay();
    showToast('Mood updated! ' + data.emoji);
}

function clearMood() {
    localStorage.removeItem('polleneer_mood');
    updateMoodDisplay();
    showToast('Mood cleared');
}

function updateMoodDisplay() {
    var el = document.getElementById('profileMoodStatus');
    if (el) el.innerHTML = getMoodStatusHTML();
}

function renderMoodSettings() {
    var current = getMoodStatus();
    var currentEmoji = current ? current.emoji : '';
    var currentText = current ? current.text : '';

    return '<div style="padding:16px;">' +
        '<h4 style="margin-bottom:14px;"><i class="fas fa-smile-beam"></i> Profile Mood / Status</h4>' +
        '<p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">Shows under your bio. Let people know what you\'re up to.</p>' +

        '<div style="display:flex;gap:8px;margin-bottom:14px;">' +
            '<input type="text" id="settingsMoodEmoji" value="' + currentEmoji + '" placeholder="\u{1F41D}" maxlength="4" style="width:50px;text-align:center;font-size:24px;padding:8px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:10px;color:var(--text-primary);">' +
            '<input type="text" id="settingsMoodText" value="' + escapeHtml(currentText) + '" placeholder="What are you up to?" maxlength="60" style="flex:1;padding:8px 12px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:10px;color:var(--text-primary);font-size:14px;">' +
        '</div>' +

        '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;">' +
            MOOD_PRESETS.map(function(p) {
                return '<button onclick="document.getElementById(\'settingsMoodEmoji\').value=\'' + p.emoji + '\';document.getElementById(\'settingsMoodText\').value=\'' + p.label + '\';" ' +
                    'style="padding:5px 10px;border-radius:16px;border:1px solid var(--border-color);background:var(--bg-input);cursor:pointer;color:var(--text-primary);font-size:12px;transition:all 0.2s;" ' +
                    'onmouseover="this.style.borderColor=\'var(--honey-yellow)\'" onmouseout="this.style.borderColor=\'var(--border-color)\'">' +
                    p.emoji + ' ' + p.label +
                '</button>';
            }).join('') +
        '</div>' +

        '<div style="display:flex;gap:8px;">' +
            '<button onclick="var e=document.getElementById(\'settingsMoodEmoji\').value.trim();var t=document.getElementById(\'settingsMoodText\').value.trim();if(t){saveMoodFromSettings(e,t)}else{clearMood()}" style="padding:8px 20px;border-radius:20px;border:none;background:var(--honey-yellow);color:#000;cursor:pointer;font-weight:600;font-size:13px;">Save Mood</button>' +
            '<button onclick="clearMood()" style="padding:8px 16px;border-radius:20px;border:1px solid var(--border-color);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:13px;">Clear</button>' +
        '</div>' +
    '</div>';
}

function saveMoodFromSettings(emoji, text) {
    var data = { emoji: emoji || '\u{1F41D}', text: text, updatedAt: Date.now() };
    localStorage.setItem('polleneer_mood', JSON.stringify(data));
    updateMoodDisplay();
    showToast('Mood updated! ' + data.emoji);
}

// =====================================================================
// FEATURE 3: PINNED POST
// =====================================================================
function getPinnedPostId() {
    try {
        var saved = localStorage.getItem('polleneer_pinned_post');
        if (saved) return parseInt(saved);
    } catch(e) {}
    return null;
}

function setPinnedPost(postId) {
    localStorage.setItem('polleneer_pinned_post', postId.toString());
    loadPinnedPost();
    showToast('Post pinned to your profile! \u{1F4CC}');
}

function unpinPost() {
    localStorage.removeItem('polleneer_pinned_post');
    loadPinnedPost();
    showToast('Post unpinned');
}

function loadPinnedPost() {
    var area = document.getElementById('pinnedPostArea');
    if (!area) return;

    var pinnedId = getPinnedPostId();
    if (!pinnedId) { area.innerHTML = ''; return; }

    var post = posts.find(function(p) { return p.id === pinnedId; });
    if (!post || post.userId !== (currentUser ? currentUser.id : -1)) {
        area.innerHTML = '';
        return;
    }

    var postHTML = createPostHTML(post);
    area.innerHTML = '<div class="pinned-post-container" style="margin-top:10px;">' +
        '<div class="pinned-post-label"><i class="fas fa-thumbtack"></i> Pinned Post</div>' +
        postHTML +
    '</div>';
}

// Add "Pin to profile" option to post menu (non-hoisting override)
(function() {
    var _prevCreatePostHTML = createPostHTML;
    createPostHTML = function(post) {
        var html = _prevCreatePostHTML(post);

        // Only add pin option for current user's posts
        if (currentUser && post.userId === currentUser.id) {
            var isPinned = getPinnedPostId() === post.id;
            var pinBtn = isPinned ?
                '<button style="width:100%;padding:10px 16px;border:none;background:transparent;color:var(--text-primary);cursor:pointer;text-align:left;font-size:14px;transition:background 0.2s;" onmouseover="this.style.background=\'var(--bg-input)\'" onmouseout="this.style.background=\'transparent\'" onclick="unpinPost()"><i class="fas fa-thumbtack" style="color:var(--honey-yellow);width:24px;"></i> Unpin from profile</button>' :
                '<button style="width:100%;padding:10px 16px;border:none;background:transparent;color:var(--text-primary);cursor:pointer;text-align:left;font-size:14px;transition:background 0.2s;" onmouseover="this.style.background=\'var(--bg-input)\'" onmouseout="this.style.background=\'transparent\'" onclick="setPinnedPost(' + post.id + ')"><i class="fas fa-thumbtack" style="width:24px;"></i> Pin to your profile</button>';

            // Insert pin button into the post's dropdown menu before Delete
            var deleteIdx = html.indexOf('Delete');
            if (deleteIdx > 0) {
                var btnStart = html.lastIndexOf('<button', deleteIdx);
                if (btnStart > 0) {
                    html = html.substring(0, btnStart) + pinBtn + html.substring(btnStart);
                }
            }
        }
        return html;
    };
})();

// =====================================================================
// ADD NEW TAB TO CUSTOMIZE MODAL: "Flair" 
// (contains Avatar Border + Mood settings)
// =====================================================================






// ==================== ONLINE STATUS INDICATOR ====================

function getUserStatus(user) {
    if (!user) return { status: 'offline', label: 'Offline', tooltip: 'User is offline' };

    // Current user is always online
    if (user.username === (currentUser && currentUser.username)) {
        return { status: 'online', label: 'Online Now', tooltip: 'Active right now' };
    }

    var lastActive = user.lastActive;
    if (!lastActive) return { status: 'offline', label: 'Offline', tooltip: 'No recent activity' };

    var now = Date.now();
    var lastTime = (lastActive instanceof Date) ? lastActive.getTime() : new Date(lastActive).getTime();
    var diffMs = now - lastTime;
    var diffMins = Math.floor(diffMs / 60000);
    var diffHours = Math.floor(diffMs / 3600000);
    var diffDays = Math.floor(diffMs / 86400000);

    // Online: active within last 10 minutes
    if (diffMins < 10) {
        return {
            status: 'online',
            label: 'Online Now',
            tooltip: 'Active ' + (diffMins <= 1 ? 'just now' : diffMins + ' minutes ago')
        };
    }

    // Busy/Away: active between 10 minutes and 2 hours ago
    if (diffHours < 2) {
        var timeAgo = diffMins < 60 ? diffMins + 'min ago' : '1hr ago';
        return {
            status: 'busy',
            label: 'Away',
            tooltip: 'Last seen ' + timeAgo
        };
    }

    // Offline: more than 2 hours ago
    var timeLabel = '';
    if (diffHours < 24) {
        timeLabel = diffHours + 'hr' + (diffHours > 1 ? 's' : '') + ' ago';
    } else if (diffDays < 7) {
        timeLabel = diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
    } else {
        timeLabel = new Date(lastTime).toLocaleDateString();
    }

    return {
        status: 'offline',
        label: 'Offline',
        tooltip: 'Last seen ' + timeLabel
    };
}

function getUserStatusHTML(user) {
    var info = getUserStatus(user);
    return '<span class="status-indicator">' +
        '<span class="status-dot ' + info.status + '"></span>' +
        '<span class="status-label ' + info.status + '">' + info.label + '</span>' +
        '<span class="status-tooltip">' + info.tooltip + '</span>' +
    '</span>';
}

function getMiniStatusDot(user) {
    var info = getUserStatus(user);
    return '<span class="mini-status-dot ' + info.status + '" title="' + info.tooltip + '"></span>';
}

// Keep currentUser lastActive fresh (simulates real-time tracking)
(function() {
    setInterval(function() {
        if (currentUser) {
            currentUser.lastActive = new Date();
        }
    }, 60000);

    // Also update on any user interaction
    document.addEventListener('click', function() {
        if (currentUser) currentUser.lastActive = new Date();
    });
    document.addEventListener('keydown', function() {
        if (currentUser) currentUser.lastActive = new Date();
    });
})();

// Simulate other users' activity changes (for demo)
(function() {
    setInterval(function() {
        if (typeof SAMPLE_USERS !== 'undefined') {
            SAMPLE_USERS.forEach(function(u) {
                // Random chance a user "does something" 
                if (Math.random() < 0.15) {
                    u.lastActive = new Date(Date.now() - Math.floor(Math.random() * 10) * 60000);
                }
            });
        }
    }, 30000);
})();

        </script>

    <!-- Generic Settings Modal -->
    <div class="modal" id="genericSettingsModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="modal-close" onclick="closeModal('genericSettingsModal')">&times;</button>
            </div>
            <div class="modal-body" id="genericSettingsModalBody">
            </div>
        </div>
    </div>
</body>
</html>
